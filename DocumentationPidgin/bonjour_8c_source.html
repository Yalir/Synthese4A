<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>protocols/bonjour/bonjour.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('bonjour_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">protocols/bonjour/bonjour.c</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * purple - Bonjour Protocol Plugin</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Purple is the legal property of its developers, whose names are too numerous</span>
<a name="l00005"></a>00005 <span class="comment"> * to list here.  Please refer to the COPYRIGHT file distributed with this</span>
<a name="l00006"></a>00006 <span class="comment"> * source distribution.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00009"></a>00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00010"></a>00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00011"></a>00011 <span class="comment"> * (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00016"></a>00016 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00019"></a>00019 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00020"></a>00020 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02111-1301  USA</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;glib.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#ifndef _WIN32</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="preprocessor">#include &lt;pwd.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#else</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#define UNICODE</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span><span class="preprocessor">#include &lt;winsock2.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;windows.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;lm.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;dns_sd_proxy.h&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#endif</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;internal.h&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="account_8h.html">account.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="accountopt_8h.html">accountopt.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html">debug.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="util_8h.html">util.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="version_8h.html">version.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="bonjour_8h.html">bonjour.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;mdns_common.h&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;jabber.h&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;buddy.h&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;bonjour_ft.h&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">static</span> <span class="keywordtype">char</span> *default_firstname;
<a name="l00048"></a>00048 <span class="keyword">static</span> <span class="keywordtype">char</span> *default_lastname;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00051"></a><a class="code" href="bonjour_8h.html#aee20497b731b7cc5c35ba81fbfce74a9">00051</a> bonjour_get_jid(<a class="code" href="struct___purple_account.html">PurpleAccount</a> *account)
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053         <a class="code" href="struct___purple_connection.html">PurpleConnection</a> *conn = purple_account_get_connection(account);
<a name="l00054"></a>00054         <a class="code" href="struct___bonjour_data.html">BonjourData</a> *bd = conn-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00055"></a>00055         <span class="keywordflow">return</span> bd-&gt;jid;
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00059"></a>00059 bonjour_removeallfromlocal(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *conn, <a class="code" href="struct___purple_group.html">PurpleGroup</a> *bonjour_group)
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061         <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account = purple_connection_get_account(conn);
<a name="l00062"></a>00062         <a class="code" href="struct___purple_blist_node.html">PurpleBlistNode</a> *cnode, *cnodenext, *bnode, *bnodenext;
<a name="l00063"></a>00063         <a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <span class="keywordflow">if</span> (bonjour_group == NULL)
<a name="l00066"></a>00066                 <span class="keywordflow">return</span>;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068         <span class="comment">/* Go through and remove all buddies that belong to this account */</span>
<a name="l00069"></a>00069         <span class="keywordflow">for</span> (cnode = purple_blist_node_get_first_child((<a class="code" href="struct___purple_blist_node.html">PurpleBlistNode</a> *) bonjour_group); cnode; cnode = cnodenext) {
<a name="l00070"></a>00070                 cnodenext = purple_blist_node_get_sibling_next(cnode);
<a name="l00071"></a>00071                 <span class="keywordflow">if</span> (!PURPLE_BLIST_NODE_IS_CONTACT(cnode))
<a name="l00072"></a>00072                         <span class="keywordflow">continue</span>;
<a name="l00073"></a>00073                 <span class="keywordflow">for</span> (bnode = purple_blist_node_get_first_child(cnode); bnode; bnode = bnodenext) {
<a name="l00074"></a>00074                         bnodenext = purple_blist_node_get_sibling_next(bnode);
<a name="l00075"></a>00075                         <span class="keywordflow">if</span> (!PURPLE_BLIST_NODE_IS_BUDDY(bnode))
<a name="l00076"></a>00076                                 <span class="keywordflow">continue</span>;
<a name="l00077"></a>00077                         buddy = (<a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *) bnode;
<a name="l00078"></a>00078                         <span class="keywordflow">if</span> (purple_buddy_get_account(buddy) != account)
<a name="l00079"></a>00079                                 <span class="keywordflow">continue</span>;
<a name="l00080"></a>00080                         purple_account_remove_buddy(account, buddy, NULL);
<a name="l00081"></a>00081                         purple_blist_remove_buddy(buddy);
<a name="l00082"></a>00082                 }
<a name="l00083"></a>00083         }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00088"></a>00088 bonjour_login(<a class="code" href="struct___purple_account.html">PurpleAccount</a> *account)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090         <a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc = purple_account_get_connection(account);
<a name="l00091"></a>00091         <a class="code" href="struct___bonjour_data.html">BonjourData</a> *bd;
<a name="l00092"></a>00092         <a class="code" href="struct___purple_status.html">PurpleStatus</a> *status;
<a name="l00093"></a>00093         <a class="code" href="struct___purple_presence.html">PurplePresence</a> *presence;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!dns_sd_available()) {
<a name="l00097"></a>00097                 purple_connection_error_reason(gc,
<a name="l00098"></a>00098                                 <a class="code" href="connection_8h.html#ad073b7b1d65488a3b3e39fc382324c4dac75515e26e28365555ad227717317ffa">PURPLE_CONNECTION_ERROR_OTHER_ERROR</a>,
<a name="l00099"></a>00099                                 _(<span class="stringliteral">&quot;Unable to find Apple&#39;s \&quot;Bonjour for Windows\&quot; toolkit, see &quot;</span>
<a name="l00100"></a>00100                                   <span class="stringliteral">&quot;http://d.pidgin.im/BonjourWindows for more information.&quot;</span>));
<a name="l00101"></a>00101                 <span class="keywordflow">return</span>;
<a name="l00102"></a>00102         }
<a name="l00103"></a>00103 <span class="preprocessor">#endif </span><span class="comment">/* _WIN32 */</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105         gc-&gt;<a class="code" href="struct___purple_connection.html#a9164f327f3728939f0177bf92cc3d259">flags</a> |= <a class="code" href="connection_8h.html#a5073f95bd10eb9eed84fa58cbf1bb162a93b3e0b7e291b0516ee4e8057f874f48">PURPLE_CONNECTION_HTML</a>;
<a name="l00106"></a>00106         gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a> = bd = g_new0(<a class="code" href="struct___bonjour_data.html">BonjourData</a>, 1);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         <span class="comment">/* Start waiting for jabber connections (iChat style) */</span>
<a name="l00109"></a>00109         bd-&gt;jabber_data = g_new0(<a class="code" href="struct___bonjour_jabber.html">BonjourJabber</a>, 1);
<a name="l00110"></a>00110         bd-&gt;jabber_data-&gt;socket = -1;
<a name="l00111"></a>00111         bd-&gt;jabber_data-&gt;socket6 = -1;
<a name="l00112"></a>00112         bd-&gt;jabber_data-&gt;port = purple_account_get_int(account, <span class="stringliteral">&quot;port&quot;</span>, BONJOUR_DEFAULT_PORT);
<a name="l00113"></a>00113         bd-&gt;jabber_data-&gt;account = account;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115         <span class="keywordflow">if</span> (bonjour_jabber_start(bd-&gt;jabber_data) == -1) {
<a name="l00116"></a>00116                 <span class="comment">/* Send a message about the connection error */</span>
<a name="l00117"></a>00117                 purple_connection_error_reason (gc,
<a name="l00118"></a>00118                                 <a class="code" href="connection_8h.html#ad073b7b1d65488a3b3e39fc382324c4dae83601cb8c581624c7af7dd81b5eaac9">PURPLE_CONNECTION_ERROR_NETWORK_ERROR</a>,
<a name="l00119"></a>00119                                 _(<span class="stringliteral">&quot;Unable to listen for incoming IM connections&quot;</span>));
<a name="l00120"></a>00120                 <span class="keywordflow">return</span>;
<a name="l00121"></a>00121         }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="comment">/* Connect to the mDNS daemon looking for buddies in the LAN */</span>
<a name="l00124"></a>00124         bd-&gt;dns_sd_data = bonjour_dns_sd_new();
<a name="l00125"></a>00125         bd-&gt;dns_sd_data-&gt;first = g_strdup(purple_account_get_string(account, <span class="stringliteral">&quot;first&quot;</span>, default_firstname));
<a name="l00126"></a>00126         bd-&gt;dns_sd_data-&gt;last = g_strdup(purple_account_get_string(account, <span class="stringliteral">&quot;last&quot;</span>, default_lastname));
<a name="l00127"></a>00127         bd-&gt;dns_sd_data-&gt;port_p2pj = bd-&gt;jabber_data-&gt;port;
<a name="l00128"></a>00128         <span class="comment">/* Not engaged in AV conference */</span>
<a name="l00129"></a>00129         bd-&gt;dns_sd_data-&gt;vc = g_strdup(<span class="stringliteral">&quot;!&quot;</span>);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         status = purple_account_get_active_status(account);
<a name="l00132"></a>00132         presence = purple_account_get_presence(account);
<a name="l00133"></a>00133         <span class="keywordflow">if</span> (purple_presence_is_available(presence))
<a name="l00134"></a>00134                 bd-&gt;dns_sd_data-&gt;status = g_strdup(<span class="stringliteral">&quot;avail&quot;</span>);
<a name="l00135"></a>00135         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (purple_presence_is_idle(presence))
<a name="l00136"></a>00136                 bd-&gt;dns_sd_data-&gt;status = g_strdup(<span class="stringliteral">&quot;away&quot;</span>);
<a name="l00137"></a>00137         <span class="keywordflow">else</span>
<a name="l00138"></a>00138                 bd-&gt;dns_sd_data-&gt;status = g_strdup(<span class="stringliteral">&quot;dnd&quot;</span>);
<a name="l00139"></a>00139         bd-&gt;dns_sd_data-&gt;msg = g_strdup(purple_status_get_attr_string(status, <span class="stringliteral">&quot;message&quot;</span>));
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         bd-&gt;dns_sd_data-&gt;account = account;
<a name="l00142"></a>00142         <span class="keywordflow">if</span> (!bonjour_dns_sd_start(bd-&gt;dns_sd_data))
<a name="l00143"></a>00143         {
<a name="l00144"></a>00144                 purple_connection_error_reason (gc,
<a name="l00145"></a>00145                         <a class="code" href="connection_8h.html#ad073b7b1d65488a3b3e39fc382324c4dae83601cb8c581624c7af7dd81b5eaac9">PURPLE_CONNECTION_ERROR_NETWORK_ERROR</a>,
<a name="l00146"></a>00146                         _(<span class="stringliteral">&quot;Unable to establish connection with the local mDNS server.  Is it running?&quot;</span>));
<a name="l00147"></a>00147                 <span class="keywordflow">return</span>;
<a name="l00148"></a>00148         }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         bonjour_dns_sd_update_buddy_icon(bd-&gt;dns_sd_data);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152         <span class="comment">/* Show the buddy list by telling Purple we have already connected */</span>
<a name="l00153"></a>00153         purple_connection_set_state(gc, <a class="code" href="connection_8h.html#afba52f486d090ff5e2d1189fd93fff2ca76b07b6cf140a5f65d41791f9b09aaf8">PURPLE_CONNECTED</a>);
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00157"></a>00157 bonjour_close(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *connection)
<a name="l00158"></a>00158 {
<a name="l00159"></a>00159         <a class="code" href="struct___purple_group.html">PurpleGroup</a> *bonjour_group;
<a name="l00160"></a>00160         <a class="code" href="struct___bonjour_data.html">BonjourData</a> *bd = connection-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         bonjour_group = purple_find_group(BONJOUR_GROUP_NAME);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <span class="comment">/* Remove all the bonjour buddies */</span>
<a name="l00165"></a>00165         bonjour_removeallfromlocal(connection, bonjour_group);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="comment">/* Stop looking for buddies in the LAN */</span>
<a name="l00168"></a>00168         <span class="keywordflow">if</span> (bd != NULL &amp;&amp; bd-&gt;dns_sd_data != NULL)
<a name="l00169"></a>00169         {
<a name="l00170"></a>00170                 bonjour_dns_sd_stop(bd-&gt;dns_sd_data);
<a name="l00171"></a>00171                 bonjour_dns_sd_free(bd-&gt;dns_sd_data);
<a name="l00172"></a>00172         }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         <span class="keywordflow">if</span> (bd != NULL &amp;&amp; bd-&gt;jabber_data != NULL)
<a name="l00175"></a>00175         {
<a name="l00176"></a>00176                 <span class="comment">/* Stop waiting for conversations */</span>
<a name="l00177"></a>00177                 bonjour_jabber_stop(bd-&gt;jabber_data);
<a name="l00178"></a>00178                 g_free(bd-&gt;jabber_data);
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <span class="comment">/* Delete the bonjour group</span>
<a name="l00182"></a>00182 <span class="comment">         * (purple_blist_remove_group will bail out if the group isn&#39;t empty)</span>
<a name="l00183"></a>00183 <span class="comment">         */</span>
<a name="l00184"></a>00184         <span class="keywordflow">if</span> (bonjour_group != NULL)
<a name="l00185"></a>00185                 purple_blist_remove_group(bonjour_group);
<a name="l00186"></a>00186 
<a name="l00187"></a>00187         <span class="comment">/* Cancel any file transfers */</span>
<a name="l00188"></a>00188         <span class="keywordflow">while</span> (bd != NULL &amp;&amp; bd-&gt;xfer_lists) {
<a name="l00189"></a>00189                 purple_xfer_cancel_local(bd-&gt;xfer_lists-&gt;data);
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192         <span class="keywordflow">if</span> (bd != NULL)
<a name="l00193"></a>00193                 g_free(bd-&gt;jid);
<a name="l00194"></a>00194         g_free(bd);
<a name="l00195"></a>00195         connection-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a> = NULL;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00199"></a>00199 bonjour_list_icon(<a class="code" href="struct___purple_account.html">PurpleAccount</a> *account, <a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201         <span class="keywordflow">return</span> BONJOUR_ICON_NAME;
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00205"></a>00205 bonjour_send_im(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *connection, <span class="keyword">const</span> <span class="keywordtype">char</span> *to, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg, <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5">PurpleMessageFlags</a> flags)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207         <span class="keywordflow">if</span>(!to || !msg)
<a name="l00208"></a>00208                 <span class="keywordflow">return</span> 0;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="keywordflow">return</span> bonjour_jabber_send_message(((<a class="code" href="struct___bonjour_data.html">BonjourData</a>*)(connection-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>))-&gt;jabber_data, to, msg);
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00214"></a>00214 bonjour_set_status(<a class="code" href="struct___purple_account.html">PurpleAccount</a> *account, <a class="code" href="struct___purple_status.html">PurpleStatus</a> *status)
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216         <a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc;
<a name="l00217"></a>00217         <a class="code" href="struct___bonjour_data.html">BonjourData</a> *bd;
<a name="l00218"></a>00218         <a class="code" href="struct___purple_presence.html">PurplePresence</a> *presence;
<a name="l00219"></a>00219         <span class="keyword">const</span> <span class="keywordtype">char</span> *message, *bonjour_status;
<a name="l00220"></a>00220         gchar *stripped;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222         gc = purple_account_get_connection(account);
<a name="l00223"></a>00223         bd = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00224"></a>00224         presence = purple_account_get_presence(account);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         message = purple_status_get_attr_string(status, <span class="stringliteral">&quot;message&quot;</span>);
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (message == NULL)
<a name="l00228"></a>00228                 message = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00229"></a>00229         stripped = purple_markup_strip_html(message);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="comment">/*</span>
<a name="l00232"></a>00232 <span class="comment">         * The three possible status for Bonjour are</span>
<a name="l00233"></a>00233 <span class="comment">         *   -available (&quot;avail&quot;)</span>
<a name="l00234"></a>00234 <span class="comment">         *   -idle (&quot;away&quot;)</span>
<a name="l00235"></a>00235 <span class="comment">         *   -away (&quot;dnd&quot;)</span>
<a name="l00236"></a>00236 <span class="comment">         * Each of them can have an optional message.</span>
<a name="l00237"></a>00237 <span class="comment">         */</span>
<a name="l00238"></a>00238         <span class="keywordflow">if</span> (purple_presence_is_available(presence))
<a name="l00239"></a>00239                 bonjour_status = <span class="stringliteral">&quot;avail&quot;</span>;
<a name="l00240"></a>00240         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (purple_presence_is_idle(presence))
<a name="l00241"></a>00241                 bonjour_status = <span class="stringliteral">&quot;away&quot;</span>;
<a name="l00242"></a>00242         <span class="keywordflow">else</span>
<a name="l00243"></a>00243                 bonjour_status = <span class="stringliteral">&quot;dnd&quot;</span>;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         bonjour_dns_sd_send_status(bd-&gt;dns_sd_data, bonjour_status, stripped);
<a name="l00246"></a>00246         g_free(stripped);
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="comment">/*</span>
<a name="l00250"></a>00250 <span class="comment"> * The add_buddy callback removes the buddy from the local list.</span>
<a name="l00251"></a>00251 <span class="comment"> * Bonjour manages buddies for you, and adding someone locally by</span>
<a name="l00252"></a>00252 <span class="comment"> * hand is stupid.  Perhaps we should change libpurple not to allow adding</span>
<a name="l00253"></a>00253 <span class="comment"> * if there is no add_buddy callback.</span>
<a name="l00254"></a>00254 <span class="comment"> */</span>
<a name="l00255"></a>00255 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00256"></a>00256 bonjour_fake_add_buddy(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *pc, <a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy, <a class="code" href="struct___purple_group.html">PurpleGroup</a> *group) {
<a name="l00257"></a>00257         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;bonjour&quot;</span>, <span class="stringliteral">&quot;Buddy &#39;%s&#39; manually added; removing.  &quot;</span>
<a name="l00258"></a>00258                                       <span class="stringliteral">&quot;Bonjour buddies must be discovered and not manually added.\n&quot;</span>,
<a name="l00259"></a>00259                            purple_buddy_get_name(buddy));
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <span class="comment">/* I suppose we could alert the user here, but it seems unnecessary. */</span>
<a name="l00262"></a>00262 
<a name="l00263"></a>00263         <span class="comment">/* If this causes problems, it can be moved to an idle callback */</span>
<a name="l00264"></a>00264         purple_blist_remove_buddy(buddy);
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 <span class="keyword">static</span> <span class="keywordtype">void</span> bonjour_remove_buddy(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *pc, <a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy, <a class="code" href="struct___purple_group.html">PurpleGroup</a> *group) {
<a name="l00269"></a>00269         <a class="code" href="struct___bonjour_buddy.html">BonjourBuddy</a> *bb = purple_buddy_get_protocol_data(buddy);
<a name="l00270"></a>00270         <span class="keywordflow">if</span> (bb) {
<a name="l00271"></a>00271                 bonjour_buddy_delete(bb);
<a name="l00272"></a>00272                 purple_buddy_set_protocol_data(buddy, NULL);
<a name="l00273"></a>00273         }
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="keyword">static</span> GList *
<a name="l00277"></a>00277 bonjour_status_types(<a class="code" href="struct___purple_account.html">PurpleAccount</a> *account)
<a name="l00278"></a>00278 {
<a name="l00279"></a>00279         GList *status_types = NULL;
<a name="l00280"></a>00280         <a class="code" href="struct___purple_status_type.html">PurpleStatusType</a> *type;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         g_return_val_if_fail(account != NULL, NULL);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         type = purple_status_type_new_with_attrs(PURPLE_STATUS_AVAILABLE,
<a name="l00285"></a>00285                                                                                    BONJOUR_STATUS_ID_AVAILABLE,
<a name="l00286"></a>00286                                                                                    NULL, TRUE, TRUE, FALSE,
<a name="l00287"></a>00287                                                                                    <span class="stringliteral">&quot;message&quot;</span>, _(<span class="stringliteral">&quot;Message&quot;</span>),
<a name="l00288"></a>00288                                                                                    <a class="code" href="value_8c.html#ab40d80035ac1a3e1728302d6bb007646">purple_value_new</a>(<a class="code" href="value_8h.html#a87d0e48c3af4f74259fe96a3c9f32694aa05738cd3332f9b63773e4c4bc17f83f">PURPLE_TYPE_STRING</a>), NULL);
<a name="l00289"></a>00289         status_types = g_list_append(status_types, type);
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         type = purple_status_type_new_with_attrs(PURPLE_STATUS_AWAY,
<a name="l00292"></a>00292                                                                                    BONJOUR_STATUS_ID_AWAY,
<a name="l00293"></a>00293                                                                                    NULL, TRUE, TRUE, FALSE,
<a name="l00294"></a>00294                                                                                    <span class="stringliteral">&quot;message&quot;</span>, _(<span class="stringliteral">&quot;Message&quot;</span>),
<a name="l00295"></a>00295                                                                                    <a class="code" href="value_8c.html#ab40d80035ac1a3e1728302d6bb007646">purple_value_new</a>(<a class="code" href="value_8h.html#a87d0e48c3af4f74259fe96a3c9f32694aa05738cd3332f9b63773e4c4bc17f83f">PURPLE_TYPE_STRING</a>), NULL);
<a name="l00296"></a>00296         status_types = g_list_append(status_types, type);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         type = purple_status_type_new_full(PURPLE_STATUS_OFFLINE,
<a name="l00299"></a>00299                                                                          BONJOUR_STATUS_ID_OFFLINE,
<a name="l00300"></a>00300                                                                          NULL, TRUE, TRUE, FALSE);
<a name="l00301"></a>00301         status_types = g_list_append(status_types, type);
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         <span class="keywordflow">return</span> status_types;
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00307"></a>00307 bonjour_convo_closed(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *connection, <span class="keyword">const</span> <span class="keywordtype">char</span> *who)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309         <a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy = purple_find_buddy(connection-&gt;<a class="code" href="struct___purple_connection.html#ab7713db5a3c9faff940723d9c30c0e63">account</a>, who);
<a name="l00310"></a>00310         <a class="code" href="struct___bonjour_buddy.html">BonjourBuddy</a> *bb;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312         <span class="keywordflow">if</span> (buddy == NULL || (bb = purple_buddy_get_protocol_data(buddy)) == NULL)
<a name="l00313"></a>00313         {
<a name="l00314"></a>00314                 <span class="comment">/*</span>
<a name="l00315"></a>00315 <span class="comment">                 * This buddy is not in our buddy list, and therefore does not really</span>
<a name="l00316"></a>00316 <span class="comment">                 * exist, so we won&#39;t have any data about them.</span>
<a name="l00317"></a>00317 <span class="comment">                 */</span>
<a name="l00318"></a>00318                 <span class="keywordflow">return</span>;
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         bonjour_jabber_close_conversation(bb-&gt;conversation);
<a name="l00322"></a>00322         bb-&gt;conversation = NULL;
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325 <span class="keyword">static</span>
<a name="l00326"></a>00326 <span class="keywordtype">void</span> bonjour_set_buddy_icon(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *conn, <a class="code" href="struct___purple_stored_image.html">PurpleStoredImage</a> *img)
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328         <a class="code" href="struct___bonjour_data.html">BonjourData</a> *bd = conn-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00329"></a>00329         bonjour_dns_sd_update_buddy_icon(bd-&gt;dns_sd_data);
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00334"></a>00334 bonjour_status_text(<a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy)
<a name="l00335"></a>00335 {
<a name="l00336"></a>00336         <span class="keyword">const</span> <a class="code" href="struct___purple_presence.html">PurplePresence</a> *presence;
<a name="l00337"></a>00337         <span class="keyword">const</span> <a class="code" href="struct___purple_status.html">PurpleStatus</a> *status;
<a name="l00338"></a>00338         <span class="keyword">const</span> <span class="keywordtype">char</span> *message;
<a name="l00339"></a>00339         gchar *ret = NULL;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         presence = purple_buddy_get_presence(buddy);
<a name="l00342"></a>00342         status = purple_presence_get_active_status(presence);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         message = purple_status_get_attr_string(status, <span class="stringliteral">&quot;message&quot;</span>);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346         <span class="keywordflow">if</span> (message != NULL) {
<a name="l00347"></a>00347                 ret = g_markup_escape_text(message, -1);
<a name="l00348"></a>00348                 purple_util_chrreplace(ret, <span class="charliteral">&#39;\n&#39;</span>, <span class="charliteral">&#39; &#39;</span>);
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <span class="keywordflow">return</span> ret;
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00355"></a>00355 bonjour_tooltip_text(<a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy, <a class="code" href="struct___purple_notify_user_info.html">PurpleNotifyUserInfo</a> *user_info, gboolean full)
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357         <a class="code" href="struct___purple_presence.html">PurplePresence</a> *presence;
<a name="l00358"></a>00358         <a class="code" href="struct___purple_status.html">PurpleStatus</a> *status;
<a name="l00359"></a>00359         <a class="code" href="struct___bonjour_buddy.html">BonjourBuddy</a> *bb = purple_buddy_get_protocol_data(buddy);
<a name="l00360"></a>00360         <span class="keyword">const</span> <span class="keywordtype">char</span> *status_description;
<a name="l00361"></a>00361         <span class="keyword">const</span> <span class="keywordtype">char</span> *message;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         presence = purple_buddy_get_presence(buddy);
<a name="l00364"></a>00364         status = purple_presence_get_active_status(presence);
<a name="l00365"></a>00365         message = purple_status_get_attr_string(status, <span class="stringliteral">&quot;message&quot;</span>);
<a name="l00366"></a>00366 
<a name="l00367"></a>00367         <span class="keywordflow">if</span> (purple_presence_is_available(presence))
<a name="l00368"></a>00368                 status_description = purple_status_get_name(status);
<a name="l00369"></a>00369         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (purple_presence_is_idle(presence))
<a name="l00370"></a>00370                 status_description = _(<span class="stringliteral">&quot;Idle&quot;</span>);
<a name="l00371"></a>00371         <span class="keywordflow">else</span>
<a name="l00372"></a>00372                 status_description = purple_status_get_name(status);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         purple_notify_user_info_add_pair(user_info, _(<span class="stringliteral">&quot;Status&quot;</span>), status_description);
<a name="l00375"></a>00375         <span class="keywordflow">if</span> (message != NULL)
<a name="l00376"></a>00376                 purple_notify_user_info_add_pair(user_info, _(<span class="stringliteral">&quot;Message&quot;</span>), message);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         <span class="keywordflow">if</span> (bb == NULL) {
<a name="l00379"></a>00379                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;bonjour&quot;</span>, <span class="stringliteral">&quot;Got tooltip request for a buddy without protocol data.\n&quot;</span>);
<a name="l00380"></a>00380                 <span class="keywordflow">return</span>;
<a name="l00381"></a>00381         }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383         <span class="comment">/* Only show first/last name if there is a nickname set (to avoid duplication) */</span>
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (bb-&gt;nick != NULL &amp;&amp; *bb-&gt;nick != <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00385"></a>00385                 <span class="keywordflow">if</span> (bb-&gt;first != NULL &amp;&amp; *bb-&gt;first != <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00386"></a>00386                         purple_notify_user_info_add_pair(user_info, _(<span class="stringliteral">&quot;First name&quot;</span>), bb-&gt;first);
<a name="l00387"></a>00387                 <span class="keywordflow">if</span> (bb-&gt;last != NULL &amp;&amp; *bb-&gt;last != <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00388"></a>00388                         purple_notify_user_info_add_pair(user_info, _(<span class="stringliteral">&quot;Last name&quot;</span>), bb-&gt;last);
<a name="l00389"></a>00389         }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391         <span class="keywordflow">if</span> (bb-&gt;email != NULL &amp;&amp; *bb-&gt;email != <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00392"></a>00392                 purple_notify_user_info_add_pair(user_info, _(<span class="stringliteral">&quot;Email&quot;</span>), bb-&gt;email);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394         <span class="keywordflow">if</span> (bb-&gt;AIM != NULL &amp;&amp; *bb-&gt;AIM != <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00395"></a>00395                 purple_notify_user_info_add_pair(user_info, _(<span class="stringliteral">&quot;AIM Account&quot;</span>), bb-&gt;AIM);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         <span class="keywordflow">if</span> (bb-&gt;jid != NULL &amp;&amp; *bb-&gt;jid != <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00398"></a>00398                 purple_notify_user_info_add_pair(user_info, _(<span class="stringliteral">&quot;XMPP Account&quot;</span>), bb-&gt;jid);
<a name="l00399"></a>00399 }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00402"></a>00402 bonjour_do_group_change(<a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy, <span class="keyword">const</span> <span class="keywordtype">char</span> *new_group) {
<a name="l00403"></a>00403         <a class="code" href="blist_8h.html#a1d3134d2dd4ad58f28784cce78a05bdf">PurpleBlistNodeFlags</a> oldflags;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="keywordflow">if</span> (buddy == NULL)
<a name="l00406"></a>00406                 <span class="keywordflow">return</span>;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         oldflags = purple_blist_node_get_flags((<a class="code" href="struct___purple_blist_node.html">PurpleBlistNode</a> *)buddy);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <span class="comment">/* If we&#39;re moving them out of the bonjour group, make them persistent */</span>
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (purple_strequal(new_group, BONJOUR_GROUP_NAME))
<a name="l00412"></a>00412                 purple_blist_node_set_flags((<a class="code" href="struct___purple_blist_node.html">PurpleBlistNode</a> *)buddy, oldflags | <a class="code" href="blist_8h.html#a1d3134d2dd4ad58f28784cce78a05bdfad1f33a67ed892a333ef2a06391b1bc01">PURPLE_BLIST_NODE_FLAG_NO_SAVE</a>);
<a name="l00413"></a>00413         <span class="keywordflow">else</span>
<a name="l00414"></a>00414                 purple_blist_node_set_flags((<a class="code" href="struct___purple_blist_node.html">PurpleBlistNode</a> *)buddy, oldflags ^ <a class="code" href="blist_8h.html#a1d3134d2dd4ad58f28784cce78a05bdfad1f33a67ed892a333ef2a06391b1bc01">PURPLE_BLIST_NODE_FLAG_NO_SAVE</a>);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00419"></a>00419 bonjour_group_buddy(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *connection, <span class="keyword">const</span> <span class="keywordtype">char</span> *who, <span class="keyword">const</span> <span class="keywordtype">char</span> *old_group, <span class="keyword">const</span> <span class="keywordtype">char</span> *new_group)
<a name="l00420"></a>00420 {
<a name="l00421"></a>00421         <a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy = purple_find_buddy(connection-&gt;<a class="code" href="struct___purple_connection.html#ab7713db5a3c9faff940723d9c30c0e63">account</a>, who);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         bonjour_do_group_change(buddy, new_group);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00428"></a>00428 bonjour_rename_group(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *connection, <span class="keyword">const</span> <span class="keywordtype">char</span> *old_name, <a class="code" href="struct___purple_group.html">PurpleGroup</a> *group, GList *moved_buddies)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430         GList *cur;
<a name="l00431"></a>00431         <span class="keyword">const</span> <span class="keywordtype">char</span> *new_group;
<a name="l00432"></a>00432         <a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         new_group = purple_group_get_name(group);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="keywordflow">for</span> (cur = moved_buddies; cur; cur = cur-&gt;next) {
<a name="l00437"></a>00437                 buddy = cur-&gt;data;
<a name="l00438"></a>00438                 bonjour_do_group_change(buddy, new_group);
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="keyword">static</span> gboolean
<a name="l00444"></a>00444 bonjour_can_receive_file(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *connection, <span class="keyword">const</span> <span class="keywordtype">char</span> *who)
<a name="l00445"></a>00445 {
<a name="l00446"></a>00446         <a class="code" href="struct___purple_buddy.html">PurpleBuddy</a> *buddy = purple_find_buddy(connection-&gt;<a class="code" href="struct___purple_connection.html#ab7713db5a3c9faff940723d9c30c0e63">account</a>, who);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         <span class="keywordflow">return</span> (buddy != NULL &amp;&amp; purple_buddy_get_protocol_data(buddy) != NULL);
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 <span class="keyword">static</span> gboolean
<a name="l00452"></a>00452 plugin_unload(<a class="code" href="struct___purple_plugin.html">PurplePlugin</a> *plugin)
<a name="l00453"></a>00453 {
<a name="l00454"></a>00454         <span class="comment">/* These shouldn&#39;t happen here because they are allocated in _init() */</span>
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         g_free(default_firstname);
<a name="l00457"></a>00457         g_free(default_lastname);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         <span class="keywordflow">return</span> TRUE;
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="keyword">static</span> <a class="code" href="struct___purple_plugin.html">PurplePlugin</a> *my_protocol = NULL;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 <span class="keyword">static</span> <a class="code" href="struct___purple_plugin_protocol_info.html">PurplePluginProtocolInfo</a> prpl_info =
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466         <a class="code" href="prpl_8h.html#a766e7a0dcfe8c92068ecca710456fd02a5821f08823a2aef44c6d8a2b223192da">OPT_PROTO_NO_PASSWORD</a>,
<a name="l00467"></a>00467         NULL,                                                    <span class="comment">/* user_splits */</span>
<a name="l00468"></a>00468         NULL,                                                    <span class="comment">/* protocol_options */</span>
<a name="l00469"></a>00469         {<span class="stringliteral">&quot;png,gif,jpeg&quot;</span>, 0, 0, 96, 96, 65535, <a class="code" href="prpl_8h.html#a5e927eea02086b031af475b48a6e2bc0a595fda0b8fb3e24d566d815024165a6c">PURPLE_ICON_SCALE_DISPLAY</a>}, <span class="comment">/* icon_spec */</span>
<a name="l00470"></a>00470         bonjour_list_icon,                                       <span class="comment">/* list_icon */</span>
<a name="l00471"></a>00471         NULL,                                                    <span class="comment">/* list_emblem */</span>
<a name="l00472"></a>00472         bonjour_status_text,                                     <span class="comment">/* status_text */</span>
<a name="l00473"></a>00473         bonjour_tooltip_text,                                    <span class="comment">/* tooltip_text */</span>
<a name="l00474"></a>00474         bonjour_status_types,                                    <span class="comment">/* status_types */</span>
<a name="l00475"></a>00475         NULL,                                                    <span class="comment">/* blist_node_menu */</span>
<a name="l00476"></a>00476         NULL,                                                    <span class="comment">/* chat_info */</span>
<a name="l00477"></a>00477         NULL,                                                    <span class="comment">/* chat_info_defaults */</span>
<a name="l00478"></a>00478         bonjour_login,                                           <span class="comment">/* login */</span>
<a name="l00479"></a>00479         bonjour_close,                                           <span class="comment">/* close */</span>
<a name="l00480"></a>00480         bonjour_send_im,                                         <span class="comment">/* send_im */</span>
<a name="l00481"></a>00481         NULL,                                                    <span class="comment">/* set_info */</span>
<a name="l00482"></a>00482         NULL,                                                    <span class="comment">/* send_typing */</span>
<a name="l00483"></a>00483         NULL,                                                    <span class="comment">/* get_info */</span>
<a name="l00484"></a>00484         bonjour_set_status,                                      <span class="comment">/* set_status */</span>
<a name="l00485"></a>00485         NULL,                                                    <span class="comment">/* set_idle */</span>
<a name="l00486"></a>00486         NULL,                                                    <span class="comment">/* change_passwd */</span>
<a name="l00487"></a>00487         bonjour_fake_add_buddy,                                  <span class="comment">/* add_buddy */</span>
<a name="l00488"></a>00488         NULL,                                                    <span class="comment">/* add_buddies */</span>
<a name="l00489"></a>00489         bonjour_remove_buddy,                                    <span class="comment">/* remove_buddy */</span>
<a name="l00490"></a>00490         NULL,                                                    <span class="comment">/* remove_buddies */</span>
<a name="l00491"></a>00491         NULL,                                                    <span class="comment">/* add_permit */</span>
<a name="l00492"></a>00492         NULL,                                                    <span class="comment">/* add_deny */</span>
<a name="l00493"></a>00493         NULL,                                                    <span class="comment">/* rem_permit */</span>
<a name="l00494"></a>00494         NULL,                                                    <span class="comment">/* rem_deny */</span>
<a name="l00495"></a>00495         NULL,                                                    <span class="comment">/* set_permit_deny */</span>
<a name="l00496"></a>00496         NULL,                                                    <span class="comment">/* join_chat */</span>
<a name="l00497"></a>00497         NULL,                                                    <span class="comment">/* reject_chat */</span>
<a name="l00498"></a>00498         NULL,                                                    <span class="comment">/* get_chat_name */</span>
<a name="l00499"></a>00499         NULL,                                                    <span class="comment">/* chat_invite */</span>
<a name="l00500"></a>00500         NULL,                                                    <span class="comment">/* chat_leave */</span>
<a name="l00501"></a>00501         NULL,                                                    <span class="comment">/* chat_whisper */</span>
<a name="l00502"></a>00502         NULL,                                                    <span class="comment">/* chat_send */</span>
<a name="l00503"></a>00503         NULL,                                                    <span class="comment">/* keepalive */</span>
<a name="l00504"></a>00504         NULL,                                                    <span class="comment">/* register_user */</span>
<a name="l00505"></a>00505         NULL,                                                    <span class="comment">/* get_cb_info */</span>
<a name="l00506"></a>00506         NULL,                                                    <span class="comment">/* get_cb_away */</span>
<a name="l00507"></a>00507         NULL,                                                    <span class="comment">/* alias_buddy */</span>
<a name="l00508"></a>00508         bonjour_group_buddy,                                     <span class="comment">/* group_buddy */</span>
<a name="l00509"></a>00509         bonjour_rename_group,                                    <span class="comment">/* rename_group */</span>
<a name="l00510"></a>00510         NULL,                                                    <span class="comment">/* buddy_free */</span>
<a name="l00511"></a>00511         bonjour_convo_closed,                                    <span class="comment">/* convo_closed */</span>
<a name="l00512"></a>00512         NULL,                                                    <span class="comment">/* normalize */</span>
<a name="l00513"></a>00513         bonjour_set_buddy_icon,                                  <span class="comment">/* set_buddy_icon */</span>
<a name="l00514"></a>00514         NULL,                                                    <span class="comment">/* remove_group */</span>
<a name="l00515"></a>00515         NULL,                                                    <span class="comment">/* get_cb_real_name */</span>
<a name="l00516"></a>00516         NULL,                                                    <span class="comment">/* set_chat_topic */</span>
<a name="l00517"></a>00517         NULL,                                                    <span class="comment">/* find_blist_chat */</span>
<a name="l00518"></a>00518         NULL,                                                    <span class="comment">/* roomlist_get_list */</span>
<a name="l00519"></a>00519         NULL,                                                    <span class="comment">/* roomlist_cancel */</span>
<a name="l00520"></a>00520         NULL,                                                    <span class="comment">/* roomlist_expand_category */</span>
<a name="l00521"></a>00521         bonjour_can_receive_file,                                <span class="comment">/* can_receive_file */</span>
<a name="l00522"></a>00522         bonjour_send_file,                                       <span class="comment">/* send_file */</span>
<a name="l00523"></a>00523         bonjour_new_xfer,                                        <span class="comment">/* new_xfer */</span>
<a name="l00524"></a>00524         NULL,                                                    <span class="comment">/* offline_message */</span>
<a name="l00525"></a>00525         NULL,                                                    <span class="comment">/* whiteboard_prpl_ops */</span>
<a name="l00526"></a>00526         NULL,                                                    <span class="comment">/* send_raw */</span>
<a name="l00527"></a>00527         NULL,                                                    <span class="comment">/* roomlist_room_serialize */</span>
<a name="l00528"></a>00528         NULL,                                                    <span class="comment">/* unregister_user */</span>
<a name="l00529"></a>00529         NULL,                                                    <span class="comment">/* send_attention */</span>
<a name="l00530"></a>00530         NULL,                                                    <span class="comment">/* get_attention_types */</span>
<a name="l00531"></a>00531         <span class="keyword">sizeof</span>(<a class="code" href="struct___purple_plugin_protocol_info.html">PurplePluginProtocolInfo</a>),                        <span class="comment">/* struct_size */</span>
<a name="l00532"></a>00532         NULL,                                                    <span class="comment">/* get_account_text_table */</span>
<a name="l00533"></a>00533         NULL,                                                    <span class="comment">/* initiate_media */</span>
<a name="l00534"></a>00534         NULL,                                                    <span class="comment">/* get_media_caps */</span>
<a name="l00535"></a>00535         NULL,                                                    <span class="comment">/* get_moods */</span>
<a name="l00536"></a>00536         NULL,                                                    <span class="comment">/* set_public_alias */</span>
<a name="l00537"></a>00537         NULL,                                                    <span class="comment">/* get_public_alias */</span>
<a name="l00538"></a>00538         NULL,                                                    <span class="comment">/* add_buddy_with_invite */</span>
<a name="l00539"></a>00539         NULL                                                     <span class="comment">/* add_buddies_with_invite */</span>
<a name="l00540"></a>00540 };
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <span class="keyword">static</span> <a class="code" href="struct___purple_plugin_info.html">PurplePluginInfo</a> info =
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544         PURPLE_PLUGIN_MAGIC,
<a name="l00545"></a>00545         <a class="code" href="version_8h.html#a046c2ee58f2b6ed94f29c524c2241f4d">PURPLE_MAJOR_VERSION</a>,
<a name="l00546"></a>00546         <a class="code" href="version_8h.html#aa67c27a6835b76d1b01df29cb3dc9f07">PURPLE_MINOR_VERSION</a>,
<a name="l00547"></a>00547         <a class="code" href="plugin_8h.html#a0e1cfd7954f1157f5ed3ccb42e6f6d58a90cb9161ce675db7fdc7151ec09520cf">PURPLE_PLUGIN_PROTOCOL</a>,                           
<a name="l00548"></a>00548         NULL,                                             
<a name="l00549"></a>00549         0,                                                
<a name="l00550"></a>00550         NULL,                                             
<a name="l00551"></a>00551         PURPLE_PRIORITY_DEFAULT,                          
<a name="l00553"></a>00553         <span class="stringliteral">&quot;prpl-bonjour&quot;</span>,                                   
<a name="l00554"></a>00554         <span class="stringliteral">&quot;Bonjour&quot;</span>,                                        
<a name="l00555"></a>00555         DISPLAY_VERSION,                                  
<a name="l00557"></a>00557         N_(<span class="stringliteral">&quot;Bonjour Protocol Plugin&quot;</span>),
<a name="l00559"></a>00559         N_(<span class="stringliteral">&quot;Bonjour Protocol Plugin&quot;</span>),
<a name="l00560"></a>00560         NULL,                                             
<a name="l00561"></a>00561         PURPLE_WEBSITE,                                   
<a name="l00563"></a>00563         NULL,                                             
<a name="l00564"></a>00564         plugin_unload,                                    
<a name="l00565"></a>00565         NULL,                                             
<a name="l00567"></a>00567         NULL,                                             
<a name="l00568"></a>00568         &amp;prpl_info,                                       
<a name="l00569"></a>00569         NULL,                                             
<a name="l00570"></a>00570         NULL,
<a name="l00571"></a>00571 
<a name="l00572"></a>00572         <span class="comment">/* padding */</span>
<a name="l00573"></a>00573         NULL,
<a name="l00574"></a>00574         NULL,
<a name="l00575"></a>00575         NULL,
<a name="l00576"></a>00576         NULL
<a name="l00577"></a>00577 };
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00580"></a>00580 <span class="preprocessor"></span><span class="keyword">static</span> gboolean
<a name="l00581"></a>00581 _set_default_name_cb(gpointer data) {
<a name="l00582"></a>00582         gchar *fullname = data;
<a name="l00583"></a>00583         <span class="keyword">const</span> <span class="keywordtype">char</span> *splitpoint;
<a name="l00584"></a>00584         GList *tmp = prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a>;
<a name="l00585"></a>00585         <a class="code" href="struct_purple_account_option.html">PurpleAccountOption</a> *option;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         <span class="keywordflow">if</span> (!fullname) {
<a name="l00588"></a>00588                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;bonjour&quot;</span>, <span class="stringliteral">&quot;Unable to look up First and Last name or Username from system; using defaults.\n&quot;</span>);
<a name="l00589"></a>00589                 <span class="keywordflow">return</span> FALSE;
<a name="l00590"></a>00590         }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592         g_free(default_firstname);
<a name="l00593"></a>00593         g_free(default_lastname);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         <span class="comment">/* Split the real name into a first and last name */</span>
<a name="l00596"></a>00596         splitpoint = strchr(fullname, <span class="charliteral">&#39; &#39;</span>);
<a name="l00597"></a>00597         <span class="keywordflow">if</span> (splitpoint != NULL) {
<a name="l00598"></a>00598                 default_firstname = g_strndup(fullname, splitpoint - fullname);
<a name="l00599"></a>00599                 default_lastname = g_strdup(&amp;splitpoint[1]);
<a name="l00600"></a>00600         } <span class="keywordflow">else</span> {
<a name="l00601"></a>00601                 default_firstname = g_strdup(fullname);
<a name="l00602"></a>00602                 default_lastname = g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00603"></a>00603         }
<a name="l00604"></a>00604         g_free(fullname);
<a name="l00605"></a>00605 
<a name="l00606"></a>00606 
<a name="l00607"></a>00607         <span class="keywordflow">for</span>(; tmp != NULL; tmp = tmp-&gt;next) {
<a name="l00608"></a>00608                 option = tmp-&gt;data;
<a name="l00609"></a>00609                 <span class="keywordflow">if</span> (strcmp(<span class="stringliteral">&quot;first&quot;</span>, <a class="code" href="accountopt_8c.html#a858c814b31acc3cda00249d7c4694889">purple_account_option_get_setting</a>(option)) == 0)
<a name="l00610"></a>00610                         <a class="code" href="accountopt_8c.html#a0688fcaa2d2b2614f65fd3b60fbc035d">purple_account_option_set_default_string</a>(option, default_firstname);
<a name="l00611"></a>00611                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(<span class="stringliteral">&quot;last&quot;</span>, <a class="code" href="accountopt_8c.html#a858c814b31acc3cda00249d7c4694889">purple_account_option_get_setting</a>(option)) == 0)
<a name="l00612"></a>00612                         <a class="code" href="accountopt_8c.html#a0688fcaa2d2b2614f65fd3b60fbc035d">purple_account_option_set_default_string</a>(option, default_lastname);
<a name="l00613"></a>00613         }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615         <span class="keywordflow">return</span> FALSE;
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="keyword">static</span> gpointer
<a name="l00619"></a>00619 _win32_name_lookup_thread(gpointer data) {
<a name="l00620"></a>00620         gchar *fullname = NULL;
<a name="l00621"></a>00621         <span class="keywordtype">wchar_t</span> username[UNLEN + 1];
<a name="l00622"></a>00622         DWORD dwLenUsername = UNLEN + 1;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         GetUserNameW((LPWSTR) &amp;username, &amp;dwLenUsername);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626         <span class="keywordflow">if</span> (username != NULL &amp;&amp; *username != <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00627"></a>00627                 LPBYTE servername = NULL;
<a name="l00628"></a>00628                 LPBYTE info = NULL;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630                 NetGetDCName(NULL, NULL, &amp;servername);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632                 <span class="comment">/* purple_debug_info(&quot;bonjour&quot;, &quot;Looking up the full name from the %s.\n&quot;, (servername ? &quot;domain controller&quot; : &quot;local machine&quot;)); */</span>
<a name="l00633"></a>00633 
<a name="l00634"></a>00634                 <span class="keywordflow">if</span> (NetUserGetInfo((LPCWSTR) servername, username, 10, &amp;info) == NERR_Success
<a name="l00635"></a>00635                                 &amp;&amp; info != NULL &amp;&amp; ((LPUSER_INFO_10) info)-&gt;usri10_full_name != NULL
<a name="l00636"></a>00636                                 &amp;&amp; *(((LPUSER_INFO_10) info)-&gt;usri10_full_name) != <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00637"></a>00637                         fullname = g_utf16_to_utf8(
<a name="l00638"></a>00638                                 ((LPUSER_INFO_10) info)-&gt;usri10_full_name,
<a name="l00639"></a>00639                                 -1, NULL, NULL, NULL);
<a name="l00640"></a>00640                 }
<a name="l00641"></a>00641                 <span class="comment">/* Fall back to the local machine if we didn&#39;t get the full name from the domain controller */</span>
<a name="l00642"></a>00642                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (servername != NULL) {
<a name="l00643"></a>00643                         <span class="comment">/* purple_debug_info(&quot;bonjour&quot;, &quot;Looking up the full name from the local machine&quot;); */</span>
<a name="l00644"></a>00644 
<a name="l00645"></a>00645                         <span class="keywordflow">if</span> (info != NULL) NetApiBufferFree(info);
<a name="l00646"></a>00646                         info = NULL;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648                         <span class="keywordflow">if</span> (NetUserGetInfo(NULL, username, 10, &amp;info) == NERR_Success
<a name="l00649"></a>00649                                         &amp;&amp; info != NULL &amp;&amp; ((LPUSER_INFO_10) info)-&gt;usri10_full_name != NULL
<a name="l00650"></a>00650                                         &amp;&amp; *(((LPUSER_INFO_10) info)-&gt;usri10_full_name) != <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00651"></a>00651                                 fullname = g_utf16_to_utf8(
<a name="l00652"></a>00652                                         ((LPUSER_INFO_10) info)-&gt;usri10_full_name,
<a name="l00653"></a>00653                                         -1, NULL, NULL, NULL);
<a name="l00654"></a>00654                         }
<a name="l00655"></a>00655                 }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657                 <span class="keywordflow">if</span> (info != NULL) NetApiBufferFree(info);
<a name="l00658"></a>00658                 <span class="keywordflow">if</span> (servername != NULL) NetApiBufferFree(servername);
<a name="l00659"></a>00659 
<a name="l00660"></a>00660                 <span class="keywordflow">if</span> (!fullname)
<a name="l00661"></a>00661                         fullname = g_utf16_to_utf8(username, -1, NULL, NULL, NULL);
<a name="l00662"></a>00662         }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         <a class="code" href="eventloop_8c.html#aadefb8b6d8b677ba989e47cbf8a05806">purple_timeout_add</a>(0, _set_default_name_cb, fullname);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         <span class="keywordflow">return</span> NULL;
<a name="l00667"></a>00667 }
<a name="l00668"></a>00668 <span class="preprocessor">#endif</span>
<a name="l00669"></a>00669 <span class="preprocessor"></span>
<a name="l00670"></a>00670 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00671"></a>00671 initialize_default_account_values(<span class="keywordtype">void</span>)
<a name="l00672"></a>00672 {
<a name="l00673"></a>00673 <span class="preprocessor">#ifndef _WIN32</span>
<a name="l00674"></a>00674 <span class="preprocessor"></span>        <span class="keyword">struct </span>passwd *info;
<a name="l00675"></a>00675 <span class="preprocessor">#endif</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span>        <span class="keyword">const</span> <span class="keywordtype">char</span> *fullname = NULL, *splitpoint, *tmp;
<a name="l00677"></a>00677         gchar *conv = NULL;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 <span class="preprocessor">#ifndef _WIN32</span>
<a name="l00680"></a>00680 <span class="preprocessor"></span>        <span class="comment">/* Try to figure out the user&#39;s real name */</span>
<a name="l00681"></a>00681         info = getpwuid(getuid());
<a name="l00682"></a>00682         <span class="keywordflow">if</span> ((info != NULL) &amp;&amp; (info-&gt;pw_gecos != NULL) &amp;&amp; (info-&gt;pw_gecos[0] != <span class="charliteral">&#39;\0&#39;</span>))
<a name="l00683"></a>00683                 fullname = info-&gt;pw_gecos;
<a name="l00684"></a>00684         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((info != NULL) &amp;&amp; (info-&gt;pw_name != NULL) &amp;&amp; (info-&gt;pw_name[0] != <span class="charliteral">&#39;\0&#39;</span>))
<a name="l00685"></a>00685                 fullname = info-&gt;pw_name;
<a name="l00686"></a>00686         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((fullname = getlogin()) != NULL) &amp;&amp; (fullname[0] == <span class="charliteral">&#39;\0&#39;</span>))
<a name="l00687"></a>00687                 fullname = NULL;
<a name="l00688"></a>00688 <span class="preprocessor">#else</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span>        <span class="comment">/* The Win32 username lookup functions are synchronous so we do it in a thread */</span>
<a name="l00690"></a>00690         g_thread_create(_win32_name_lookup_thread, NULL, FALSE, NULL);
<a name="l00691"></a>00691 <span class="preprocessor">#endif</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span>
<a name="l00693"></a>00693         <span class="comment">/* Make sure fullname is valid UTF-8.  If not, try to convert it. */</span>
<a name="l00694"></a>00694         <span class="keywordflow">if</span> (fullname != NULL &amp;&amp; !g_utf8_validate(fullname, -1, NULL)) {
<a name="l00695"></a>00695                 fullname = conv = g_locale_to_utf8(fullname, -1, NULL, NULL, NULL);
<a name="l00696"></a>00696                 <span class="keywordflow">if</span> (conv == NULL || *conv == <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00697"></a>00697                         fullname = NULL;
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (fullname == NULL)
<a name="l00701"></a>00701                 fullname = _(<span class="stringliteral">&quot;Purple Person&quot;</span>);
<a name="l00702"></a>00702 
<a name="l00703"></a>00703         <span class="comment">/* Split the real name into a first and last name */</span>
<a name="l00704"></a>00704         splitpoint = strchr(fullname, <span class="charliteral">&#39; &#39;</span>);
<a name="l00705"></a>00705         <span class="keywordflow">if</span> (splitpoint != NULL) {
<a name="l00706"></a>00706                 default_firstname = g_strndup(fullname, splitpoint - fullname);
<a name="l00707"></a>00707                 tmp = &amp;splitpoint[1];
<a name="l00708"></a>00708 
<a name="l00709"></a>00709                 <span class="comment">/* The last name may be followed by a comma and additional data.</span>
<a name="l00710"></a>00710 <span class="comment">                 * Only use the last name itself.</span>
<a name="l00711"></a>00711 <span class="comment">                 */</span>
<a name="l00712"></a>00712                 splitpoint = strchr(tmp, <span class="charliteral">&#39;,&#39;</span>);
<a name="l00713"></a>00713                 <span class="keywordflow">if</span> (splitpoint != NULL)
<a name="l00714"></a>00714                         default_lastname = g_strndup(tmp, splitpoint - tmp);
<a name="l00715"></a>00715                 <span class="keywordflow">else</span>
<a name="l00716"></a>00716                         default_lastname = g_strdup(tmp);
<a name="l00717"></a>00717         } <span class="keywordflow">else</span> {
<a name="l00718"></a>00718                 default_firstname = g_strdup(fullname);
<a name="l00719"></a>00719                 default_lastname = g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         g_free(conv);
<a name="l00723"></a>00723 }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00726"></a>00726 init_plugin(<a class="code" href="struct___purple_plugin.html">PurplePlugin</a> *plugin)
<a name="l00727"></a>00727 {
<a name="l00728"></a>00728         <a class="code" href="struct_purple_account_option.html">PurpleAccountOption</a> *option;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         initialize_default_account_values();
<a name="l00731"></a>00731 
<a name="l00732"></a>00732         <span class="comment">/* Creating the options for the protocol */</span>
<a name="l00733"></a>00733         option = <a class="code" href="accountopt_8c.html#ad94515631fe798e67b9764c8265d9a81">purple_account_option_int_new</a>(_(<span class="stringliteral">&quot;Local Port&quot;</span>), <span class="stringliteral">&quot;port&quot;</span>, BONJOUR_DEFAULT_PORT);
<a name="l00734"></a>00734         prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a> = g_list_append(prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a>, option);
<a name="l00735"></a>00735 
<a name="l00736"></a>00736         option = <a class="code" href="accountopt_8c.html#a9a5afbb458539783d9e8c9907f7f6a5d">purple_account_option_string_new</a>(_(<span class="stringliteral">&quot;First name&quot;</span>), <span class="stringliteral">&quot;first&quot;</span>, default_firstname);
<a name="l00737"></a>00737         prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a> = g_list_append(prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a>, option);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         option = <a class="code" href="accountopt_8c.html#a9a5afbb458539783d9e8c9907f7f6a5d">purple_account_option_string_new</a>(_(<span class="stringliteral">&quot;Last name&quot;</span>), <span class="stringliteral">&quot;last&quot;</span>, default_lastname);
<a name="l00740"></a>00740         prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a> = g_list_append(prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a>, option);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742         option = <a class="code" href="accountopt_8c.html#a9a5afbb458539783d9e8c9907f7f6a5d">purple_account_option_string_new</a>(_(<span class="stringliteral">&quot;Email&quot;</span>), <span class="stringliteral">&quot;email&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00743"></a>00743         prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a> = g_list_append(prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a>, option);
<a name="l00744"></a>00744 
<a name="l00745"></a>00745         option = <a class="code" href="accountopt_8c.html#a9a5afbb458539783d9e8c9907f7f6a5d">purple_account_option_string_new</a>(_(<span class="stringliteral">&quot;AIM Account&quot;</span>), <span class="stringliteral">&quot;AIM&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00746"></a>00746         prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a> = g_list_append(prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a>, option);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         option = <a class="code" href="accountopt_8c.html#a9a5afbb458539783d9e8c9907f7f6a5d">purple_account_option_string_new</a>(_(<span class="stringliteral">&quot;XMPP Account&quot;</span>), <span class="stringliteral">&quot;jid&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00749"></a>00749         prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a> = g_list_append(prpl_info.<a class="code" href="struct___purple_plugin_protocol_info.html#a7374e9c68494a9831f1d544e22471ad2">protocol_options</a>, option);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751         my_protocol = plugin;
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 PURPLE_INIT_PLUGIN(bonjour, init_plugin, info);
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>bonjour.c</b>      </li>
      <li class="footer">Generated on Sun Mar 24 2013 16:05:11 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
