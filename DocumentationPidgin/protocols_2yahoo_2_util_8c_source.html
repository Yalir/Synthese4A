<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>protocols/yahoo/util.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('protocols_2yahoo_2_util_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">protocols/yahoo/util.c</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * purple</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Some code copyright 2003 Tim Ringenbach &lt;omarvo@hotmail.com&gt;</span>
<a name="l00005"></a>00005 <span class="comment"> * (marv on irc.freenode.net)</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00008"></a>00008 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00009"></a>00009 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00010"></a>00010 <span class="comment"> * (at your option) any later version.</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00015"></a>00015 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00019"></a>00019 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02111-1301  USA</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_CONFIG_H */</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html">debug.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;internal.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="prpl_8h.html">prpl.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="libymsg_8h.html">libymsg.h</a>&quot;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 gboolean
<a name="l00036"></a>00036 yahoo_account_use_http_proxy(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *pc)
<a name="l00037"></a>00037 {
<a name="l00038"></a>00038         <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account = purple_connection_get_account(pc);
<a name="l00039"></a>00039         <a class="code" href="struct_purple_proxy_info.html">PurpleProxyInfo</a> *ppi = NULL;
<a name="l00040"></a>00040         <a class="code" href="proxy_8h.html#a309c31c148d41c540645b06f28508ac0">PurpleProxyType</a> type = <a class="code" href="proxy_8h.html#a309c31c148d41c540645b06f28508ac0abe9f97ae94b2fafe7edf81071de63149">PURPLE_PROXY_NONE</a>;
<a name="l00041"></a>00041         gboolean proxy_ssl = purple_account_get_bool(account, <span class="stringliteral">&quot;proxy_ssl&quot;</span>, FALSE);
<a name="l00042"></a>00042 
<a name="l00043"></a>00043         <span class="keywordflow">if</span>(proxy_ssl)
<a name="l00044"></a>00044                 ppi = purple_proxy_get_setup(account);
<a name="l00045"></a>00045         <span class="keywordflow">else</span>
<a name="l00046"></a>00046                 ppi = purple_proxy_get_setup(NULL);
<a name="l00047"></a>00047 
<a name="l00048"></a>00048         type = purple_proxy_info_get_type(ppi);
<a name="l00049"></a>00049 
<a name="l00050"></a>00050         <span class="keywordflow">return</span> (type == <a class="code" href="proxy_8h.html#a309c31c148d41c540645b06f28508ac0ad760452c810a08540407856c0d43bd35">PURPLE_PROXY_HTTP</a> || type == <a class="code" href="proxy_8h.html#a309c31c148d41c540645b06f28508ac0a9f2dea8f08459221ed056ddd9fe90695">PURPLE_PROXY_USE_ENVVAR</a>);
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">/*</span>
<a name="l00054"></a>00054 <span class="comment"> * Returns cookies formatted as a null terminated string for the given connection.</span>
<a name="l00055"></a>00055 <span class="comment"> * Must g_free return value.</span>
<a name="l00056"></a>00056 <span class="comment"> *</span>
<a name="l00057"></a>00057 <span class="comment"> * TODO:will work, but must test for strict correctness</span>
<a name="l00058"></a>00058 <span class="comment"> */</span>
<a name="l00059"></a>00059 gchar* yahoo_get_cookies(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc)
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061         gchar *ans = NULL;
<a name="l00062"></a>00062         gchar *cur;
<a name="l00063"></a>00063         <span class="keywordtype">char</span> firstflag = 1;
<a name="l00064"></a>00064         gchar *t1,*t2,*t3;
<a name="l00065"></a>00065         GSList *tmp;
<a name="l00066"></a>00066         GSList *cookies;
<a name="l00067"></a>00067         cookies = ((<a class="code" href="struct_yahoo_data.html">YahooData</a>*)(gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>))-&gt;cookies;
<a name="l00068"></a>00068         tmp = cookies;
<a name="l00069"></a>00069         <span class="keywordflow">while</span>(tmp)
<a name="l00070"></a>00070         {
<a name="l00071"></a>00071                 cur = tmp-&gt;data;
<a name="l00072"></a>00072                 t1 = ans;
<a name="l00073"></a>00073                 t2 = g_strrstr(cur, <span class="stringliteral">&quot;;expires=&quot;</span>);
<a name="l00074"></a>00074                 <span class="keywordflow">if</span>(t2 == NULL)
<a name="l00075"></a>00075                         t2 = g_strrstr(cur, <span class="stringliteral">&quot;; expires=&quot;</span>);
<a name="l00076"></a>00076                 <span class="keywordflow">if</span>(t2 == NULL)
<a name="l00077"></a>00077                 {
<a name="l00078"></a>00078                         <span class="keywordflow">if</span>(firstflag)
<a name="l00079"></a>00079                                 ans = g_strdup_printf(<span class="stringliteral">&quot;%c=%s&quot;</span>, cur[0], cur+2);
<a name="l00080"></a>00080                         <span class="keywordflow">else</span>
<a name="l00081"></a>00081                                 ans = g_strdup_printf(<span class="stringliteral">&quot;%s; %c=%s&quot;</span>, t1, cur[0], cur+2);
<a name="l00082"></a>00082                 }
<a name="l00083"></a>00083                 <span class="keywordflow">else</span>
<a name="l00084"></a>00084                 {
<a name="l00085"></a>00085                         t3 = strstr(t2+1, <span class="stringliteral">&quot;;&quot;</span>);
<a name="l00086"></a>00086                         <span class="keywordflow">if</span>(t3 != NULL)
<a name="l00087"></a>00087                         {
<a name="l00088"></a>00088                                 t2[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090                                 <span class="keywordflow">if</span>(firstflag)
<a name="l00091"></a>00091                                         ans = g_strdup_printf(<span class="stringliteral">&quot;%c=%s%s&quot;</span>, cur[0], cur+2, t3);
<a name="l00092"></a>00092                                 <span class="keywordflow">else</span>
<a name="l00093"></a>00093                                         ans = g_strdup_printf(<span class="stringliteral">&quot;%s; %c=%s%s&quot;</span>, t1, cur[0], cur+2, t3);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095                                 t2[0] = <span class="charliteral">&#39;;&#39;</span>;
<a name="l00096"></a>00096                         }
<a name="l00097"></a>00097                         <span class="keywordflow">else</span>
<a name="l00098"></a>00098                         {
<a name="l00099"></a>00099                                 t2[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101                                 <span class="keywordflow">if</span>(firstflag)
<a name="l00102"></a>00102                                         ans = g_strdup_printf(<span class="stringliteral">&quot;%c=%s&quot;</span>, cur[0], cur+2);
<a name="l00103"></a>00103                                 <span class="keywordflow">else</span>
<a name="l00104"></a>00104                                         ans = g_strdup_printf(<span class="stringliteral">&quot;%s; %c=%s&quot;</span>, t1, cur[0], cur+2);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106                                 t2[0] = <span class="charliteral">&#39;;&#39;</span>;
<a name="l00107"></a>00107                         }
<a name="l00108"></a>00108                 }
<a name="l00109"></a>00109                 <span class="keywordflow">if</span>(firstflag)
<a name="l00110"></a>00110                         firstflag = 0;
<a name="l00111"></a>00111                 <span class="keywordflow">else</span>
<a name="l00112"></a>00112                         g_free(t1);
<a name="l00113"></a>00113                 tmp = g_slist_next(tmp);
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115         <span class="keywordflow">return</span> ans;
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00130"></a><a class="code" href="libymsg_8h.html#a5e6991175654e51ff3bf0bfb890d2b6a">00130</a> <span class="keywordtype">char</span> *<a class="code" href="libymsg_8h.html#a5e6991175654e51ff3bf0bfb890d2b6a">yahoo_string_encode</a>(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keyword">const</span> <span class="keywordtype">char</span> *str, gboolean *utf8)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132         <a class="code" href="struct_yahoo_data.html">YahooData</a> *yd = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00133"></a>00133         <span class="keywordtype">char</span> *ret;
<a name="l00134"></a>00134         <span class="keyword">const</span> <span class="keywordtype">char</span> *to_codeset;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136         <span class="keywordflow">if</span> (yd-&gt;jp)
<a name="l00137"></a>00137                 <span class="keywordflow">return</span> g_strdup(str);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         <span class="keywordflow">if</span> (utf8 &amp;&amp; *utf8) <span class="comment">/* FIXME: maybe don&#39;t use utf8 if it&#39;ll fit in latin1 */</span>
<a name="l00140"></a>00140                 <span class="keywordflow">return</span> g_strdup(str);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         to_codeset = purple_account_get_string(purple_connection_get_account(gc), <span class="stringliteral">&quot;local_charset&quot;</span>,  <span class="stringliteral">&quot;ISO-8859-1&quot;</span>);
<a name="l00143"></a>00143         ret = g_convert_with_fallback(str, -1, to_codeset, <span class="stringliteral">&quot;UTF-8&quot;</span>, <span class="stringliteral">&quot;?&quot;</span>, NULL, NULL, NULL);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145         <span class="keywordflow">if</span> (ret)
<a name="l00146"></a>00146                 <span class="keywordflow">return</span> ret;
<a name="l00147"></a>00147         <span class="keywordflow">else</span>
<a name="l00148"></a>00148                 <span class="keywordflow">return</span> g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00159"></a><a class="code" href="libymsg_8h.html#a7b2cd132abebcd9b5a43917c52a25b9c">00159</a> <span class="keywordtype">char</span> *<a class="code" href="libymsg_8h.html#a7b2cd132abebcd9b5a43917c52a25b9c">yahoo_string_decode</a>(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keyword">const</span> <span class="keywordtype">char</span> *str, gboolean utf8)
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161         <a class="code" href="struct_yahoo_data.html">YahooData</a> *yd = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00162"></a>00162         <span class="keywordtype">char</span> *ret;
<a name="l00163"></a>00163         <span class="keyword">const</span> <span class="keywordtype">char</span> *from_codeset;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="keywordflow">if</span> (utf8) {
<a name="l00166"></a>00166                 <span class="keywordflow">if</span> (g_utf8_validate(str, -1, NULL))
<a name="l00167"></a>00167                         <span class="keywordflow">return</span> g_strdup(str);
<a name="l00168"></a>00168         }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="keywordflow">if</span> (yd-&gt;jp)
<a name="l00171"></a>00171                 from_codeset = <span class="stringliteral">&quot;SHIFT_JIS&quot;</span>;
<a name="l00172"></a>00172         <span class="keywordflow">else</span>
<a name="l00173"></a>00173                 from_codeset = purple_account_get_string(purple_connection_get_account(gc), <span class="stringliteral">&quot;local_charset&quot;</span>,  <span class="stringliteral">&quot;ISO-8859-1&quot;</span>);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175         ret = g_convert_with_fallback(str, -1, <span class="stringliteral">&quot;UTF-8&quot;</span>, from_codeset, NULL, NULL, NULL, NULL);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (ret)
<a name="l00178"></a>00178                 <span class="keywordflow">return</span> ret;
<a name="l00179"></a>00179         <span class="keywordflow">else</span>
<a name="l00180"></a>00180                 <span class="keywordflow">return</span> g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="keywordtype">char</span> *yahoo_convert_to_numeric(<span class="keyword">const</span> <span class="keywordtype">char</span> *str)
<a name="l00184"></a>00184 {
<a name="l00185"></a>00185         GString *gstr = NULL;
<a name="l00186"></a>00186         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188         gstr = g_string_sized_new(strlen(str) * 6 + 1);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190         <span class="keywordflow">for</span> (p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)str; *p; p++) {
<a name="l00191"></a>00191                 g_string_append_printf(gstr, <span class="stringliteral">&quot;&amp;#%u;&quot;</span>, *p);
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194         <span class="keywordflow">return</span> g_string_free(gstr, FALSE);
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="comment">/*</span>
<a name="l00198"></a>00198 <span class="comment"> * The values in this hash table should probably be lowercase, since that&#39;s</span>
<a name="l00199"></a>00199 <span class="comment"> * what xhtml expects.  Also because yahoo_codes_to_html() does</span>
<a name="l00200"></a>00200 <span class="comment"> * case-sensitive comparisons.</span>
<a name="l00201"></a>00201 <span class="comment"> *</span>
<a name="l00202"></a>00202 <span class="comment"> * I found these on some website but i don&#39;t know that they actually</span>
<a name="l00203"></a>00203 <span class="comment"> * work (or are supposed to work). I didn&#39;t implement them yet.</span>
<a name="l00204"></a>00204 <span class="comment"> *</span>
<a name="l00205"></a>00205 <span class="comment"> * [0;30m ---black</span>
<a name="l00206"></a>00206 <span class="comment"> * [1;37m ---white</span>
<a name="l00207"></a>00207 <span class="comment"> * [0;37m ---tan</span>
<a name="l00208"></a>00208 <span class="comment"> * [0;38m ---light black</span>
<a name="l00209"></a>00209 <span class="comment"> * [1;39m ---dark blue</span>
<a name="l00210"></a>00210 <span class="comment"> * [0;32m ---green</span>
<a name="l00211"></a>00211 <span class="comment"> * [0;33m ---yellow</span>
<a name="l00212"></a>00212 <span class="comment"> * [0;35m ---pink</span>
<a name="l00213"></a>00213 <span class="comment"> * [1;35m ---purple</span>
<a name="l00214"></a>00214 <span class="comment"> * [1;30m ---light blue</span>
<a name="l00215"></a>00215 <span class="comment"> * [0;31m ---red</span>
<a name="l00216"></a>00216 <span class="comment"> * [0;34m ---blue</span>
<a name="l00217"></a>00217 <span class="comment"> * [0;36m ---aqua</span>
<a name="l00218"></a>00218 <span class="comment"> * (shift+comma)lyellow(shift+period) ---light yellow</span>
<a name="l00219"></a>00219 <span class="comment"> * (shift+comma)lgreen(shift+period) ---light green</span>
<a name="l00220"></a>00220 <span class="comment"> * [2;30m &lt;--white out</span>
<a name="l00221"></a>00221 <span class="comment"> */</span>
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 <span class="keyword">static</span> GHashTable *esc_codes_ht = NULL;
<a name="l00224"></a>00224 <span class="keyword">static</span> GHashTable *tags_ht = NULL;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <span class="keywordtype">void</span> yahoo_init_colorht()
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (esc_codes_ht != NULL)
<a name="l00229"></a>00229                 <span class="comment">/* Hash table has already been initialized */</span>
<a name="l00230"></a>00230                 <span class="keywordflow">return</span>;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="comment">/* Key is the escape code string.  Value is the HTML that should be</span>
<a name="l00233"></a>00233 <span class="comment">         * inserted in place of the escape code. */</span>
<a name="l00234"></a>00234         esc_codes_ht = g_hash_table_new(g_str_hash, g_str_equal);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <span class="comment">/* Key is the name of the HTML tag, for example &quot;font&quot; or &quot;/font&quot;</span>
<a name="l00237"></a>00237 <span class="comment">         * value is the HTML that should be inserted in place of the old tag */</span>
<a name="l00238"></a>00238         tags_ht = g_hash_table_new(g_str_hash, g_str_equal);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         <span class="comment">/* the numbers in comments are what gyach uses, but i think they&#39;re incorrect */</span>
<a name="l00241"></a>00241 <span class="preprocessor">#ifdef USE_CSS_FORMATTING</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span>        g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;30&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #000000\&quot;&gt;&quot;</span>); <span class="comment">/* black */</span>
<a name="l00243"></a>00243         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;31&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #0000FF\&quot;&gt;&quot;</span>); <span class="comment">/* blue */</span>
<a name="l00244"></a>00244         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;32&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #008080\&quot;&gt;&quot;</span>); <span class="comment">/* cyan */</span>      <span class="comment">/* 00b2b2 */</span>
<a name="l00245"></a>00245         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;33&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #808080\&quot;&gt;&quot;</span>); <span class="comment">/* gray */</span>      <span class="comment">/* 808080 */</span>
<a name="l00246"></a>00246         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;34&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #008000\&quot;&gt;&quot;</span>); <span class="comment">/* green */</span>     <span class="comment">/* 00c200 */</span>
<a name="l00247"></a>00247         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;35&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #FF0080\&quot;&gt;&quot;</span>); <span class="comment">/* pink */</span>      <span class="comment">/* ffafaf */</span>
<a name="l00248"></a>00248         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;36&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #800080\&quot;&gt;&quot;</span>); <span class="comment">/* purple */</span>    <span class="comment">/* b200b2 */</span>
<a name="l00249"></a>00249         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;37&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #FF8000\&quot;&gt;&quot;</span>); <span class="comment">/* orange */</span>    <span class="comment">/* ffff00 */</span>
<a name="l00250"></a>00250         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;38&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #FF0000\&quot;&gt;&quot;</span>); <span class="comment">/* red */</span>
<a name="l00251"></a>00251         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;39&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #808000\&quot;&gt;&quot;</span>); <span class="comment">/* olive */</span>     <span class="comment">/* 546b50 */</span>
<a name="l00252"></a>00252 <span class="preprocessor">#else</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>        g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;30&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#000000\&quot;&gt;&quot;</span>); <span class="comment">/* black */</span>
<a name="l00254"></a>00254         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;31&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#0000FF\&quot;&gt;&quot;</span>); <span class="comment">/* blue */</span>
<a name="l00255"></a>00255         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;32&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#008080\&quot;&gt;&quot;</span>); <span class="comment">/* cyan */</span>      <span class="comment">/* 00b2b2 */</span>
<a name="l00256"></a>00256         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;33&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#808080\&quot;&gt;&quot;</span>); <span class="comment">/* gray */</span>      <span class="comment">/* 808080 */</span>
<a name="l00257"></a>00257         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;34&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#008000\&quot;&gt;&quot;</span>); <span class="comment">/* green */</span>     <span class="comment">/* 00c200 */</span>
<a name="l00258"></a>00258         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;35&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#FF0080\&quot;&gt;&quot;</span>); <span class="comment">/* pink */</span>      <span class="comment">/* ffafaf */</span>
<a name="l00259"></a>00259         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;36&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#800080\&quot;&gt;&quot;</span>); <span class="comment">/* purple */</span>    <span class="comment">/* b200b2 */</span>
<a name="l00260"></a>00260         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;37&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#FF8000\&quot;&gt;&quot;</span>); <span class="comment">/* orange */</span>    <span class="comment">/* ffff00 */</span>
<a name="l00261"></a>00261         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;38&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#FF0000\&quot;&gt;&quot;</span>); <span class="comment">/* red */</span>
<a name="l00262"></a>00262         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;39&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#808000\&quot;&gt;&quot;</span>); <span class="comment">/* olive */</span>     <span class="comment">/* 546b50 */</span>
<a name="l00263"></a>00263 <span class="preprocessor">#endif </span><span class="comment">/* !USE_CSS_FORMATTING */</span>
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         g_hash_table_insert(esc_codes_ht,  <span class="stringliteral">&quot;1&quot;</span>,  <span class="stringliteral">&quot;&lt;b&gt;&quot;</span>);
<a name="l00266"></a>00266         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;x1&quot;</span>, <span class="stringliteral">&quot;&lt;/b&gt;&quot;</span>);
<a name="l00267"></a>00267         g_hash_table_insert(esc_codes_ht,  <span class="stringliteral">&quot;2&quot;</span>,  <span class="stringliteral">&quot;&lt;i&gt;&quot;</span>);
<a name="l00268"></a>00268         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;x2&quot;</span>, <span class="stringliteral">&quot;&lt;/i&gt;&quot;</span>);
<a name="l00269"></a>00269         g_hash_table_insert(esc_codes_ht,  <span class="stringliteral">&quot;4&quot;</span>,  <span class="stringliteral">&quot;&lt;u&gt;&quot;</span>);
<a name="l00270"></a>00270         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;x4&quot;</span>, <span class="stringliteral">&quot;&lt;/u&gt;&quot;</span>);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="comment">/* these just tell us the text they surround is supposed</span>
<a name="l00273"></a>00273 <span class="comment">         * to be a link. purple figures that out on its own so we</span>
<a name="l00274"></a>00274 <span class="comment">         * just ignore it.</span>
<a name="l00275"></a>00275 <span class="comment">         */</span>
<a name="l00276"></a>00276         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;l&quot;</span>, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">/* link start */</span>
<a name="l00277"></a>00277         g_hash_table_insert(esc_codes_ht, <span class="stringliteral">&quot;xl&quot;</span>, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">/* link end */</span>
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="preprocessor">#ifdef USE_CSS_FORMATTING</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span>        g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;black&quot;</span>,  <span class="stringliteral">&quot;&lt;span style=\&quot;color: #000000\&quot;&gt;&quot;</span>);
<a name="l00281"></a>00281         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;blue&quot;</span>,   <span class="stringliteral">&quot;&lt;span style=\&quot;color: #0000FF\&quot;&gt;&quot;</span>);
<a name="l00282"></a>00282         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;cyan&quot;</span>,   <span class="stringliteral">&quot;&lt;span style=\&quot;color: #008284\&quot;&gt;&quot;</span>);
<a name="l00283"></a>00283         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;gray&quot;</span>,   <span class="stringliteral">&quot;&lt;span style=\&quot;color: #848284\&quot;&gt;&quot;</span>);
<a name="l00284"></a>00284         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;green&quot;</span>,  <span class="stringliteral">&quot;&lt;span style=\&quot;color: #008200\&quot;&gt;&quot;</span>);
<a name="l00285"></a>00285         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;pink&quot;</span>,   <span class="stringliteral">&quot;&lt;span style=\&quot;color: #FF0084\&quot;&gt;&quot;</span>);
<a name="l00286"></a>00286         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;purple&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #840084\&quot;&gt;&quot;</span>);
<a name="l00287"></a>00287         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;orange&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #FF8000\&quot;&gt;&quot;</span>);
<a name="l00288"></a>00288         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;red&quot;</span>,    <span class="stringliteral">&quot;&lt;span style=\&quot;color: #FF0000\&quot;&gt;&quot;</span>);
<a name="l00289"></a>00289         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;yellow&quot;</span>, <span class="stringliteral">&quot;&lt;span style=\&quot;color: #848200\&quot;&gt;&quot;</span>);
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/black&quot;</span>,  <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00292"></a>00292         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/blue&quot;</span>,   <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00293"></a>00293         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/cyan&quot;</span>,   <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00294"></a>00294         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/gray&quot;</span>,   <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00295"></a>00295         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/green&quot;</span>,  <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00296"></a>00296         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/pink&quot;</span>,   <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00297"></a>00297         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/purple&quot;</span>, <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00298"></a>00298         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/orange&quot;</span>, <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00299"></a>00299         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/red&quot;</span>,    <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00300"></a>00300         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/yellow&quot;</span>, <span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l00301"></a>00301 <span class="preprocessor">#else</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>        g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;black&quot;</span>,  <span class="stringliteral">&quot;&lt;font color=\&quot;#000000\&quot;&gt;&quot;</span>);
<a name="l00303"></a>00303         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;blue&quot;</span>,   <span class="stringliteral">&quot;&lt;font color=\&quot;#0000FF\&quot;&gt;&quot;</span>);
<a name="l00304"></a>00304         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;cyan&quot;</span>,   <span class="stringliteral">&quot;&lt;font color=\&quot;#008284\&quot;&gt;&quot;</span>);
<a name="l00305"></a>00305         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;gray&quot;</span>,   <span class="stringliteral">&quot;&lt;font color=\&quot;#848284\&quot;&gt;&quot;</span>);
<a name="l00306"></a>00306         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;green&quot;</span>,  <span class="stringliteral">&quot;&lt;font color=\&quot;#008200\&quot;&gt;&quot;</span>);
<a name="l00307"></a>00307         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;pink&quot;</span>,   <span class="stringliteral">&quot;&lt;font color=\&quot;#FF0084\&quot;&gt;&quot;</span>);
<a name="l00308"></a>00308         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;purple&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#840084\&quot;&gt;&quot;</span>);
<a name="l00309"></a>00309         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;orange&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#FF8000\&quot;&gt;&quot;</span>);
<a name="l00310"></a>00310         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;red&quot;</span>,    <span class="stringliteral">&quot;&lt;font color=\&quot;#FF0000\&quot;&gt;&quot;</span>);
<a name="l00311"></a>00311         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;yellow&quot;</span>, <span class="stringliteral">&quot;&lt;font color=\&quot;#848200\&quot;&gt;&quot;</span>);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/black&quot;</span>,  <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00314"></a>00314         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/blue&quot;</span>,   <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00315"></a>00315         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/cyan&quot;</span>,   <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00316"></a>00316         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/gray&quot;</span>,   <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00317"></a>00317         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/green&quot;</span>,  <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00318"></a>00318         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/pink&quot;</span>,   <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00319"></a>00319         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/purple&quot;</span>, <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00320"></a>00320         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/orange&quot;</span>, <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00321"></a>00321         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/red&quot;</span>,    <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00322"></a>00322         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/yellow&quot;</span>, <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00323"></a>00323 <span class="preprocessor">#endif </span><span class="comment">/* !USE_CSS_FORMATTING */</span>
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         <span class="comment">/* We don&#39;t support these tags, so discard them */</span>
<a name="l00326"></a>00326         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;alt&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00327"></a>00327         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;fade&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00328"></a>00328         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;snd&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00329"></a>00329         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/alt&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00330"></a>00330         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/fade&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="comment">/* Official clients don&#39;t seem to send b, i or u tags.  They use</span>
<a name="l00333"></a>00333 <span class="comment">         * the escape codes listed above.  Official clients definitely send</span>
<a name="l00334"></a>00334 <span class="comment">         * font tags, though.  I wonder if we can remove the opening and</span>
<a name="l00335"></a>00335 <span class="comment">         * closing b, i and u tags from here? */</span>
<a name="l00336"></a>00336         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;b&quot;</span>, <span class="stringliteral">&quot;&lt;b&gt;&quot;</span>);
<a name="l00337"></a>00337         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;i&quot;</span>, <span class="stringliteral">&quot;&lt;i&gt;&quot;</span>);
<a name="l00338"></a>00338         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;u&quot;</span>, <span class="stringliteral">&quot;&lt;u&gt;&quot;</span>);
<a name="l00339"></a>00339         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;font&quot;</span>, <span class="stringliteral">&quot;&lt;font&gt;&quot;</span>);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/b&quot;</span>, <span class="stringliteral">&quot;&lt;/b&gt;&quot;</span>);
<a name="l00342"></a>00342         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/i&quot;</span>, <span class="stringliteral">&quot;&lt;/i&gt;&quot;</span>);
<a name="l00343"></a>00343         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/u&quot;</span>, <span class="stringliteral">&quot;&lt;/u&gt;&quot;</span>);
<a name="l00344"></a>00344         g_hash_table_insert(tags_ht, <span class="stringliteral">&quot;/font&quot;</span>, <span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>);
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="keywordtype">void</span> yahoo_dest_colorht()
<a name="l00348"></a>00348 {
<a name="l00349"></a>00349         <span class="keywordflow">if</span> (esc_codes_ht == NULL)
<a name="l00350"></a>00350                 <span class="comment">/* Hash table has already been destroyed */</span>
<a name="l00351"></a>00351                 <span class="keywordflow">return</span>;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         g_hash_table_destroy(esc_codes_ht);
<a name="l00354"></a>00354         esc_codes_ht = NULL;
<a name="l00355"></a>00355         g_hash_table_destroy(tags_ht);
<a name="l00356"></a>00356         tags_ht = NULL;
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <span class="preprocessor">#ifndef USE_CSS_FORMATTING</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> point_to_html(<span class="keywordtype">int</span> x)
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362         <span class="keywordflow">if</span> (x &lt; 9)
<a name="l00363"></a>00363                 <span class="keywordflow">return</span> 1;
<a name="l00364"></a>00364         <span class="keywordflow">if</span> (x &lt; 11)
<a name="l00365"></a>00365                 <span class="keywordflow">return</span> 2;
<a name="l00366"></a>00366         <span class="keywordflow">if</span> (x &lt; 13)
<a name="l00367"></a>00367                 <span class="keywordflow">return</span> 3;
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (x &lt; 17)
<a name="l00369"></a>00369                 <span class="keywordflow">return</span> 4;
<a name="l00370"></a>00370         <span class="keywordflow">if</span> (x &lt; 25)
<a name="l00371"></a>00371                 <span class="keywordflow">return</span> 5;
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (x &lt; 35)
<a name="l00373"></a>00373                 <span class="keywordflow">return</span> 6;
<a name="l00374"></a>00374         <span class="keywordflow">return</span> 7;
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 <span class="preprocessor">#endif </span><span class="comment">/* !USE_CSS_FORMATTING */</span>
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="keyword">static</span> <span class="keywordtype">void</span> append_attrs_datalist_foreach_cb(GQuark key_id, gpointer data, gpointer user_data)
<a name="l00379"></a>00379 {
<a name="l00380"></a>00380         <span class="keyword">const</span> <span class="keywordtype">char</span> *key;
<a name="l00381"></a>00381         <span class="keyword">const</span> <span class="keywordtype">char</span> *value;
<a name="l00382"></a>00382         <a class="code" href="struct__xmlnode.html">xmlnode</a> *cur;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384         key = g_quark_to_string(key_id);
<a name="l00385"></a>00385         value = data;
<a name="l00386"></a>00386         cur = user_data;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         xmlnode_set_attrib(cur, key, value);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00396"></a>00396 <span class="keyword">static</span> <span class="keywordtype">void</span> yahoo_codes_to_html_add_tag(<a class="code" href="struct__xmlnode.html">xmlnode</a> **cur, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structtag.html">tag</a>, gboolean is_closing_tag, <span class="keyword">const</span> gchar *tag_name, gboolean is_font_tag)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398         <span class="keywordflow">if</span> (is_closing_tag) {
<a name="l00399"></a>00399                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *tmp;
<a name="l00400"></a>00400                 GSList *dangling_tags = NULL;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402                 <span class="comment">/* Move up the DOM until we find the opening tag */</span>
<a name="l00403"></a>00403                 <span class="keywordflow">for</span> (tmp = *cur; tmp != NULL; tmp = xmlnode_get_parent(tmp)) {
<a name="l00404"></a>00404                         <span class="comment">/* Add one to tag_name when doing this comparison because it starts with a / */</span>
<a name="l00405"></a>00405                         <span class="keywordflow">if</span> (g_str_equal(tmp-&gt;<a class="code" href="struct__xmlnode.html#ab357e9f2c7b58e690877bfbb8caa7277">name</a>, tag_name + 1))
<a name="l00406"></a>00406                                 <span class="comment">/* Found */</span>
<a name="l00407"></a>00407                                 <span class="keywordflow">break</span>;
<a name="l00408"></a>00408                         dangling_tags = g_slist_prepend(dangling_tags, tmp);
<a name="l00409"></a>00409                 }
<a name="l00410"></a>00410                 <span class="keywordflow">if</span> (tmp == NULL) {
<a name="l00411"></a>00411                         <span class="comment">/* This is a closing tag with no opening tag.  Useless. */</span>
<a name="l00412"></a>00412                         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;yahoo&quot;</span>, <span class="stringliteral">&quot;Ignoring unmatched tag %s&quot;</span>, tag);
<a name="l00413"></a>00413                         g_slist_free(dangling_tags);
<a name="l00414"></a>00414                         <span class="keywordflow">return</span>;
<a name="l00415"></a>00415                 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417                 <span class="comment">/* Move our current position up, now that we&#39;ve closed a tag */</span>
<a name="l00418"></a>00418                 *cur = xmlnode_get_parent(tmp);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420                 <span class="comment">/* Re-open any tags that were nested below the tag we just closed */</span>
<a name="l00421"></a>00421                 <span class="keywordflow">while</span> (dangling_tags != NULL) {
<a name="l00422"></a>00422                         tmp = dangling_tags-&gt;<a class="code" href="struct__xmlnode.html#ab8f526b3af05690f9d17977d57d28ac2">data</a>;
<a name="l00423"></a>00423                         dangling_tags = g_slist_delete_link(dangling_tags, dangling_tags);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425                         <span class="comment">/* Create a copy of this tag+attributes (but not child tags or</span>
<a name="l00426"></a>00426 <span class="comment">                         * data) at our new location */</span>
<a name="l00427"></a>00427                         *cur = xmlnode_new_child(*cur, tmp-&gt;<a class="code" href="struct__xmlnode.html#ab357e9f2c7b58e690877bfbb8caa7277">name</a>);
<a name="l00428"></a>00428                         <span class="keywordflow">for</span> (tmp = tmp-&gt;<a class="code" href="struct__xmlnode.html#a3235357f6dbc06d107e7f05ea2d2743a">child</a>; tmp != NULL; tmp = tmp-&gt;<a class="code" href="struct__xmlnode.html#a5c648a698f037ffdedc5d139e1150486">next</a>)
<a name="l00429"></a>00429                                 <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="struct__xmlnode.html#a8fbb1f77b2521e0c89aa938ae9571572">type</a> == <a class="code" href="xmlnode_8h.html#a8a157d675dacb83011bf613a088411f0a2079fa580d44773bcaea40723b68d475">XMLNODE_TYPE_ATTRIB</a>)
<a name="l00430"></a>00430                                         xmlnode_set_attrib_full(*cur, tmp-&gt;<a class="code" href="struct__xmlnode.html#ab357e9f2c7b58e690877bfbb8caa7277">name</a>,
<a name="l00431"></a>00431                                                         tmp-&gt;<a class="code" href="struct__xmlnode.html#aadfcf60230f7ad9e63877803dff18496">xmlns</a>, tmp-&gt;<a class="code" href="struct__xmlnode.html#aeeba9a9b9a86329f321fb039894aecb5">prefix</a>, tmp-&gt;<a class="code" href="struct__xmlnode.html#ab8f526b3af05690f9d17977d57d28ac2">data</a>);
<a name="l00432"></a>00432                 }
<a name="l00433"></a>00433         } <span class="keywordflow">else</span> {
<a name="l00434"></a>00434                 <span class="keyword">const</span> <span class="keywordtype">char</span> *start;
<a name="l00435"></a>00435                 <span class="keyword">const</span> <span class="keywordtype">char</span> *end;
<a name="l00436"></a>00436                 GData *attributes;
<a name="l00437"></a>00437                 <span class="keywordtype">char</span> *fontsize = NULL;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439                 purple_markup_find_tag(tag_name, tag, &amp;start, &amp;end, &amp;attributes);
<a name="l00440"></a>00440                 *cur = xmlnode_new_child(*cur, tag_name);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442                 <span class="keywordflow">if</span> (is_font_tag) {
<a name="l00443"></a>00443                         <span class="comment">/* Special case for the font size attribute */</span>
<a name="l00444"></a>00444                         fontsize = g_strdup(g_datalist_get_data(&amp;attributes, <span class="stringliteral">&quot;size&quot;</span>));
<a name="l00445"></a>00445                         <span class="keywordflow">if</span> (fontsize != NULL)
<a name="l00446"></a>00446                                 g_datalist_remove_data(&amp;attributes, <span class="stringliteral">&quot;size&quot;</span>);
<a name="l00447"></a>00447                 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449                 <span class="comment">/* Add all font tag attributes */</span>
<a name="l00450"></a>00450                 g_datalist_foreach(&amp;attributes, append_attrs_datalist_foreach_cb, *cur);
<a name="l00451"></a>00451                 g_datalist_clear(&amp;attributes);
<a name="l00452"></a>00452 
<a name="l00453"></a>00453                 <span class="keywordflow">if</span> (fontsize != NULL) {
<a name="l00454"></a>00454 <span class="preprocessor">#ifdef USE_CSS_FORMATTING</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span>                        <span class="comment">/*</span>
<a name="l00456"></a>00456 <span class="comment">                         * The Yahoo font size value is given in pt, even though the HTML</span>
<a name="l00457"></a>00457 <span class="comment">                         * standard for &lt;font size=&quot;x&quot;&gt; treats the size as a number on a</span>
<a name="l00458"></a>00458 <span class="comment">                         * scale between 1 and 7.  So we insert the font size as a CSS</span>
<a name="l00459"></a>00459 <span class="comment">                         * style on a span tag.</span>
<a name="l00460"></a>00460 <span class="comment">                         */</span>
<a name="l00461"></a>00461                         gchar *tmp = g_strdup_printf(<span class="stringliteral">&quot;font-size: %spt&quot;</span>, fontsize);
<a name="l00462"></a>00462                         *cur = xmlnode_new_child(*cur, <span class="stringliteral">&quot;span&quot;</span>);
<a name="l00463"></a>00463                         xmlnode_set_attrib(*cur, <span class="stringliteral">&quot;style&quot;</span>, tmp);
<a name="l00464"></a>00464                         g_free(tmp);
<a name="l00465"></a>00465 <span class="preprocessor">#else</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span>                        <span class="comment">/*</span>
<a name="l00467"></a>00467 <span class="comment">                         * The Yahoo font size value is given in pt, even though the HTML</span>
<a name="l00468"></a>00468 <span class="comment">                         * standard for &lt;font size=&quot;x&quot;&gt; treats the size as a number on a</span>
<a name="l00469"></a>00469 <span class="comment">                         * scale between 1 and 7.  So we convert it to an appropriate</span>
<a name="l00470"></a>00470 <span class="comment">                         * value.  This loses precision, which is why CSS formatting is</span>
<a name="l00471"></a>00471 <span class="comment">                         * preferred.  The &quot;absz&quot; attribute remains here for backward</span>
<a name="l00472"></a>00472 <span class="comment">                         * compatibility with UIs that might use it, but it is totally</span>
<a name="l00473"></a>00473 <span class="comment">                         * not standard at all.</span>
<a name="l00474"></a>00474 <span class="comment">                         */</span>
<a name="l00475"></a>00475                         <span class="keywordtype">int</span> size, htmlsize;
<a name="l00476"></a>00476                         gchar tmp[11];
<a name="l00477"></a>00477                         size = strtol(fontsize, NULL, 10);
<a name="l00478"></a>00478                         htmlsize = point_to_html(size);
<a name="l00479"></a>00479                         sprintf(tmp, <span class="stringliteral">&quot;%u&quot;</span>, htmlsize);
<a name="l00480"></a>00480                         xmlnode_set_attrib(*cur, <span class="stringliteral">&quot;size&quot;</span>, tmp);
<a name="l00481"></a>00481                         xmlnode_set_attrib(*cur, <span class="stringliteral">&quot;absz&quot;</span>, fontsize);
<a name="l00482"></a>00482 <span class="preprocessor">#endif </span><span class="comment">/* !USE_CSS_FORMATTING */</span>
<a name="l00483"></a>00483                         g_free(fontsize);
<a name="l00484"></a>00484                 }
<a name="l00485"></a>00485         }
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00495"></a>00495 <span class="keyword">static</span> gchar *yahoo_markup_get_tag_name(<span class="keyword">const</span> <span class="keywordtype">char</span> *tag, gboolean *is_closing_tag)
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497         <span class="keywordtype">size_t</span> len;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499         *is_closing_tag = (tag[1] == <span class="charliteral">&#39;/&#39;</span>);
<a name="l00500"></a>00500         <span class="keywordflow">if</span> (*is_closing_tag)
<a name="l00501"></a>00501                 len = strcspn(tag + 1, <span class="stringliteral">&quot;&gt; &quot;</span>);
<a name="l00502"></a>00502         <span class="keywordflow">else</span>
<a name="l00503"></a>00503                 len = strcspn(tag + 1, <span class="stringliteral">&quot;&gt; /&quot;</span>);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         <span class="keywordflow">return</span> g_utf8_strdown(tag + 1, len);
<a name="l00506"></a>00506 }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 <span class="comment">/*</span>
<a name="l00509"></a>00509 <span class="comment"> * Yahoo! messages generally aren&#39;t well-formed.  Their markup is</span>
<a name="l00510"></a>00510 <span class="comment"> * more of a flow from start to finish rather than a hierarchy from</span>
<a name="l00511"></a>00511 <span class="comment"> * outer to inner.  They tend to open tags and close them only when</span>
<a name="l00512"></a>00512 <span class="comment"> * necessary.</span>
<a name="l00513"></a>00513 <span class="comment"> *</span>
<a name="l00514"></a>00514 <span class="comment"> * Example: &lt;font size=&quot;8&quot;&gt;size 8 &lt;font size=&quot;16&quot;&gt;size 16 &lt;font size=&quot;8&quot;&gt;size 8 again</span>
<a name="l00515"></a>00515 <span class="comment"> *</span>
<a name="l00516"></a>00516 <span class="comment"> * But we want to send well-formed HTML to the core, so we step through</span>
<a name="l00517"></a>00517 <span class="comment"> * the input string and build an xmlnode tree containing sanitized HTML.</span>
<a name="l00518"></a>00518 <span class="comment"> */</span>
<a name="l00519"></a>00519 <span class="keywordtype">char</span> *yahoo_codes_to_html(<span class="keyword">const</span> <span class="keywordtype">char</span> *x)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521         <span class="keywordtype">size_t</span> x_len;
<a name="l00522"></a>00522         <a class="code" href="struct__xmlnode.html">xmlnode</a> *html, *cur;
<a name="l00523"></a>00523         GString *cdata = g_string_new(NULL);
<a name="l00524"></a>00524         <span class="keywordtype">int</span> i, j;
<a name="l00525"></a>00525         gboolean no_more_gt_brackets = FALSE;
<a name="l00526"></a>00526         <span class="keyword">const</span> <span class="keywordtype">char</span> *match;
<a name="l00527"></a>00527         gchar *xmlstr1, *xmlstr2, *esc;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529         x_len = strlen(x);
<a name="l00530"></a>00530         html = xmlnode_new(<span class="stringliteral">&quot;html&quot;</span>);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532         cur = html;
<a name="l00533"></a>00533         <span class="keywordflow">for</span> (i = 0; i &lt; x_len; i++) {
<a name="l00534"></a>00534                 <span class="keywordflow">if</span> ((x[i] == 0x1b) &amp;&amp; (x[i+1] == <span class="charliteral">&#39;[&#39;</span>)) {
<a name="l00535"></a>00535                         <span class="comment">/* This escape sequence signifies the beginning of some</span>
<a name="l00536"></a>00536 <span class="comment">                         * text formatting code */</span>
<a name="l00537"></a>00537                         j = i + 1;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539                         <span class="keywordflow">while</span> (j++ &lt; x_len) {
<a name="l00540"></a>00540                                 gchar *code;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542                                 <span class="keywordflow">if</span> (x[j] != <span class="charliteral">&#39;m&#39;</span>)
<a name="l00543"></a>00543                                         <span class="comment">/* Keep looking for the end of this sequence */</span>
<a name="l00544"></a>00544                                         <span class="keywordflow">continue</span>;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546                                 <span class="comment">/* We&#39;ve reached the end of the formatting sequence, yay */</span>
<a name="l00547"></a>00547 
<a name="l00548"></a>00548                                 <span class="comment">/* Append any character data that belongs in the current node */</span>
<a name="l00549"></a>00549                                 <span class="keywordflow">if</span> (cdata-&gt;len &gt; 0) {
<a name="l00550"></a>00550                                         xmlnode_insert_data(cur, cdata-&gt;str, cdata-&gt;len);
<a name="l00551"></a>00551                                         g_string_truncate(cdata, 0);
<a name="l00552"></a>00552                                 }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554                                 code = g_strndup(x + i + 2, j - i - 2);
<a name="l00555"></a>00555                                 <span class="keywordflow">if</span> (code[0] == <span class="charliteral">&#39;#&#39;</span>) {
<a name="l00556"></a>00556 <span class="preprocessor">#ifdef USE_CSS_FORMATTING</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span>                                        gchar *tmp = g_strdup_printf(<span class="stringliteral">&quot;color: %s&quot;</span>, code);
<a name="l00558"></a>00558                                         cur = xmlnode_new_child(cur, <span class="stringliteral">&quot;span&quot;</span>);
<a name="l00559"></a>00559                                         xmlnode_set_attrib(cur, <span class="stringliteral">&quot;style&quot;</span>, tmp);
<a name="l00560"></a>00560                                         g_free(tmp);
<a name="l00561"></a>00561 <span class="preprocessor">#else</span>
<a name="l00562"></a>00562 <span class="preprocessor"></span>                                        cur = xmlnode_new_child(cur, <span class="stringliteral">&quot;font&quot;</span>);
<a name="l00563"></a>00563                                         xmlnode_set_attrib(cur, <span class="stringliteral">&quot;color&quot;</span>, code);
<a name="l00564"></a>00564 <span class="preprocessor">#endif </span><span class="comment">/* !USE_CSS_FORMATTING */</span>
<a name="l00565"></a>00565 
<a name="l00566"></a>00566                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((match = g_hash_table_lookup(esc_codes_ht, code))) {
<a name="l00567"></a>00567                                         <span class="comment">/* Some tags are in the hash table only because we</span>
<a name="l00568"></a>00568 <span class="comment">                                         * want to ignore them */</span>
<a name="l00569"></a>00569                                         <span class="keywordflow">if</span> (match[0] != <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00570"></a>00570                                                 gboolean is_closing_tag;
<a name="l00571"></a>00571                                                 gchar *tag_name;
<a name="l00572"></a>00572                                                 tag_name = yahoo_markup_get_tag_name(match, &amp;is_closing_tag);
<a name="l00573"></a>00573                                                 yahoo_codes_to_html_add_tag(&amp;cur, match, is_closing_tag, tag_name, FALSE);
<a name="l00574"></a>00574                                                 g_free(tag_name);
<a name="l00575"></a>00575                                         }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577                                 } <span class="keywordflow">else</span> {
<a name="l00578"></a>00578                                         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;yahoo&quot;</span>,
<a name="l00579"></a>00579                                                 <span class="stringliteral">&quot;Ignoring unknown ansi code &#39;ESC[%sm&#39;.\n&quot;</span>, code);
<a name="l00580"></a>00580                                 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582                                 g_free(code);
<a name="l00583"></a>00583                                 i = j;
<a name="l00584"></a>00584                                 <span class="keywordflow">break</span>;
<a name="l00585"></a>00585                         }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x[i] == <span class="charliteral">&#39;&lt;&#39;</span> &amp;&amp; !no_more_gt_brackets) {
<a name="l00588"></a>00588                         <span class="comment">/* The start of an HTML tag */</span>
<a name="l00589"></a>00589                         j = i;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591                         <span class="keywordflow">while</span> (j++ &lt; x_len) {
<a name="l00592"></a>00592                                 gchar *tag;
<a name="l00593"></a>00593                                 gboolean is_closing_tag;
<a name="l00594"></a>00594                                 gchar *tag_name;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596                                 <span class="keywordflow">if</span> (x[j] != <span class="charliteral">&#39;&gt;&#39;</span>) {
<a name="l00597"></a>00597                                         <span class="keywordflow">if</span> (x[j] == <span class="charliteral">&#39;&quot;&#39;</span>) {
<a name="l00598"></a>00598                                                 <span class="comment">/* We&#39;re inside a quoted attribute value. Skip to the end */</span>
<a name="l00599"></a>00599                                                 j++;
<a name="l00600"></a>00600                                                 <span class="keywordflow">while</span> (j != x_len &amp;&amp; x[j] != <span class="charliteral">&#39;&quot;&#39;</span>)
<a name="l00601"></a>00601                                                         j++;
<a name="l00602"></a>00602                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x[j] == <span class="charliteral">&#39;\&#39;&#39;</span>) {
<a name="l00603"></a>00603                                                 <span class="comment">/* We&#39;re inside a quoted attribute value. Skip to the end */</span>
<a name="l00604"></a>00604                                                 j++;
<a name="l00605"></a>00605                                                 <span class="keywordflow">while</span> (j != x_len &amp;&amp; x[j] != <span class="charliteral">&#39;\&#39;&#39;</span>)
<a name="l00606"></a>00606                                                         j++;
<a name="l00607"></a>00607                                         }
<a name="l00608"></a>00608                                         <span class="keywordflow">if</span> (j != x_len)
<a name="l00609"></a>00609                                                 <span class="comment">/* Keep looking for the end of this tag */</span>
<a name="l00610"></a>00610                                                 <span class="keywordflow">continue</span>;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612                                         <span class="comment">/* This &lt; has no corresponding &gt; */</span>
<a name="l00613"></a>00613                                         g_string_append_c(cdata, x[i]);
<a name="l00614"></a>00614                                         no_more_gt_brackets = TRUE;
<a name="l00615"></a>00615                                         <span class="keywordflow">break</span>;
<a name="l00616"></a>00616                                 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618                                 tag = g_strndup(x + i, j - i + 1);
<a name="l00619"></a>00619                                 tag_name = yahoo_markup_get_tag_name(tag, &amp;is_closing_tag);
<a name="l00620"></a>00620 
<a name="l00621"></a>00621                                 match = g_hash_table_lookup(tags_ht, tag_name);
<a name="l00622"></a>00622                                 <span class="keywordflow">if</span> (match == NULL) {
<a name="l00623"></a>00623                                         <span class="comment">/* Unknown tag.  The user probably typed a less-than sign */</span>
<a name="l00624"></a>00624                                         g_string_append_c(cdata, x[i]);
<a name="l00625"></a>00625                                         g_free(tag);
<a name="l00626"></a>00626                                         g_free(tag_name);
<a name="l00627"></a>00627                                         <span class="keywordflow">break</span>;
<a name="l00628"></a>00628                                 }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630                                 <span class="comment">/* Some tags are in the hash table only because we</span>
<a name="l00631"></a>00631 <span class="comment">                                 * want to ignore them */</span>
<a name="l00632"></a>00632                                 <span class="keywordflow">if</span> (match[0] != <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00633"></a>00633                                         <span class="comment">/* Append any character data that belongs in the current node */</span>
<a name="l00634"></a>00634                                         <span class="keywordflow">if</span> (cdata-&gt;len &gt; 0) {
<a name="l00635"></a>00635                                                 xmlnode_insert_data(cur, cdata-&gt;str, cdata-&gt;len);
<a name="l00636"></a>00636                                                 g_string_truncate(cdata, 0);
<a name="l00637"></a>00637                                         }
<a name="l00638"></a>00638                                         <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;font&quot;</span>))
<a name="l00639"></a>00639                                                 <span class="comment">/* Font tags are a special case.  We don&#39;t</span>
<a name="l00640"></a>00640 <span class="comment">                                                 * necessarily want to replace the whole thing--</span>
<a name="l00641"></a>00641 <span class="comment">                                                 * we just want to fix the size attribute. */</span>
<a name="l00642"></a>00642                                                 yahoo_codes_to_html_add_tag(&amp;cur, tag, is_closing_tag, tag_name, TRUE);
<a name="l00643"></a>00643                                         <span class="keywordflow">else</span>
<a name="l00644"></a>00644                                                 yahoo_codes_to_html_add_tag(&amp;cur, match, is_closing_tag, tag_name, FALSE);
<a name="l00645"></a>00645                                 }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647                                 i = j;
<a name="l00648"></a>00648                                 g_free(tag);
<a name="l00649"></a>00649                                 g_free(tag_name);
<a name="l00650"></a>00650                                 <span class="keywordflow">break</span>;
<a name="l00651"></a>00651                         }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653                 } <span class="keywordflow">else</span> {
<a name="l00654"></a>00654                         g_string_append_c(cdata, x[i]);
<a name="l00655"></a>00655                 }
<a name="l00656"></a>00656         }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         <span class="comment">/* Append any remaining character data */</span>
<a name="l00659"></a>00659         <span class="keywordflow">if</span> (cdata-&gt;len &gt; 0)
<a name="l00660"></a>00660                 xmlnode_insert_data(cur, cdata-&gt;str, cdata-&gt;len);
<a name="l00661"></a>00661         g_string_free(cdata, TRUE);
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         <span class="comment">/* Serialize our HTML */</span>
<a name="l00664"></a>00664         xmlstr1 = xmlnode_to_str(html, NULL);
<a name="l00665"></a>00665         xmlnode_free(html);
<a name="l00666"></a>00666 
<a name="l00667"></a>00667         <span class="comment">/* Strip off the outter HTML node */</span>
<a name="l00668"></a>00668         <span class="comment">/* This probably isn&#39;t necessary, especially if we made the outter HTML</span>
<a name="l00669"></a>00669 <span class="comment">         * node an empty span.  But the HTML is simpler this way. */</span>
<a name="l00670"></a>00670         <span class="keywordflow">if</span> (!purple_strequal(xmlstr1, <span class="stringliteral">&quot;&lt;html/&gt;&quot;</span>))
<a name="l00671"></a>00671                 xmlstr2 = g_strndup(xmlstr1 + 6, strlen(xmlstr1) - 13);
<a name="l00672"></a>00672         <span class="keywordflow">else</span>
<a name="l00673"></a>00673                 xmlstr2 = g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00674"></a>00674         g_free(xmlstr1);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         esc = g_strescape(x, NULL);
<a name="l00677"></a>00677         <a class="code" href="debug_8h.html#a89b6474a316d3e177cc91b35897ae20a">purple_debug_misc</a>(<span class="stringliteral">&quot;yahoo&quot;</span>, <span class="stringliteral">&quot;yahoo_codes_to_html(%s)=%s\n&quot;</span>, esc, xmlstr2);
<a name="l00678"></a>00678         g_free(esc);
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         <span class="keywordflow">return</span> xmlstr2;
<a name="l00681"></a>00681 }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683 <span class="comment">/* borrowed from gtkimhtml */</span>
<a name="l00684"></a>00684 <span class="preprocessor">#define MAX_FONT_SIZE 7</span>
<a name="l00685"></a>00685 <span class="preprocessor"></span><span class="preprocessor">#define POINT_SIZE(x) (_point_sizes [MIN ((x &gt; 0 ? x : 1), MAX_FONT_SIZE) - 1])</span>
<a name="l00686"></a>00686 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> gint _point_sizes [] = { 8, 10, 12, 14, 20, 30, 40 };
<a name="l00687"></a>00687 
<a name="l00688"></a><a class="code" href="struct_current_msg_state.html">00688</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00689"></a>00689 {
<a name="l00690"></a>00690         gboolean bold;
<a name="l00691"></a>00691         gboolean italic;
<a name="l00692"></a>00692         gboolean underline;
<a name="l00693"></a>00693         gboolean in_link;
<a name="l00694"></a>00694         <span class="keywordtype">int</span> font_size;
<a name="l00695"></a>00695         <span class="keywordtype">char</span> *font_face;
<a name="l00696"></a>00696         <span class="keywordtype">char</span> *font_color;
<a name="l00697"></a>00697 } <a class="code" href="struct_current_msg_state.html">CurrentMsgState</a>;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 <span class="keyword">static</span> <span class="keywordtype">void</span> yahoo_htc_list_cleanup(GSList *l)
<a name="l00700"></a>00700 {
<a name="l00701"></a>00701         <span class="keywordflow">while</span> (l != NULL) {
<a name="l00702"></a>00702                 g_free(l-&gt;data);
<a name="l00703"></a>00703                 l = g_slist_delete_link(l, l);
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 <span class="keyword">static</span> <span class="keywordtype">void</span> parse_font_tag(GString *dest, <span class="keyword">const</span> <span class="keywordtype">char</span> *tag_name, <span class="keyword">const</span> <span class="keywordtype">char</span> *tag,
<a name="l00708"></a>00708                                 GSList **colors, GSList **tags)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710         <span class="keyword">const</span> <span class="keywordtype">char</span> *start;
<a name="l00711"></a>00711         <span class="keyword">const</span> <span class="keywordtype">char</span> *end;
<a name="l00712"></a>00712         GData *attributes;
<a name="l00713"></a>00713         <span class="keyword">const</span> <span class="keywordtype">char</span> *attribute;
<a name="l00714"></a>00714         gboolean needendtag;
<a name="l00715"></a>00715         GString *tmp;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717         purple_markup_find_tag(tag_name, tag, &amp;start, &amp;end, &amp;attributes);
<a name="l00718"></a>00718 
<a name="l00719"></a>00719         needendtag = FALSE;
<a name="l00720"></a>00720         tmp = g_string_new(NULL);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         attribute = g_datalist_get_data(&amp;attributes, <span class="stringliteral">&quot;color&quot;</span>);
<a name="l00723"></a>00723         <span class="keywordflow">if</span> (attribute != NULL) {
<a name="l00724"></a>00724                 g_string_append(tmp, *colors ? (*colors)-&gt;data : <span class="stringliteral">&quot;\033[#000000m&quot;</span>);
<a name="l00725"></a>00725                 g_string_append_printf(dest, <span class="stringliteral">&quot;\033[%sm&quot;</span>, attribute);
<a name="l00726"></a>00726                 *colors = g_slist_prepend(*colors,
<a name="l00727"></a>00727                                 g_strdup_printf(<span class="stringliteral">&quot;\033[%sm&quot;</span>, attribute));
<a name="l00728"></a>00728         } <span class="keywordflow">else</span> {
<a name="l00729"></a>00729                 <span class="comment">/* We need to add a value to the colors stack even if we&#39;re not</span>
<a name="l00730"></a>00730 <span class="comment">                 * setting a color because we ALWAYS pop exactly 1 element from</span>
<a name="l00731"></a>00731 <span class="comment">                 * this stack for every &lt;/font&gt; tag.  If we don&#39;t add anything</span>
<a name="l00732"></a>00732 <span class="comment">                 * then we&#39;ll pop something that we shouldn&#39;t when we hit this</span>
<a name="l00733"></a>00733 <span class="comment">                 * corresponding &lt;/font&gt;. */</span>
<a name="l00734"></a>00734                 *colors = g_slist_prepend(*colors,
<a name="l00735"></a>00735                                 *colors ? g_strdup((*colors)-&gt;data) : g_strdup(<span class="stringliteral">&quot;\033[#000000m&quot;</span>));
<a name="l00736"></a>00736         }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738         attribute = g_datalist_get_data(&amp;attributes, <span class="stringliteral">&quot;face&quot;</span>);
<a name="l00739"></a>00739         <span class="keywordflow">if</span> (attribute != NULL) {
<a name="l00740"></a>00740                 needendtag = TRUE;
<a name="l00741"></a>00741                 g_string_append(dest, <span class="stringliteral">&quot;&lt;font &quot;</span>);
<a name="l00742"></a>00742                 g_string_append_printf(dest, <span class="stringliteral">&quot;face=\&quot;%s\&quot; &quot;</span>, attribute);
<a name="l00743"></a>00743         }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745         attribute = g_datalist_get_data(&amp;attributes, <span class="stringliteral">&quot;size&quot;</span>);
<a name="l00746"></a>00746         <span class="keywordflow">if</span> (attribute != NULL) {
<a name="l00747"></a>00747                 <span class="keywordflow">if</span> (!needendtag) {
<a name="l00748"></a>00748                         needendtag = TRUE;
<a name="l00749"></a>00749                         g_string_append(dest, <span class="stringliteral">&quot;&lt;font &quot;</span>);
<a name="l00750"></a>00750                 }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752                 g_string_append_printf(dest, <span class="stringliteral">&quot;size=\&quot;%d\&quot; &quot;</span>,
<a name="l00753"></a>00753                                 POINT_SIZE(strtol(attribute, NULL, 10)));
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (needendtag) {
<a name="l00757"></a>00757                 dest-&gt;str[dest-&gt;len-1] = <span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l00758"></a>00758                 *tags = g_slist_prepend(*tags, g_strdup(<span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>));
<a name="l00759"></a>00759                 g_string_free(tmp, TRUE);
<a name="l00760"></a>00760         } <span class="keywordflow">else</span> {
<a name="l00761"></a>00761                 *tags = g_slist_prepend(*tags, tmp-&gt;str);
<a name="l00762"></a>00762                 g_string_free(tmp, FALSE);
<a name="l00763"></a>00763         }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765         g_datalist_clear(&amp;attributes);
<a name="l00766"></a>00766 }
<a name="l00767"></a>00767 
<a name="l00768"></a><a class="code" href="libymsg_8h.html#aa47ff27ec0f3dc9692d6722d41a3b099">00768</a> <span class="keywordtype">char</span> *<a class="code" href="libymsg_8h.html#aa47ff27ec0f3dc9692d6722d41a3b099">yahoo_html_to_codes</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *src)
<a name="l00769"></a>00769 {
<a name="l00770"></a>00770         GSList *colors = NULL;
<a name="l00771"></a>00771 
<a name="l00777"></a>00777         GSList *tags = NULL;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779         <span class="keywordtype">size_t</span> src_len;
<a name="l00780"></a>00780         <span class="keywordtype">int</span> i, j;
<a name="l00781"></a>00781         GString *dest;
<a name="l00782"></a>00782         <span class="keywordtype">char</span> *esc;
<a name="l00783"></a>00783         gboolean no_more_gt_brackets = FALSE;
<a name="l00784"></a>00784         gchar *tag, *tag_name;
<a name="l00785"></a>00785         gboolean is_closing_tag;
<a name="l00786"></a>00786         <a class="code" href="struct_current_msg_state.html">CurrentMsgState</a> current_state;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788         memset(&amp;current_state, 0, <span class="keyword">sizeof</span>(current_state));
<a name="l00789"></a>00789 
<a name="l00790"></a>00790         src_len = strlen(src);
<a name="l00791"></a>00791         dest = g_string_sized_new(src_len);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793         <span class="keywordflow">for</span> (i = 0; i &lt; src_len; i++) {
<a name="l00794"></a>00794                 <span class="keywordflow">if</span> (src[i] == <span class="charliteral">&#39;&lt;&#39;</span> &amp;&amp; !no_more_gt_brackets) {
<a name="l00795"></a>00795                         <span class="comment">/* The start of an HTML tag  */</span>
<a name="l00796"></a>00796                         j = i;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798                         <span class="keywordflow">while</span> (j++ &lt; src_len) {
<a name="l00799"></a>00799                                 <span class="keywordflow">if</span> (src[j] != <span class="charliteral">&#39;&gt;&#39;</span>) {
<a name="l00800"></a>00800                                         <span class="keywordflow">if</span> (src[j] == <span class="charliteral">&#39;&quot;&#39;</span>) {
<a name="l00801"></a>00801                                                 <span class="comment">/* We&#39;re inside a quoted attribute value. Skip to the end */</span>
<a name="l00802"></a>00802                                                 j++;
<a name="l00803"></a>00803                                                 <span class="keywordflow">while</span> (j != src_len &amp;&amp; src[j] != <span class="charliteral">&#39;&quot;&#39;</span>)
<a name="l00804"></a>00804                                                         j++;
<a name="l00805"></a>00805                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (src[j] == <span class="charliteral">&#39;\&#39;&#39;</span>) {
<a name="l00806"></a>00806                                                 <span class="comment">/* We&#39;re inside a quoted attribute value. Skip to the end */</span>
<a name="l00807"></a>00807                                                 j++;
<a name="l00808"></a>00808                                                 <span class="keywordflow">while</span> (j != src_len &amp;&amp; src[j] != <span class="charliteral">&#39;\&#39;&#39;</span>)
<a name="l00809"></a>00809                                                         j++;
<a name="l00810"></a>00810                                         }
<a name="l00811"></a>00811                                         <span class="keywordflow">if</span> (j != src_len)
<a name="l00812"></a>00812                                                 <span class="comment">/* Keep looking for the end of this tag */</span>
<a name="l00813"></a>00813                                                 <span class="keywordflow">continue</span>;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815                                         <span class="comment">/* This &lt; has no corresponding &gt; */</span>
<a name="l00816"></a>00816                                         g_string_append_c(dest, src[i]);
<a name="l00817"></a>00817                                         no_more_gt_brackets = TRUE;
<a name="l00818"></a>00818                                         <span class="keywordflow">break</span>;
<a name="l00819"></a>00819                                 }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821                                 tag = g_strndup(src + i, j - i + 1);
<a name="l00822"></a>00822                                 tag_name = yahoo_markup_get_tag_name(tag, &amp;is_closing_tag);
<a name="l00823"></a>00823 
<a name="l00824"></a>00824                                 <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;a&quot;</span>)) {
<a name="l00825"></a>00825                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *start;
<a name="l00826"></a>00826                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *end;
<a name="l00827"></a>00827                                         GData *attributes;
<a name="l00828"></a>00828                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *attribute;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830                                         <span class="comment">/*</span>
<a name="l00831"></a>00831 <span class="comment">                                         * TODO: Ideally we would replace this:</span>
<a name="l00832"></a>00832 <span class="comment">                                         * &lt;a href=&quot;http://pidgin.im/&quot;&gt;Pidgin&lt;/a&gt;</span>
<a name="l00833"></a>00833 <span class="comment">                                         * with this:</span>
<a name="l00834"></a>00834 <span class="comment">                                         * Pidgin (http://pidgin.im/)</span>
<a name="l00835"></a>00835 <span class="comment">                                         *</span>
<a name="l00836"></a>00836 <span class="comment">                                         * Currently we drop the text within the &lt;a&gt; tag and</span>
<a name="l00837"></a>00837 <span class="comment">                                         * just show the URL.  Doing it the fancy way is</span>
<a name="l00838"></a>00838 <span class="comment">                                         * complicated when dealing with HTML tags within the</span>
<a name="l00839"></a>00839 <span class="comment">                                         * &lt;a&gt; tag.</span>
<a name="l00840"></a>00840 <span class="comment">                                         */</span>
<a name="l00841"></a>00841 
<a name="l00842"></a>00842                                         <span class="comment">/* Append the URL */</span>
<a name="l00843"></a>00843                                         purple_markup_find_tag(tag_name, tag, &amp;start, &amp;end, &amp;attributes);
<a name="l00844"></a>00844                                         attribute = g_datalist_get_data(&amp;attributes, <span class="stringliteral">&quot;href&quot;</span>);
<a name="l00845"></a>00845                                         <span class="keywordflow">if</span> (attribute != NULL) {
<a name="l00846"></a>00846                                                 <span class="keywordflow">if</span> (purple_str_has_prefix(attribute, <span class="stringliteral">&quot;mailto:&quot;</span>))
<a name="l00847"></a>00847                                                         attribute += 7;
<a name="l00848"></a>00848                                                 g_string_append(dest, attribute);
<a name="l00849"></a>00849                                         }
<a name="l00850"></a>00850                                         g_datalist_clear(&amp;attributes);
<a name="l00851"></a>00851 
<a name="l00852"></a>00852                                         <span class="comment">/* Skip past the closing &lt;/a&gt; tag */</span>
<a name="l00853"></a>00853                                         end = purple_strcasestr(src + j, <span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>);
<a name="l00854"></a>00854                                         <span class="keywordflow">if</span> (end != NULL)
<a name="l00855"></a>00855                                                 j = end - src + 3;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;font&quot;</span>)) {
<a name="l00858"></a>00858                                         parse_font_tag(dest, tag_name, tag, &amp;colors, &amp;tags);
<a name="l00859"></a>00859                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;b&quot;</span>)) {
<a name="l00860"></a>00860                                         g_string_append(dest, <span class="stringliteral">&quot;\033[1m&quot;</span>);
<a name="l00861"></a>00861                                         current_state.bold = TRUE;
<a name="l00862"></a>00862                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;/b&quot;</span>)) {
<a name="l00863"></a>00863                                         <span class="keywordflow">if</span> (current_state.bold) {
<a name="l00864"></a>00864                                                 g_string_append(dest, <span class="stringliteral">&quot;\033[x1m&quot;</span>);
<a name="l00865"></a>00865                                                 current_state.bold = FALSE;
<a name="l00866"></a>00866                                         }
<a name="l00867"></a>00867                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;i&quot;</span>)) {
<a name="l00868"></a>00868                                         current_state.italic = TRUE;
<a name="l00869"></a>00869                                         g_string_append(dest, <span class="stringliteral">&quot;\033[2m&quot;</span>);
<a name="l00870"></a>00870                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;/i&quot;</span>)) {
<a name="l00871"></a>00871                                         <span class="keywordflow">if</span> (current_state.italic) {
<a name="l00872"></a>00872                                                 g_string_append(dest, <span class="stringliteral">&quot;\033[x2m&quot;</span>);
<a name="l00873"></a>00873                                                 current_state.italic = FALSE;
<a name="l00874"></a>00874                                         }
<a name="l00875"></a>00875                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;u&quot;</span>)) {
<a name="l00876"></a>00876                                         current_state.underline = TRUE;
<a name="l00877"></a>00877                                         g_string_append(dest, <span class="stringliteral">&quot;\033[4m&quot;</span>);
<a name="l00878"></a>00878                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;/u&quot;</span>)) {
<a name="l00879"></a>00879                                         <span class="keywordflow">if</span> (current_state.underline) {
<a name="l00880"></a>00880                                                 g_string_append(dest, <span class="stringliteral">&quot;\033[x4m&quot;</span>);
<a name="l00881"></a>00881                                                 current_state.underline = FALSE;
<a name="l00882"></a>00882                                         }
<a name="l00883"></a>00883                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;/a&quot;</span>)) {
<a name="l00884"></a>00884                                         <span class="comment">/* Do nothing */</span>
<a name="l00885"></a>00885                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;br&quot;</span>)) {
<a name="l00886"></a>00886                                         g_string_append_c(dest, <span class="charliteral">&#39;\n&#39;</span>);
<a name="l00887"></a>00887                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;/font&quot;</span>)) {
<a name="l00888"></a>00888                                         <span class="keywordflow">if</span> (tags != NULL) {
<a name="l00889"></a>00889                                                 <span class="keywordtype">char</span> *etag = tags-&gt;data;
<a name="l00890"></a>00890                                                 tags = g_slist_delete_link(tags, tags);
<a name="l00891"></a>00891                                                 g_string_append(dest, etag);
<a name="l00892"></a>00892                                                 <span class="keywordflow">if</span> (colors != NULL) {
<a name="l00893"></a>00893                                                         g_free(colors-&gt;data);
<a name="l00894"></a>00894                                                         colors = g_slist_delete_link(colors, colors);
<a name="l00895"></a>00895                                                 }
<a name="l00896"></a>00896                                                 g_free(etag);
<a name="l00897"></a>00897                                         }
<a name="l00898"></a>00898                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_str_equal(tag_name, <span class="stringliteral">&quot;span&quot;</span>) || g_str_equal(tag_name, <span class="stringliteral">&quot;/span&quot;</span>)) {
<a name="l00899"></a>00899                                         <span class="comment">/* Do nothing */</span>
<a name="l00900"></a>00900                                 } <span class="keywordflow">else</span> {
<a name="l00901"></a>00901                                         <span class="comment">/* We don&#39;t know what the tag is. Send it unmodified. */</span>
<a name="l00902"></a>00902                                         g_string_append(dest, tag);
<a name="l00903"></a>00903                                 }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905                                 i = j;
<a name="l00906"></a>00906                                 g_free(tag);
<a name="l00907"></a>00907                                 g_free(tag_name);
<a name="l00908"></a>00908                                 <span class="keywordflow">break</span>;
<a name="l00909"></a>00909                         }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911                 } <span class="keywordflow">else</span> {
<a name="l00912"></a>00912                         <span class="keyword">const</span> <span class="keywordtype">char</span> *entity;
<a name="l00913"></a>00913                         <span class="keywordtype">int</span> length;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915                         entity = purple_markup_unescape_entity(src + i, &amp;length);
<a name="l00916"></a>00916                         <span class="keywordflow">if</span> (entity != NULL) {
<a name="l00917"></a>00917                                 <span class="comment">/* src[i] is the start of an HTML entity */</span>
<a name="l00918"></a>00918                                 g_string_append(dest, entity);
<a name="l00919"></a>00919                                 i += length - 1;
<a name="l00920"></a>00920                         } <span class="keywordflow">else</span>
<a name="l00921"></a>00921                                 <span class="comment">/* src[i] is a normal character */</span>
<a name="l00922"></a>00922                                 g_string_append_c(dest, src[i]);
<a name="l00923"></a>00923                 }
<a name="l00924"></a>00924         }
<a name="l00925"></a>00925 
<a name="l00926"></a>00926         esc = g_strescape(dest-&gt;str, NULL);
<a name="l00927"></a>00927         <a class="code" href="debug_8h.html#a89b6474a316d3e177cc91b35897ae20a">purple_debug_misc</a>(<span class="stringliteral">&quot;yahoo&quot;</span>, <span class="stringliteral">&quot;yahoo_html_to_codes(%s)=%s\n&quot;</span>, src, esc);
<a name="l00928"></a>00928         g_free(esc);
<a name="l00929"></a>00929 
<a name="l00930"></a>00930         yahoo_htc_list_cleanup(colors);
<a name="l00931"></a>00931         yahoo_htc_list_cleanup(tags);
<a name="l00932"></a>00932 
<a name="l00933"></a>00933         <span class="keywordflow">return</span> g_string_free(dest, FALSE);
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936 YahooFederation yahoo_get_federation_from_name(<span class="keyword">const</span> <span class="keywordtype">char</span> *who)
<a name="l00937"></a>00937 {
<a name="l00938"></a>00938         YahooFederation fed = YAHOO_FEDERATION_NONE;
<a name="l00939"></a>00939         <span class="keywordflow">if</span> (who[3] == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00940"></a>00940                 <span class="keywordflow">if</span> (!g_ascii_strncasecmp(who, <span class="stringliteral">&quot;msn&quot;</span>, 3))
<a name="l00941"></a>00941                         fed = YAHOO_FEDERATION_MSN;
<a name="l00942"></a>00942                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!g_ascii_strncasecmp(who, <span class="stringliteral">&quot;ocs&quot;</span>, 3))
<a name="l00943"></a>00943                         fed = YAHOO_FEDERATION_OCS;
<a name="l00944"></a>00944                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!g_ascii_strncasecmp(who, <span class="stringliteral">&quot;ibm&quot;</span>, 3))
<a name="l00945"></a>00945                         fed = YAHOO_FEDERATION_IBM;
<a name="l00946"></a>00946                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!g_ascii_strncasecmp(who, <span class="stringliteral">&quot;pbx&quot;</span>, 3))
<a name="l00947"></a>00947                         fed = YAHOO_FEDERATION_PBX;
<a name="l00948"></a>00948         }
<a name="l00949"></a>00949         <span class="keywordflow">return</span> fed;
<a name="l00950"></a>00950 }
<a name="l00951"></a>00951 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>util.c</b>      </li>
      <li class="footer">Generated on Sun Mar 24 2013 16:05:10 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
