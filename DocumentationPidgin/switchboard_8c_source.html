<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>protocols/msn/switchboard.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('switchboard_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">protocols/msn/switchboard.c</div>  </div>
</div>
<div class="contents">
<a href="switchboard_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;internal.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html">debug.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="msnutils_8h.html">msnutils.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="switchboard_8h.html">switchboard.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="sbconn_8h.html">sbconn.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="slplink_8h.html">slplink.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;user.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="userlist_8h.html">userlist.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="keyword">static</span> <a class="code" href="struct___msn_table.html">MsnTable</a> *cbs_table;
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">/**************************************************************************</span>
<a name="l00038"></a>00038 <span class="comment"> * Main</span>
<a name="l00039"></a>00039 <span class="comment"> **************************************************************************/</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *
<a name="l00042"></a><a class="code" href="switchboard_8h.html#af4e32e50c2cc595d08313a6ad554b20e">00042</a> <a class="code" href="switchboard_8c.html#af4e32e50c2cc595d08313a6ad554b20e">msn_switchboard_new</a>(<a class="code" href="struct___msn_session.html">MsnSession</a> *session)
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046         g_return_val_if_fail(session != NULL, NULL);
<a name="l00047"></a>00047 
<a name="l00048"></a>00048         swboard = g_new0(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a>, 1);
<a name="l00049"></a>00049 
<a name="l00050"></a>00050         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e4d714eda8cb92707b334047dea3c9e">session</a> = session;
<a name="l00051"></a>00051         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a> = <a class="code" href="servconn_8c.html#aa20b3cbefdc6a7919e8ad54a30f8d7a2">msn_servconn_new</a>(session, MSN_SERVCONN_SB);
<a name="l00052"></a>00052         <a class="code" href="servconn_8c.html#af452265defe176b9911ce175b1815903">msn_servconn_set_idle_timeout</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>, 60);
<a name="l00053"></a>00053         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a> = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>-&gt;<a class="code" href="struct___msn_serv_conn.html#ad48d2b93fe2cc85d732a0035958f7fb0">cmdproc</a>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a3e79c70f19238de170f49c9c2a77aa46">msg_queue</a> = g_queue_new();
<a name="l00056"></a>00056         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad4d89cd056a3cf1a028d372baee5975e">empty</a> = TRUE;
<a name="l00057"></a>00057 
<a name="l00058"></a>00058         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a> = swboard;
<a name="l00059"></a>00059         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>-&gt;cbs_table = cbs_table;
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         session-&gt;<a class="code" href="struct___msn_session.html#a2bcf2ea73b2bef10c56bc05050e0f7af">switches</a> = g_list_prepend(session-&gt;<a class="code" href="struct___msn_session.html#a2bcf2ea73b2bef10c56bc05050e0f7af">switches</a>, swboard);
<a name="l00062"></a>00062 
<a name="l00063"></a>00063         <span class="keywordflow">if</span> (purple_debug_is_verbose())
<a name="l00064"></a>00064                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;switchboard new: swboard(%p)\n&quot;</span>, swboard);
<a name="l00065"></a>00065 
<a name="l00066"></a>00066         <span class="keywordflow">return</span> swboard;
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="keywordtype">void</span>
<a name="l00070"></a><a class="code" href="switchboard_8h.html#ad8a057029a45c43bdb2a51022ec9e1c1">00070</a> <a class="code" href="switchboard_8c.html#ad8a057029a45c43bdb2a51022ec9e1c1">msn_switchboard_destroy</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072         <a class="code" href="struct___msn_session.html">MsnSession</a> *session;
<a name="l00073"></a>00073         <a class="code" href="struct___msn_message.html">MsnMessage</a> *msg;
<a name="l00074"></a>00074         GList *l;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076         <span class="keywordflow">if</span> (purple_debug_is_verbose())
<a name="l00077"></a>00077                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;switchboard destroy: swboard(%p)\n&quot;</span>, swboard);
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         g_return_if_fail(swboard != NULL);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8f3a3cbb4ac7e71023b9f3cd1ccb7222">destroying</a>)
<a name="l00082"></a>00082                 <span class="keywordflow">return</span>;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8f3a3cbb4ac7e71023b9f3cd1ccb7222">destroying</a> = TRUE;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         <span class="keywordflow">if</span> (swboard-&gt;reconn_timeout_h &gt; 0)
<a name="l00087"></a>00087                 <a class="code" href="eventloop_8c.html#aa63215615dfb1d5e8e61612520e5ec27">purple_timeout_remove</a>(swboard-&gt;reconn_timeout_h);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089         <span class="comment">/* If it linked us is because its looking for trouble */</span>
<a name="l00090"></a>00090         <span class="keywordflow">while</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e86045386ff9f5fd92c156dfdd38306">slplinks</a> != NULL) {
<a name="l00091"></a>00091                 <a class="code" href="struct___msn_slp_link.html">MsnSlpLink</a> *slplink = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e86045386ff9f5fd92c156dfdd38306">slplinks</a>-&gt;data;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e86045386ff9f5fd92c156dfdd38306">slplinks</a> = g_list_remove(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e86045386ff9f5fd92c156dfdd38306">slplinks</a>, slplink);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095                 <span class="comment">/* Destroy only those slplinks which use the switchboard */</span>
<a name="l00096"></a>00096                 <span class="keywordflow">if</span> (slplink-&gt;dc == NULL)
<a name="l00097"></a>00097                         msn_slplink_unref(slplink);
<a name="l00098"></a>00098                 <span class="keywordflow">else</span> {
<a name="l00099"></a>00099                         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e86045386ff9f5fd92c156dfdd38306">slplinks</a> = g_list_remove(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e86045386ff9f5fd92c156dfdd38306">slplinks</a>, slplink);
<a name="l00100"></a>00100                         slplink-&gt;swboard = NULL;
<a name="l00101"></a>00101                 }
<a name="l00102"></a>00102         }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="comment">/* Destroy the message queue */</span>
<a name="l00105"></a>00105         <span class="keywordflow">while</span> ((msg = g_queue_pop_head(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a3e79c70f19238de170f49c9c2a77aa46">msg_queue</a>)) != NULL)
<a name="l00106"></a>00106         {
<a name="l00107"></a>00107                 <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a6d88be78fdf381044e78ad21f0e40a05">error</a> != <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a530b06aad3a1c31f0a76546d80c5b419">MSN_SB_ERROR_NONE</a>)
<a name="l00108"></a>00108                 {
<a name="l00109"></a>00109                         <span class="comment">/* The messages could not be sent due to a switchboard error */</span>
<a name="l00110"></a>00110                         msg_error_helper(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>, msg,
<a name="l00111"></a>00111                                                          <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521a5b4b55fbf6d35bc004123f290a7a4157">MSN_MSG_ERROR_SB</a>);
<a name="l00112"></a>00112                 }
<a name="l00113"></a>00113                 <a class="code" href="msg_8c.html#ac90a4fbb4c0fb2f9ff60ff4476c26148">msn_message_unref</a>(msg);
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         g_queue_free(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a3e79c70f19238de170f49c9c2a77aa46">msg_queue</a>);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <span class="comment">/* msg_error_helper will both remove the msg from ack_list and</span>
<a name="l00119"></a>00119 <span class="comment">           unref it, so we don&#39;t need to do either here */</span>
<a name="l00120"></a>00120         <span class="keywordflow">while</span> ((l = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad6a8be692dd612a9d6356aecd15263e8">ack_list</a>) != NULL)
<a name="l00121"></a>00121                 msg_error_helper(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>, l-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>, <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521a5b4b55fbf6d35bc004123f290a7a4157">MSN_MSG_ERROR_SB</a>);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         g_free(swboard-&gt;im_user);
<a name="l00124"></a>00124         g_free(swboard-&gt;auth_key);
<a name="l00125"></a>00125         g_free(swboard-&gt;session_id);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <span class="keywordflow">for</span> (; swboard-&gt;users; swboard-&gt;users = g_list_delete_link(swboard-&gt;users, swboard-&gt;users))
<a name="l00128"></a>00128                 msn_user_unref(swboard-&gt;users-&gt;data);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         session = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e4d714eda8cb92707b334047dea3c9e">session</a>;
<a name="l00131"></a>00131         session-&gt;<a class="code" href="struct___msn_session.html#a2bcf2ea73b2bef10c56bc05050e0f7af">switches</a> = g_list_remove(session-&gt;<a class="code" href="struct___msn_session.html#a2bcf2ea73b2bef10c56bc05050e0f7af">switches</a>, swboard);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133         <span class="keywordflow">for</span> (l = session-&gt;<a class="code" href="struct___msn_session.html#ad79ce8b264981035b06afe03e77e5170">slplinks</a>; l; l = l-&gt;next) {
<a name="l00134"></a>00134                 <a class="code" href="struct___msn_slp_link.html">MsnSlpLink</a> *slplink = l-&gt;data;
<a name="l00135"></a>00135                 <span class="keywordflow">if</span> (slplink-&gt;swboard == swboard) slplink-&gt;swboard = NULL;
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="preprocessor">#if 0</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>        <span class="comment">/* This should never happen or we are in trouble. */</span>
<a name="l00140"></a>00140         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a> != NULL)
<a name="l00141"></a>00141                 <a class="code" href="servconn_8c.html#ae06a6828ed4383d3ee4126a36a269eee">msn_servconn_destroy</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>);
<a name="l00142"></a>00142 <span class="preprocessor">#endif</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>
<a name="l00144"></a>00144         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a> = NULL;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146         <a class="code" href="servconn_8c.html#a6c834390471c12349d37d518a5a8cbcc">msn_servconn_set_disconnect_cb</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>, NULL);
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         <a class="code" href="servconn_8c.html#ae06a6828ed4383d3ee4126a36a269eee">msn_servconn_destroy</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         g_free(swboard);
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="keywordtype">void</span>
<a name="l00154"></a><a class="code" href="switchboard_8h.html#ad6c21c12e7ce3eb4c761f5b86af79efd">00154</a> <a class="code" href="switchboard_8c.html#ad6c21c12e7ce3eb4c761f5b86af79efd">msn_switchboard_set_auth_key</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <span class="keyword">const</span> <span class="keywordtype">char</span> *key)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156         g_return_if_fail(swboard != NULL);
<a name="l00157"></a>00157         g_return_if_fail(key != NULL);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159         swboard-&gt;auth_key = g_strdup(key);
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00163"></a><a class="code" href="switchboard_8h.html#a17b6812dbd7e874802d8d8c0f961cff2">00163</a> <a class="code" href="switchboard_8c.html#a17b6812dbd7e874802d8d8c0f961cff2">msn_switchboard_get_auth_key</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165         g_return_val_if_fail(swboard != NULL, NULL);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="keywordflow">return</span> swboard-&gt;auth_key;
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="keywordtype">void</span>
<a name="l00171"></a><a class="code" href="switchboard_8h.html#addcd6180587effc60f5d7e36fb916257">00171</a> <a class="code" href="switchboard_8c.html#addcd6180587effc60f5d7e36fb916257">msn_switchboard_set_session_id</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173         g_return_if_fail(swboard != NULL);
<a name="l00174"></a>00174         g_return_if_fail(<span class="keywordtype">id</span> != NULL);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         g_free(swboard-&gt;session_id);
<a name="l00177"></a>00177         swboard-&gt;session_id = g_strdup(<span class="keywordtype">id</span>);
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00181"></a><a class="code" href="switchboard_8h.html#aa2ae1b8e437e8c2dffff2e790e3be71a">00181</a> <a class="code" href="switchboard_8c.html#aa2ae1b8e437e8c2dffff2e790e3be71a">msn_switchboard_get_session_id</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183         g_return_val_if_fail(swboard != NULL, NULL);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185         <span class="keywordflow">return</span> swboard-&gt;session_id;
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="keywordtype">int</span>
<a name="l00189"></a><a class="code" href="switchboard_8h.html#accc9091ef0c219dae0b8183f8cc7c4dd">00189</a> <a class="code" href="switchboard_8c.html#accc9091ef0c219dae0b8183f8cc7c4dd">msn_switchboard_get_chat_id</a>(<span class="keywordtype">void</span>)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191         <span class="keyword">static</span> <span class="keywordtype">int</span> chat_id = 1;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         <span class="keywordflow">return</span> chat_id++;
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="keywordtype">void</span>
<a name="l00197"></a><a class="code" href="switchboard_8h.html#ae3c5b637ecd29500bd2a9d397ee9f332">00197</a> <a class="code" href="switchboard_8c.html#ae3c5b637ecd29500bd2a9d397ee9f332">msn_switchboard_set_invited</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, gboolean invited)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199         g_return_if_fail(swboard != NULL);
<a name="l00200"></a>00200 
<a name="l00201"></a>00201         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#acb92803fb7f38588f338cb82b7c79ecd">invited</a> = invited;
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 gboolean
<a name="l00205"></a><a class="code" href="switchboard_8h.html#acd181c10ecb40e2b6b54b28762fee757">00205</a> <a class="code" href="switchboard_8c.html#acd181c10ecb40e2b6b54b28762fee757">msn_switchboard_is_invited</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207         g_return_val_if_fail(swboard != NULL, FALSE);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <span class="keywordflow">return</span> swboard-&gt;<a class="code" href="struct___msn_switch_board.html#acb92803fb7f38588f338cb82b7c79ecd">invited</a>;
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="comment">/**************************************************************************</span>
<a name="l00213"></a>00213 <span class="comment"> * Utility</span>
<a name="l00214"></a>00214 <span class="comment"> **************************************************************************/</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00217"></a>00217 send_clientcaps(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219         <a class="code" href="struct___msn_message.html">MsnMessage</a> *msg;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         msg = <a class="code" href="msg_8c.html#ad93cb0be5756486c1a3451b0ddc7f595">msn_message_new</a>(MSN_MSG_CAPS);
<a name="l00222"></a>00222         <a class="code" href="msg_8c.html#a2ca330bb9051d88489f3d40ae4770411">msn_message_set_content_type</a>(msg, <span class="stringliteral">&quot;text/x-clientcaps&quot;</span>);
<a name="l00223"></a>00223         <a class="code" href="msg_8c.html#a6c0ef1f806368d8701c2cb3f9c402403">msn_message_set_flag</a>(msg, <span class="charliteral">&#39;U&#39;</span>);
<a name="l00224"></a>00224         <a class="code" href="msg_8c.html#a38b4dcdfbaa0fbe0dd41d6a33e808150">msn_message_set_bin_data</a>(msg, MSN_CLIENTINFO, strlen(MSN_CLIENTINFO));
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         <a class="code" href="sbconn_8c.html#a81d196af90c81ba668b8206a24cd7740">msn_switchboard_send_msg</a>(swboard, msg, TRUE);
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         <a class="code" href="msg_8c.html#ac90a4fbb4c0fb2f9ff60ff4476c26148">msn_message_unref</a>(msg);
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00232"></a>00232 msn_switchboard_add_user(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <span class="keyword">const</span> <span class="keywordtype">char</span> *user)
<a name="l00233"></a>00233 {
<a name="l00234"></a>00234         <a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc;
<a name="l00235"></a>00235         <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account;
<a name="l00236"></a>00236         <a class="code" href="struct___msn_user_list.html">MsnUserList</a> *userlist;
<a name="l00237"></a>00237         <a class="code" href="struct___msn_user.html">MsnUser</a> *msnuser;
<a name="l00238"></a>00238         <span class="keywordtype">char</span> *semicolon;
<a name="l00239"></a>00239         <span class="keywordtype">char</span> *passport;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241         g_return_if_fail(swboard != NULL);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         cmdproc = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>;
<a name="l00244"></a>00244         account = cmdproc-&gt;session-&gt;account;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         semicolon = strchr(user, <span class="charliteral">&#39;;&#39;</span>);
<a name="l00247"></a>00247         <span class="comment">/* We don&#39;t really care about the machine ID. */</span>
<a name="l00248"></a>00248         <span class="keywordflow">if</span> (semicolon)
<a name="l00249"></a>00249                 passport = g_strndup(user, semicolon - user);
<a name="l00250"></a>00250         <span class="keywordflow">else</span>
<a name="l00251"></a>00251                 passport = g_strdup(user);
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         userlist = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e4d714eda8cb92707b334047dea3c9e">session</a>-&gt;userlist;
<a name="l00254"></a>00254         msnuser = msn_userlist_find_user(userlist, passport);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">/* Don&#39;t add multiple endpoints to the conversation. */</span>
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (g_list_find_custom(swboard-&gt;users, passport, (GCompareFunc)msn_user_passport_cmp)) {
<a name="l00258"></a>00258                 g_free(passport);
<a name="l00259"></a>00259                 <span class="keywordflow">return</span>;
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         <span class="comment">/* Don&#39;t add ourselves either... */</span>
<a name="l00263"></a>00263         <span class="keywordflow">if</span> (g_str_equal(passport, purple_account_get_username(account))) {
<a name="l00264"></a>00264                 g_free(passport);
<a name="l00265"></a>00265                 <span class="keywordflow">return</span>;
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <span class="keywordflow">if</span> (!msnuser) {
<a name="l00269"></a>00269                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>,<span class="stringliteral">&quot;User %s is not on our list.\n&quot;</span>, passport);
<a name="l00270"></a>00270                 msnuser = msn_user_new(userlist, passport, NULL);
<a name="l00271"></a>00271         } <span class="keywordflow">else</span>
<a name="l00272"></a>00272                 msn_user_ref(msnuser);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274         g_free(passport);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         swboard-&gt;users = g_list_prepend(swboard-&gt;users, msnuser);
<a name="l00277"></a>00277         swboard-&gt;current_users++;
<a name="l00278"></a>00278         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad4d89cd056a3cf1a028d372baee5975e">empty</a> = FALSE;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (purple_debug_is_verbose())
<a name="l00281"></a>00281                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;user=[%s], total=%d\n&quot;</span>,
<a name="l00282"></a>00282                                   user, swboard-&gt;current_users);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (!(swboard-&gt;flag &amp; <a class="code" href="switchboard_8h.html#a38b40b31e3f28b31e68fd721802eed66a33d7d203b371f24ba1989229d74d1a58">MSN_SB_FLAG_IM</a>) &amp;&amp; (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> != NULL))
<a name="l00285"></a>00285         {
<a name="l00286"></a>00286                 <span class="comment">/* This is a helper switchboard. */</span>
<a name="l00287"></a>00287                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;switchboard_add_user: conv != NULL\n&quot;</span>);
<a name="l00288"></a>00288                 <span class="keywordflow">return</span>;
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         <span class="keywordflow">if</span> ((swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> != NULL) &amp;&amp;
<a name="l00292"></a>00292                 (purple_conversation_get_type(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>) == <a class="code" href="conversation_8h.html#a9e9f3ae232444332eb34f16aef64f721a91481bc864f7ebb9541adce5e332c838">PURPLE_CONV_TYPE_CHAT</a>))
<a name="l00293"></a>00293         {
<a name="l00294"></a>00294                 purple_conv_chat_add_user(PURPLE_CONV_CHAT(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>), msnuser-&gt;<a class="code" href="struct___msn_user.html#a44abdb98ec53b701bccff06cb3aae46a">passport</a>, NULL,
<a name="l00295"></a>00295                                                                 <a class="code" href="conversation_8h.html#a3635e89c9e02d67f03439d6524272754add974cbea163764e0caf40927d177ee0">PURPLE_CBFLAGS_NONE</a>, TRUE);
<a name="l00296"></a>00296                 <a class="code" href="servconn_8c.html#af452265defe176b9911ce175b1815903">msn_servconn_set_idle_timeout</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>, 0);
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (swboard-&gt;current_users &gt; 1)
<a name="l00299"></a>00299         {
<a name="l00300"></a>00300                 <a class="code" href="servconn_8c.html#af452265defe176b9911ce175b1815903">msn_servconn_set_idle_timeout</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>, 0);
<a name="l00301"></a>00301                 <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> == NULL ||
<a name="l00302"></a>00302                         purple_conversation_get_type(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>) != <a class="code" href="conversation_8h.html#a9e9f3ae232444332eb34f16aef64f721a91481bc864f7ebb9541adce5e332c838">PURPLE_CONV_TYPE_CHAT</a>)
<a name="l00303"></a>00303                 {
<a name="l00304"></a>00304                         GList *l;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 <span class="preprocessor">#if 0</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span>                        <span class="comment">/* this is bad - it causes msn_switchboard_close to be called on the</span>
<a name="l00308"></a>00308 <span class="comment">                         * switchboard we&#39;re in the middle of using :( */</span>
<a name="l00309"></a>00309                         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> != NULL)
<a name="l00310"></a>00310                                 purple_conversation_destroy(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>);
<a name="l00311"></a>00311 <span class="preprocessor">#endif</span>
<a name="l00312"></a>00312 <span class="preprocessor"></span>
<a name="l00313"></a>00313                         swboard-&gt;chat_id = <a class="code" href="switchboard_8c.html#accc9091ef0c219dae0b8183f8cc7c4dd">msn_switchboard_get_chat_id</a>();
<a name="l00314"></a>00314                         swboard-&gt;flag |= <a class="code" href="switchboard_8h.html#a38b40b31e3f28b31e68fd721802eed66a33d7d203b371f24ba1989229d74d1a58">MSN_SB_FLAG_IM</a>;
<a name="l00315"></a>00315                         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> = serv_got_joined_chat(account-&gt;<a class="code" href="struct___purple_account.html#ad5f87680b2657133cf67e05cfd828c41">gc</a>,
<a name="l00316"></a>00316                                                                                                  swboard-&gt;chat_id,
<a name="l00317"></a>00317                                                                                                  <span class="stringliteral">&quot;MSN Chat&quot;</span>);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319                         <span class="keywordflow">for</span> (l = swboard-&gt;users; l != NULL; l = l-&gt;next)
<a name="l00320"></a>00320                         {
<a name="l00321"></a>00321                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp_user;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323                                 tmp_user = ((<a class="code" href="struct___msn_user.html">MsnUser</a>*)l-&gt;data)-&gt;passport;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325                                 purple_conv_chat_add_user(PURPLE_CONV_CHAT(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>),
<a name="l00326"></a>00326                                                                                 tmp_user, NULL, <a class="code" href="conversation_8h.html#a3635e89c9e02d67f03439d6524272754add974cbea163764e0caf40927d177ee0">PURPLE_CBFLAGS_NONE</a>, TRUE);
<a name="l00327"></a>00327                         }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                         purple_conv_chat_add_user(PURPLE_CONV_CHAT(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>),
<a name="l00330"></a>00330                                                                         purple_account_get_username(account),
<a name="l00331"></a>00331                                                                         NULL, <a class="code" href="conversation_8h.html#a3635e89c9e02d67f03439d6524272754add974cbea163764e0caf40927d177ee0">PURPLE_CBFLAGS_NONE</a>, TRUE);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333                         g_free(swboard-&gt;im_user);
<a name="l00334"></a>00334                         swboard-&gt;im_user = NULL;
<a name="l00335"></a>00335                 }
<a name="l00336"></a>00336         }
<a name="l00337"></a>00337         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> == NULL)
<a name="l00338"></a>00338         {
<a name="l00339"></a>00339                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> = purple_find_conversation_with_account(<a class="code" href="conversation_8h.html#a9e9f3ae232444332eb34f16aef64f721a4e1c3df052e10fb1b3789ce5925496ab">PURPLE_CONV_TYPE_IM</a>,
<a name="l00340"></a>00340                                                                                                                         msnuser-&gt;<a class="code" href="struct___msn_user.html#a44abdb98ec53b701bccff06cb3aae46a">passport</a>, account);
<a name="l00341"></a>00341         }
<a name="l00342"></a>00342         <span class="keywordflow">else</span>
<a name="l00343"></a>00343         {
<a name="l00344"></a>00344                 <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;switchboard_add_user: This should not happen!\n&quot;</span>);
<a name="l00345"></a>00345         }
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 <span class="keyword">static</span> <a class="code" href="struct___purple_conversation.html">PurpleConversation</a> *
<a name="l00349"></a>00349 msn_switchboard_get_conv(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351         <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         g_return_val_if_fail(swboard != NULL, NULL);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> != NULL)
<a name="l00356"></a>00356                 <span class="keywordflow">return</span> swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;Switchboard with unassigned conversation\n&quot;</span>);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         account = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e4d714eda8cb92707b334047dea3c9e">session</a>-&gt;account;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362         <span class="keywordflow">return</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> = purple_conversation_new(<a class="code" href="conversation_8h.html#a9e9f3ae232444332eb34f16aef64f721a4e1c3df052e10fb1b3789ce5925496ab">PURPLE_CONV_TYPE_IM</a>,
<a name="l00363"></a>00363                                                                                                   account, swboard-&gt;im_user));
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00367"></a>00367 msn_switchboard_report_user(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5">PurpleMessageFlags</a> flags, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369         <a class="code" href="struct___purple_conversation.html">PurpleConversation</a> *conv;
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         g_return_if_fail(swboard != NULL);
<a name="l00372"></a>00372         g_return_if_fail(msg != NULL);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <span class="keywordflow">if</span> ((conv = msn_switchboard_get_conv(swboard)) != NULL)
<a name="l00375"></a>00375         {
<a name="l00376"></a>00376                 purple_conversation_write(conv, NULL, msg, flags, time(NULL));
<a name="l00377"></a>00377         }
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00381"></a>00381 swboard_error_helper(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <span class="keywordtype">int</span> reason, <span class="keyword">const</span> <span class="keywordtype">char</span> *passport)
<a name="l00382"></a>00382 {
<a name="l00383"></a>00383         g_return_if_fail(swboard != NULL);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;Error: Unable to call the user %s for reason %i\n&quot;</span>,
<a name="l00386"></a>00386                                            passport ? passport : <span class="stringliteral">&quot;(null)&quot;</span>, reason);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="comment">/* TODO: if current_users &gt; 0, this is probably a chat and an invite failed,</span>
<a name="l00389"></a>00389 <span class="comment">         * we should report that in the chat or something */</span>
<a name="l00390"></a>00390         <span class="keywordflow">if</span> (swboard-&gt;current_users == 0)
<a name="l00391"></a>00391         {
<a name="l00392"></a>00392                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a6d88be78fdf381044e78ad21f0e40a05">error</a> = reason;
<a name="l00393"></a>00393                 <a class="code" href="switchboard_8c.html#a1d4f32dc8d658e3ad893cd030f38966e">msn_switchboard_close</a>(swboard);
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00398"></a>00398 cal_error_helper(<a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans, <span class="keywordtype">int</span> reason)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00401"></a>00401         <span class="keyword">const</span> <span class="keywordtype">char</span> *passport;
<a name="l00402"></a>00402         <span class="keywordtype">char</span> **params;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         params = g_strsplit(trans-&gt;params, <span class="stringliteral">&quot; &quot;</span>, 0);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         passport = params[0];
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         swboard = trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a>;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;cal_error_helper: command %s failed for reason %i\n&quot;</span>,trans-&gt;command,reason);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         swboard_error_helper(swboard, reason, passport);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         g_strfreev(params);
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="keyword">static</span> gboolean
<a name="l00418"></a>00418 msg_resend_cb(gpointer data)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard = data;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;unqueuing unsent message to %s\n&quot;</span>, swboard-&gt;im_user);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424         <span class="keywordflow">if</span> (msn_switchboard_request(swboard)) {
<a name="l00425"></a>00425                 msn_switchboard_request_add_user(swboard, swboard-&gt;im_user);
<a name="l00426"></a>00426                 swboard-&gt;reconn_timeout_h = 0;
<a name="l00427"></a>00427         }
<a name="l00428"></a>00428         <span class="keywordflow">return</span> FALSE;
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="keywordtype">void</span>
<a name="l00432"></a>00432 msg_error_helper(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_message.html">MsnMessage</a> *msg, <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521">MsnMsgErrorType</a> error)
<a name="l00433"></a>00433 {
<a name="l00434"></a>00434         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         g_return_if_fail(cmdproc != NULL);
<a name="l00437"></a>00437         g_return_if_fail(msg     != NULL);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439         <span class="keywordflow">if</span> ((error != <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521a5b4b55fbf6d35bc004123f290a7a4157">MSN_MSG_ERROR_SB</a>) &amp;&amp; (msg-&gt;<a class="code" href="struct___msn_message.html#a032197f6759404b783e0f21127a7bb46">nak_cb</a> != NULL))
<a name="l00440"></a>00440                 msg-&gt;<a class="code" href="struct___msn_message.html#a032197f6759404b783e0f21127a7bb46">nak_cb</a>(msg, msg-&gt;<a class="code" href="struct___msn_message.html#a6bccb8c5dbf0e691a155b122f5a33a54">ack_data</a>);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444         <span class="comment">/* This is not good, and should be fixed somewhere else. */</span>
<a name="l00445"></a>00445         g_return_if_fail(swboard != NULL);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         <span class="keywordflow">if</span> (msg-&gt;type == MSN_MSG_TEXT)
<a name="l00448"></a>00448         {
<a name="l00449"></a>00449                 <span class="keyword">const</span> <span class="keywordtype">char</span> *format, *str_reason;
<a name="l00450"></a>00450                 <span class="keywordtype">char</span> *body_str, *body_enc, *pre, *post;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 <span class="preprocessor">#if 0</span>
<a name="l00453"></a>00453 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> == NULL)
<a name="l00454"></a>00454                 {
<a name="l00455"></a>00455                         <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="struct___msn_message.html#a1897071b35adf37f40b91122ebd78ad1">ack_ref</a>)
<a name="l00456"></a>00456                                 <a class="code" href="msg_8c.html#ac90a4fbb4c0fb2f9ff60ff4476c26148">msn_message_unref</a>(msg);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458                         <span class="keywordflow">return</span>;
<a name="l00459"></a>00459                 }
<a name="l00460"></a>00460 <span class="preprocessor">#endif</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>
<a name="l00462"></a>00462                 <span class="keywordflow">if</span> (error == <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521a52e92b736ae87ed1c41dd6d9fd98d1c3">MSN_MSG_ERROR_TIMEOUT</a>)
<a name="l00463"></a>00463                 {
<a name="l00464"></a>00464                         str_reason = _(<span class="stringliteral">&quot;Message may have not been sent &quot;</span>
<a name="l00465"></a>00465                                                    <span class="stringliteral">&quot;because a timeout occurred:&quot;</span>);
<a name="l00466"></a>00466                 }
<a name="l00467"></a>00467                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error == <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521a5b4b55fbf6d35bc004123f290a7a4157">MSN_MSG_ERROR_SB</a>)
<a name="l00468"></a>00468                 {
<a name="l00469"></a>00469                         <a class="code" href="struct___msn_session.html">MsnSession</a> *session = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e4d714eda8cb92707b334047dea3c9e">session</a>;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471                         <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct___msn_session.html#a1c2cea86a9f2fdef797a6535a2047b46">destroying</a> &amp;&amp; msg-&gt;retries &amp;&amp;     swboard-&gt;im_user &amp;&amp;
<a name="l00472"></a>00472                                 (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a6d88be78fdf381044e78ad21f0e40a05">error</a> == <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a16f3d8d1e23b2093aaadf418220078db">MSN_SB_ERROR_CONNECTION</a> ||
<a name="l00473"></a>00473                                         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a6d88be78fdf381044e78ad21f0e40a05">error</a> == <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743addb0db5999927bc637030325707761c9">MSN_SB_ERROR_UNKNOWN</a>)) {
<a name="l00474"></a>00474                                 <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *new_sw = msn_session_find_swboard(session,
<a name="l00475"></a>00475                                         swboard-&gt;im_user);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477                                 <span class="keywordflow">if</span> (new_sw == NULL || new_sw-&gt;reconn_timeout_h == 0) {
<a name="l00478"></a>00478                                         new_sw = <a class="code" href="switchboard_8c.html#af4e32e50c2cc595d08313a6ad554b20e">msn_switchboard_new</a>(session);
<a name="l00479"></a>00479                                         new_sw-&gt;im_user = g_strdup(swboard-&gt;im_user);
<a name="l00480"></a>00480                                         new_sw-&gt;reconn_timeout_h = <a class="code" href="eventloop_8c.html#a17752ee1277e09350a612b0b88921fc5">purple_timeout_add_seconds</a>(3, msg_resend_cb, new_sw);
<a name="l00481"></a>00481                                         new_sw-&gt;flag |= <a class="code" href="switchboard_8h.html#a38b40b31e3f28b31e68fd721802eed66a33d7d203b371f24ba1989229d74d1a58">MSN_SB_FLAG_IM</a>;
<a name="l00482"></a>00482                                 }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484                                 body_str = msn_message_to_string(msg);
<a name="l00485"></a>00485                                 body_enc = g_markup_escape_text(body_str, -1);
<a name="l00486"></a>00486                                 g_free(body_str);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488                                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;queuing unsent message to %s: %s\n&quot;</span>,
<a name="l00489"></a>00489                                         swboard-&gt;im_user, body_enc);
<a name="l00490"></a>00490                                 g_free(body_enc);
<a name="l00491"></a>00491                                 msn_send_im_message(session, msg);
<a name="l00492"></a>00492                                 msg-&gt;retries--;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494                                 <span class="keywordflow">return</span>;
<a name="l00495"></a>00495                         }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497                         <span class="keywordflow">switch</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a6d88be78fdf381044e78ad21f0e40a05">error</a>)
<a name="l00498"></a>00498                         {
<a name="l00499"></a>00499                                 <span class="keywordflow">case</span> <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a820af70e11df8e42f5160135d5905857">MSN_SB_ERROR_OFFLINE</a>:
<a name="l00500"></a>00500                                         str_reason = _(<span class="stringliteral">&quot;Message could not be sent, &quot;</span>
<a name="l00501"></a>00501                                                                    <span class="stringliteral">&quot;not allowed while invisible:&quot;</span>);
<a name="l00502"></a>00502                                         <span class="keywordflow">break</span>;
<a name="l00503"></a>00503                                 <span class="keywordflow">case</span> <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a28c6b0aa4f55d707ac5d41aee08e7210">MSN_SB_ERROR_USER_OFFLINE</a>:
<a name="l00504"></a>00504                                         str_reason = _(<span class="stringliteral">&quot;Message could not be sent &quot;</span>
<a name="l00505"></a>00505                                                                    <span class="stringliteral">&quot;because the user is offline:&quot;</span>);
<a name="l00506"></a>00506                                         <span class="keywordflow">break</span>;
<a name="l00507"></a>00507                                 <span class="keywordflow">case</span> <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a16f3d8d1e23b2093aaadf418220078db">MSN_SB_ERROR_CONNECTION</a>:
<a name="l00508"></a>00508                                         str_reason = _(<span class="stringliteral">&quot;Message could not be sent &quot;</span>
<a name="l00509"></a>00509                                                                    <span class="stringliteral">&quot;because a connection error occurred:&quot;</span>);
<a name="l00510"></a>00510                                         <span class="keywordflow">break</span>;
<a name="l00511"></a>00511                                 <span class="keywordflow">case</span> <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a7c5b793929d0633966b922414070a1d3">MSN_SB_ERROR_TOO_FAST</a>:
<a name="l00512"></a>00512                                         str_reason = _(<span class="stringliteral">&quot;Message could not be sent &quot;</span>
<a name="l00513"></a>00513                                                                    <span class="stringliteral">&quot;because we are sending too quickly:&quot;</span>);
<a name="l00514"></a>00514                                         <span class="keywordflow">break</span>;
<a name="l00515"></a>00515                                 <span class="keywordflow">case</span> <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a7b82adc858a67c122dae3947a6b3e4c8">MSN_SB_ERROR_AUTHFAILED</a>:
<a name="l00516"></a>00516                                         str_reason = _(<span class="stringliteral">&quot;Message could not be sent &quot;</span>
<a name="l00517"></a>00517                                                                    <span class="stringliteral">&quot;because we were unable to establish a &quot;</span>
<a name="l00518"></a>00518                                                                    <span class="stringliteral">&quot;session with the server. This is &quot;</span>
<a name="l00519"></a>00519                                                                    <span class="stringliteral">&quot;likely a server problem, try again in &quot;</span>
<a name="l00520"></a>00520                                                                    <span class="stringliteral">&quot;a few minutes:&quot;</span>);
<a name="l00521"></a>00521                                         <span class="keywordflow">break</span>;
<a name="l00522"></a>00522                                 <span class="keywordflow">default</span>:
<a name="l00523"></a>00523                                         str_reason = _(<span class="stringliteral">&quot;Message could not be sent &quot;</span>
<a name="l00524"></a>00524                                                                    <span class="stringliteral">&quot;because an error with &quot;</span>
<a name="l00525"></a>00525                                                                    <span class="stringliteral">&quot;the switchboard occurred:&quot;</span>);
<a name="l00526"></a>00526                                         <span class="keywordflow">break</span>;
<a name="l00527"></a>00527                         }
<a name="l00528"></a>00528                 }
<a name="l00529"></a>00529                 <span class="keywordflow">else</span>
<a name="l00530"></a>00530                 {
<a name="l00531"></a>00531                         str_reason = _(<span class="stringliteral">&quot;Message may have not been sent &quot;</span>
<a name="l00532"></a>00532                                                    <span class="stringliteral">&quot;because an unknown error occurred:&quot;</span>);
<a name="l00533"></a>00533                 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535                 body_str = msn_message_to_string(msg);
<a name="l00536"></a>00536                 body_enc = g_markup_escape_text(body_str, -1);
<a name="l00537"></a>00537                 g_free(body_str);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539                 format = <a class="code" href="msg_8c.html#aef49ca98f6d74618e256325284a7d447">msn_message_get_header_value</a>(msg, <span class="stringliteral">&quot;X-MMS-IM-Format&quot;</span>);
<a name="l00540"></a>00540                 <a class="code" href="msnutils_8c.html#a162fce74206f32e10b58b167c02eeaee">msn_parse_format</a>(format, &amp;pre, &amp;post);
<a name="l00541"></a>00541                 body_str = g_strdup_printf(<span class="stringliteral">&quot;%s%s%s&quot;</span>, pre ? pre : <span class="stringliteral">&quot;&quot;</span>,
<a name="l00542"></a>00542                                                                    body_enc ? body_enc : <span class="stringliteral">&quot;&quot;</span>, post ? post : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00543"></a>00543                 g_free(body_enc);
<a name="l00544"></a>00544                 g_free(pre);
<a name="l00545"></a>00545                 g_free(post);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547                 msn_switchboard_report_user(swboard, <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5ac5afe562ad591ce873bde03e0a271765">PURPLE_MESSAGE_ERROR</a>,
<a name="l00548"></a>00548                                                                         str_reason);
<a name="l00549"></a>00549                 msn_switchboard_report_user(swboard, <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5a18eced8ede5e983f69b1ae449c9a0d68">PURPLE_MESSAGE_RAW</a>,
<a name="l00550"></a>00550                                                                         body_str);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552                 g_free(body_str);
<a name="l00553"></a>00553         }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555         <span class="comment">/* If a timeout occures we will want the msg around just in case we</span>
<a name="l00556"></a>00556 <span class="comment">         * receive the ACK after the timeout. */</span>
<a name="l00557"></a>00557         <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="struct___msn_message.html#a1897071b35adf37f40b91122ebd78ad1">ack_ref</a> &amp;&amp; error != <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521a52e92b736ae87ed1c41dd6d9fd98d1c3">MSN_MSG_ERROR_TIMEOUT</a>)
<a name="l00558"></a>00558         {
<a name="l00559"></a>00559                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad6a8be692dd612a9d6356aecd15263e8">ack_list</a> = g_list_remove(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad6a8be692dd612a9d6356aecd15263e8">ack_list</a>, msg);
<a name="l00560"></a>00560                 <a class="code" href="msg_8c.html#ac90a4fbb4c0fb2f9ff60ff4476c26148">msn_message_unref</a>(msg);
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="comment">/**************************************************************************</span>
<a name="l00565"></a>00565 <span class="comment"> * Message Stuff</span>
<a name="l00566"></a>00566 <span class="comment"> **************************************************************************/</span>
<a name="l00567"></a>00567 
<a name="l00569"></a>00569 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00570"></a>00570 msg_error(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans, <span class="keywordtype">int</span> error)
<a name="l00571"></a>00571 {
<a name="l00572"></a>00572         msg_error_helper(cmdproc, trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a>, <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521a1a0153f00dc9c855e9f25f9664b3e8f4">MSN_MSG_ERROR_UNKNOWN</a>);
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 gboolean
<a name="l00576"></a><a class="code" href="switchboard_8h.html#a4c2313ab1de5fd17e34dfbfa08e0e023">00576</a> <a class="code" href="switchboard_8c.html#a4c2313ab1de5fd17e34dfbfa08e0e023">msn_switchboard_can_send</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l00577"></a>00577 {
<a name="l00578"></a>00578         g_return_val_if_fail(swboard != NULL, FALSE);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad4d89cd056a3cf1a028d372baee5975e">empty</a> || !g_queue_is_empty(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a3e79c70f19238de170f49c9c2a77aa46">msg_queue</a>))
<a name="l00581"></a>00581                 <span class="keywordflow">return</span> FALSE;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         <span class="keywordflow">return</span> TRUE;
<a name="l00584"></a>00584 }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 <span class="comment">/**************************************************************************</span>
<a name="l00587"></a>00587 <span class="comment"> * Switchboard Commands</span>
<a name="l00588"></a>00588 <span class="comment"> **************************************************************************/</span>
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00591"></a>00591 ans_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00596"></a>00596         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#adeadaf979f3695b27ddd84e6b1a283e9">ready</a> = TRUE;
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00600"></a>00600 bye_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00603"></a>00603         <span class="keyword">const</span> <span class="keywordtype">char</span> *user;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00606"></a>00606         user = cmd-&gt;params[0];
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         <span class="comment">/* cmdproc-&gt;data is set to NULL when the switchboard is destroyed;</span>
<a name="l00609"></a>00609 <span class="comment">         * we may get a bye shortly thereafter. */</span>
<a name="l00610"></a>00610         g_return_if_fail(swboard != NULL);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         <span class="keywordflow">if</span> (!(swboard-&gt;flag &amp; <a class="code" href="switchboard_8h.html#a38b40b31e3f28b31e68fd721802eed66a33d7d203b371f24ba1989229d74d1a58">MSN_SB_FLAG_IM</a>) &amp;&amp; (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> != NULL))
<a name="l00613"></a>00613                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;bye_cmd: helper bug\n&quot;</span>);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> == NULL)
<a name="l00616"></a>00616         {
<a name="l00617"></a>00617                 <span class="comment">/* This is a helper switchboard */</span>
<a name="l00618"></a>00618                 <a class="code" href="switchboard_8c.html#ad8a057029a45c43bdb2a51022ec9e1c1">msn_switchboard_destroy</a>(swboard);
<a name="l00619"></a>00619         }
<a name="l00620"></a>00620         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((swboard-&gt;current_users &gt; 1) ||
<a name="l00621"></a>00621                          (purple_conversation_get_type(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>) == <a class="code" href="conversation_8h.html#a9e9f3ae232444332eb34f16aef64f721a91481bc864f7ebb9541adce5e332c838">PURPLE_CONV_TYPE_CHAT</a>))
<a name="l00622"></a>00622         {
<a name="l00623"></a>00623                 GList *passport;
<a name="l00624"></a>00624                 <span class="comment">/* This is a switchboard used for a chat */</span>
<a name="l00625"></a>00625                 purple_conv_chat_remove_user(PURPLE_CONV_CHAT(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>), user, NULL);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627                 passport = g_list_find_custom(swboard-&gt;users, user, (GCompareFunc)strcmp);
<a name="l00628"></a>00628                 <span class="keywordflow">if</span> (passport)
<a name="l00629"></a>00629                         g_free(passport-&gt;data);
<a name="l00630"></a>00630                 <span class="keywordflow">else</span>
<a name="l00631"></a>00631                         <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;Can&#39;t find user %s in the switchboard\n&quot;</span>, user);
<a name="l00632"></a>00632                 swboard-&gt;users = g_list_delete_link(swboard-&gt;users, passport);
<a name="l00633"></a>00633                 swboard-&gt;current_users--;
<a name="l00634"></a>00634                 <span class="keywordflow">if</span> (swboard-&gt;current_users == 0)
<a name="l00635"></a>00635                         <a class="code" href="switchboard_8c.html#ad8a057029a45c43bdb2a51022ec9e1c1">msn_switchboard_destroy</a>(swboard);
<a name="l00636"></a>00636         }
<a name="l00637"></a>00637         <span class="keywordflow">else</span>
<a name="l00638"></a>00638         {
<a name="l00639"></a>00639                 <span class="comment">/* This is a switchboard used for a im session */</span>
<a name="l00640"></a>00640                 <a class="code" href="switchboard_8c.html#ad8a057029a45c43bdb2a51022ec9e1c1">msn_switchboard_destroy</a>(swboard);
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00645"></a>00645 iro_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651         swboard-&gt;total_users = atoi(cmd-&gt;params[2]);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         msn_switchboard_add_user(swboard, cmd-&gt;params[3]);
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00657"></a>00657 joi_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00658"></a>00658 {
<a name="l00659"></a>00659         <a class="code" href="struct___msn_session.html">MsnSession</a> *session;
<a name="l00660"></a>00660         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00661"></a>00661         <span class="keyword">const</span> <span class="keywordtype">char</span> *passport;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         passport = cmd-&gt;params[0];
<a name="l00664"></a>00664 
<a name="l00665"></a>00665         session = cmdproc-&gt;session;
<a name="l00666"></a>00666         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668         msn_switchboard_add_user(swboard, passport);
<a name="l00669"></a>00669 
<a name="l00670"></a>00670         msn_sbconn_process_queue(swboard);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         <span class="keywordflow">if</span> (!session-&gt;http_method)
<a name="l00673"></a>00673                 send_clientcaps(swboard);
<a name="l00674"></a>00674 
<a name="l00675"></a>00675         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a80e829cd29e904661f883a38012b0898">closed</a>)
<a name="l00676"></a>00676                 <a class="code" href="switchboard_8c.html#a1d4f32dc8d658e3ad893cd030f38966e">msn_switchboard_close</a>(swboard);
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00680"></a>00680 msg_cmd_post(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd, <span class="keywordtype">char</span> *payload, <span class="keywordtype">size_t</span> len)
<a name="l00681"></a>00681 {
<a name="l00682"></a>00682         <a class="code" href="struct___msn_message.html">MsnMessage</a> *msg;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684         msg = <a class="code" href="msg_8c.html#a02322c4d01135a07867a7a1bd8b7917a">msn_message_new_from_cmd</a>(cmdproc-&gt;session, cmd);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <a class="code" href="msg_8c.html#a82be33e3c290cab3d89e33372c5f4685">msn_message_parse_payload</a>(msg, payload, len,
<a name="l00687"></a>00687                                         MSG_LINE_DEM,MSG_BODY_DEM);
<a name="l00688"></a>00688         <span class="keywordflow">if</span> (purple_debug_is_verbose())
<a name="l00689"></a>00689                 msn_message_show_readable(msg, <span class="stringliteral">&quot;SB RECV&quot;</span>, FALSE);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691         g_free (msg-&gt;remote_user);
<a name="l00692"></a>00692         msg-&gt;remote_user = g_strdup(cmd-&gt;params[0]);
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         msn_cmdproc_process_msg(cmdproc, msg);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696         <a class="code" href="msg_8c.html#ac90a4fbb4c0fb2f9ff60ff4476c26148">msn_message_unref</a>(msg);
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00700"></a>00700 msg_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00701"></a>00701 {
<a name="l00702"></a>00702         cmd-&gt;payload_len = atoi(cmd-&gt;params[2]);
<a name="l00703"></a>00703         cmdproc-&gt;last_cmd-&gt;payload_cb = msg_cmd_post;
<a name="l00704"></a>00704 }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00707"></a>00707 ubm_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00708"></a>00708 {
<a name="l00709"></a>00709         <a class="code" href="debug_8h.html#a89b6474a316d3e177cc91b35897ae20a">purple_debug_misc</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;get UBM...\n&quot;</span>);
<a name="l00710"></a>00710         cmd-&gt;payload_len = atoi(cmd-&gt;params[5]);
<a name="l00711"></a>00711         cmdproc-&gt;last_cmd-&gt;payload_cb = msg_cmd_post;
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00715"></a>00715 nak_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00716"></a>00716 {
<a name="l00717"></a>00717         <a class="code" href="struct___msn_message.html">MsnMessage</a> *msg;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719         msg = cmd-&gt;trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a>;
<a name="l00720"></a>00720         g_return_if_fail(msg != NULL);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         msg_error_helper(cmdproc, msg, <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521af0e6587ce4d89946f721c369378a02f5">MSN_MSG_ERROR_NAK</a>);
<a name="l00723"></a>00723         cmd-&gt;trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a> = NULL;
<a name="l00724"></a>00724 }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00727"></a>00727 ack_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00730"></a>00730         <a class="code" href="struct___msn_message.html">MsnMessage</a> *msg;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732         msg = cmd-&gt;trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a>;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734         <span class="keywordflow">if</span> (msg-&gt;part &amp;&amp; msg-&gt;part-&gt;ack_cb != NULL)
<a name="l00735"></a>00735                 msg-&gt;part-&gt;ack_cb(msg-&gt;part, msg-&gt;part-&gt;ack_data);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00738"></a>00738         <span class="keywordflow">if</span> (swboard)
<a name="l00739"></a>00739                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad6a8be692dd612a9d6356aecd15263e8">ack_list</a> = g_list_remove(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad6a8be692dd612a9d6356aecd15263e8">ack_list</a>, msg);
<a name="l00740"></a>00740         <a class="code" href="msg_8c.html#ac90a4fbb4c0fb2f9ff60ff4476c26148">msn_message_unref</a>(msg);
<a name="l00741"></a>00741         cmd-&gt;trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a> = NULL;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00745"></a>00745 out_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00746"></a>00746 {
<a name="l00747"></a>00747         <a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc;
<a name="l00748"></a>00748         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00749"></a>00749 
<a name="l00750"></a>00750         gc = cmdproc-&gt;session-&gt;account-&gt;<a class="code" href="struct___purple_account.html#ad5f87680b2657133cf67e05cfd828c41">gc</a>;
<a name="l00751"></a>00751         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (swboard-&gt;current_users &gt; 1)
<a name="l00754"></a>00754                 serv_got_chat_left(gc, swboard-&gt;chat_id);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <a class="code" href="switchboard_8c.html#a4ed80daf09f6033b684e4e04cb4ae63a">msn_switchboard_disconnect</a>(swboard);
<a name="l00757"></a>00757 }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00760"></a>00760 usr_cmd(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00761"></a>00761 {
<a name="l00762"></a>00762         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 <span class="preprocessor">#if 0</span>
<a name="l00767"></a>00767 <span class="preprocessor"></span>        GList *l;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         <span class="keywordflow">for</span> (l = swboard-&gt;users; l != NULL; l = l-&gt;next)
<a name="l00770"></a>00770         {
<a name="l00771"></a>00771                 <span class="keyword">const</span> <span class="keywordtype">char</span> *user;
<a name="l00772"></a>00772                 user = l-&gt;data;
<a name="l00773"></a>00773 
<a name="l00774"></a>00774                 msn_cmdproc_send(cmdproc, <span class="stringliteral">&quot;CAL&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, user);
<a name="l00775"></a>00775         }
<a name="l00776"></a>00776 <span class="preprocessor">#endif</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>
<a name="l00778"></a>00778         swboard-&gt;<a class="code" href="struct___msn_switch_board.html#adeadaf979f3695b27ddd84e6b1a283e9">ready</a> = TRUE;
<a name="l00779"></a>00779         <a class="code" href="cmdproc_8c.html#aa29159a8480ecb03bcbfb7399ee4b172">msn_cmdproc_process_queue</a>(cmdproc);
<a name="l00780"></a>00780 }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 <span class="comment">/**************************************************************************</span>
<a name="l00783"></a>00783 <span class="comment"> * Message Handlers</span>
<a name="l00784"></a>00784 <span class="comment"> **************************************************************************/</span>
<a name="l00785"></a>00785 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00786"></a>00786 clientcaps_msg(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_message.html">MsnMessage</a> *msg)
<a name="l00787"></a>00787 {
<a name="l00788"></a>00788 <span class="preprocessor">#if 0</span>
<a name="l00789"></a>00789 <span class="preprocessor"></span>        <a class="code" href="struct___msn_session.html">MsnSession</a> *session;
<a name="l00790"></a>00790         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00791"></a>00791         <a class="code" href="struct___msn_user.html">MsnUser</a> *user;
<a name="l00792"></a>00792         GHashTable *clientcaps;
<a name="l00793"></a>00793         <span class="keyword">const</span> <span class="keywordtype">char</span> *value;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795         <span class="keywordtype">char</span> *passport = msg-&gt;sender;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797         session = cmdproc-&gt;session;
<a name="l00798"></a>00798         swboard = cmdproc-&gt;servconn-&gt;swboard;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         clientcaps = <a class="code" href="msg_8c.html#a543934d3a7fe38ec258e475b5bbdc786">msn_message_get_hashtable_from_body</a>(msg);
<a name="l00801"></a>00801 <span class="preprocessor">#endif</span>
<a name="l00802"></a>00802 <span class="preprocessor"></span>}
<a name="l00803"></a>00803 
<a name="l00804"></a>00804 <span class="keywordtype">void</span>
<a name="l00805"></a><a class="code" href="switchboard_8h.html#a4a5fc4fe01c798663f6cab66234961b6">00805</a> <a class="code" href="switchboard_8c.html#a4a5fc4fe01c798663f6cab66234961b6">msn_switchboard_show_ink</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <span class="keyword">const</span> <span class="keywordtype">char</span> *passport,
<a name="l00806"></a>00806                          <span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808         <a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc;
<a name="l00809"></a>00809         guchar *image_data;
<a name="l00810"></a>00810         <span class="keywordtype">size_t</span> image_len;
<a name="l00811"></a>00811         <span class="keywordtype">int</span> imgid;
<a name="l00812"></a>00812         <span class="keywordtype">char</span> *image_msg;
<a name="l00813"></a>00813 
<a name="l00814"></a>00814         <span class="keywordflow">if</span> (!purple_str_has_prefix(data, <span class="stringliteral">&quot;base64:&quot;</span>))
<a name="l00815"></a>00815         {
<a name="l00816"></a>00816                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;Ignoring Ink not in Base64 format.\n&quot;</span>);
<a name="l00817"></a>00817                 <span class="keywordflow">return</span>;
<a name="l00818"></a>00818         }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820         gc = purple_account_get_connection(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e4d714eda8cb92707b334047dea3c9e">session</a>-&gt;account);
<a name="l00821"></a>00821 
<a name="l00822"></a>00822         data += <span class="keyword">sizeof</span>(<span class="stringliteral">&quot;base64:&quot;</span>) - 1;
<a name="l00823"></a>00823         image_data = purple_base64_decode(data, &amp;image_len);
<a name="l00824"></a>00824         <span class="keywordflow">if</span> (!image_data || !image_len)
<a name="l00825"></a>00825         {
<a name="l00826"></a>00826                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;Unable to decode Ink from Base64 format.\n&quot;</span>);
<a name="l00827"></a>00827                 <span class="keywordflow">return</span>;
<a name="l00828"></a>00828         }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830         imgid = purple_imgstore_add_with_id(image_data, image_len, NULL);
<a name="l00831"></a>00831         image_msg = g_strdup_printf(<span class="stringliteral">&quot;&lt;IMG ID=&#39;%d&#39;&gt;&quot;</span>, imgid);
<a name="l00832"></a>00832 
<a name="l00833"></a>00833         <span class="keywordflow">if</span> (swboard-&gt;current_users &gt; 1 ||
<a name="l00834"></a>00834                 ((swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> != NULL) &amp;&amp;
<a name="l00835"></a>00835                  purple_conversation_get_type(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a>) == <a class="code" href="conversation_8h.html#a9e9f3ae232444332eb34f16aef64f721a91481bc864f7ebb9541adce5e332c838">PURPLE_CONV_TYPE_CHAT</a>))
<a name="l00836"></a>00836                 serv_got_chat_in(gc, swboard-&gt;chat_id, passport, 0, image_msg,
<a name="l00837"></a>00837                                                  time(NULL));
<a name="l00838"></a>00838         <span class="keywordflow">else</span>
<a name="l00839"></a>00839                 serv_got_im(gc, passport, image_msg, 0, time(NULL));
<a name="l00840"></a>00840 
<a name="l00841"></a>00841         purple_imgstore_unref_by_id(imgid);
<a name="l00842"></a>00842         g_free(image_msg);
<a name="l00843"></a>00843 }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 <span class="comment">/**************************************************************************</span>
<a name="l00846"></a>00846 <span class="comment"> * Connect stuff</span>
<a name="l00847"></a>00847 <span class="comment"> **************************************************************************/</span>
<a name="l00848"></a>00848 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00849"></a>00849 ans_usr_error(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans, <span class="keywordtype">int</span> error);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00852"></a>00852 connect_cb(<a class="code" href="struct___msn_serv_conn.html">MsnServConn</a> *servconn)
<a name="l00853"></a>00853 {
<a name="l00854"></a>00854         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00855"></a>00855         <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans;
<a name="l00856"></a>00856         <a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc;
<a name="l00857"></a>00857         <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account;
<a name="l00858"></a>00858         <span class="keywordtype">char</span> *username;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860         cmdproc = servconn-&gt;<a class="code" href="struct___msn_serv_conn.html#ad48d2b93fe2cc85d732a0035958f7fb0">cmdproc</a>;
<a name="l00861"></a>00861         g_return_if_fail(cmdproc != NULL);
<a name="l00862"></a>00862 
<a name="l00863"></a>00863         account = cmdproc-&gt;session-&gt;account;
<a name="l00864"></a>00864         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00865"></a>00865         g_return_if_fail(swboard != NULL);
<a name="l00866"></a>00866 
<a name="l00867"></a>00867         username = g_strdup_printf(<span class="stringliteral">&quot;%s;{%s}&quot;</span>,
<a name="l00868"></a>00868                                    purple_account_get_username(account),
<a name="l00869"></a>00869                                    servconn-&gt;<a class="code" href="struct___msn_serv_conn.html#ac7e2a348f8aac1ad8102a68fbf40da67">session</a>-&gt;guid);
<a name="l00870"></a>00870 
<a name="l00871"></a>00871         <span class="keywordflow">if</span> (<a class="code" href="switchboard_8c.html#acd181c10ecb40e2b6b54b28762fee757">msn_switchboard_is_invited</a>(swboard))
<a name="l00872"></a>00872         {
<a name="l00873"></a>00873                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ad4d89cd056a3cf1a028d372baee5975e">empty</a> = FALSE;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875                 trans = msn_transaction_new(cmdproc, <span class="stringliteral">&quot;ANS&quot;</span>, <span class="stringliteral">&quot;%s %s %s&quot;</span>,
<a name="l00876"></a>00876                                                                         username,
<a name="l00877"></a>00877                                                                         swboard-&gt;auth_key, swboard-&gt;session_id);
<a name="l00878"></a>00878         }
<a name="l00879"></a>00879         <span class="keywordflow">else</span>
<a name="l00880"></a>00880         {
<a name="l00881"></a>00881                 trans = msn_transaction_new(cmdproc, <span class="stringliteral">&quot;USR&quot;</span>, <span class="stringliteral">&quot;%s %s&quot;</span>,
<a name="l00882"></a>00882                                                                         username,
<a name="l00883"></a>00883                                                                         swboard-&gt;auth_key);
<a name="l00884"></a>00884         }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886         msn_transaction_set_error_cb(trans, ans_usr_error);
<a name="l00887"></a>00887         msn_transaction_set_data(trans, swboard);
<a name="l00888"></a>00888         <a class="code" href="cmdproc_8c.html#ab99f15c122d9023e3e2815ad62e9f76c">msn_cmdproc_send_trans</a>(cmdproc, trans);
<a name="l00889"></a>00889 
<a name="l00890"></a>00890         g_free(username);
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00894"></a>00894 ans_usr_error(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans, <span class="keywordtype">int</span> error)
<a name="l00895"></a>00895 {
<a name="l00896"></a>00896         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00897"></a>00897         <span class="keywordtype">char</span> **params;
<a name="l00898"></a>00898         <span class="keywordtype">char</span> *passport;
<a name="l00899"></a>00899         <span class="keywordtype">int</span> reason = <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743addb0db5999927bc637030325707761c9">MSN_SB_ERROR_UNKNOWN</a>;
<a name="l00900"></a>00900 
<a name="l00901"></a>00901         <span class="keywordflow">if</span> (error == 911)
<a name="l00902"></a>00902         {
<a name="l00903"></a>00903                 reason = <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a7b82adc858a67c122dae3947a6b3e4c8">MSN_SB_ERROR_AUTHFAILED</a>;
<a name="l00904"></a>00904         }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906         <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;ans_usr_error: command %s gave error %i\n&quot;</span>, trans-&gt;command, error);
<a name="l00907"></a>00907 
<a name="l00908"></a>00908         params = g_strsplit(trans-&gt;params, <span class="stringliteral">&quot; &quot;</span>, 0);
<a name="l00909"></a>00909         passport = params[0];
<a name="l00910"></a>00910         swboard = trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a>;
<a name="l00911"></a>00911 
<a name="l00912"></a>00912         swboard_error_helper(swboard, reason, passport);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         g_strfreev(params);
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00918"></a>00918 disconnect_cb(<a class="code" href="struct___msn_serv_conn.html">MsnServConn</a> *servconn)
<a name="l00919"></a>00919 {
<a name="l00920"></a>00920         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922         swboard = servconn-&gt;<a class="code" href="struct___msn_serv_conn.html#ad48d2b93fe2cc85d732a0035958f7fb0">cmdproc</a>-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00923"></a>00923         g_return_if_fail(swboard != NULL);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925         <a class="code" href="servconn_8c.html#a6c834390471c12349d37d518a5a8cbcc">msn_servconn_set_disconnect_cb</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>, NULL);
<a name="l00926"></a>00926 
<a name="l00927"></a>00927         <a class="code" href="switchboard_8c.html#ad8a057029a45c43bdb2a51022ec9e1c1">msn_switchboard_destroy</a>(swboard);
<a name="l00928"></a>00928 }
<a name="l00929"></a>00929 
<a name="l00930"></a>00930 gboolean
<a name="l00931"></a><a class="code" href="switchboard_8h.html#a79d4edee05958c5e152b6782f1fc4ef2">00931</a> <a class="code" href="switchboard_8c.html#a79d4edee05958c5e152b6782f1fc4ef2">msn_switchboard_connect</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <span class="keyword">const</span> <span class="keywordtype">char</span> *host, <span class="keywordtype">int</span> port)
<a name="l00932"></a>00932 {
<a name="l00933"></a>00933         g_return_val_if_fail(swboard != NULL, FALSE);
<a name="l00934"></a>00934 
<a name="l00935"></a>00935         <a class="code" href="servconn_8c.html#a2f56be5785e0a6b1960bfa721744c582">msn_servconn_set_connect_cb</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>, connect_cb);
<a name="l00936"></a>00936         <a class="code" href="servconn_8c.html#a6c834390471c12349d37d518a5a8cbcc">msn_servconn_set_disconnect_cb</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>, disconnect_cb);
<a name="l00937"></a>00937 
<a name="l00938"></a>00938         <span class="keywordflow">return</span> <a class="code" href="servconn_8c.html#a85515b5f06bbe9de06b56b8806de0d72">msn_servconn_connect</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>, host, port, FALSE);
<a name="l00939"></a>00939 }
<a name="l00940"></a>00940 
<a name="l00941"></a>00941 <span class="keywordtype">void</span>
<a name="l00942"></a><a class="code" href="switchboard_8h.html#a4ed80daf09f6033b684e4e04cb4ae63a">00942</a> <a class="code" href="switchboard_8c.html#a4ed80daf09f6033b684e4e04cb4ae63a">msn_switchboard_disconnect</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l00943"></a>00943 {
<a name="l00944"></a>00944         g_return_if_fail(swboard != NULL);
<a name="l00945"></a>00945 
<a name="l00946"></a>00946         <a class="code" href="servconn_8c.html#aa54d0a886f5de5b49113ec56f88f72c1">msn_servconn_disconnect</a>(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ae0a079e783b2a9e0496c95c5c17e2c59">servconn</a>);
<a name="l00947"></a>00947 }
<a name="l00948"></a>00948 
<a name="l00949"></a>00949 <span class="comment">/**************************************************************************</span>
<a name="l00950"></a>00950 <span class="comment"> * Call stuff</span>
<a name="l00951"></a>00951 <span class="comment"> **************************************************************************/</span>
<a name="l00952"></a>00952 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00953"></a>00953 got_cal(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l00954"></a>00954 {
<a name="l00955"></a>00955 <span class="preprocessor">#if 0</span>
<a name="l00956"></a>00956 <span class="preprocessor"></span>        <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l00957"></a>00957         <span class="keyword">const</span> <span class="keywordtype">char</span> *user;
<a name="l00958"></a>00958 
<a name="l00959"></a>00959         swboard = cmdproc-&gt;<a class="code" href="struct___msn_cmd_proc.html#a86253bae8f3e6d2530bf298cc2c088c6">data</a>;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         user = cmd-&gt;params[0];
<a name="l00962"></a>00962 
<a name="l00963"></a>00963         msn_switchboard_add_user(swboard, user);
<a name="l00964"></a>00964 <span class="preprocessor">#endif</span>
<a name="l00965"></a>00965 <span class="preprocessor"></span>}
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00968"></a>00968 cal_timeout(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans)
<a name="l00969"></a>00969 {
<a name="l00970"></a>00970         <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;cal_timeout: command %s timed out\n&quot;</span>, trans-&gt;command);
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         cal_error_helper(trans, <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743addb0db5999927bc637030325707761c9">MSN_SB_ERROR_UNKNOWN</a>);
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00976"></a>00976 cal_error(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans, <span class="keywordtype">int</span> error)
<a name="l00977"></a>00977 {
<a name="l00978"></a>00978         <span class="keywordtype">int</span> reason = <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743addb0db5999927bc637030325707761c9">MSN_SB_ERROR_UNKNOWN</a>;
<a name="l00979"></a>00979         <a class="code" href="struct___msn_message.html">MsnMessage</a> *msg;
<a name="l00980"></a>00980         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard = trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a>;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982         <span class="keywordflow">if</span> (error == 215)
<a name="l00983"></a>00983         {
<a name="l00984"></a>00984                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;Invited user already in switchboard\n&quot;</span>);
<a name="l00985"></a>00985                 <span class="keywordflow">return</span>;
<a name="l00986"></a>00986         }
<a name="l00987"></a>00987         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error == 217)
<a name="l00988"></a>00988         {
<a name="l00989"></a>00989                 reason = <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a28c6b0aa4f55d707ac5d41aee08e7210">MSN_SB_ERROR_USER_OFFLINE</a>;
<a name="l00990"></a>00990         }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992         <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;cal_error: command %s gave error %i\n&quot;</span>, trans-&gt;command, error);
<a name="l00993"></a>00993 
<a name="l00994"></a>00994         <span class="keywordflow">while</span> ((msg = g_queue_pop_head(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a3e79c70f19238de170f49c9c2a77aa46">msg_queue</a>)) != NULL){
<a name="l00995"></a>00995                 <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;Unable to send msg: {%s}\n&quot;</span>, msg-&gt;body);
<a name="l00996"></a>00996                 <span class="comment">/* The messages could not be sent due to a switchboard error */</span>
<a name="l00997"></a>00997                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a6d88be78fdf381044e78ad21f0e40a05">error</a> = <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a28c6b0aa4f55d707ac5d41aee08e7210">MSN_SB_ERROR_USER_OFFLINE</a>;
<a name="l00998"></a>00998                 msg_error_helper(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>, msg,
<a name="l00999"></a>00999                                                          <a class="code" href="msg_8h.html#a83920e8a32e4d5c0a562942274fb5521a5b4b55fbf6d35bc004123f290a7a4157">MSN_MSG_ERROR_SB</a>);
<a name="l01000"></a>01000         }
<a name="l01001"></a>01001         cal_error_helper(trans, reason);
<a name="l01002"></a>01002 }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="keywordtype">void</span>
<a name="l01005"></a>01005 msn_switchboard_request_add_user(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <span class="keyword">const</span> <span class="keywordtype">char</span> *user)
<a name="l01006"></a>01006 {
<a name="l01007"></a>01007         <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans;
<a name="l01008"></a>01008         <a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc;
<a name="l01009"></a>01009 
<a name="l01010"></a>01010         g_return_if_fail(swboard != NULL);
<a name="l01011"></a>01011 
<a name="l01012"></a>01012         cmdproc = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014         trans = msn_transaction_new(cmdproc, <span class="stringliteral">&quot;CAL&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, user);
<a name="l01015"></a>01015         <span class="comment">/* this doesn&#39;t do anything, but users seem to think that</span>
<a name="l01016"></a>01016 <span class="comment">         * &#39;Unhandled command&#39; is some kind of error, so we don&#39;t report it */</span>
<a name="l01017"></a>01017         msn_transaction_add_cb(trans, <span class="stringliteral">&quot;CAL&quot;</span>, got_cal);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         msn_transaction_set_data(trans, swboard);
<a name="l01020"></a>01020         msn_transaction_set_timeout_cb(trans, cal_timeout);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#adeadaf979f3695b27ddd84e6b1a283e9">ready</a>)
<a name="l01023"></a>01023                 <a class="code" href="cmdproc_8c.html#ab99f15c122d9023e3e2815ad62e9f76c">msn_cmdproc_send_trans</a>(cmdproc, trans);
<a name="l01024"></a>01024         <span class="keywordflow">else</span>
<a name="l01025"></a>01025                 <a class="code" href="cmdproc_8c.html#a4f721af937f2d6daf1e1448f7c53d5e8">msn_cmdproc_queue_trans</a>(cmdproc, trans);
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 <span class="comment">/**************************************************************************</span>
<a name="l01029"></a>01029 <span class="comment"> * Create &amp; Transfer stuff</span>
<a name="l01030"></a>01030 <span class="comment"> **************************************************************************/</span>
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01033"></a>01033 got_swboard(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_command.html">MsnCommand</a> *cmd)
<a name="l01034"></a>01034 {
<a name="l01035"></a>01035         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l01036"></a>01036         <span class="keywordtype">char</span> *host;
<a name="l01037"></a>01037         <span class="keywordtype">int</span> port;
<a name="l01038"></a>01038         swboard = cmd-&gt;trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a>;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040         <span class="keywordflow">if</span> (g_list_find(cmdproc-&gt;session-&gt;<a class="code" href="struct___msn_session.html#a2bcf2ea73b2bef10c56bc05050e0f7af">switches</a>, swboard) == NULL)
<a name="l01041"></a>01041                 <span class="comment">/* The conversation window was closed. */</span>
<a name="l01042"></a>01042                 <span class="keywordflow">return</span>;
<a name="l01043"></a>01043 
<a name="l01044"></a>01044         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>, <span class="stringliteral">&quot;Switchboard:auth:{%s} socket:{%s}\n&quot;</span>, cmd-&gt;params[4], cmd-&gt;params[2]);
<a name="l01045"></a>01045         <a class="code" href="switchboard_8c.html#ad6c21c12e7ce3eb4c761f5b86af79efd">msn_switchboard_set_auth_key</a>(swboard, cmd-&gt;params[4]);
<a name="l01046"></a>01046 
<a name="l01047"></a>01047         <a class="code" href="msnutils_8c.html#a873d08caab6d45ce786330e94598eb1d">msn_parse_socket</a>(cmd-&gt;params[2], &amp;host, &amp;port);
<a name="l01048"></a>01048 
<a name="l01049"></a>01049         <span class="keywordflow">if</span> (!<a class="code" href="switchboard_8c.html#a79d4edee05958c5e152b6782f1fc4ef2">msn_switchboard_connect</a>(swboard, host, port))
<a name="l01050"></a>01050                 <a class="code" href="switchboard_8c.html#ad8a057029a45c43bdb2a51022ec9e1c1">msn_switchboard_destroy</a>(swboard);
<a name="l01051"></a>01051 
<a name="l01052"></a>01052         g_free(host);
<a name="l01053"></a>01053 }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01056"></a>01056 xfr_error(<a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc, <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans, <span class="keywordtype">int</span> error)
<a name="l01057"></a>01057 {
<a name="l01058"></a>01058         <a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard;
<a name="l01059"></a>01059         <span class="keywordtype">int</span> reason = <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743addb0db5999927bc637030325707761c9">MSN_SB_ERROR_UNKNOWN</a>;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061         <span class="keywordflow">if</span> (error == 913)
<a name="l01062"></a>01062                 reason = <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a820af70e11df8e42f5160135d5905857">MSN_SB_ERROR_OFFLINE</a>;
<a name="l01063"></a>01063         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error == 800)
<a name="l01064"></a>01064                 reason = <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a7c5b793929d0633966b922414070a1d3">MSN_SB_ERROR_TOO_FAST</a>;
<a name="l01065"></a>01065 
<a name="l01066"></a>01066         swboard = trans-&gt;<a class="code" href="struct___msn_transaction.html#a875f893be4caef81c03b4da3c7db6dfe">data</a>;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;msn&quot;</span>,
<a name="l01069"></a>01069                 <span class="stringliteral">&quot;xfr_error %i for %s: trans %p, command %s, reason %i\n&quot;</span>,
<a name="l01070"></a>01070                 error, (swboard-&gt;im_user ? swboard-&gt;im_user : <span class="stringliteral">&quot;(null)&quot;</span>), trans,
<a name="l01071"></a>01071                 (trans-&gt;command ? trans-&gt;command : <span class="stringliteral">&quot;(null)&quot;</span>), reason);
<a name="l01072"></a>01072 
<a name="l01073"></a>01073         swboard_error_helper(swboard, reason, swboard-&gt;im_user);
<a name="l01074"></a>01074 }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076 gboolean
<a name="l01077"></a>01077 msn_switchboard_request(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l01078"></a>01078 {
<a name="l01079"></a>01079         <a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc;
<a name="l01080"></a>01080         <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans;
<a name="l01081"></a>01081 
<a name="l01082"></a>01082         g_return_val_if_fail(swboard != NULL, FALSE);
<a name="l01083"></a>01083 
<a name="l01084"></a>01084         cmdproc = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e4d714eda8cb92707b334047dea3c9e">session</a>-&gt;notification-&gt;<a class="code" href="struct___msn_notification.html#a068f8cd0af100638bdb45641b1215c6e">cmdproc</a>;
<a name="l01085"></a>01085 
<a name="l01086"></a>01086         trans = msn_transaction_new(cmdproc, <span class="stringliteral">&quot;XFR&quot;</span>, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;SB&quot;</span>);
<a name="l01087"></a>01087         msn_transaction_add_cb(trans, <span class="stringliteral">&quot;XFR&quot;</span>, got_swboard);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089         msn_transaction_set_data(trans, swboard);
<a name="l01090"></a>01090         msn_transaction_set_error_cb(trans, xfr_error);
<a name="l01091"></a>01091 
<a name="l01092"></a>01092         <span class="keywordflow">return</span> <a class="code" href="cmdproc_8c.html#ab99f15c122d9023e3e2815ad62e9f76c">msn_cmdproc_send_trans</a>(cmdproc, trans);
<a name="l01093"></a>01093 }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095 <span class="keywordtype">void</span>
<a name="l01096"></a><a class="code" href="switchboard_8h.html#a1d4f32dc8d658e3ad893cd030f38966e">01096</a> <a class="code" href="switchboard_8c.html#a1d4f32dc8d658e3ad893cd030f38966e">msn_switchboard_close</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard)
<a name="l01097"></a>01097 {
<a name="l01098"></a>01098         g_return_if_fail(swboard != NULL);
<a name="l01099"></a>01099 
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a6d88be78fdf381044e78ad21f0e40a05">error</a> != <a class="code" href="switchboard_8h.html#a84d00091d83fb1a82d82a1027fa23743a530b06aad3a1c31f0a76546d80c5b419">MSN_SB_ERROR_NONE</a>)
<a name="l01101"></a>01101         {
<a name="l01102"></a>01102                 <a class="code" href="switchboard_8c.html#ad8a057029a45c43bdb2a51022ec9e1c1">msn_switchboard_destroy</a>(swboard);
<a name="l01103"></a>01103         }
<a name="l01104"></a>01104         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_queue_is_empty(swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a3e79c70f19238de170f49c9c2a77aa46">msg_queue</a>) ||
<a name="l01105"></a>01105                          !swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a8e4d714eda8cb92707b334047dea3c9e">session</a>-&gt;connected)
<a name="l01106"></a>01106         {
<a name="l01107"></a>01107                 <a class="code" href="struct___msn_cmd_proc.html">MsnCmdProc</a> *cmdproc;
<a name="l01108"></a>01108                 <a class="code" href="struct___msn_transaction.html">MsnTransaction</a> *trans;
<a name="l01109"></a>01109                 cmdproc = swboard-&gt;<a class="code" href="struct___msn_switch_board.html#ada4ff4fc9ddce1ed475a4c00b6215019">cmdproc</a>;
<a name="l01110"></a>01110                 trans = msn_transaction_new(cmdproc, <span class="stringliteral">&quot;OUT&quot;</span>, NULL);
<a name="l01111"></a>01111                 msn_transaction_set_saveable(trans, FALSE);
<a name="l01112"></a>01112                 <a class="code" href="cmdproc_8c.html#ab99f15c122d9023e3e2815ad62e9f76c">msn_cmdproc_send_trans</a>(cmdproc, trans);
<a name="l01113"></a>01113 
<a name="l01114"></a>01114                 <a class="code" href="switchboard_8c.html#ad8a057029a45c43bdb2a51022ec9e1c1">msn_switchboard_destroy</a>(swboard);
<a name="l01115"></a>01115         }
<a name="l01116"></a>01116         <span class="keywordflow">else</span>
<a name="l01117"></a>01117         {
<a name="l01118"></a>01118                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a80e829cd29e904661f883a38012b0898">closed</a> = TRUE;
<a name="l01119"></a>01119         }
<a name="l01120"></a>01120 }
<a name="l01121"></a>01121 
<a name="l01122"></a>01122 <span class="keywordtype">void</span>
<a name="l01123"></a><a class="code" href="switchboard_8h.html#a922cac7d5a837f43bed38e843945b9f6">01123</a> <a class="code" href="switchboard_8c.html#a922cac7d5a837f43bed38e843945b9f6">msn_switchboard_release</a>(<a class="code" href="struct___msn_switch_board.html">MsnSwitchBoard</a> *swboard, <a class="code" href="switchboard_8h.html#a38b40b31e3f28b31e68fd721802eed66">MsnSBFlag</a> flag)
<a name="l01124"></a>01124 {
<a name="l01125"></a>01125         g_return_if_fail(swboard != NULL);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127         swboard-&gt;flag &amp;= ~flag;
<a name="l01128"></a>01128 
<a name="l01129"></a>01129         <span class="keywordflow">if</span> (flag == <a class="code" href="switchboard_8h.html#a38b40b31e3f28b31e68fd721802eed66a33d7d203b371f24ba1989229d74d1a58">MSN_SB_FLAG_IM</a>)
<a name="l01130"></a>01130                 <span class="comment">/* Forget any conversation that used to be associated with this</span>
<a name="l01131"></a>01131 <span class="comment">                 * swboard. */</span>
<a name="l01132"></a>01132                 swboard-&gt;<a class="code" href="struct___msn_switch_board.html#a34787b8d83c8b52bd303b4ccc1b9cd99">conv</a> = NULL;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134         <span class="keywordflow">if</span> (swboard-&gt;flag == 0)
<a name="l01135"></a>01135                 <span class="comment">/* Nothing else is using this switchboard, so close it */</span>
<a name="l01136"></a>01136                 <a class="code" href="switchboard_8c.html#a1d4f32dc8d658e3ad893cd030f38966e">msn_switchboard_close</a>(swboard);
<a name="l01137"></a>01137 }
<a name="l01138"></a>01138 
<a name="l01139"></a>01139 <span class="comment">/**************************************************************************</span>
<a name="l01140"></a>01140 <span class="comment"> * Init stuff</span>
<a name="l01141"></a>01141 <span class="comment"> **************************************************************************/</span>
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 <span class="keywordtype">void</span>
<a name="l01144"></a><a class="code" href="switchboard_8h.html#a19bc58dff1869310eaf5a978fe8f9834">01144</a> <a class="code" href="switchboard_8c.html#a19bc58dff1869310eaf5a978fe8f9834">msn_switchboard_init</a>(<span class="keywordtype">void</span>)
<a name="l01145"></a>01145 {
<a name="l01146"></a>01146         cbs_table = <a class="code" href="table_8c.html#aa460d470b58b591a00256d3c5d63d740">msn_table_new</a>();
<a name="l01147"></a>01147 
<a name="l01148"></a>01148         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, <span class="stringliteral">&quot;ANS&quot;</span>, <span class="stringliteral">&quot;ANS&quot;</span>, ans_cmd);
<a name="l01149"></a>01149         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, <span class="stringliteral">&quot;ANS&quot;</span>, <span class="stringliteral">&quot;IRO&quot;</span>, iro_cmd);
<a name="l01150"></a>01150 
<a name="l01151"></a>01151         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, <span class="stringliteral">&quot;MSG&quot;</span>, <span class="stringliteral">&quot;ACK&quot;</span>, ack_cmd);
<a name="l01152"></a>01152         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, <span class="stringliteral">&quot;MSG&quot;</span>, <span class="stringliteral">&quot;NAK&quot;</span>, nak_cmd);
<a name="l01153"></a>01153 
<a name="l01154"></a>01154         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, <span class="stringliteral">&quot;USR&quot;</span>, <span class="stringliteral">&quot;USR&quot;</span>, usr_cmd);
<a name="l01155"></a>01155 
<a name="l01156"></a>01156         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, NULL, <span class="stringliteral">&quot;MSG&quot;</span>, msg_cmd);
<a name="l01157"></a>01157         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, NULL, <span class="stringliteral">&quot;UBM&quot;</span>, ubm_cmd);
<a name="l01158"></a>01158         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, NULL, <span class="stringliteral">&quot;JOI&quot;</span>, joi_cmd);
<a name="l01159"></a>01159         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, NULL, <span class="stringliteral">&quot;BYE&quot;</span>, bye_cmd);
<a name="l01160"></a>01160         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, NULL, <span class="stringliteral">&quot;OUT&quot;</span>, out_cmd);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162 <span class="preprocessor">#if 0</span>
<a name="l01163"></a>01163 <span class="preprocessor"></span>        <span class="comment">/* They might skip the history */</span>
<a name="l01164"></a>01164         <a class="code" href="table_8c.html#a1465c2254ee44a7cb8397ac160cfac95">msn_table_add_cmd</a>(cbs_table, NULL, <span class="stringliteral">&quot;ACK&quot;</span>, NULL);
<a name="l01165"></a>01165 <span class="preprocessor">#endif</span>
<a name="l01166"></a>01166 <span class="preprocessor"></span>
<a name="l01167"></a>01167         <a class="code" href="table_8c.html#a5bcb0d24852f1f275b8a2188325231f5">msn_table_add_error</a>(cbs_table, <span class="stringliteral">&quot;MSG&quot;</span>, msg_error);
<a name="l01168"></a>01168         <a class="code" href="table_8c.html#a5bcb0d24852f1f275b8a2188325231f5">msn_table_add_error</a>(cbs_table, <span class="stringliteral">&quot;CAL&quot;</span>, cal_error);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170         <span class="comment">/* Register the message type callbacks. */</span>
<a name="l01171"></a>01171         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;text/plain&quot;</span>,
<a name="l01172"></a>01172                                                    msn_plain_msg);
<a name="l01173"></a>01173         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;text/x-msmsgscontrol&quot;</span>,
<a name="l01174"></a>01174                                                    msn_control_msg);
<a name="l01175"></a>01175         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;text/x-clientcaps&quot;</span>,
<a name="l01176"></a>01176                                                    clientcaps_msg);
<a name="l01177"></a>01177         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;text/x-clientinfo&quot;</span>,
<a name="l01178"></a>01178                                                    clientcaps_msg);
<a name="l01179"></a>01179         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;application/x-msnmsgrp2p&quot;</span>,
<a name="l01180"></a>01180                                                    <a class="code" href="msg_8c.html#ab817f47103821951b99368d210cc23d8">msn_p2p_msg</a>);
<a name="l01181"></a>01181         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;text/x-mms-emoticon&quot;</span>,
<a name="l01182"></a>01182                                                    <a class="code" href="msg_8c.html#a1cb342a058a80de7ff6ad9fcf8ee1549">msn_emoticon_msg</a>);
<a name="l01183"></a>01183         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;text/x-mms-animemoticon&quot;</span>,
<a name="l01184"></a>01184                                <a class="code" href="msg_8c.html#a1cb342a058a80de7ff6ad9fcf8ee1549">msn_emoticon_msg</a>);
<a name="l01185"></a>01185         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;text/x-msnmsgr-datacast&quot;</span>,
<a name="l01186"></a>01186                                                    msn_datacast_msg);
<a name="l01187"></a>01187         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;text/x-msmsgsinvite&quot;</span>,
<a name="l01188"></a>01188                                                    <a class="code" href="msg_8c.html#a45eef9a6981c0ef124327334ee4a2740">msn_invite_msg</a>);
<a name="l01189"></a>01189         <a class="code" href="table_8c.html#a70851f64bb89fb4abd9aab4a23724cb0">msn_table_add_msg_type</a>(cbs_table, <span class="stringliteral">&quot;image/gif&quot;</span>,
<a name="l01190"></a>01190                                                    msn_handwritten_msg);
<a name="l01191"></a>01191 }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193 <span class="keywordtype">void</span>
<a name="l01194"></a><a class="code" href="switchboard_8h.html#aec36c82223198b531e23973376a22782">01194</a> <a class="code" href="switchboard_8c.html#aec36c82223198b531e23973376a22782">msn_switchboard_end</a>(<span class="keywordtype">void</span>)
<a name="l01195"></a>01195 {
<a name="l01196"></a>01196         <a class="code" href="table_8c.html#abfea8899e6e14c910a44884b4b40b54b">msn_table_destroy</a>(cbs_table);
<a name="l01197"></a>01197 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="switchboard_8c.html">switchboard.c</a>      </li>
      <li class="footer">Generated on Sun Mar 24 2013 16:05:13 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
