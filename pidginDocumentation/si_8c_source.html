<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>protocols/jabber/si.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('si_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">protocols/jabber/si.c</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * purple - Jabber Protocol Plugin</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Purple is the legal property of its developers, whose names are too numerous</span>
<a name="l00005"></a>00005 <span class="comment"> * to list here.  Please refer to the COPYRIGHT file distributed with this</span>
<a name="l00006"></a>00006 <span class="comment"> * source distribution.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00009"></a>00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00010"></a>00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00011"></a>00011 <span class="comment"> * (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00020"></a>00020 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02111-1301  USA</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> */</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;internal.h&quot;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="blist_8h.html">blist.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html">debug.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="ft_8h.html">ft.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="request_8h.html">request.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="network_8h.html">network.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="notify_8h.html">notify.h</a>&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;buddy.h&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;data.h&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="disco_8h.html">disco.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;jabber.h&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;ibb.h&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="iq_8h.html">iq.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="si_8h.html">si.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#define STREAMHOST_CONNECT_TIMEOUT 15</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#define ENABLE_FT_THUMBNAILS 0</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a><a class="code" href="struct___jabber_s_i_xfer.html">00045</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct___jabber_s_i_xfer.html">_JabberSIXfer</a> {
<a name="l00046"></a>00046         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js;
<a name="l00047"></a>00047 
<a name="l00048"></a>00048         <a class="code" href="struct___purple_proxy_connect_data.html">PurpleProxyConnectData</a> *connect_data;
<a name="l00049"></a>00049         <a class="code" href="struct___purple_network_listen_data.html">PurpleNetworkListenData</a> *listen_data;
<a name="l00050"></a>00050         guint connect_timeout;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052         gboolean accepted;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054         <span class="keywordtype">char</span> *stream_id;
<a name="l00055"></a>00055         <span class="keywordtype">char</span> *iq_id;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057         <span class="keyword">enum</span> {
<a name="l00058"></a>00058                 STREAM_METHOD_UNKNOWN     = 0,
<a name="l00059"></a>00059                 STREAM_METHOD_BYTESTREAMS = 2 &lt;&lt; 1,
<a name="l00060"></a>00060                 STREAM_METHOD_IBB         = 2 &lt;&lt; 2,
<a name="l00061"></a>00061                 STREAM_METHOD_UNSUPPORTED = 2 &lt;&lt; 31
<a name="l00062"></a>00062         } stream_method;
<a name="l00063"></a>00063 
<a name="l00064"></a>00064         GList *streamhosts;
<a name="l00065"></a>00065         <a class="code" href="struct_purple_proxy_info.html">PurpleProxyInfo</a> *gpi;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="keywordtype">char</span> *rxqueue;
<a name="l00068"></a>00068         <span class="keywordtype">size_t</span> rxlen;
<a name="l00069"></a>00069         gsize rxmaxlen;
<a name="l00070"></a>00070         <span class="keywordtype">int</span> local_streamhost_fd;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <a class="code" href="struct___jabber_i_b_b_session.html">JabberIBBSession</a> *ibb_session;
<a name="l00073"></a>00073         guint ibb_timeout_handle;
<a name="l00074"></a>00074         <a class="code" href="struct___purple_circ_buffer.html">PurpleCircBuffer</a> *ibb_buffer;
<a name="l00075"></a>00075 } <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a>;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">/* some forward declarations */</span>
<a name="l00078"></a>00078 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_ibb_send_init(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="keyword">static</span> <a class="code" href="struct___purple_xfer.html">PurpleXfer</a>*
<a name="l00081"></a>00081 jabber_si_xfer_find(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *sid, <span class="keyword">const</span> <span class="keywordtype">char</span> *from)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083         GList *xfers;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085         <span class="keywordflow">if</span>(!sid || !from)
<a name="l00086"></a>00086                 <span class="keywordflow">return</span> NULL;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088         <span class="keywordflow">for</span>(xfers = js-&gt;file_transfers; xfers; xfers = xfers-&gt;next) {
<a name="l00089"></a>00089                 <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = xfers-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00090"></a>00090                 <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00091"></a>00091                 <span class="keywordflow">if</span>(jsx-&gt;stream_id &amp;&amp; xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a> &amp;&amp;
<a name="l00092"></a>00092                                 !strcmp(jsx-&gt;stream_id, sid) &amp;&amp; !strcmp(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>, from))
<a name="l00093"></a>00093                         <span class="keywordflow">return</span> xfer;
<a name="l00094"></a>00094         }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         <span class="keywordflow">return</span> NULL;
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00100"></a>00100 jabber_si_free_streamhost(gpointer data, gpointer user_data)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102         <a class="code" href="struct___jabber_bytestreams_streamhost.html">JabberBytestreamsStreamhost</a> *sh = data;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="keywordflow">if</span>(!data)
<a name="l00105"></a>00105                 <span class="keywordflow">return</span>;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107         g_free(sh-&gt;jid);
<a name="l00108"></a>00108         g_free(sh-&gt;host);
<a name="l00109"></a>00109         g_free(sh-&gt;zeroconf);
<a name="l00110"></a>00110         g_free(sh);
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_bytestreams_attempt_connect(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00118"></a>00118 jabber_si_bytestreams_connect_cb(gpointer data, gint source, <span class="keyword">const</span> gchar *error_message)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00121"></a>00121         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00122"></a>00122         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00123"></a>00123         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *su;
<a name="l00124"></a>00124         <a class="code" href="struct___jabber_bytestreams_streamhost.html">JabberBytestreamsStreamhost</a> *streamhost = jsx-&gt;streamhosts-&gt;data;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         purple_proxy_info_destroy(jsx-&gt;gpi);
<a name="l00127"></a>00127         jsx-&gt;gpi = NULL;
<a name="l00128"></a>00128         jsx-&gt;connect_data = NULL;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         <span class="keywordflow">if</span> (jsx-&gt;connect_timeout &gt; 0)
<a name="l00131"></a>00131                 <a class="code" href="eventloop_8c.html#aa63215615dfb1d5e8e61612520e5ec27">purple_timeout_remove</a>(jsx-&gt;connect_timeout);
<a name="l00132"></a>00132         jsx-&gt;connect_timeout = 0;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134         <span class="keywordflow">if</span>(source &lt; 0) {
<a name="l00135"></a>00135                 <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l00136"></a>00136                                 <span class="stringliteral">&quot;si connection failed, jid was %s, host was %s, error was %s\n&quot;</span>,
<a name="l00137"></a>00137                                 streamhost-&gt;jid, streamhost-&gt;host,
<a name="l00138"></a>00138                                 error_message ? error_message : <span class="stringliteral">&quot;(null)&quot;</span>);
<a name="l00139"></a>00139                 jsx-&gt;streamhosts = g_list_remove(jsx-&gt;streamhosts, streamhost);
<a name="l00140"></a>00140                 jabber_si_free_streamhost(streamhost, NULL);
<a name="l00141"></a>00141                 jabber_si_bytestreams_attempt_connect(xfer);
<a name="l00142"></a>00142                 <span class="keywordflow">return</span>;
<a name="l00143"></a>00143         }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145         <span class="comment">/* unknown file transfer type is assumed to be RECEIVE */</span>
<a name="l00146"></a>00146         <span class="keywordflow">if</span>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a01bfadf25a7dd552e0462a2e8b491b72">type</a> == <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a>)
<a name="l00147"></a>00147         {
<a name="l00148"></a>00148                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *activate;
<a name="l00149"></a>00149                 iq = jabber_iq_new_query(jsx-&gt;js, JABBER_IQ_SET, NS_BYTESTREAMS);
<a name="l00150"></a>00150                 xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, streamhost-&gt;jid);
<a name="l00151"></a>00151                 query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00152"></a>00152                 xmlnode_set_attrib(query, <span class="stringliteral">&quot;sid&quot;</span>, jsx-&gt;stream_id);
<a name="l00153"></a>00153                 activate = xmlnode_new_child(query, <span class="stringliteral">&quot;activate&quot;</span>);
<a name="l00154"></a>00154                 xmlnode_insert_data(activate, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>, -1);
<a name="l00155"></a>00155 
<a name="l00156"></a>00156                 <span class="comment">/* TODO: We need to wait for an activation result before starting */</span>
<a name="l00157"></a>00157         }
<a name="l00158"></a>00158         <span class="keywordflow">else</span>
<a name="l00159"></a>00159         {
<a name="l00160"></a>00160                 iq = jabber_iq_new_query(jsx-&gt;js, JABBER_IQ_RESULT, NS_BYTESTREAMS);
<a name="l00161"></a>00161                 xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l00162"></a>00162                 jabber_iq_set_id(iq, jsx-&gt;iq_id);
<a name="l00163"></a>00163                 query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00164"></a>00164                 su = xmlnode_new_child(query, <span class="stringliteral">&quot;streamhost-used&quot;</span>);
<a name="l00165"></a>00165                 xmlnode_set_attrib(su, <span class="stringliteral">&quot;jid&quot;</span>, streamhost-&gt;jid);
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         jabber_iq_send(iq);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         purple_xfer_start(xfer, source, NULL, -1);
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="keyword">static</span> gboolean
<a name="l00174"></a>00174 connect_timeout_cb(gpointer data)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00177"></a>00177         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Streamhost connection timeout of %d seconds exceeded.\n&quot;</span>, STREAMHOST_CONNECT_TIMEOUT);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         jsx-&gt;connect_timeout = 0;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (jsx-&gt;connect_data != NULL)
<a name="l00184"></a>00184                 purple_proxy_connect_cancel(jsx-&gt;connect_data);
<a name="l00185"></a>00185         jsx-&gt;connect_data = NULL;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187         <span class="comment">/* Trigger the connect error manually */</span>
<a name="l00188"></a>00188         jabber_si_bytestreams_connect_cb(xfer, -1, <span class="stringliteral">&quot;Timeout Exceeded.&quot;</span>);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190         <span class="keywordflow">return</span> FALSE;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00194"></a>00194 jabber_si_bytestreams_ibb_timeout_remove(<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx)
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196         <span class="keywordflow">if</span> (jsx-&gt;ibb_timeout_handle) {
<a name="l00197"></a>00197                 <a class="code" href="eventloop_8c.html#aa63215615dfb1d5e8e61612520e5ec27">purple_timeout_remove</a>(jsx-&gt;ibb_timeout_handle);
<a name="l00198"></a>00198                 jsx-&gt;ibb_timeout_handle = 0;
<a name="l00199"></a>00199         }
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="keyword">static</span> gboolean
<a name="l00203"></a>00203 jabber_si_bytestreams_ibb_timeout_cb(gpointer data)
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = (<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *) data;
<a name="l00206"></a>00206         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (jsx &amp;&amp; !jsx-&gt;ibb_session) {
<a name="l00209"></a>00209                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l00210"></a>00210                         <span class="stringliteral">&quot;jabber_si_bytestreams_ibb_timeout called and IBB session not set &quot;</span>
<a name="l00211"></a>00211                         <span class="stringliteral">&quot; up yet, cancel transfer&quot;</span>);
<a name="l00212"></a>00212                 jabber_si_bytestreams_ibb_timeout_remove(jsx);
<a name="l00213"></a>00213                 purple_xfer_cancel_local(xfer);
<a name="l00214"></a>00214         }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216         <span class="keywordflow">return</span> FALSE;
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_bytestreams_attempt_connect(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00222"></a>00222         <a class="code" href="struct___jabber_bytestreams_streamhost.html">JabberBytestreamsStreamhost</a> *streamhost;
<a name="l00223"></a>00223         <a class="code" href="struct___jabber_i_d.html">JabberID</a> *dstjid;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225         <span class="keywordflow">if</span>(!jsx-&gt;streamhosts) {
<a name="l00226"></a>00226                 <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq = jabber_iq_new(jsx-&gt;js, JABBER_IQ_ERROR);
<a name="l00227"></a>00227                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *error, *inf;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229                 <span class="keywordflow">if</span>(jsx-&gt;iq_id)
<a name="l00230"></a>00230                         jabber_iq_set_id(iq, jsx-&gt;iq_id);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232                 xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l00233"></a>00233                 error = xmlnode_new_child(iq-&gt;node, <span class="stringliteral">&quot;error&quot;</span>);
<a name="l00234"></a>00234                 xmlnode_set_attrib(error, <span class="stringliteral">&quot;code&quot;</span>, <span class="stringliteral">&quot;404&quot;</span>);
<a name="l00235"></a>00235                 xmlnode_set_attrib(error, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;cancel&quot;</span>);
<a name="l00236"></a>00236                 inf = xmlnode_new_child(error, <span class="stringliteral">&quot;item-not-found&quot;</span>);
<a name="l00237"></a>00237                 xmlnode_set_namespace(inf, NS_XMPP_STANZAS);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239                 jabber_iq_send(iq);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241                 <span class="comment">/* if IBB is available, revert to that before giving up... */</span>
<a name="l00242"></a>00242                 <span class="keywordflow">if</span> (jsx-&gt;stream_method &amp; STREAM_METHOD_IBB) {
<a name="l00243"></a>00243                         <span class="comment">/* if we are the initializer, init IBB */</span>
<a name="l00244"></a>00244                         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l00245"></a>00245                                 <span class="stringliteral">&quot;jabber_si_bytestreams_attempt_connect: &quot;</span>
<a name="l00246"></a>00246                                 <span class="stringliteral">&quot;no streamhosts found, trying IBB\n&quot;</span>);
<a name="l00247"></a>00247                         <span class="comment">/* if we are the sender, open an IBB session, but not if we already</span>
<a name="l00248"></a>00248 <span class="comment">                          did it, since we could have received the error &lt;iq/&gt; from the</span>
<a name="l00249"></a>00249 <span class="comment">                          receiver already... */</span>
<a name="l00250"></a>00250                         <span class="keywordflow">if</span> (purple_xfer_get_type(xfer) == <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a>
<a name="l00251"></a>00251                                 &amp;&amp; !jsx-&gt;ibb_session) {
<a name="l00252"></a>00252                                 jabber_si_xfer_ibb_send_init(jsx-&gt;js, xfer);
<a name="l00253"></a>00253                         } <span class="keywordflow">else</span> {
<a name="l00254"></a>00254                                 <span class="comment">/* setup a timeout to cancel waiting for IBB open */</span>
<a name="l00255"></a>00255                                 jsx-&gt;ibb_timeout_handle = <a class="code" href="eventloop_8c.html#a17752ee1277e09350a612b0b88921fc5">purple_timeout_add_seconds</a>(30,
<a name="l00256"></a>00256                                         jabber_si_bytestreams_ibb_timeout_cb, xfer);
<a name="l00257"></a>00257                         }
<a name="l00258"></a>00258                         <span class="comment">/* if we are the receiver, just wait for IBB open, callback is</span>
<a name="l00259"></a>00259 <span class="comment">                          already set up... */</span>
<a name="l00260"></a>00260                 } <span class="keywordflow">else</span> {
<a name="l00261"></a>00261                         purple_xfer_cancel_local(xfer);
<a name="l00262"></a>00262                 }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264                 <span class="keywordflow">return</span>;
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267         streamhost = jsx-&gt;streamhosts-&gt;data;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         jsx-&gt;connect_data = NULL;
<a name="l00270"></a>00270         <span class="keywordflow">if</span> (jsx-&gt;gpi != NULL)
<a name="l00271"></a>00271                 purple_proxy_info_destroy(jsx-&gt;gpi);
<a name="l00272"></a>00272         jsx-&gt;gpi = NULL;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274         dstjid = jabber_id_new(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         <span class="comment">/* TODO: Deal with zeroconf */</span>
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="keywordflow">if</span>(dstjid != NULL &amp;&amp; streamhost-&gt;host &amp;&amp; streamhost-&gt;port &gt; 0) {
<a name="l00279"></a>00279                 <span class="keywordtype">char</span> *dstaddr, *hash;
<a name="l00280"></a>00280                 <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account;
<a name="l00281"></a>00281                 jsx-&gt;gpi = purple_proxy_info_new();
<a name="l00282"></a>00282                 purple_proxy_info_set_type(jsx-&gt;gpi, <a class="code" href="proxy_8h.html#a309c31c148d41c540645b06f28508ac0a1be1c1189d8d31d1942221d50955e135">PURPLE_PROXY_SOCKS5</a>);
<a name="l00283"></a>00283                 purple_proxy_info_set_host(jsx-&gt;gpi, streamhost-&gt;host);
<a name="l00284"></a>00284                 purple_proxy_info_set_port(jsx-&gt;gpi, streamhost-&gt;port);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286                 <span class="comment">/* unknown file transfer type is assumed to be RECEIVE */</span>
<a name="l00287"></a>00287                 <span class="keywordflow">if</span>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a01bfadf25a7dd552e0462a2e8b491b72">type</a> == <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a>)
<a name="l00288"></a>00288                         dstaddr = g_strdup_printf(<span class="stringliteral">&quot;%s%s@%s/%s%s@%s/%s&quot;</span>, jsx-&gt;stream_id, jsx-&gt;js-&gt;user-&gt;node, jsx-&gt;js-&gt;user-&gt;domain,
<a name="l00289"></a>00289                                 jsx-&gt;js-&gt;user-&gt;resource, dstjid-&gt;node, dstjid-&gt;domain, dstjid-&gt;resource);
<a name="l00290"></a>00290                 <span class="keywordflow">else</span>
<a name="l00291"></a>00291                         dstaddr = g_strdup_printf(<span class="stringliteral">&quot;%s%s@%s/%s%s@%s/%s&quot;</span>, jsx-&gt;stream_id, dstjid-&gt;node, dstjid-&gt;domain, dstjid-&gt;resource,
<a name="l00292"></a>00292                                 jsx-&gt;js-&gt;user-&gt;node, jsx-&gt;js-&gt;user-&gt;domain, jsx-&gt;js-&gt;user-&gt;resource);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294                 <span class="comment">/* Per XEP-0065, the &#39;host&#39; must be SHA1(SID + from JID + to JID) */</span>
<a name="l00295"></a>00295                 hash = jabber_calculate_data_hash(dstaddr, strlen(dstaddr), <span class="stringliteral">&quot;sha1&quot;</span>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297                 account = purple_connection_get_account(jsx-&gt;js-&gt;gc);
<a name="l00298"></a>00298                 jsx-&gt;connect_data = purple_proxy_connect_socks5_account(NULL, account,
<a name="l00299"></a>00299                                 jsx-&gt;gpi, hash, 0,
<a name="l00300"></a>00300                                 jabber_si_bytestreams_connect_cb, xfer);
<a name="l00301"></a>00301                 g_free(hash);
<a name="l00302"></a>00302                 g_free(dstaddr);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304                 <span class="comment">/* When selecting a streamhost, timeout after STREAMHOST_CONNECT_TIMEOUT seconds, otherwise it takes forever */</span>
<a name="l00305"></a>00305                 <span class="keywordflow">if</span> (xfer-&gt;<a class="code" href="struct___purple_xfer.html#a01bfadf25a7dd552e0462a2e8b491b72">type</a> != <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a> &amp;&amp; jsx-&gt;connect_data != NULL)
<a name="l00306"></a>00306                         jsx-&gt;connect_timeout = <a class="code" href="eventloop_8c.html#a17752ee1277e09350a612b0b88921fc5">purple_timeout_add_seconds</a>(
<a name="l00307"></a>00307                                 STREAMHOST_CONNECT_TIMEOUT, connect_timeout_cb, xfer);
<a name="l00308"></a>00308 
<a name="l00309"></a>00309                 jabber_id_free(dstjid);
<a name="l00310"></a>00310         }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312         <span class="keywordflow">if</span> (jsx-&gt;connect_data == NULL)
<a name="l00313"></a>00313         {
<a name="l00314"></a>00314                 jsx-&gt;streamhosts = g_list_remove(jsx-&gt;streamhosts, streamhost);
<a name="l00315"></a>00315                 jabber_si_free_streamhost(streamhost, NULL);
<a name="l00316"></a>00316                 jabber_si_bytestreams_attempt_connect(xfer);
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 <span class="keywordtype">void</span> jabber_bytestreams_parse(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l00321"></a>00321                               JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <a class="code" href="struct__xmlnode.html">xmlnode</a> *query)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer;
<a name="l00324"></a>00324         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx;
<a name="l00325"></a>00325         <a class="code" href="struct__xmlnode.html">xmlnode</a> *streamhost;
<a name="l00326"></a>00326         <span class="keyword">const</span> <span class="keywordtype">char</span> *sid;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="keywordflow">if</span>(type != JABBER_IQ_SET)
<a name="l00329"></a>00329                 <span class="keywordflow">return</span>;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <span class="keywordflow">if</span>(!from)
<a name="l00332"></a>00332                 <span class="keywordflow">return</span>;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         <span class="keywordflow">if</span>(!(sid = xmlnode_get_attrib(query, <span class="stringliteral">&quot;sid&quot;</span>)))
<a name="l00335"></a>00335                 <span class="keywordflow">return</span>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         <span class="keywordflow">if</span>(!(xfer = jabber_si_xfer_find(js, sid, from)))
<a name="l00338"></a>00338                 <span class="keywordflow">return</span>;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340         jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <span class="keywordflow">if</span>(!jsx-&gt;accepted)
<a name="l00343"></a>00343                 <span class="keywordflow">return</span>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         <span class="keywordflow">if</span>(jsx-&gt;iq_id)
<a name="l00346"></a>00346                 g_free(jsx-&gt;iq_id);
<a name="l00347"></a>00347         jsx-&gt;iq_id = g_strdup(<span class="keywordtype">id</span>);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <span class="keywordflow">for</span>(streamhost = xmlnode_get_child(query, <span class="stringliteral">&quot;streamhost&quot;</span>); streamhost;
<a name="l00350"></a>00350                         streamhost = xmlnode_get_next_twin(streamhost)) {
<a name="l00351"></a>00351                 <span class="keyword">const</span> <span class="keywordtype">char</span> *jid, *host = NULL, *port, *zeroconf;
<a name="l00352"></a>00352                 <span class="keywordtype">int</span> portnum = 0;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                 <span class="keywordflow">if</span>((jid = xmlnode_get_attrib(streamhost, <span class="stringliteral">&quot;jid&quot;</span>)) &amp;&amp;
<a name="l00355"></a>00355                                 ((zeroconf = xmlnode_get_attrib(streamhost, <span class="stringliteral">&quot;zeroconf&quot;</span>)) ||
<a name="l00356"></a>00356                                 ((host = xmlnode_get_attrib(streamhost, <span class="stringliteral">&quot;host&quot;</span>)) &amp;&amp;
<a name="l00357"></a>00357                                 (port = xmlnode_get_attrib(streamhost, <span class="stringliteral">&quot;port&quot;</span>)) &amp;&amp;
<a name="l00358"></a>00358                                 (portnum = atoi(port))))) {
<a name="l00359"></a>00359                         <a class="code" href="struct___jabber_bytestreams_streamhost.html">JabberBytestreamsStreamhost</a> *sh = g_new0(<a class="code" href="struct___jabber_bytestreams_streamhost.html">JabberBytestreamsStreamhost</a>, 1);
<a name="l00360"></a>00360                         sh-&gt;jid = g_strdup(jid);
<a name="l00361"></a>00361                         sh-&gt;host = g_strdup(host);
<a name="l00362"></a>00362                         sh-&gt;port = portnum;
<a name="l00363"></a>00363                         sh-&gt;zeroconf = g_strdup(zeroconf);
<a name="l00364"></a>00364                         <span class="comment">/* If there were a lot of these, it&#39;d be worthwhile to prepend and reverse. */</span>
<a name="l00365"></a>00365                         jsx-&gt;streamhosts = g_list_append(jsx-&gt;streamhosts, sh);
<a name="l00366"></a>00366                 }
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         jabber_si_bytestreams_attempt_connect(xfer);
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00374"></a>00374 jabber_si_xfer_bytestreams_send_read_again_resp_cb(gpointer data, gint source,
<a name="l00375"></a>00375                 <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3">PurpleInputCondition</a> cond)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00378"></a>00378         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00379"></a>00379         <span class="keywordtype">int</span> len;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         len = write(source, jsx-&gt;rxqueue + jsx-&gt;rxlen, jsx-&gt;rxmaxlen - jsx-&gt;rxlen);
<a name="l00382"></a>00382         <span class="keywordflow">if</span> (len &lt; 0 &amp;&amp; errno == EAGAIN)
<a name="l00383"></a>00383                 <span class="keywordflow">return</span>;
<a name="l00384"></a>00384         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00385"></a>00385                 <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00386"></a>00386                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00387"></a>00387                 g_free(jsx-&gt;rxqueue);
<a name="l00388"></a>00388                 jsx-&gt;rxqueue = NULL;
<a name="l00389"></a>00389                 close(source);
<a name="l00390"></a>00390                 purple_xfer_cancel_remote(xfer);
<a name="l00391"></a>00391                 <span class="keywordflow">return</span>;
<a name="l00392"></a>00392         }
<a name="l00393"></a>00393         jsx-&gt;rxlen += len;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395         <span class="keywordflow">if</span> (jsx-&gt;rxlen &lt; jsx-&gt;rxmaxlen)
<a name="l00396"></a>00396                 <span class="keywordflow">return</span>;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00399"></a>00399         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00400"></a>00400         g_free(jsx-&gt;rxqueue);
<a name="l00401"></a>00401         jsx-&gt;rxqueue = NULL;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403         <span class="comment">/* Before actually starting sending the file, we need to wait until the</span>
<a name="l00404"></a>00404 <span class="comment">         * recipient sends the IQ result with &lt;streamhost-used/&gt;</span>
<a name="l00405"></a>00405 <span class="comment">         */</span>
<a name="l00406"></a>00406         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;SOCKS5 connection negotiation completed. &quot;</span>
<a name="l00407"></a>00407                                           <span class="stringliteral">&quot;Waiting for IQ result to start file transfer.\n&quot;</span>);
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00411"></a>00411 jabber_si_xfer_bytestreams_send_read_again_cb(gpointer data, gint source,
<a name="l00412"></a>00412                 <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3">PurpleInputCondition</a> cond)
<a name="l00413"></a>00413 {
<a name="l00414"></a>00414         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00415"></a>00415         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00416"></a>00416         <span class="keywordtype">char</span> buffer[42]; <span class="comment">/* 40 for DST.ADDR + 2 bytes for port number*/</span>
<a name="l00417"></a>00417         <span class="keywordtype">int</span> len;
<a name="l00418"></a>00418         <span class="keywordtype">char</span> *dstaddr, *hash;
<a name="l00419"></a>00419         <span class="keyword">const</span> <span class="keywordtype">char</span> *host;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;in jabber_si_xfer_bytestreams_send_read_again_cb\n&quot;</span>);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="keywordflow">if</span>(jsx-&gt;rxlen &lt; 5) {
<a name="l00424"></a>00424                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;reading the first 5 bytes\n&quot;</span>);
<a name="l00425"></a>00425                 len = read(source, buffer, 5 - jsx-&gt;rxlen);
<a name="l00426"></a>00426                 <span class="keywordflow">if</span>(len &lt; 0 &amp;&amp; errno == EAGAIN)
<a name="l00427"></a>00427                         <span class="keywordflow">return</span>;
<a name="l00428"></a>00428                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(len &lt;= 0) {
<a name="l00429"></a>00429                         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00430"></a>00430                         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00431"></a>00431                         close(source);
<a name="l00432"></a>00432                         purple_xfer_cancel_remote(xfer);
<a name="l00433"></a>00433                         <span class="keywordflow">return</span>;
<a name="l00434"></a>00434                 }
<a name="l00435"></a>00435                 jsx-&gt;rxqueue = g_realloc(jsx-&gt;rxqueue, len + jsx-&gt;rxlen);
<a name="l00436"></a>00436                 memcpy(jsx-&gt;rxqueue + jsx-&gt;rxlen, buffer, len);
<a name="l00437"></a>00437                 jsx-&gt;rxlen += len;
<a name="l00438"></a>00438                 <span class="keywordflow">return</span>;
<a name="l00439"></a>00439         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(jsx-&gt;rxqueue[0] != 0x05 || jsx-&gt;rxqueue[1] != 0x01 ||
<a name="l00440"></a>00440                         jsx-&gt;rxqueue[3] != 0x03 || jsx-&gt;rxqueue[4] != 40) {
<a name="l00441"></a>00441                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Invalid socks5 conn req. header[0x%x,0x%x,0x%x,0x%x,0x%x]\n&quot;</span>,
<a name="l00442"></a>00442                                   jsx-&gt;rxqueue[0], jsx-&gt;rxqueue[1], jsx-&gt;rxqueue[2],
<a name="l00443"></a>00443                                   jsx-&gt;rxqueue[3], jsx-&gt;rxqueue[4]);
<a name="l00444"></a>00444                 <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00445"></a>00445                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00446"></a>00446                 close(source);
<a name="l00447"></a>00447                 purple_xfer_cancel_remote(xfer);
<a name="l00448"></a>00448                 <span class="keywordflow">return</span>;
<a name="l00449"></a>00449         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(jsx-&gt;rxlen - 5 &lt;  jsx-&gt;rxqueue[4] + 2) {
<a name="l00450"></a>00450                 <span class="comment">/* Upper-bound of 257 (jsx-&gt;rxlen = 5, jsx-&gt;rxqueue[4] = 0xFF) */</span>
<a name="l00451"></a>00451                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> to_read = jsx-&gt;rxqueue[4] + 2 - (jsx-&gt;rxlen - 5);
<a name="l00452"></a>00452                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;reading %u bytes for DST.ADDR + port num (trying to read %hu now)\n&quot;</span>,
<a name="l00453"></a>00453                                   jsx-&gt;rxqueue[4] + 2, to_read);
<a name="l00454"></a>00454                 len = read(source, buffer, to_read);
<a name="l00455"></a>00455                 <span class="keywordflow">if</span>(len &lt; 0 &amp;&amp; errno == EAGAIN)
<a name="l00456"></a>00456                         <span class="keywordflow">return</span>;
<a name="l00457"></a>00457                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(len &lt;= 0) {
<a name="l00458"></a>00458                         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00459"></a>00459                         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00460"></a>00460                         close(source);
<a name="l00461"></a>00461                         purple_xfer_cancel_remote(xfer);
<a name="l00462"></a>00462                         <span class="keywordflow">return</span>;
<a name="l00463"></a>00463                 }
<a name="l00464"></a>00464                 jsx-&gt;rxqueue = g_realloc(jsx-&gt;rxqueue, len + jsx-&gt;rxlen);
<a name="l00465"></a>00465                 memcpy(jsx-&gt;rxqueue + jsx-&gt;rxlen, buffer, len);
<a name="l00466"></a>00466                 jsx-&gt;rxlen += len;
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         <span class="comment">/* Have we not read all of DST.ADDR and the following 2-byte port number? */</span>
<a name="l00470"></a>00470         <span class="keywordflow">if</span>(jsx-&gt;rxlen - 5 &lt; jsx-&gt;rxqueue[4] + 2)
<a name="l00471"></a>00471                 <span class="keywordflow">return</span>;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00474"></a>00474         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         dstaddr = g_strdup_printf(<span class="stringliteral">&quot;%s%s@%s/%s%s&quot;</span>, jsx-&gt;stream_id,
<a name="l00477"></a>00477                         jsx-&gt;js-&gt;user-&gt;node, jsx-&gt;js-&gt;user-&gt;domain,
<a name="l00478"></a>00478                         jsx-&gt;js-&gt;user-&gt;resource, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l00479"></a>00479 
<a name="l00480"></a>00480         <span class="comment">/* Per XEP-0065, the &#39;host&#39; must be SHA1(SID + from JID + to JID) */</span>
<a name="l00481"></a>00481         hash = jabber_calculate_data_hash(dstaddr, strlen(dstaddr), <span class="stringliteral">&quot;sha1&quot;</span>);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483         <span class="keywordflow">if</span>(strncmp(hash, jsx-&gt;rxqueue + 5, 40) ||
<a name="l00484"></a>00484                         jsx-&gt;rxqueue[45] != 0x00 || jsx-&gt;rxqueue[46] != 0x00) {
<a name="l00485"></a>00485                 <span class="keywordflow">if</span> (jsx-&gt;rxqueue[45] != 0x00 || jsx-&gt;rxqueue[46] != 0x00)
<a name="l00486"></a>00486                         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Got SOCKS5 BS conn with the wrong DST.PORT&quot;</span>
<a name="l00487"></a>00487                                                      <span class="stringliteral">&quot; (must be 0 - got[0x%x,0x%x]).\n&quot;</span>,
<a name="l00488"></a>00488                                                      jsx-&gt;rxqueue[45], jsx-&gt;rxqueue[46]);
<a name="l00489"></a>00489                 <span class="keywordflow">else</span>
<a name="l00490"></a>00490                         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Got SOCKS5 BS conn with the wrong DST.ADDR&quot;</span>
<a name="l00491"></a>00491                                                      <span class="stringliteral">&quot; (expected &#39;%s&#39; - got &#39;%.40s&#39;).\n&quot;</span>,
<a name="l00492"></a>00492                                                      hash, jsx-&gt;rxqueue + 5);
<a name="l00493"></a>00493                 close(source);
<a name="l00494"></a>00494                 purple_xfer_cancel_remote(xfer);
<a name="l00495"></a>00495                 g_free(hash);
<a name="l00496"></a>00496                 g_free(dstaddr);
<a name="l00497"></a>00497                 <span class="keywordflow">return</span>;
<a name="l00498"></a>00498         }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500         g_free(hash);
<a name="l00501"></a>00501         g_free(dstaddr);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         g_free(jsx-&gt;rxqueue);
<a name="l00504"></a>00504         host = purple_network_get_my_ip(jsx-&gt;js-&gt;fd);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         jsx-&gt;rxmaxlen = 5 + strlen(host) + 2;
<a name="l00507"></a>00507         jsx-&gt;rxqueue = g_malloc(jsx-&gt;rxmaxlen);
<a name="l00508"></a>00508         jsx-&gt;rxlen = 0;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         jsx-&gt;rxqueue[0] = 0x05;
<a name="l00511"></a>00511         jsx-&gt;rxqueue[1] = 0x00;
<a name="l00512"></a>00512         jsx-&gt;rxqueue[2] = 0x00;
<a name="l00513"></a>00513         jsx-&gt;rxqueue[3] = 0x03;
<a name="l00514"></a>00514         jsx-&gt;rxqueue[4] = strlen(host);
<a name="l00515"></a>00515         memcpy(jsx-&gt;rxqueue + 5, host, strlen(host));
<a name="l00516"></a>00516         jsx-&gt;rxqueue[5+strlen(host)] = 0x00;
<a name="l00517"></a>00517         jsx-&gt;rxqueue[6+strlen(host)] = 0x00;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = <a class="code" href="eventloop_8c.html#ad4f7f5fdc0ee617d0e3fe358f04f838b">purple_input_add</a>(source, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a00c293d57b62e5a9c09e4539ade9d51c">PURPLE_INPUT_WRITE</a>,
<a name="l00520"></a>00520                 jabber_si_xfer_bytestreams_send_read_again_resp_cb, xfer);
<a name="l00521"></a>00521         jabber_si_xfer_bytestreams_send_read_again_resp_cb(xfer, source,
<a name="l00522"></a>00522                 <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a00c293d57b62e5a9c09e4539ade9d51c">PURPLE_INPUT_WRITE</a>);
<a name="l00523"></a>00523 }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00526"></a>00526 jabber_si_xfer_bytestreams_send_read_response_cb(gpointer data, gint source,
<a name="l00527"></a>00527                 <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3">PurpleInputCondition</a> cond)
<a name="l00528"></a>00528 {
<a name="l00529"></a>00529         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00530"></a>00530         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00531"></a>00531         <span class="keywordtype">int</span> len;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533         len = write(source, jsx-&gt;rxqueue + jsx-&gt;rxlen, jsx-&gt;rxmaxlen - jsx-&gt;rxlen);
<a name="l00534"></a>00534         <span class="keywordflow">if</span> (len &lt; 0 &amp;&amp; errno == EAGAIN)
<a name="l00535"></a>00535                 <span class="keywordflow">return</span>;
<a name="l00536"></a>00536         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00537"></a>00537                 <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00538"></a>00538                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00539"></a>00539                 g_free(jsx-&gt;rxqueue);
<a name="l00540"></a>00540                 jsx-&gt;rxqueue = NULL;
<a name="l00541"></a>00541                 close(source);
<a name="l00542"></a>00542                 purple_xfer_cancel_remote(xfer);
<a name="l00543"></a>00543                 <span class="keywordflow">return</span>;
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545         jsx-&gt;rxlen += len;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="keywordflow">if</span> (jsx-&gt;rxlen &lt; jsx-&gt;rxmaxlen)
<a name="l00548"></a>00548                 <span class="keywordflow">return</span>;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00551"></a>00551         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         <span class="comment">/* If we sent a &quot;Success&quot;, wait for a response, otherwise give up and cancel */</span>
<a name="l00554"></a>00554         <span class="keywordflow">if</span> (jsx-&gt;rxqueue[1] == 0x00) {
<a name="l00555"></a>00555                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = <a class="code" href="eventloop_8c.html#ad4f7f5fdc0ee617d0e3fe358f04f838b">purple_input_add</a>(source, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a04a9339a9f5df8019b8afc3af679ec9e">PURPLE_INPUT_READ</a>,
<a name="l00556"></a>00556                         jabber_si_xfer_bytestreams_send_read_again_cb, xfer);
<a name="l00557"></a>00557                 g_free(jsx-&gt;rxqueue);
<a name="l00558"></a>00558                 jsx-&gt;rxqueue = NULL;
<a name="l00559"></a>00559                 jsx-&gt;rxlen = 0;
<a name="l00560"></a>00560         } <span class="keywordflow">else</span> {
<a name="l00561"></a>00561                 close(source);
<a name="l00562"></a>00562                 purple_xfer_cancel_remote(xfer);
<a name="l00563"></a>00563         }
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00567"></a>00567 jabber_si_xfer_bytestreams_send_read_cb(gpointer data, gint source,
<a name="l00568"></a>00568                 <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3">PurpleInputCondition</a> cond)
<a name="l00569"></a>00569 {
<a name="l00570"></a>00570         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00571"></a>00571         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00572"></a>00572         <span class="keywordtype">int</span> i;
<a name="l00573"></a>00573         <span class="keywordtype">int</span> len;
<a name="l00574"></a>00574         <span class="keywordtype">char</span> buffer[256];
<a name="l00575"></a>00575 
<a name="l00576"></a>00576         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;in jabber_si_xfer_bytestreams_send_read_cb\n&quot;</span>);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a5056a0656af41a8d502ab9459b7329a4">fd</a> = source;
<a name="l00579"></a>00579 
<a name="l00581"></a>00581         <span class="keywordflow">if</span>(jsx-&gt;rxlen &lt; 2) {
<a name="l00582"></a>00582                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;reading those first two bytes\n&quot;</span>);
<a name="l00583"></a>00583                 len = read(source, buffer, 2 - jsx-&gt;rxlen);
<a name="l00584"></a>00584                 <span class="keywordflow">if</span>(len &lt; 0 &amp;&amp; errno == EAGAIN)
<a name="l00585"></a>00585                         <span class="keywordflow">return</span>;
<a name="l00586"></a>00586                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(len &lt;= 0) {
<a name="l00587"></a>00587                         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00588"></a>00588                         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00589"></a>00589                         close(source);
<a name="l00590"></a>00590                         purple_xfer_cancel_remote(xfer);
<a name="l00591"></a>00591                         <span class="keywordflow">return</span>;
<a name="l00592"></a>00592                 }
<a name="l00593"></a>00593                 jsx-&gt;rxqueue = g_realloc(jsx-&gt;rxqueue, len + jsx-&gt;rxlen);
<a name="l00594"></a>00594                 memcpy(jsx-&gt;rxqueue + jsx-&gt;rxlen, buffer, len);
<a name="l00595"></a>00595                 jsx-&gt;rxlen += len;
<a name="l00596"></a>00596                 <span class="keywordflow">return</span>;
<a name="l00597"></a>00597         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(jsx-&gt;rxlen - 2 &lt; jsx-&gt;rxqueue[1]) {
<a name="l00598"></a>00598                 <span class="comment">/* Has a maximum value of 255 (jsx-&gt;rxlen = 2, jsx-&gt;rxqueue[1] = 0xFF) */</span>
<a name="l00599"></a>00599                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> to_read = jsx-&gt;rxqueue[1] - (jsx-&gt;rxlen - 2);
<a name="l00600"></a>00600                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;reading %u bytes for auth methods (trying to read %hu now)\n&quot;</span>,
<a name="l00601"></a>00601                                   jsx-&gt;rxqueue[1], to_read);
<a name="l00602"></a>00602                 len = read(source, buffer, to_read);
<a name="l00603"></a>00603                 <span class="keywordflow">if</span>(len &lt; 0 &amp;&amp; errno == EAGAIN)
<a name="l00604"></a>00604                         <span class="keywordflow">return</span>;
<a name="l00605"></a>00605                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(len &lt;= 0) {
<a name="l00606"></a>00606                         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00607"></a>00607                         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00608"></a>00608                         close(source);
<a name="l00609"></a>00609                         purple_xfer_cancel_remote(xfer);
<a name="l00610"></a>00610                         <span class="keywordflow">return</span>;
<a name="l00611"></a>00611                 }
<a name="l00612"></a>00612                 jsx-&gt;rxqueue = g_realloc(jsx-&gt;rxqueue, len + jsx-&gt;rxlen);
<a name="l00613"></a>00613                 memcpy(jsx-&gt;rxqueue + jsx-&gt;rxlen, buffer, len);
<a name="l00614"></a>00614                 jsx-&gt;rxlen += len;
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         <span class="comment">/* Have we not read all the auth. method bytes? */</span>
<a name="l00618"></a>00618         <span class="keywordflow">if</span>(jsx-&gt;rxlen -2 &lt; jsx-&gt;rxqueue[1])
<a name="l00619"></a>00619                 <span class="keywordflow">return</span>;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00622"></a>00622         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;checking to make sure we&#39;re socks FIVE\n&quot;</span>);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626         <span class="keywordflow">if</span>(jsx-&gt;rxqueue[0] != 0x05) {
<a name="l00627"></a>00627                 close(source);
<a name="l00628"></a>00628                 purple_xfer_cancel_remote(xfer);
<a name="l00629"></a>00629                 <span class="keywordflow">return</span>;
<a name="l00630"></a>00630         }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;going to test %hhu different methods\n&quot;</span>, jsx-&gt;rxqueue[1]);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         <span class="keywordflow">for</span>(i=0; i&lt;jsx-&gt;rxqueue[1]; i++) {
<a name="l00635"></a>00635 
<a name="l00636"></a>00636                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;testing %hhu\n&quot;</span>, jsx-&gt;rxqueue[i+2]);
<a name="l00637"></a>00637                 <span class="keywordflow">if</span>(jsx-&gt;rxqueue[i+2] == 0x00) {
<a name="l00638"></a>00638                         g_free(jsx-&gt;rxqueue);
<a name="l00639"></a>00639                         jsx-&gt;rxlen = 0;
<a name="l00640"></a>00640                         jsx-&gt;rxmaxlen = 2;
<a name="l00641"></a>00641                         jsx-&gt;rxqueue = g_malloc(jsx-&gt;rxmaxlen);
<a name="l00642"></a>00642                         jsx-&gt;rxqueue[0] = 0x05;
<a name="l00643"></a>00643                         jsx-&gt;rxqueue[1] = 0x00;
<a name="l00644"></a>00644                         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = <a class="code" href="eventloop_8c.html#ad4f7f5fdc0ee617d0e3fe358f04f838b">purple_input_add</a>(source, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a00c293d57b62e5a9c09e4539ade9d51c">PURPLE_INPUT_WRITE</a>,
<a name="l00645"></a>00645                                 jabber_si_xfer_bytestreams_send_read_response_cb,
<a name="l00646"></a>00646                                 xfer);
<a name="l00647"></a>00647                         jabber_si_xfer_bytestreams_send_read_response_cb(xfer,
<a name="l00648"></a>00648                                 source, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a00c293d57b62e5a9c09e4539ade9d51c">PURPLE_INPUT_WRITE</a>);
<a name="l00649"></a>00649                         jsx-&gt;rxqueue = NULL;
<a name="l00650"></a>00650                         jsx-&gt;rxlen = 0;
<a name="l00651"></a>00651                         <span class="keywordflow">return</span>;
<a name="l00652"></a>00652                 }
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655         g_free(jsx-&gt;rxqueue);
<a name="l00656"></a>00656         jsx-&gt;rxlen = 0;
<a name="l00657"></a>00657         jsx-&gt;rxmaxlen = 2;
<a name="l00658"></a>00658         jsx-&gt;rxqueue = g_malloc(jsx-&gt;rxmaxlen);
<a name="l00659"></a>00659         jsx-&gt;rxqueue[0] = 0x05;
<a name="l00660"></a>00660         jsx-&gt;rxqueue[1] = 0xFF;
<a name="l00661"></a>00661         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = <a class="code" href="eventloop_8c.html#ad4f7f5fdc0ee617d0e3fe358f04f838b">purple_input_add</a>(source, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a00c293d57b62e5a9c09e4539ade9d51c">PURPLE_INPUT_WRITE</a>,
<a name="l00662"></a>00662                 jabber_si_xfer_bytestreams_send_read_response_cb, xfer);
<a name="l00663"></a>00663         jabber_si_xfer_bytestreams_send_read_response_cb(xfer,
<a name="l00664"></a>00664                 source, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a00c293d57b62e5a9c09e4539ade9d51c">PURPLE_INPUT_WRITE</a>);
<a name="l00665"></a>00665 }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667 <span class="keyword">static</span> gint
<a name="l00668"></a>00668 jabber_si_compare_jid(gconstpointer a, gconstpointer b)
<a name="l00669"></a>00669 {
<a name="l00670"></a>00670         <span class="keyword">const</span> <a class="code" href="struct___jabber_bytestreams_streamhost.html">JabberBytestreamsStreamhost</a> *sh = a;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         <span class="keywordflow">if</span>(!a)
<a name="l00673"></a>00673                 <span class="keywordflow">return</span> -1;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675         <span class="keywordflow">return</span> strcmp(sh-&gt;jid, (<span class="keywordtype">char</span> *)b);
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00679"></a>00679 jabber_si_xfer_bytestreams_send_connected_cb(gpointer data, gint source,
<a name="l00680"></a>00680                 <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3">PurpleInputCondition</a> cond)
<a name="l00681"></a>00681 {
<a name="l00682"></a>00682         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00683"></a>00683         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00684"></a>00684         <span class="keywordtype">int</span> acceptfd, flags;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;in jabber_si_xfer_bytestreams_send_connected_cb\n&quot;</span>);
<a name="l00687"></a>00687 
<a name="l00688"></a>00688         acceptfd = accept(source, NULL, 0);
<a name="l00689"></a>00689         <span class="keywordflow">if</span>(acceptfd == -1 &amp;&amp; (errno == EAGAIN || errno == EWOULDBLOCK))
<a name="l00690"></a>00690                 <span class="keywordflow">return</span>;
<a name="l00691"></a>00691         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(acceptfd == -1) {
<a name="l00692"></a>00692                 <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;accept: %s\n&quot;</span>, g_strerror(errno));
<a name="l00693"></a>00693                 <span class="comment">/* Don&#39;t cancel the ft - allow it to fall to the next streamhost.*/</span>
<a name="l00694"></a>00694                 <span class="keywordflow">return</span>;
<a name="l00695"></a>00695         }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00698"></a>00698         close(source);
<a name="l00699"></a>00699         jsx-&gt;local_streamhost_fd = -1;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         flags = fcntl(acceptfd, F_GETFL);
<a name="l00702"></a>00702         fcntl(acceptfd, F_SETFL, flags | O_NONBLOCK);
<a name="l00703"></a>00703 <span class="preprocessor">#ifndef _WIN32</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span>        fcntl(acceptfd, F_SETFD, FD_CLOEXEC);
<a name="l00705"></a>00705 <span class="preprocessor">#endif</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span>
<a name="l00707"></a>00707         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = <a class="code" href="eventloop_8c.html#ad4f7f5fdc0ee617d0e3fe358f04f838b">purple_input_add</a>(acceptfd, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a04a9339a9f5df8019b8afc3af679ec9e">PURPLE_INPUT_READ</a>,
<a name="l00708"></a>00708                                          jabber_si_xfer_bytestreams_send_read_cb, xfer);
<a name="l00709"></a>00709 }
<a name="l00710"></a>00710 
<a name="l00711"></a>00711 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00712"></a>00712 jabber_si_connect_proxy_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l00713"></a>00713                            JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l00714"></a>00714                            <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00717"></a>00717         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx;
<a name="l00718"></a>00718         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *streamhost_used;
<a name="l00719"></a>00719         <span class="keyword">const</span> <span class="keywordtype">char</span> *jid;
<a name="l00720"></a>00720         GList *matched;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         <span class="comment">/* TODO: This need to send errors if we don&#39;t see what we&#39;re looking for */</span>
<a name="l00723"></a>00723 
<a name="l00724"></a>00724         <span class="comment">/* Make sure that the xfer is actually still valid and we&#39;re not just receiving an old iq response */</span>
<a name="l00725"></a>00725         <span class="keywordflow">if</span> (!g_list_find(js-&gt;file_transfers, xfer)) {
<a name="l00726"></a>00726                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Got bytestreams response for no longer existing xfer (%p)\n&quot;</span>, xfer);
<a name="l00727"></a>00727                 <span class="keywordflow">return</span>;
<a name="l00728"></a>00728         }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         <span class="comment">/* In the case of a direct file transfer, this is expected to return */</span>
<a name="l00731"></a>00731         <span class="keywordflow">if</span>(!xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>)
<a name="l00732"></a>00732                 <span class="keywordflow">return</span>;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734         jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736         <span class="keywordflow">if</span>(type != JABBER_IQ_RESULT) {
<a name="l00737"></a>00737                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l00738"></a>00738                             <span class="stringliteral">&quot;jabber_si_xfer_connect_proxy_cb: type = error\n&quot;</span>);
<a name="l00739"></a>00739                 <span class="comment">/* if IBB is available, open IBB session */</span>
<a name="l00740"></a>00740                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l00741"></a>00741                         <span class="stringliteral">&quot;jabber_si_xfer_connect_proxy_cb: got error, method: %d\n&quot;</span>,
<a name="l00742"></a>00742                         jsx-&gt;stream_method);
<a name="l00743"></a>00743                 <span class="keywordflow">if</span> (jsx-&gt;stream_method &amp; STREAM_METHOD_IBB) {
<a name="l00744"></a>00744                         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;IBB is possible, try it\n&quot;</span>);
<a name="l00745"></a>00745                         <span class="comment">/* if we are the sender and haven&#39;t already opened an IBB</span>
<a name="l00746"></a>00746 <span class="comment">                          session, do so now (we might already have failed to open</span>
<a name="l00747"></a>00747 <span class="comment">                          the bytestream proxy ourselves when receiving this &lt;iq/&gt; */</span>
<a name="l00748"></a>00748                         <span class="keywordflow">if</span> (purple_xfer_get_type(xfer) == <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a>
<a name="l00749"></a>00749                                 &amp;&amp; !jsx-&gt;ibb_session) {
<a name="l00750"></a>00750                                 jabber_si_xfer_ibb_send_init(js, xfer);
<a name="l00751"></a>00751                         } <span class="keywordflow">else</span> {
<a name="l00752"></a>00752                                 jsx-&gt;ibb_timeout_handle = <a class="code" href="eventloop_8c.html#a17752ee1277e09350a612b0b88921fc5">purple_timeout_add_seconds</a>(30,
<a name="l00753"></a>00753                                         jabber_si_bytestreams_ibb_timeout_cb, xfer);
<a name="l00754"></a>00754                         }
<a name="l00755"></a>00755                         <span class="comment">/* if we are receiver, just wait for IBB open stanza, callback</span>
<a name="l00756"></a>00756 <span class="comment">                          is already set up */</span>
<a name="l00757"></a>00757                 } <span class="keywordflow">else</span> {
<a name="l00758"></a>00758                         purple_xfer_cancel_remote(xfer);
<a name="l00759"></a>00759                 }
<a name="l00760"></a>00760                 <span class="keywordflow">return</span>;
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763         <span class="keywordflow">if</span> (!from)
<a name="l00764"></a>00764                 <span class="keywordflow">return</span>;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         <span class="keywordflow">if</span>(!(query = xmlnode_get_child(packet, <span class="stringliteral">&quot;query&quot;</span>)))
<a name="l00767"></a>00767                 <span class="keywordflow">return</span>;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         <span class="keywordflow">if</span>(!(streamhost_used = xmlnode_get_child(query, <span class="stringliteral">&quot;streamhost-used&quot;</span>)))
<a name="l00770"></a>00770                 <span class="keywordflow">return</span>;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772         <span class="keywordflow">if</span>(!(jid = xmlnode_get_attrib(streamhost_used, <span class="stringliteral">&quot;jid&quot;</span>)))
<a name="l00773"></a>00773                 <span class="keywordflow">return</span>;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;jabber_si_connect_proxy_cb() will be looking at jsx %p: jsx-&gt;streamhosts is %p and jid is %s\n&quot;</span>,
<a name="l00776"></a>00776                                           jsx, jsx-&gt;streamhosts, jid);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778         <span class="keywordflow">if</span>(!(matched = g_list_find_custom(jsx-&gt;streamhosts, jid, jabber_si_compare_jid)))
<a name="l00779"></a>00779         {
<a name="l00780"></a>00780                 gchar *my_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s/%s&quot;</span>, jsx-&gt;js-&gt;user-&gt;node,
<a name="l00781"></a>00781                         jsx-&gt;js-&gt;user-&gt;domain, jsx-&gt;js-&gt;user-&gt;resource);
<a name="l00782"></a>00782                 <span class="keywordflow">if</span> (!strcmp(jid, my_jid)) {
<a name="l00783"></a>00783                         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Got local SOCKS5 streamhost-used.\n&quot;</span>);
<a name="l00784"></a>00784                         purple_xfer_start(xfer, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a5056a0656af41a8d502ab9459b7329a4">fd</a>, NULL, -1);
<a name="l00785"></a>00785                 } <span class="keywordflow">else</span> {
<a name="l00786"></a>00786                         <span class="comment">/* if available, try to revert to IBB... */</span>
<a name="l00787"></a>00787                         <span class="keywordflow">if</span> (jsx-&gt;stream_method &amp; STREAM_METHOD_IBB) {
<a name="l00788"></a>00788                                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l00789"></a>00789                                         <span class="stringliteral">&quot;jabber_si_connect_proxy_cb: trying to revert to IBB\n&quot;</span>);
<a name="l00790"></a>00790                                 <span class="keywordflow">if</span> (purple_xfer_get_type(xfer) == <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a>) {
<a name="l00791"></a>00791                                         jabber_si_xfer_ibb_send_init(jsx-&gt;js, xfer);
<a name="l00792"></a>00792                                 } <span class="keywordflow">else</span> {
<a name="l00793"></a>00793                                         jsx-&gt;ibb_timeout_handle = <a class="code" href="eventloop_8c.html#a17752ee1277e09350a612b0b88921fc5">purple_timeout_add_seconds</a>(30,
<a name="l00794"></a>00794                                                 jabber_si_bytestreams_ibb_timeout_cb, xfer);
<a name="l00795"></a>00795                                 }
<a name="l00796"></a>00796                                 <span class="comment">/* if we are the receiver, we are already set up...*/</span>
<a name="l00797"></a>00797                         } <span class="keywordflow">else</span> {
<a name="l00798"></a>00798                                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l00799"></a>00799                                         <span class="stringliteral">&quot;streamhost-used does not match any proxy that was offered to target\n&quot;</span>);
<a name="l00800"></a>00800                                 purple_xfer_cancel_local(xfer);
<a name="l00801"></a>00801                         }
<a name="l00802"></a>00802                 }
<a name="l00803"></a>00803                 g_free(my_jid);
<a name="l00804"></a>00804                 <span class="keywordflow">return</span>;
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="comment">/* Clean up the local streamhost - it isn&#39;t going to be used.*/</span>
<a name="l00808"></a>00808         <span class="keywordflow">if</span> (xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> &gt; 0) {
<a name="l00809"></a>00809                 <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a>);
<a name="l00810"></a>00810                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = 0;
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812         <span class="keywordflow">if</span> (jsx-&gt;local_streamhost_fd &gt;= 0) {
<a name="l00813"></a>00813                 close(jsx-&gt;local_streamhost_fd);
<a name="l00814"></a>00814                 jsx-&gt;local_streamhost_fd = -1;
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         jsx-&gt;streamhosts = g_list_remove_link(jsx-&gt;streamhosts, matched);
<a name="l00818"></a>00818         g_list_foreach(jsx-&gt;streamhosts, jabber_si_free_streamhost, NULL);
<a name="l00819"></a>00819         g_list_free(jsx-&gt;streamhosts);
<a name="l00820"></a>00820 
<a name="l00821"></a>00821         jsx-&gt;streamhosts = matched;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         jabber_si_bytestreams_attempt_connect(xfer);
<a name="l00824"></a>00824 }
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00827"></a>00827 jabber_si_xfer_bytestreams_listen_cb(<span class="keywordtype">int</span> sock, gpointer data)
<a name="l00828"></a>00828 {
<a name="l00829"></a>00829         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l00830"></a>00830         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx;
<a name="l00831"></a>00831         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00832"></a>00832         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *streamhost;
<a name="l00833"></a>00833         <span class="keywordtype">char</span> port[6];
<a name="l00834"></a>00834         GList *tmp;
<a name="l00835"></a>00835         <a class="code" href="struct___jabber_bytestreams_streamhost.html">JabberBytestreamsStreamhost</a> *sh, *sh2;
<a name="l00836"></a>00836         <span class="keywordtype">int</span> streamhost_count = 0;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838         jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00839"></a>00839         jsx-&gt;listen_data = NULL;
<a name="l00840"></a>00840 
<a name="l00841"></a>00841         <span class="comment">/* I&#39;m not sure under which conditions this can happen</span>
<a name="l00842"></a>00842 <span class="comment">         * (it seems like it shouldn&#39;t be possible */</span>
<a name="l00843"></a>00843         <span class="keywordflow">if</span> (purple_xfer_get_status(xfer) == <a class="code" href="ft_8h.html#a3a1aa7cc7ce8608e151874b191b7c3dbadcf1b3eaed755af7c5f774177a372d05">PURPLE_XFER_STATUS_CANCEL_LOCAL</a>) {
<a name="l00844"></a>00844                 purple_xfer_unref(xfer);
<a name="l00845"></a>00845                 <span class="keywordflow">return</span>;
<a name="l00846"></a>00846         }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848         purple_xfer_unref(xfer);
<a name="l00849"></a>00849 
<a name="l00850"></a>00850         iq = jabber_iq_new_query(jsx-&gt;js, JABBER_IQ_SET, NS_BYTESTREAMS);
<a name="l00851"></a>00851         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l00852"></a>00852         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00853"></a>00853 
<a name="l00854"></a>00854         xmlnode_set_attrib(query, <span class="stringliteral">&quot;sid&quot;</span>, jsx-&gt;stream_id);
<a name="l00855"></a>00855 
<a name="l00856"></a>00856         <span class="comment">/* If we successfully started listening locally */</span>
<a name="l00857"></a>00857         <span class="keywordflow">if</span> (sock &gt;= 0) {
<a name="l00858"></a>00858                 gchar *jid;
<a name="l00859"></a>00859                 GList *local_ips =
<a name="l00860"></a>00860                         purple_network_get_all_local_system_ips();
<a name="l00861"></a>00861                 <span class="keyword">const</span> <span class="keywordtype">char</span> *public_ip;
<a name="l00862"></a>00862                 gboolean has_public_ip = FALSE;
<a name="l00863"></a>00863 
<a name="l00864"></a>00864                 jsx-&gt;local_streamhost_fd = sock;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866                 jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s/%s&quot;</span>, jsx-&gt;js-&gt;user-&gt;node,
<a name="l00867"></a>00867                         jsx-&gt;js-&gt;user-&gt;domain, jsx-&gt;js-&gt;user-&gt;resource);
<a name="l00868"></a>00868                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#acd34911cf755d0b6f99490df1259444f">local_port</a> = purple_network_get_port_from_fd(sock);
<a name="l00869"></a>00869                 g_snprintf(port, <span class="keyword">sizeof</span>(port), <span class="stringliteral">&quot;%hu&quot;</span>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#acd34911cf755d0b6f99490df1259444f">local_port</a>);
<a name="l00870"></a>00870 
<a name="l00871"></a>00871                 public_ip = purple_network_get_my_ip(jsx-&gt;js-&gt;fd);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873                 <span class="comment">/* Include the localhost&#39;s IPs (for in-network transfers) */</span>
<a name="l00874"></a>00874                 <span class="keywordflow">while</span> (local_ips) {
<a name="l00875"></a>00875                         gchar *local_ip = local_ips-&gt;data;
<a name="l00876"></a>00876                         streamhost_count++;
<a name="l00877"></a>00877                         streamhost = xmlnode_new_child(query, <span class="stringliteral">&quot;streamhost&quot;</span>);
<a name="l00878"></a>00878                         xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;jid&quot;</span>, jid);
<a name="l00879"></a>00879                         xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;host&quot;</span>, local_ip);
<a name="l00880"></a>00880                         xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;port&quot;</span>, port);
<a name="l00881"></a>00881                         <span class="keywordflow">if</span> (purple_strequal(local_ip, public_ip))
<a name="l00882"></a>00882                                 has_public_ip = TRUE;
<a name="l00883"></a>00883                         g_free(local_ip);
<a name="l00884"></a>00884                         local_ips = g_list_delete_link(local_ips, local_ips);
<a name="l00885"></a>00885                 }
<a name="l00886"></a>00886 
<a name="l00887"></a>00887                 <span class="comment">/* Include the public IP (assuming that there is a port mapped somehow) */</span>
<a name="l00888"></a>00888                 <span class="keywordflow">if</span> (!has_public_ip &amp;&amp; strcmp(public_ip, <span class="stringliteral">&quot;0.0.0.0&quot;</span>) != 0) {
<a name="l00889"></a>00889                         streamhost_count++;
<a name="l00890"></a>00890                         streamhost = xmlnode_new_child(query, <span class="stringliteral">&quot;streamhost&quot;</span>);
<a name="l00891"></a>00891                         xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;jid&quot;</span>, jid);
<a name="l00892"></a>00892                         xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;host&quot;</span>, public_ip);
<a name="l00893"></a>00893                         xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;port&quot;</span>, port);
<a name="l00894"></a>00894                 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896                 g_free(jid);
<a name="l00897"></a>00897 
<a name="l00898"></a>00898                 <span class="comment">/* The listener for the local proxy */</span>
<a name="l00899"></a>00899                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#a8894998ed016398069c8db0f8d9028a8">watcher</a> = <a class="code" href="eventloop_8c.html#ad4f7f5fdc0ee617d0e3fe358f04f838b">purple_input_add</a>(sock, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a04a9339a9f5df8019b8afc3af679ec9e">PURPLE_INPUT_READ</a>,
<a name="l00900"></a>00900                                 jabber_si_xfer_bytestreams_send_connected_cb, xfer);
<a name="l00901"></a>00901         }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903         <span class="keywordflow">for</span> (tmp = jsx-&gt;js-&gt;bs_proxies; tmp; tmp = tmp-&gt;next) {
<a name="l00904"></a>00904                 sh = tmp-&gt;data;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906                 <span class="comment">/* TODO: deal with zeroconf proxies */</span>
<a name="l00907"></a>00907 
<a name="l00908"></a>00908                 <span class="keywordflow">if</span> (!(sh-&gt;jid &amp;&amp; sh-&gt;host &amp;&amp; sh-&gt;port &gt; 0))
<a name="l00909"></a>00909                         <span class="keywordflow">continue</span>;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;jabber_si_xfer_bytestreams_listen_cb() will be looking at jsx %p: jsx-&gt;streamhosts %p and sh-&gt;jid %p\n&quot;</span>,
<a name="l00912"></a>00912                                                   jsx, jsx-&gt;streamhosts, sh-&gt;jid);
<a name="l00913"></a>00913                 <span class="keywordflow">if</span>(g_list_find_custom(jsx-&gt;streamhosts, sh-&gt;jid, jabber_si_compare_jid) != NULL)
<a name="l00914"></a>00914                         <span class="keywordflow">continue</span>;
<a name="l00915"></a>00915 
<a name="l00916"></a>00916                 streamhost_count++;
<a name="l00917"></a>00917                 streamhost = xmlnode_new_child(query, <span class="stringliteral">&quot;streamhost&quot;</span>);
<a name="l00918"></a>00918                 xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;jid&quot;</span>, sh-&gt;jid);
<a name="l00919"></a>00919                 xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;host&quot;</span>, sh-&gt;host);
<a name="l00920"></a>00920                 g_snprintf(port, <span class="keyword">sizeof</span>(port), <span class="stringliteral">&quot;%hu&quot;</span>, sh-&gt;port);
<a name="l00921"></a>00921                 xmlnode_set_attrib(streamhost, <span class="stringliteral">&quot;port&quot;</span>, port);
<a name="l00922"></a>00922 
<a name="l00923"></a>00923                 sh2 = g_new0(<a class="code" href="struct___jabber_bytestreams_streamhost.html">JabberBytestreamsStreamhost</a>, 1);
<a name="l00924"></a>00924                 sh2-&gt;jid = g_strdup(sh-&gt;jid);
<a name="l00925"></a>00925                 sh2-&gt;host = g_strdup(sh-&gt;host);
<a name="l00926"></a>00926                 <span class="comment">/*sh2-&gt;zeroconf = g_strdup(sh-&gt;zeroconf);*/</span>
<a name="l00927"></a>00927                 sh2-&gt;port = sh-&gt;port;
<a name="l00928"></a>00928 
<a name="l00929"></a>00929                 jsx-&gt;streamhosts = g_list_prepend(jsx-&gt;streamhosts, sh2);
<a name="l00930"></a>00930         }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932         <span class="comment">/* We have no way of transferring, cancel the transfer */</span>
<a name="l00933"></a>00933         <span class="keywordflow">if</span> (streamhost_count == 0) {
<a name="l00934"></a>00934                 jabber_iq_free(iq);
<a name="l00935"></a>00935 
<a name="l00936"></a>00936                 <span class="comment">/* if available, revert to IBB */</span>
<a name="l00937"></a>00937                 <span class="keywordflow">if</span> (jsx-&gt;stream_method &amp; STREAM_METHOD_IBB) {
<a name="l00938"></a>00938                         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l00939"></a>00939                                 <span class="stringliteral">&quot;jabber_si_xfer_bytestreams_listen_cb: trying to revert to IBB\n&quot;</span>);
<a name="l00940"></a>00940                         <span class="keywordflow">if</span> (purple_xfer_get_type(xfer) == <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a>) {
<a name="l00941"></a>00941                                 <span class="comment">/* if we are the sender, init the IBB session... */</span>
<a name="l00942"></a>00942                                 jabber_si_xfer_ibb_send_init(jsx-&gt;js, xfer);
<a name="l00943"></a>00943                         } <span class="keywordflow">else</span> {
<a name="l00944"></a>00944                                 jsx-&gt;ibb_timeout_handle = <a class="code" href="eventloop_8c.html#a17752ee1277e09350a612b0b88921fc5">purple_timeout_add_seconds</a>(30,
<a name="l00945"></a>00945                                         jabber_si_bytestreams_ibb_timeout_cb, xfer);
<a name="l00946"></a>00946                         }
<a name="l00947"></a>00947                         <span class="comment">/* if we are the receiver, we should just wait... the IBB open</span>
<a name="l00948"></a>00948 <span class="comment">                          handler has already been set up... */</span>
<a name="l00949"></a>00949                 } <span class="keywordflow">else</span> {
<a name="l00950"></a>00950                         <span class="comment">/* We should probably notify the target,</span>
<a name="l00951"></a>00951 <span class="comment">                          but this really shouldn&#39;t ever happen */</span>
<a name="l00952"></a>00952                         purple_xfer_cancel_local(xfer);
<a name="l00953"></a>00953                 }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955                 <span class="keywordflow">return</span>;
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958         jabber_iq_set_callback(iq, jabber_si_connect_proxy_cb, xfer);
<a name="l00959"></a>00959 
<a name="l00960"></a>00960         jabber_iq_send(iq);
<a name="l00961"></a>00961 
<a name="l00962"></a>00962 }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00965"></a>00965 jabber_si_xfer_bytestreams_send_init(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l00966"></a>00966 {
<a name="l00967"></a>00967         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx;
<a name="l00968"></a>00968         <a class="code" href="proxy_8h.html#a309c31c148d41c540645b06f28508ac0">PurpleProxyType</a> proxy_type;
<a name="l00969"></a>00969 
<a name="l00970"></a>00970         purple_xfer_ref(xfer);
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974         <span class="comment">/* TODO: This should probably be done with an account option instead of</span>
<a name="l00975"></a>00975 <span class="comment">         *       piggy-backing on the TOR proxy type. */</span>
<a name="l00976"></a>00976         proxy_type = purple_proxy_info_get_type(
<a name="l00977"></a>00977                 purple_proxy_get_setup(purple_connection_get_account(jsx-&gt;js-&gt;gc)));
<a name="l00978"></a>00978         <span class="keywordflow">if</span> (proxy_type == <a class="code" href="proxy_8h.html#a309c31c148d41c540645b06f28508ac0abbc2693e87c3a92da487ecea9f47a0d4">PURPLE_PROXY_TOR</a>) {
<a name="l00979"></a>00979                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Skipping attempting local streamhost.\n&quot;</span>);
<a name="l00980"></a>00980                 jsx-&gt;listen_data = NULL;
<a name="l00981"></a>00981         } <span class="keywordflow">else</span>
<a name="l00982"></a>00982                 jsx-&gt;listen_data = purple_network_listen_range(0, 0, SOCK_STREAM,
<a name="l00983"></a>00983                                 jabber_si_xfer_bytestreams_listen_cb, xfer);
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         <span class="keywordflow">if</span> (jsx-&gt;listen_data == NULL) {
<a name="l00986"></a>00986                 <span class="comment">/* We couldn&#39;t open a local port.  Perhaps we can use a proxy. */</span>
<a name="l00987"></a>00987                 jabber_si_xfer_bytestreams_listen_cb(-1, xfer);
<a name="l00988"></a>00988         }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00993"></a>00993 jabber_si_xfer_ibb_error_cb(<a class="code" href="struct___jabber_i_b_b_session.html">JabberIBBSession</a> *sess)
<a name="l00994"></a>00994 {
<a name="l00995"></a>00995         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = (<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *) jabber_ibb_session_get_user_data(sess);
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;an error occurred during IBB file transfer\n&quot;</span>);
<a name="l00998"></a>00998         purple_xfer_cancel_remote(xfer);
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01002"></a>01002 jabber_si_xfer_ibb_closed_cb(<a class="code" href="struct___jabber_i_b_b_session.html">JabberIBBSession</a> *sess)
<a name="l01003"></a>01003 {
<a name="l01004"></a>01004         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = (<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *) jabber_ibb_session_get_user_data(sess);
<a name="l01005"></a>01005 
<a name="l01006"></a>01006         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;the remote user closed the transfer\n&quot;</span>);
<a name="l01007"></a>01007         <span class="keywordflow">if</span> (purple_xfer_get_bytes_remaining(xfer) &gt; 0) {
<a name="l01008"></a>01008                 purple_xfer_cancel_remote(xfer);
<a name="l01009"></a>01009         } <span class="keywordflow">else</span> {
<a name="l01010"></a>01010                 purple_xfer_set_completed(xfer, TRUE);
<a name="l01011"></a>01011                 purple_xfer_end(xfer);
<a name="l01012"></a>01012         }
<a name="l01013"></a>01013 }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01016"></a>01016 jabber_si_xfer_ibb_recv_data_cb(<a class="code" href="struct___jabber_i_b_b_session.html">JabberIBBSession</a> *sess, gpointer data,
<a name="l01017"></a>01017         gsize size)
<a name="l01018"></a>01018 {
<a name="l01019"></a>01019         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = (<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *) jabber_ibb_session_get_user_data(sess);
<a name="l01020"></a>01020         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         if (size &lt;= purple_xfer_get_bytes_remaining(xfer)) {
<a name="l01023"></a>01023                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;about to write %&quot;</span> G_GSIZE_FORMAT <span class="stringliteral">&quot; bytes from IBB stream\n&quot;</span>,
<a name="l01024"></a>01024                         size);
<a name="l01025"></a>01025                 purple_circ_buffer_append(jsx-&gt;ibb_buffer, data, size);
<a name="l01026"></a>01026                 purple_xfer_prpl_ready(xfer);
<a name="l01027"></a>01027         } <span class="keywordflow">else</span> {
<a name="l01028"></a>01028                 <span class="comment">/* trying to write past size of file transfers negotiated size,</span>
<a name="l01029"></a>01029 <span class="comment">                  reject transfer to protect against malicious behaviour */</span>
<a name="l01030"></a>01030                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l01031"></a>01031                         <span class="stringliteral">&quot;IBB file transfer send more data than expected\n&quot;</span>);
<a name="l01032"></a>01032                 purple_xfer_cancel_remote(xfer);
<a name="l01033"></a>01033         }
<a name="l01034"></a>01034 
<a name="l01035"></a>01035 }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037 <span class="keyword">static</span> gssize
<a name="l01038"></a>01038 jabber_si_xfer_ibb_read(guchar **out_buffer, <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01039"></a>01039 {
<a name="l01040"></a>01040         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01041"></a>01041         guchar *buffer;
<a name="l01042"></a>01042         gsize size;
<a name="l01043"></a>01043         gsize tmp;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045         size = jsx-&gt;ibb_buffer-&gt;<a class="code" href="struct___purple_circ_buffer.html#a794a6e41ea3f9f57be2f522c1567c3c1">bufused</a>;
<a name="l01046"></a>01046         *out_buffer = buffer = g_malloc(size);
<a name="l01047"></a>01047         <span class="keywordflow">while</span> ((tmp = purple_circ_buffer_get_max_read(jsx-&gt;ibb_buffer))) {
<a name="l01048"></a>01048                 memcpy(buffer, jsx-&gt;ibb_buffer-&gt;<a class="code" href="struct___purple_circ_buffer.html#a9282df7cb8bb4cc968362f122d706664">outptr</a>, tmp);
<a name="l01049"></a>01049                 buffer += tmp;
<a name="l01050"></a>01050                 purple_circ_buffer_mark_read(jsx-&gt;ibb_buffer, tmp);
<a name="l01051"></a>01051         }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053         <span class="keywordflow">return</span> size;
<a name="l01054"></a>01054 }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056 <span class="keyword">static</span> gboolean
<a name="l01057"></a>01057 jabber_si_xfer_ibb_open_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *who, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l01058"></a>01058                            <a class="code" href="struct__xmlnode.html">xmlnode</a> *open)
<a name="l01059"></a>01059 {
<a name="l01060"></a>01060         <span class="keyword">const</span> gchar *sid = xmlnode_get_attrib(open, <span class="stringliteral">&quot;sid&quot;</span>);
<a name="l01061"></a>01061         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = jabber_si_xfer_find(js, sid, who);
<a name="l01062"></a>01062         <span class="keywordflow">if</span> (xfer) {
<a name="l01063"></a>01063                 <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01064"></a>01064                 <a class="code" href="struct___jabber_i_b_b_session.html">JabberIBBSession</a> *sess =
<a name="l01065"></a>01065                         jabber_ibb_session_create_from_xmlnode(js, who, <span class="keywordtype">id</span>, open, xfer);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067                 jabber_si_bytestreams_ibb_timeout_remove(jsx);
<a name="l01068"></a>01068 
<a name="l01069"></a>01069                 <span class="keywordflow">if</span> (sess) {
<a name="l01070"></a>01070                         <span class="comment">/* setup callbacks here...*/</span>
<a name="l01071"></a>01071                         jabber_ibb_session_set_data_received_callback(sess,
<a name="l01072"></a>01072                                 jabber_si_xfer_ibb_recv_data_cb);
<a name="l01073"></a>01073                         jabber_ibb_session_set_closed_callback(sess,
<a name="l01074"></a>01074                                 jabber_si_xfer_ibb_closed_cb);
<a name="l01075"></a>01075                         jabber_ibb_session_set_error_callback(sess,
<a name="l01076"></a>01076                                 jabber_si_xfer_ibb_error_cb);
<a name="l01077"></a>01077 
<a name="l01078"></a>01078                         jsx-&gt;ibb_session = sess;
<a name="l01079"></a>01079                         <span class="comment">/* we handle up to block-size bytes of decoded data, to handle</span>
<a name="l01080"></a>01080 <span class="comment">                         clients interpreting the block-size attribute as that</span>
<a name="l01081"></a>01081 <span class="comment">                         (see also remark in ibb.c) */</span>
<a name="l01082"></a>01082                         jsx-&gt;ibb_buffer =
<a name="l01083"></a>01083                                 purple_circ_buffer_new(jabber_ibb_session_get_block_size(sess));
<a name="l01084"></a>01084 
<a name="l01085"></a>01085                         <span class="comment">/* set up read function */</span>
<a name="l01086"></a>01086                         purple_xfer_set_read_fnc(xfer, jabber_si_xfer_ibb_read);
<a name="l01087"></a>01087 
<a name="l01088"></a>01088                         <span class="comment">/* start the transfer */</span>
<a name="l01089"></a>01089                         purple_xfer_start(xfer, -1, NULL, 0);
<a name="l01090"></a>01090                         <span class="keywordflow">return</span> TRUE;
<a name="l01091"></a>01091                 } <span class="keywordflow">else</span> {
<a name="l01092"></a>01092                         <span class="comment">/* failed to create IBB session */</span>
<a name="l01093"></a>01093                         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;failed to create IBB session\n&quot;</span>);
<a name="l01094"></a>01094                         purple_xfer_cancel_remote(xfer);
<a name="l01095"></a>01095                         <span class="keywordflow">return</span> FALSE;
<a name="l01096"></a>01096                 }
<a name="l01097"></a>01097         } <span class="keywordflow">else</span> {
<a name="l01098"></a>01098                 <span class="comment">/* we got an IBB &lt;open/&gt; for an unknown file transfer, pass along... */</span>
<a name="l01099"></a>01099                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l01100"></a>01100                         <span class="stringliteral">&quot;IBB open did not match any SI file transfer\n&quot;</span>);
<a name="l01101"></a>01101                 <span class="keywordflow">return</span> FALSE;
<a name="l01102"></a>01102         }
<a name="l01103"></a>01103 }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105 <span class="keyword">static</span> gssize
<a name="l01106"></a>01106 jabber_si_xfer_ibb_write(<span class="keyword">const</span> guchar *buffer, <span class="keywordtype">size_t</span> len, <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01107"></a>01107 {
<a name="l01108"></a>01108         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01109"></a>01109         <a class="code" href="struct___jabber_i_b_b_session.html">JabberIBBSession</a> *sess = jsx-&gt;ibb_session;
<a name="l01110"></a>01110         gsize packet_size = len &lt; jabber_ibb_session_get_max_data_size(sess) ?
<a name="l01111"></a>01111                 len : jabber_ibb_session_get_max_data_size(sess);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113         jabber_ibb_session_send_data(sess, buffer, packet_size);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115         <span class="keywordflow">return</span> packet_size;
<a name="l01116"></a>01116 }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01119"></a>01119 jabber_si_xfer_ibb_sent_cb(<a class="code" href="struct___jabber_i_b_b_session.html">JabberIBBSession</a> *sess)
<a name="l01120"></a>01120 {
<a name="l01121"></a>01121         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = (<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *) jabber_ibb_session_get_user_data(sess);
<a name="l01122"></a>01122         gsize remaining = purple_xfer_get_bytes_remaining(xfer);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124         <span class="keywordflow">if</span> (remaining == 0) {
<a name="l01125"></a>01125                 <span class="comment">/* close the session */</span>
<a name="l01126"></a>01126                 jabber_ibb_session_close(sess);
<a name="l01127"></a>01127                 purple_xfer_set_completed(xfer, TRUE);
<a name="l01128"></a>01128                 purple_xfer_end(xfer);
<a name="l01129"></a>01129         } <span class="keywordflow">else</span> {
<a name="l01130"></a>01130                 <span class="comment">/* send more... */</span>
<a name="l01131"></a>01131                 purple_xfer_prpl_ready(xfer);
<a name="l01132"></a>01132         }
<a name="l01133"></a>01133 }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01136"></a>01136 jabber_si_xfer_ibb_opened_cb(<a class="code" href="struct___jabber_i_b_b_session.html">JabberIBBSession</a> *sess)
<a name="l01137"></a>01137 {
<a name="l01138"></a>01138         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = (<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *) jabber_ibb_session_get_user_data(sess);
<a name="l01139"></a>01139 
<a name="l01140"></a>01140         <span class="keywordflow">if</span> (jabber_ibb_session_get_state(sess) == JABBER_IBB_SESSION_OPENED) {
<a name="l01141"></a>01141                 purple_xfer_start(xfer, -1, NULL, 0);
<a name="l01142"></a>01142                 purple_xfer_prpl_ready(xfer);
<a name="l01143"></a>01143         } <span class="keywordflow">else</span> {
<a name="l01144"></a>01144                 <span class="comment">/* error */</span>
<a name="l01145"></a>01145                 purple_xfer_end(xfer);
<a name="l01146"></a>01146         }
<a name="l01147"></a>01147 }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01150"></a>01150 jabber_si_xfer_ibb_send_init(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01151"></a>01151 {
<a name="l01152"></a>01152         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01153"></a>01153 
<a name="l01154"></a>01154         jsx-&gt;ibb_session = jabber_ibb_session_create(js, jsx-&gt;stream_id,
<a name="l01155"></a>01155                 purple_xfer_get_remote_user(xfer), xfer);
<a name="l01156"></a>01156 
<a name="l01157"></a>01157         <span class="keywordflow">if</span> (jsx-&gt;ibb_session) {
<a name="l01158"></a>01158                 <span class="comment">/* should set callbacks here... */</span>
<a name="l01159"></a>01159                 jabber_ibb_session_set_opened_callback(jsx-&gt;ibb_session,
<a name="l01160"></a>01160                         jabber_si_xfer_ibb_opened_cb);
<a name="l01161"></a>01161                 jabber_ibb_session_set_data_sent_callback(jsx-&gt;ibb_session,
<a name="l01162"></a>01162                         jabber_si_xfer_ibb_sent_cb);
<a name="l01163"></a>01163                 jabber_ibb_session_set_closed_callback(jsx-&gt;ibb_session,
<a name="l01164"></a>01164                         jabber_si_xfer_ibb_closed_cb);
<a name="l01165"></a>01165                 jabber_ibb_session_set_error_callback(jsx-&gt;ibb_session,
<a name="l01166"></a>01166                         jabber_si_xfer_ibb_error_cb);
<a name="l01167"></a>01167 
<a name="l01168"></a>01168                 purple_xfer_set_write_fnc(xfer, jabber_si_xfer_ibb_write);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170                 jsx-&gt;ibb_buffer =
<a name="l01171"></a>01171                         purple_circ_buffer_new(jabber_ibb_session_get_max_data_size(jsx-&gt;ibb_session));
<a name="l01172"></a>01172 
<a name="l01173"></a>01173                 <span class="comment">/* open the IBB session */</span>
<a name="l01174"></a>01174                 jabber_ibb_session_open(jsx-&gt;ibb_session);
<a name="l01175"></a>01175 
<a name="l01176"></a>01176         } <span class="keywordflow">else</span> {
<a name="l01177"></a>01177                 <span class="comment">/* failed to create IBB session */</span>
<a name="l01178"></a>01178                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l01179"></a>01179                         <span class="stringliteral">&quot;failed to initiate IBB session for file transfer\n&quot;</span>);
<a name="l01180"></a>01180                 purple_xfer_cancel_local(xfer);
<a name="l01181"></a>01181         }
<a name="l01182"></a>01182 }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_send_method_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l01185"></a>01185                                           JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l01186"></a>01186                                           <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l01187"></a>01187 {
<a name="l01188"></a>01188         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = data;
<a name="l01189"></a>01189         <a class="code" href="struct__xmlnode.html">xmlnode</a> *si, *feature, *x, *<a class="code" href="structfield.html">field</a>, *value;
<a name="l01190"></a>01190         gboolean found_method = FALSE;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192         <span class="keywordflow">if</span>(!(si = xmlnode_get_child_with_namespace(packet, <span class="stringliteral">&quot;si&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/si&quot;</span>))) {
<a name="l01193"></a>01193                 purple_xfer_cancel_remote(xfer);
<a name="l01194"></a>01194                 <span class="keywordflow">return</span>;
<a name="l01195"></a>01195         }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197         <span class="keywordflow">if</span>(!(feature = xmlnode_get_child_with_namespace(si, <span class="stringliteral">&quot;feature&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/feature-neg&quot;</span>))) {
<a name="l01198"></a>01198                 purple_xfer_cancel_remote(xfer);
<a name="l01199"></a>01199                 <span class="keywordflow">return</span>;
<a name="l01200"></a>01200         }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202         <span class="keywordflow">if</span>(!(x = xmlnode_get_child_with_namespace(feature, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;jabber:x:data&quot;</span>))) {
<a name="l01203"></a>01203                 purple_xfer_cancel_remote(xfer);
<a name="l01204"></a>01204                 <span class="keywordflow">return</span>;
<a name="l01205"></a>01205         }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207         <span class="keywordflow">for</span>(field = xmlnode_get_child(x, <span class="stringliteral">&quot;field&quot;</span>); field; field = xmlnode_get_next_twin(field)) {
<a name="l01208"></a>01208                 <span class="keyword">const</span> <span class="keywordtype">char</span> *var = xmlnode_get_attrib(field, <span class="stringliteral">&quot;var&quot;</span>);
<a name="l01209"></a>01209                 <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01210"></a>01210 
<a name="l01211"></a>01211                 <span class="keywordflow">if</span>(var &amp;&amp; !strcmp(var, <span class="stringliteral">&quot;stream-method&quot;</span>)) {
<a name="l01212"></a>01212                         <span class="keywordflow">if</span>((value = xmlnode_get_child(field, <span class="stringliteral">&quot;value&quot;</span>))) {
<a name="l01213"></a>01213                                 <span class="keywordtype">char</span> *val = xmlnode_get_data(value);
<a name="l01214"></a>01214                                 <span class="keywordflow">if</span>(val &amp;&amp; !strcmp(val, NS_BYTESTREAMS)) {
<a name="l01215"></a>01215                                         jabber_si_xfer_bytestreams_send_init(xfer);
<a name="l01216"></a>01216                                         jsx-&gt;stream_method |= STREAM_METHOD_BYTESTREAMS;
<a name="l01217"></a>01217                                         found_method = TRUE;
<a name="l01218"></a>01218                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val &amp;&amp; !strcmp(val, NS_IBB)) {
<a name="l01219"></a>01219                                         jsx-&gt;stream_method |= STREAM_METHOD_IBB;
<a name="l01220"></a>01220                                         <span class="keywordflow">if</span> (!found_method) {
<a name="l01221"></a>01221                                                 <span class="comment">/* we haven&#39;t tried to init a bytestream session, yet</span>
<a name="l01222"></a>01222 <span class="comment">                                                  start IBB right away... */</span>
<a name="l01223"></a>01223                                                 jabber_si_xfer_ibb_send_init(js, xfer);
<a name="l01224"></a>01224                                                 found_method = TRUE;
<a name="l01225"></a>01225                                         }
<a name="l01226"></a>01226                                 }
<a name="l01227"></a>01227                                 g_free(val);
<a name="l01228"></a>01228                         }
<a name="l01229"></a>01229                 }
<a name="l01230"></a>01230         }
<a name="l01231"></a>01231 
<a name="l01232"></a>01232         <span class="keywordflow">if</span> (!found_method) {
<a name="l01233"></a>01233                 purple_xfer_cancel_remote(xfer);
<a name="l01234"></a>01234         }
<a name="l01235"></a>01235 
<a name="l01236"></a>01236 }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_send_request(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01239"></a>01239 {
<a name="l01240"></a>01240         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01241"></a>01241         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l01242"></a>01242         <a class="code" href="struct__xmlnode.html">xmlnode</a> *si, *file, *feature, *x, *field, *option, *value;
<a name="l01243"></a>01243         <span class="keywordtype">char</span> buf[32];
<a name="l01244"></a>01244 <span class="preprocessor">#if ENABLE_FT_THUMBNAILS</span>
<a name="l01245"></a>01245 <span class="preprocessor"></span>        gconstpointer thumb;
<a name="l01246"></a>01246         gsize thumb_size;
<a name="l01247"></a>01247 
<a name="l01248"></a>01248         purple_xfer_prepare_thumbnail(xfer, <span class="stringliteral">&quot;jpeg,png&quot;</span>);
<a name="l01249"></a>01249 <span class="preprocessor">#endif</span>
<a name="l01250"></a>01250 <span class="preprocessor"></span>        xfer-&gt;<a class="code" href="struct___purple_xfer.html#a274b7e1e494a8f7c9eb6d2422cef12a2">filename</a> = g_path_get_basename(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a243fcaa367d1829a35b9f258691c9e72">local_filename</a>);
<a name="l01251"></a>01251 
<a name="l01252"></a>01252         iq = jabber_iq_new(jsx-&gt;js, JABBER_IQ_SET);
<a name="l01253"></a>01253         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l01254"></a>01254         si = xmlnode_new_child(iq-&gt;node, <span class="stringliteral">&quot;si&quot;</span>);
<a name="l01255"></a>01255         xmlnode_set_namespace(si, <span class="stringliteral">&quot;http://jabber.org/protocol/si&quot;</span>);
<a name="l01256"></a>01256         jsx-&gt;stream_id = jabber_get_next_id(jsx-&gt;js);
<a name="l01257"></a>01257         xmlnode_set_attrib(si, <span class="stringliteral">&quot;id&quot;</span>, jsx-&gt;stream_id);
<a name="l01258"></a>01258         xmlnode_set_attrib(si, <span class="stringliteral">&quot;profile&quot;</span>, NS_SI_FILE_TRANSFER);
<a name="l01259"></a>01259 
<a name="l01260"></a>01260         file = xmlnode_new_child(si, <span class="stringliteral">&quot;file&quot;</span>);
<a name="l01261"></a>01261         xmlnode_set_namespace(file, NS_SI_FILE_TRANSFER);
<a name="l01262"></a>01262         xmlnode_set_attrib(file, <span class="stringliteral">&quot;name&quot;</span>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a274b7e1e494a8f7c9eb6d2422cef12a2">filename</a>);
<a name="l01263"></a>01263         g_snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%&quot;</span> G_GSIZE_FORMAT, xfer-&gt;<a class="code" href="struct___purple_xfer.html#ad215a5927fad2a46b28ce5c8476e876f">size</a>);
<a name="l01264"></a>01264         xmlnode_set_attrib(file, <span class="stringliteral">&quot;size&quot;</span>, buf);
<a name="l01265"></a>01265         <span class="comment">/* maybe later we&#39;ll do hash and date attribs */</span>
<a name="l01266"></a>01266 
<a name="l01267"></a>01267 <span class="preprocessor">#if ENABLE_FT_THUMBNAILS</span>
<a name="l01268"></a>01268 <span class="preprocessor"></span>        <span class="comment">/* add thumbnail, if appropriate */</span>
<a name="l01269"></a>01269         <span class="keywordflow">if</span> ((thumb = purple_xfer_get_thumbnail(xfer, &amp;thumb_size))) {
<a name="l01270"></a>01270                 <span class="keyword">const</span> gchar *mimetype = purple_xfer_get_thumbnail_mimetype(xfer);
<a name="l01271"></a>01271                 <a class="code" href="struct_jabber_data.html">JabberData</a> *thumbnail_data =
<a name="l01272"></a>01272                         jabber_data_create_from_data(thumb, thumb_size,
<a name="l01273"></a>01273                                 mimetype, TRUE, jsx-&gt;js);
<a name="l01274"></a>01274                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *thumbnail = xmlnode_new_child(file, <span class="stringliteral">&quot;thumbnail&quot;</span>);
<a name="l01275"></a>01275                 xmlnode_set_namespace(thumbnail, NS_THUMBS);
<a name="l01276"></a>01276                 xmlnode_set_attrib(thumbnail, <span class="stringliteral">&quot;cid&quot;</span>,
<a name="l01277"></a>01277                         jabber_data_get_cid(thumbnail_data));
<a name="l01278"></a>01278                 xmlnode_set_attrib(thumbnail, <span class="stringliteral">&quot;mime-type&quot;</span>, mimetype);
<a name="l01279"></a>01279                 <span class="comment">/* cache data */</span>
<a name="l01280"></a>01280                 jabber_data_associate_local(thumbnail_data, NULL);
<a name="l01281"></a>01281         }
<a name="l01282"></a>01282 <span class="preprocessor">#endif</span>
<a name="l01283"></a>01283 <span class="preprocessor"></span>
<a name="l01284"></a>01284         feature = xmlnode_new_child(si, <span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01285"></a>01285         xmlnode_set_namespace(feature, <span class="stringliteral">&quot;http://jabber.org/protocol/feature-neg&quot;</span>);
<a name="l01286"></a>01286         x = xmlnode_new_child(feature, <span class="stringliteral">&quot;x&quot;</span>);
<a name="l01287"></a>01287         xmlnode_set_namespace(x, <span class="stringliteral">&quot;jabber:x:data&quot;</span>);
<a name="l01288"></a>01288         xmlnode_set_attrib(x, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;form&quot;</span>);
<a name="l01289"></a>01289         field = xmlnode_new_child(x, <span class="stringliteral">&quot;field&quot;</span>);
<a name="l01290"></a>01290         xmlnode_set_attrib(field, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;stream-method&quot;</span>);
<a name="l01291"></a>01291         xmlnode_set_attrib(field, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;list-single&quot;</span>);
<a name="l01292"></a>01292         <span class="comment">/* maybe we should add an option to always skip bytestreams for people</span>
<a name="l01293"></a>01293 <span class="comment">                behind troublesome firewalls */</span>
<a name="l01294"></a>01294         option = xmlnode_new_child(field, <span class="stringliteral">&quot;option&quot;</span>);
<a name="l01295"></a>01295         value = xmlnode_new_child(option, <span class="stringliteral">&quot;value&quot;</span>);
<a name="l01296"></a>01296         xmlnode_insert_data(value, NS_BYTESTREAMS, -1);
<a name="l01297"></a>01297         option = xmlnode_new_child(field, <span class="stringliteral">&quot;option&quot;</span>);
<a name="l01298"></a>01298         value = xmlnode_new_child(option, <span class="stringliteral">&quot;value&quot;</span>);
<a name="l01299"></a>01299         xmlnode_insert_data(value, NS_IBB, -1);
<a name="l01300"></a>01300 
<a name="l01301"></a>01301         jabber_iq_set_callback(iq, jabber_si_xfer_send_method_cb, xfer);
<a name="l01302"></a>01302 
<a name="l01303"></a>01303         <span class="comment">/* Store the IQ id so that we can cancel the callback */</span>
<a name="l01304"></a>01304         g_free(jsx-&gt;iq_id);
<a name="l01305"></a>01305         jsx-&gt;iq_id = g_strdup(iq-&gt;id);
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         jabber_iq_send(iq);
<a name="l01308"></a>01308 }
<a name="l01309"></a>01309 
<a name="l01310"></a>01310 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_free(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01311"></a>01311 {
<a name="l01312"></a>01312         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01313"></a>01313 
<a name="l01314"></a>01314         <span class="keywordflow">if</span> (jsx) {
<a name="l01315"></a>01315                 <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = jsx-&gt;js;
<a name="l01316"></a>01316 
<a name="l01317"></a>01317                 js-&gt;file_transfers = g_list_remove(js-&gt;file_transfers, xfer);
<a name="l01318"></a>01318 
<a name="l01319"></a>01319                 <span class="keywordflow">if</span> (jsx-&gt;connect_data != NULL)
<a name="l01320"></a>01320                         purple_proxy_connect_cancel(jsx-&gt;connect_data);
<a name="l01321"></a>01321                 <span class="keywordflow">if</span> (jsx-&gt;listen_data != NULL)
<a name="l01322"></a>01322                         purple_network_listen_cancel(jsx-&gt;listen_data);
<a name="l01323"></a>01323                 <span class="keywordflow">if</span> (jsx-&gt;iq_id != NULL)
<a name="l01324"></a>01324                         jabber_iq_remove_callback_by_id(js, jsx-&gt;iq_id);
<a name="l01325"></a>01325                 <span class="keywordflow">if</span> (jsx-&gt;local_streamhost_fd &gt;= 0)
<a name="l01326"></a>01326                         close(jsx-&gt;local_streamhost_fd);
<a name="l01327"></a>01327                 <span class="keywordflow">if</span> (purple_xfer_get_type(xfer) == <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a> &amp;&amp;
<a name="l01328"></a>01328                         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a5056a0656af41a8d502ab9459b7329a4">fd</a> &gt;= 0) {
<a name="l01329"></a>01329                         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;remove port mapping\n&quot;</span>);
<a name="l01330"></a>01330                         purple_network_remove_port_mapping(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a5056a0656af41a8d502ab9459b7329a4">fd</a>);
<a name="l01331"></a>01331                 }
<a name="l01332"></a>01332                 <span class="keywordflow">if</span> (jsx-&gt;connect_timeout &gt; 0)
<a name="l01333"></a>01333                         <a class="code" href="eventloop_8c.html#aa63215615dfb1d5e8e61612520e5ec27">purple_timeout_remove</a>(jsx-&gt;connect_timeout);
<a name="l01334"></a>01334                 <span class="keywordflow">if</span> (jsx-&gt;ibb_timeout_handle &gt; 0)
<a name="l01335"></a>01335                         <a class="code" href="eventloop_8c.html#aa63215615dfb1d5e8e61612520e5ec27">purple_timeout_remove</a>(jsx-&gt;ibb_timeout_handle);
<a name="l01336"></a>01336 
<a name="l01337"></a>01337                 <span class="keywordflow">if</span> (jsx-&gt;streamhosts) {
<a name="l01338"></a>01338                         g_list_foreach(jsx-&gt;streamhosts, jabber_si_free_streamhost, NULL);
<a name="l01339"></a>01339                         g_list_free(jsx-&gt;streamhosts);
<a name="l01340"></a>01340                 }
<a name="l01341"></a>01341 
<a name="l01342"></a>01342                 <span class="keywordflow">if</span> (jsx-&gt;ibb_session) {
<a name="l01343"></a>01343                         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l01344"></a>01344                                 <span class="stringliteral">&quot;jabber_si_xfer_free: destroying IBB session\n&quot;</span>);
<a name="l01345"></a>01345                         jabber_ibb_session_destroy(jsx-&gt;ibb_session);
<a name="l01346"></a>01346                 }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348                 <span class="keywordflow">if</span> (jsx-&gt;ibb_buffer) {
<a name="l01349"></a>01349                         purple_circ_buffer_destroy(jsx-&gt;ibb_buffer);
<a name="l01350"></a>01350                 }
<a name="l01351"></a>01351 
<a name="l01352"></a>01352                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;jabber_si_xfer_free(): freeing jsx %p\n&quot;</span>, jsx);
<a name="l01353"></a>01353 
<a name="l01354"></a>01354                 g_free(jsx-&gt;stream_id);
<a name="l01355"></a>01355                 g_free(jsx-&gt;iq_id);
<a name="l01356"></a>01356                 <span class="comment">/* XXX: free other stuff */</span>
<a name="l01357"></a>01357                 g_free(jsx-&gt;rxqueue);
<a name="l01358"></a>01358                 g_free(jsx);
<a name="l01359"></a>01359                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a> = NULL;
<a name="l01360"></a>01360         }
<a name="l01361"></a>01361 }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363 <span class="comment">/*</span>
<a name="l01364"></a>01364 <span class="comment"> * These four functions should only be called from the PurpleXfer functions</span>
<a name="l01365"></a>01365 <span class="comment"> * (typically purple_xfer_cancel_(remote|local), purple_xfer_end, or</span>
<a name="l01366"></a>01366 <span class="comment"> * purple_xfer_request_denied.</span>
<a name="l01367"></a>01367 <span class="comment"> */</span>
<a name="l01368"></a>01368 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_cancel_send(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01369"></a>01369 {
<a name="l01370"></a>01370         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372         <span class="comment">/* if there is an IBB session active, send close on that */</span>
<a name="l01373"></a>01373         if (jsx-&gt;ibb_session) {
<a name="l01374"></a>01374                 jabber_ibb_session_close(jsx-&gt;ibb_session);
<a name="l01375"></a>01375         }
<a name="l01376"></a>01376         jabber_si_xfer_free(xfer);
<a name="l01377"></a>01377         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;in jabber_si_xfer_cancel_send\n&quot;</span>);
<a name="l01378"></a>01378 }
<a name="l01379"></a>01379 
<a name="l01380"></a>01380 
<a name="l01381"></a>01381 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_request_denied(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01382"></a>01382 {
<a name="l01383"></a>01383         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01384"></a>01384         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = jsx-&gt;js;
<a name="l01385"></a>01385 
<a name="l01386"></a>01386         <span class="comment">/*</span>
<a name="l01387"></a>01387 <span class="comment">         * TODO: It&#39;s probably an error if jsx-&gt;iq_id == NULL. g_return_if_fail</span>
<a name="l01388"></a>01388 <span class="comment">         * might be warranted.</span>
<a name="l01389"></a>01389 <span class="comment">         */</span>
<a name="l01390"></a>01390         if (jsx-&gt;iq_id &amp;&amp; !jsx-&gt;accepted) {
<a name="l01391"></a>01391                 <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l01392"></a>01392                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *error, *child;
<a name="l01393"></a>01393                 iq = jabber_iq_new(js, JABBER_IQ_ERROR);
<a name="l01394"></a>01394                 xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l01395"></a>01395                 jabber_iq_set_id(iq, jsx-&gt;iq_id);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397                 error = xmlnode_new_child(iq-&gt;node, <span class="stringliteral">&quot;error&quot;</span>);
<a name="l01398"></a>01398                 xmlnode_set_attrib(error, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;cancel&quot;</span>);
<a name="l01399"></a>01399                 child = xmlnode_new_child(error, <span class="stringliteral">&quot;forbidden&quot;</span>);
<a name="l01400"></a>01400                 xmlnode_set_namespace(child, NS_XMPP_STANZAS);
<a name="l01401"></a>01401                 child = xmlnode_new_child(error, <span class="stringliteral">&quot;text&quot;</span>);
<a name="l01402"></a>01402                 xmlnode_set_namespace(child, NS_XMPP_STANZAS);
<a name="l01403"></a>01403                 xmlnode_insert_data(child, <span class="stringliteral">&quot;Offer Declined&quot;</span>, -1);
<a name="l01404"></a>01404 
<a name="l01405"></a>01405                 jabber_iq_send(iq);
<a name="l01406"></a>01406         }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408         jabber_si_xfer_free(xfer);
<a name="l01409"></a>01409         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;in jabber_si_xfer_request_denied\n&quot;</span>);
<a name="l01410"></a>01410 }
<a name="l01411"></a>01411 
<a name="l01412"></a>01412 
<a name="l01413"></a>01413 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_cancel_recv(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01414"></a>01414 {
<a name="l01415"></a>01415         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01416"></a>01416         <span class="comment">/* if there is an IBB session active, send close */</span>
<a name="l01417"></a>01417         if (jsx-&gt;ibb_session) {
<a name="l01418"></a>01418                 jabber_ibb_session_close(jsx-&gt;ibb_session);
<a name="l01419"></a>01419         }
<a name="l01420"></a>01420         jabber_si_xfer_free(xfer);
<a name="l01421"></a>01421         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;in jabber_si_xfer_cancel_recv\n&quot;</span>);
<a name="l01422"></a>01422 }
<a name="l01423"></a>01423 
<a name="l01424"></a>01424 
<a name="l01425"></a>01425 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_end(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01426"></a>01426 {
<a name="l01427"></a>01427         jabber_si_xfer_free(xfer);
<a name="l01428"></a>01428 }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430 
<a name="l01431"></a>01431 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_send_disco_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *who,
<a name="l01432"></a>01432                 JabberCapabilities capabilities, gpointer data)
<a name="l01433"></a>01433 {
<a name="l01434"></a>01434         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = (<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *) data;
<a name="l01435"></a>01435         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = (<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *) xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01436"></a>01436 
<a name="l01437"></a>01437         if (capabilities &amp; JABBER_CAP_IBB) {
<a name="l01438"></a>01438                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;jabber&quot;</span>,
<a name="l01439"></a>01439                         <span class="stringliteral">&quot;jabber_si_xfer_send_disco_cb: remote JID supports IBB\n&quot;</span>);
<a name="l01440"></a>01440                 jsx-&gt;stream_method |= STREAM_METHOD_IBB;
<a name="l01441"></a>01441         }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443         <span class="keywordflow">if</span> (capabilities &amp; JABBER_CAP_SI_FILE_XFER) {
<a name="l01444"></a>01444                 jabber_si_xfer_send_request(xfer);
<a name="l01445"></a>01445         } <span class="keywordflow">else</span> {
<a name="l01446"></a>01446                 <span class="keywordtype">char</span> *msg = g_strdup_printf(_(<span class="stringliteral">&quot;Unable to send file to %s, user does not support file transfers&quot;</span>), who);
<a name="l01447"></a>01447                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(js-&gt;gc, _(<span class="stringliteral">&quot;File Send Failed&quot;</span>),
<a name="l01448"></a>01448                                 _(<span class="stringliteral">&quot;File Send Failed&quot;</span>), msg);
<a name="l01449"></a>01449                 g_free(msg);
<a name="l01450"></a>01450                 purple_xfer_cancel_local(xfer);
<a name="l01451"></a>01451         }
<a name="l01452"></a>01452 }
<a name="l01453"></a>01453 
<a name="l01454"></a>01454 <span class="keyword">static</span> <span class="keywordtype">void</span> resource_select_cancel_cb(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer, <a class="code" href="struct_purple_request_fields.html">PurpleRequestFields</a> *fields)
<a name="l01455"></a>01455 {
<a name="l01456"></a>01456         purple_xfer_cancel_local(xfer);
<a name="l01457"></a>01457 }
<a name="l01458"></a>01458 
<a name="l01459"></a>01459 <span class="keyword">static</span> <span class="keywordtype">void</span> do_transfer_send(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer, <span class="keyword">const</span> <span class="keywordtype">char</span> *resource)
<a name="l01460"></a>01460 {
<a name="l01461"></a>01461         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01462"></a>01462         <span class="keywordtype">char</span> **who_v = g_strsplit(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>, <span class="stringliteral">&quot;/&quot;</span>, 2);
<a name="l01463"></a>01463         <span class="keywordtype">char</span> *who;
<a name="l01464"></a>01464         <a class="code" href="struct___jabber_buddy.html">JabberBuddy</a> *jb;
<a name="l01465"></a>01465         <a class="code" href="struct___jabber_buddy_resource.html">JabberBuddyResource</a> *jbr = NULL;
<a name="l01466"></a>01466 
<a name="l01467"></a>01467         jb = jabber_buddy_find(jsx-&gt;js, who_v[0], FALSE);
<a name="l01468"></a>01468         <span class="keywordflow">if</span> (jb) {
<a name="l01469"></a>01469                 jbr = jabber_buddy_find_resource(jb, resource);
<a name="l01470"></a>01470         }
<a name="l01471"></a>01471 
<a name="l01472"></a>01472         who = g_strdup_printf(<span class="stringliteral">&quot;%s/%s&quot;</span>, who_v[0], resource);
<a name="l01473"></a>01473         g_strfreev(who_v);
<a name="l01474"></a>01474         g_free(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l01475"></a>01475         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a> = who;
<a name="l01476"></a>01476 
<a name="l01477"></a>01477         <span class="keywordflow">if</span> (jbr &amp;&amp; jabber_resource_know_capabilities(jbr)) {
<a name="l01478"></a>01478                 <span class="keywordtype">char</span> *msg;
<a name="l01479"></a>01479 
<a name="l01480"></a>01480                 <span class="keywordflow">if</span> (jabber_resource_has_capability(jbr, NS_IBB))
<a name="l01481"></a>01481                         jsx-&gt;stream_method |= STREAM_METHOD_IBB;
<a name="l01482"></a>01482                 <span class="keywordflow">if</span> (jabber_resource_has_capability(jbr, NS_SI_FILE_TRANSFER)) {
<a name="l01483"></a>01483                         jabber_si_xfer_send_request(xfer);
<a name="l01484"></a>01484                         <span class="keywordflow">return</span>;
<a name="l01485"></a>01485                 }
<a name="l01486"></a>01486 
<a name="l01487"></a>01487                 msg = g_strdup_printf(_(<span class="stringliteral">&quot;Unable to send file to %s, user does not support file transfers&quot;</span>), who);
<a name="l01488"></a>01488                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(jsx-&gt;js-&gt;gc, _(<span class="stringliteral">&quot;File Send Failed&quot;</span>),
<a name="l01489"></a>01489                                 _(<span class="stringliteral">&quot;File Send Failed&quot;</span>), msg);
<a name="l01490"></a>01490                 g_free(msg);
<a name="l01491"></a>01491                 purple_xfer_cancel_local(xfer);
<a name="l01492"></a>01492         } <span class="keywordflow">else</span> {
<a name="l01493"></a>01493                 jabber_disco_info_do(jsx-&gt;js, who,
<a name="l01494"></a>01494                                 jabber_si_xfer_send_disco_cb, xfer);
<a name="l01495"></a>01495         }
<a name="l01496"></a>01496 }
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 <span class="keyword">static</span> <span class="keywordtype">void</span> resource_select_ok_cb(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer, <a class="code" href="struct_purple_request_fields.html">PurpleRequestFields</a> *fields)
<a name="l01499"></a>01499 {
<a name="l01500"></a>01500         <a class="code" href="struct___purple_request_field.html">PurpleRequestField</a> *field = purple_request_fields_get_field(fields, <span class="stringliteral">&quot;resource&quot;</span>);
<a name="l01501"></a>01501         <span class="keywordtype">int</span> selected_id = purple_request_field_choice_get_value(field);
<a name="l01502"></a>01502         GList *labels = purple_request_field_choice_get_labels(field);
<a name="l01503"></a>01503 
<a name="l01504"></a>01504         <span class="keyword">const</span> <span class="keywordtype">char</span> *selected_label = g_list_nth_data(labels, selected_id);
<a name="l01505"></a>01505 
<a name="l01506"></a>01506         do_transfer_send(xfer, selected_label);
<a name="l01507"></a>01507 }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_si_xfer_init(<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer)
<a name="l01510"></a>01510 {
<a name="l01511"></a>01511         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx = xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a>;
<a name="l01512"></a>01512         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l01513"></a>01513         <span class="keywordflow">if</span>(purple_xfer_get_type(xfer) == <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a>) {
<a name="l01514"></a>01514                 <a class="code" href="struct___jabber_buddy.html">JabberBuddy</a> *jb;
<a name="l01515"></a>01515                 <a class="code" href="struct___jabber_buddy_resource.html">JabberBuddyResource</a> *jbr = NULL;
<a name="l01516"></a>01516                 <span class="keywordtype">char</span> *resource;
<a name="l01517"></a>01517                 GList *resources = NULL;
<a name="l01518"></a>01518 
<a name="l01519"></a>01519                 <span class="keywordflow">if</span>(NULL != (resource = jabber_get_resource(xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>))) {
<a name="l01520"></a>01520                         <span class="comment">/* they&#39;ve specified a resource, no need to ask or</span>
<a name="l01521"></a>01521 <span class="comment">                         * default or anything, just do it */</span>
<a name="l01522"></a>01522 
<a name="l01523"></a>01523                         do_transfer_send(xfer, resource);
<a name="l01524"></a>01524                         g_free(resource);
<a name="l01525"></a>01525                         <span class="keywordflow">return</span>;
<a name="l01526"></a>01526                 }
<a name="l01527"></a>01527 
<a name="l01528"></a>01528                 jb = jabber_buddy_find(jsx-&gt;js, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>, TRUE);
<a name="l01529"></a>01529 
<a name="l01530"></a>01530                 <span class="keywordflow">if</span> (jb) {
<a name="l01531"></a>01531                         GList *l;
<a name="l01532"></a>01532 
<a name="l01533"></a>01533                         <span class="keywordflow">for</span> (l = jb-&gt;<a class="code" href="struct___jabber_buddy.html#aeededcd4291a8c0d43741c757976696d">resources</a> ; l ; l = g_list_next(l)) {
<a name="l01534"></a>01534                                 jbr = l-&gt;data;
<a name="l01535"></a>01535 
<a name="l01536"></a>01536                                 <span class="keywordflow">if</span> (!jabber_resource_know_capabilities(jbr) ||
<a name="l01537"></a>01537                                     (jabber_resource_has_capability(jbr, NS_SI_FILE_TRANSFER)
<a name="l01538"></a>01538                                      &amp;&amp; (jabber_resource_has_capability(jbr, NS_BYTESTREAMS)
<a name="l01539"></a>01539                                          || jabber_resource_has_capability(jbr, NS_IBB)))) {
<a name="l01540"></a>01540                                         resources = g_list_append(resources, jbr);
<a name="l01541"></a>01541                                 }
<a name="l01542"></a>01542                         }
<a name="l01543"></a>01543                 }
<a name="l01544"></a>01544 
<a name="l01545"></a>01545                 <span class="keywordflow">if</span> (!resources) {
<a name="l01546"></a>01546                         <span class="comment">/* no resources online, we&#39;re trying to send to someone</span>
<a name="l01547"></a>01547 <span class="comment">                         * whose presence we&#39;re not subscribed to, or</span>
<a name="l01548"></a>01548 <span class="comment">                         * someone who is offline.  Let&#39;s inform the user */</span>
<a name="l01549"></a>01549                         <span class="keywordtype">char</span> *msg;
<a name="l01550"></a>01550 
<a name="l01551"></a>01551                         <span class="keywordflow">if</span>(!jb) {
<a name="l01552"></a>01552                                 msg = g_strdup_printf(_(<span class="stringliteral">&quot;Unable to send file to %s, invalid JID&quot;</span>), xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l01553"></a>01553                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(jb-&gt;subscription &amp; JABBER_SUB_TO) {
<a name="l01554"></a>01554                                 msg = g_strdup_printf(_(<span class="stringliteral">&quot;Unable to send file to %s, user is not online&quot;</span>), xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l01555"></a>01555                         } <span class="keywordflow">else</span> {
<a name="l01556"></a>01556                                 msg = g_strdup_printf(_(<span class="stringliteral">&quot;Unable to send file to %s, not subscribed to user presence&quot;</span>), xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l01557"></a>01557                         }
<a name="l01558"></a>01558 
<a name="l01559"></a>01559                         <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(jsx-&gt;js-&gt;gc, _(<span class="stringliteral">&quot;File Send Failed&quot;</span>), _(<span class="stringliteral">&quot;File Send Failed&quot;</span>), msg);
<a name="l01560"></a>01560                         g_free(msg);
<a name="l01561"></a>01561                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_list_length(resources) == 1) {
<a name="l01562"></a>01562                         <span class="comment">/* only 1 resource online (probably our most common case)</span>
<a name="l01563"></a>01563 <span class="comment">                         * so no need to ask who to send to */</span>
<a name="l01564"></a>01564                         jbr = resources-&gt;data;
<a name="l01565"></a>01565                         do_transfer_send(xfer, jbr-&gt;name);
<a name="l01566"></a>01566                 } <span class="keywordflow">else</span> {
<a name="l01567"></a>01567                         <span class="comment">/* we&#39;ve got multiple resources, we need to pick one to send to */</span>
<a name="l01568"></a>01568                         GList *l;
<a name="l01569"></a>01569                         <span class="keywordtype">char</span> *msg = g_strdup_printf(_(<span class="stringliteral">&quot;Please select the resource of %s to which you would like to send a file&quot;</span>), xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l01570"></a>01570                         <a class="code" href="struct_purple_request_fields.html">PurpleRequestFields</a> *fields = purple_request_fields_new();
<a name="l01571"></a>01571                         <a class="code" href="struct___purple_request_field.html">PurpleRequestField</a> *field = purple_request_field_choice_new(<span class="stringliteral">&quot;resource&quot;</span>, _(<span class="stringliteral">&quot;Resource&quot;</span>), 0);
<a name="l01572"></a>01572                         <a class="code" href="struct_purple_request_field_group.html">PurpleRequestFieldGroup</a> *group = purple_request_field_group_new(NULL);
<a name="l01573"></a>01573 
<a name="l01574"></a>01574                         <span class="keywordflow">for</span>(l = resources; l; l = l-&gt;next) {
<a name="l01575"></a>01575                                 jbr = l-&gt;data;
<a name="l01576"></a>01576                                 purple_request_field_choice_add(field, jbr-&gt;name);
<a name="l01577"></a>01577                         }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579                         purple_request_field_group_add_field(group, field);
<a name="l01580"></a>01580 
<a name="l01581"></a>01581                         purple_request_fields_add_group(fields, group);
<a name="l01582"></a>01582 
<a name="l01583"></a>01583                         purple_request_fields(jsx-&gt;js-&gt;gc, _(<span class="stringliteral">&quot;Select a Resource&quot;</span>), msg, NULL, fields,
<a name="l01584"></a>01584                                         _(<span class="stringliteral">&quot;Send File&quot;</span>), G_CALLBACK(resource_select_ok_cb), _(<span class="stringliteral">&quot;Cancel&quot;</span>), G_CALLBACK(resource_select_cancel_cb),
<a name="l01585"></a>01585                                         jsx-&gt;js-&gt;gc-&gt;<a class="code" href="struct___purple_connection.html#ab7713db5a3c9faff940723d9c30c0e63">account</a>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>, NULL, xfer);
<a name="l01586"></a>01586 
<a name="l01587"></a>01587                         g_free(msg);
<a name="l01588"></a>01588                 }
<a name="l01589"></a>01589 
<a name="l01590"></a>01590                 g_list_free(resources);
<a name="l01591"></a>01591         } <span class="keywordflow">else</span> {
<a name="l01592"></a>01592                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *si, *feature, *x, *field, *value;
<a name="l01593"></a>01593 
<a name="l01594"></a>01594                 iq = jabber_iq_new(jsx-&gt;js, JABBER_IQ_RESULT);
<a name="l01595"></a>01595                 xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, xfer-&gt;<a class="code" href="struct___purple_xfer.html#a7cabb2ac275cd724643036d13ba7d6c0">who</a>);
<a name="l01596"></a>01596                 <span class="keywordflow">if</span>(jsx-&gt;iq_id)
<a name="l01597"></a>01597                         jabber_iq_set_id(iq, jsx-&gt;iq_id);
<a name="l01598"></a>01598                 <span class="keywordflow">else</span>
<a name="l01599"></a>01599                         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Sending SI result with new IQ id.\n&quot;</span>);
<a name="l01600"></a>01600 
<a name="l01601"></a>01601                 jsx-&gt;accepted = TRUE;
<a name="l01602"></a>01602 
<a name="l01603"></a>01603                 si = xmlnode_new_child(iq-&gt;node, <span class="stringliteral">&quot;si&quot;</span>);
<a name="l01604"></a>01604                 xmlnode_set_namespace(si, <span class="stringliteral">&quot;http://jabber.org/protocol/si&quot;</span>);
<a name="l01605"></a>01605 
<a name="l01606"></a>01606                 feature = xmlnode_new_child(si, <span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01607"></a>01607                 xmlnode_set_namespace(feature, <span class="stringliteral">&quot;http://jabber.org/protocol/feature-neg&quot;</span>);
<a name="l01608"></a>01608 
<a name="l01609"></a>01609                 x = xmlnode_new_child(feature, <span class="stringliteral">&quot;x&quot;</span>);
<a name="l01610"></a>01610                 xmlnode_set_namespace(x, <span class="stringliteral">&quot;jabber:x:data&quot;</span>);
<a name="l01611"></a>01611                 xmlnode_set_attrib(x, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;submit&quot;</span>);
<a name="l01612"></a>01612                 field = xmlnode_new_child(x, <span class="stringliteral">&quot;field&quot;</span>);
<a name="l01613"></a>01613                 xmlnode_set_attrib(field, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;stream-method&quot;</span>);
<a name="l01614"></a>01614 
<a name="l01615"></a>01615                 <span class="comment">/* we should maybe &quot;remember&quot; if bytestreams has failed before (in the</span>
<a name="l01616"></a>01616 <span class="comment">                        same session) with this JID, and only present IBB as an option to</span>
<a name="l01617"></a>01617 <span class="comment">                        avoid unnessesary timeout */</span>
<a name="l01618"></a>01618                 <span class="comment">/* maybe we should have an account option to always just try IBB</span>
<a name="l01619"></a>01619 <span class="comment">                        for people who know their firewalls are very restrictive */</span>
<a name="l01620"></a>01620                 <span class="keywordflow">if</span> (jsx-&gt;stream_method &amp; STREAM_METHOD_BYTESTREAMS) {
<a name="l01621"></a>01621                         value = xmlnode_new_child(field, <span class="stringliteral">&quot;value&quot;</span>);
<a name="l01622"></a>01622                         xmlnode_insert_data(value, NS_BYTESTREAMS, -1);
<a name="l01623"></a>01623                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(jsx-&gt;stream_method &amp; STREAM_METHOD_IBB) {
<a name="l01624"></a>01624                         value = xmlnode_new_child(field, <span class="stringliteral">&quot;value&quot;</span>);
<a name="l01625"></a>01625                         xmlnode_insert_data(value, NS_IBB, -1);
<a name="l01626"></a>01626                 }
<a name="l01627"></a>01627 
<a name="l01628"></a>01628                 jabber_iq_send(iq);
<a name="l01629"></a>01629         }
<a name="l01630"></a>01630 }
<a name="l01631"></a>01631 
<a name="l01632"></a>01632 <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *jabber_si_new_xfer(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keyword">const</span> <span class="keywordtype">char</span> *who)
<a name="l01633"></a>01633 {
<a name="l01634"></a>01634         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js;
<a name="l01635"></a>01635 
<a name="l01636"></a>01636         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer;
<a name="l01637"></a>01637         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx;
<a name="l01638"></a>01638 
<a name="l01639"></a>01639         js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         xfer = purple_xfer_new(gc-&gt;<a class="code" href="struct___purple_connection.html#ab7713db5a3c9faff940723d9c30c0e63">account</a>, <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356ac52c4c9694591c04ad151e913a716f9a">PURPLE_XFER_SEND</a>, who);
<a name="l01642"></a>01642         <span class="keywordflow">if</span> (xfer)
<a name="l01643"></a>01643         {
<a name="l01644"></a>01644                 xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a> = jsx = g_new0(<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a>, 1);
<a name="l01645"></a>01645                 jsx-&gt;js = js;
<a name="l01646"></a>01646                 jsx-&gt;local_streamhost_fd = -1;
<a name="l01647"></a>01647 
<a name="l01648"></a>01648                 jsx-&gt;ibb_session = NULL;
<a name="l01649"></a>01649 
<a name="l01650"></a>01650                 purple_xfer_set_init_fnc(xfer, jabber_si_xfer_init);
<a name="l01651"></a>01651                 purple_xfer_set_cancel_send_fnc(xfer, jabber_si_xfer_cancel_send);
<a name="l01652"></a>01652                 purple_xfer_set_end_fnc(xfer, jabber_si_xfer_end);
<a name="l01653"></a>01653 
<a name="l01654"></a>01654                 js-&gt;file_transfers = g_list_append(js-&gt;file_transfers, xfer);
<a name="l01655"></a>01655         }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657         <span class="keywordflow">return</span> xfer;
<a name="l01658"></a>01658 }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660 <span class="keywordtype">void</span> jabber_si_xfer_send(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keyword">const</span> <span class="keywordtype">char</span> *who, <span class="keyword">const</span> <span class="keywordtype">char</span> *file)
<a name="l01661"></a>01661 {
<a name="l01662"></a>01662         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer;
<a name="l01663"></a>01663 
<a name="l01664"></a>01664         xfer = jabber_si_new_xfer(gc, who);
<a name="l01665"></a>01665 
<a name="l01666"></a>01666         <span class="keywordflow">if</span> (file)
<a name="l01667"></a>01667                 purple_xfer_request_accepted(xfer, file);
<a name="l01668"></a>01668         <span class="keywordflow">else</span>
<a name="l01669"></a>01669                 purple_xfer_request(xfer);
<a name="l01670"></a>01670 }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672 <span class="preprocessor">#if ENABLE_FT_THUMBNAILS</span>
<a name="l01673"></a>01673 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01674"></a>01674 jabber_si_thumbnail_cb(<a class="code" href="struct_jabber_data.html">JabberData</a> *data, gchar *alt, gpointer userdata)
<a name="l01675"></a>01675 {
<a name="l01676"></a>01676         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer = (<a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *) userdata;
<a name="l01677"></a>01677 
<a name="l01678"></a>01678         <span class="keywordflow">if</span> (data) {
<a name="l01679"></a>01679                 purple_xfer_set_thumbnail(xfer, jabber_data_get_data(data),
<a name="l01680"></a>01680                         jabber_data_get_size(data), jabber_data_get_type(data));
<a name="l01681"></a>01681                 <span class="comment">/* data is ephemeral, get rid of now (the xfer re-owned the thumbnail */</span>
<a name="l01682"></a>01682                 jabber_data_destroy(data);
<a name="l01683"></a>01683         }
<a name="l01684"></a>01684 
<a name="l01685"></a>01685         purple_xfer_request(xfer);
<a name="l01686"></a>01686 }
<a name="l01687"></a>01687 <span class="preprocessor">#endif</span>
<a name="l01688"></a>01688 <span class="preprocessor"></span>
<a name="l01689"></a>01689 <span class="keywordtype">void</span> jabber_si_parse(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from, JabberIqType type,
<a name="l01690"></a>01690                      <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <a class="code" href="struct__xmlnode.html">xmlnode</a> *si)
<a name="l01691"></a>01691 {
<a name="l01692"></a>01692         <a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a> *jsx;
<a name="l01693"></a>01693         <a class="code" href="struct___purple_xfer.html">PurpleXfer</a> *xfer;
<a name="l01694"></a>01694         <a class="code" href="struct__xmlnode.html">xmlnode</a> *file, *feature, *x, *field, *option, *value;
<a name="l01695"></a>01695 <span class="preprocessor">#if ENABLE_FT_THUMBNAILS</span>
<a name="l01696"></a>01696 <span class="preprocessor"></span>        <a class="code" href="struct__xmlnode.html">xmlnode</a> *thumbnail;
<a name="l01697"></a>01697 <span class="preprocessor">#endif</span>
<a name="l01698"></a>01698 <span class="preprocessor"></span>        <span class="keyword">const</span> <span class="keywordtype">char</span> *stream_id, *filename, *filesize_c, *profile;
<a name="l01699"></a>01699         guint64 filesize_64 = 0;
<a name="l01700"></a>01700         <span class="keywordtype">size_t</span> filesize = 0;
<a name="l01701"></a>01701 
<a name="l01702"></a>01702         <span class="keywordflow">if</span>(!(profile = xmlnode_get_attrib(si, <span class="stringliteral">&quot;profile&quot;</span>)) ||
<a name="l01703"></a>01703                         strcmp(profile, NS_SI_FILE_TRANSFER))
<a name="l01704"></a>01704                 <span class="keywordflow">return</span>;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706         <span class="keywordflow">if</span>(!(stream_id = xmlnode_get_attrib(si, <span class="stringliteral">&quot;id&quot;</span>)))
<a name="l01707"></a>01707                 <span class="keywordflow">return</span>;
<a name="l01708"></a>01708 
<a name="l01709"></a>01709         <span class="keywordflow">if</span>(!(file = xmlnode_get_child(si, <span class="stringliteral">&quot;file&quot;</span>)))
<a name="l01710"></a>01710                 <span class="keywordflow">return</span>;
<a name="l01711"></a>01711 
<a name="l01712"></a>01712         <span class="keywordflow">if</span>(!(filename = xmlnode_get_attrib(file, <span class="stringliteral">&quot;name&quot;</span>)))
<a name="l01713"></a>01713                 <span class="keywordflow">return</span>;
<a name="l01714"></a>01714 
<a name="l01715"></a>01715         <span class="keywordflow">if</span>((filesize_c = xmlnode_get_attrib(file, <span class="stringliteral">&quot;size&quot;</span>)))
<a name="l01716"></a>01716                 filesize_64 = g_ascii_strtoull(filesize_c, NULL, 10);
<a name="l01717"></a>01717         <span class="comment">/* TODO 3.0.0: When the core uses a guint64, this is redundant.</span>
<a name="l01718"></a>01718 <span class="comment">         * See #8477.</span>
<a name="l01719"></a>01719 <span class="comment">         */</span>
<a name="l01720"></a>01720         <span class="keywordflow">if</span> (filesize_64 &gt; G_MAXSIZE) {
<a name="l01721"></a>01721                 <span class="comment">/* Should this pop up a warning? */</span>
<a name="l01722"></a>01722                 <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Unable to transfer file (too large)&quot;</span>
<a name="l01723"></a>01723                                      <span class="stringliteral">&quot; -- see #8477 for more details.&quot;</span>);
<a name="l01724"></a>01724                 <span class="keywordflow">return</span>;
<a name="l01725"></a>01725         }
<a name="l01726"></a>01726         filesize = filesize_64;
<a name="l01727"></a>01727 
<a name="l01728"></a>01728         <span class="keywordflow">if</span>(!(feature = xmlnode_get_child(si, <span class="stringliteral">&quot;feature&quot;</span>)))
<a name="l01729"></a>01729                 <span class="keywordflow">return</span>;
<a name="l01730"></a>01730 
<a name="l01731"></a>01731         <span class="keywordflow">if</span>(!(x = xmlnode_get_child_with_namespace(feature, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;jabber:x:data&quot;</span>)))
<a name="l01732"></a>01732                 <span class="keywordflow">return</span>;
<a name="l01733"></a>01733 
<a name="l01734"></a>01734         <span class="keywordflow">if</span>(!from)
<a name="l01735"></a>01735                 <span class="keywordflow">return</span>;
<a name="l01736"></a>01736 
<a name="l01737"></a>01737         <span class="comment">/* if they&#39;ve already sent us this file transfer with the same damn id</span>
<a name="l01738"></a>01738 <span class="comment">         * then we&#39;re gonna ignore it, until I think of something better to do</span>
<a name="l01739"></a>01739 <span class="comment">         * with it */</span>
<a name="l01740"></a>01740         <span class="keywordflow">if</span>(jabber_si_xfer_find(js, stream_id, from) != NULL)
<a name="l01741"></a>01741                 <span class="keywordflow">return</span>;
<a name="l01742"></a>01742 
<a name="l01743"></a>01743         jsx = g_new0(<a class="code" href="struct___jabber_s_i_xfer.html">JabberSIXfer</a>, 1);
<a name="l01744"></a>01744         jsx-&gt;local_streamhost_fd = -1;
<a name="l01745"></a>01745 
<a name="l01746"></a>01746         jsx-&gt;ibb_session = NULL;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748         <span class="keywordflow">for</span>(field = xmlnode_get_child(x, <span class="stringliteral">&quot;field&quot;</span>); field; field = xmlnode_get_next_twin(field)) {
<a name="l01749"></a>01749                 <span class="keyword">const</span> <span class="keywordtype">char</span> *var = xmlnode_get_attrib(field, <span class="stringliteral">&quot;var&quot;</span>);
<a name="l01750"></a>01750                 <span class="keywordflow">if</span>(var &amp;&amp; !strcmp(var, <span class="stringliteral">&quot;stream-method&quot;</span>)) {
<a name="l01751"></a>01751                         <span class="keywordflow">for</span>(option = xmlnode_get_child(field, <span class="stringliteral">&quot;option&quot;</span>); option;
<a name="l01752"></a>01752                                         option = xmlnode_get_next_twin(option)) {
<a name="l01753"></a>01753                                 <span class="keywordflow">if</span>((value = xmlnode_get_child(option, <span class="stringliteral">&quot;value&quot;</span>))) {
<a name="l01754"></a>01754                                         <span class="keywordtype">char</span> *val;
<a name="l01755"></a>01755                                         <span class="keywordflow">if</span>((val = xmlnode_get_data(value))) {
<a name="l01756"></a>01756                                                 <span class="keywordflow">if</span>(!strcmp(val, NS_BYTESTREAMS)) {
<a name="l01757"></a>01757                                                         jsx-&gt;stream_method |= STREAM_METHOD_BYTESTREAMS;
<a name="l01758"></a>01758                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(val, NS_IBB)) {
<a name="l01759"></a>01759                                                         jsx-&gt;stream_method |= STREAM_METHOD_IBB;
<a name="l01760"></a>01760                                                 }
<a name="l01761"></a>01761                                                 g_free(val);
<a name="l01762"></a>01762                                         }
<a name="l01763"></a>01763                                 }
<a name="l01764"></a>01764                         }
<a name="l01765"></a>01765                 }
<a name="l01766"></a>01766         }
<a name="l01767"></a>01767 
<a name="l01768"></a>01768         <span class="keywordflow">if</span>(jsx-&gt;stream_method == STREAM_METHOD_UNKNOWN) {
<a name="l01769"></a>01769                 g_free(jsx);
<a name="l01770"></a>01770                 <span class="keywordflow">return</span>;
<a name="l01771"></a>01771         }
<a name="l01772"></a>01772 
<a name="l01773"></a>01773         jsx-&gt;js = js;
<a name="l01774"></a>01774         jsx-&gt;stream_id = g_strdup(stream_id);
<a name="l01775"></a>01775         jsx-&gt;iq_id = g_strdup(<span class="keywordtype">id</span>);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777         xfer = purple_xfer_new(js-&gt;gc-&gt;<a class="code" href="struct___purple_connection.html#ab7713db5a3c9faff940723d9c30c0e63">account</a>, <a class="code" href="ft_8h.html#a78fc08b8e8082913b7d7c92bacc12356a6758524d6aa2050ecf0f513a29f6aa05">PURPLE_XFER_RECEIVE</a>, from);
<a name="l01778"></a>01778         g_return_if_fail(xfer != NULL);
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         xfer-&gt;<a class="code" href="struct___purple_xfer.html#a4ce7ab5aaa647508c1eb9ba1593afeda">data</a> = jsx;
<a name="l01781"></a>01781 
<a name="l01782"></a>01782         purple_xfer_set_filename(xfer, filename);
<a name="l01783"></a>01783         <span class="keywordflow">if</span>(filesize &gt; 0)
<a name="l01784"></a>01784                 purple_xfer_set_size(xfer, filesize);
<a name="l01785"></a>01785 
<a name="l01786"></a>01786         purple_xfer_set_init_fnc(xfer, jabber_si_xfer_init);
<a name="l01787"></a>01787         purple_xfer_set_request_denied_fnc(xfer, jabber_si_xfer_request_denied);
<a name="l01788"></a>01788         purple_xfer_set_cancel_recv_fnc(xfer, jabber_si_xfer_cancel_recv);
<a name="l01789"></a>01789         purple_xfer_set_end_fnc(xfer, jabber_si_xfer_end);
<a name="l01790"></a>01790 
<a name="l01791"></a>01791         js-&gt;file_transfers = g_list_append(js-&gt;file_transfers, xfer);
<a name="l01792"></a>01792 
<a name="l01793"></a>01793 <span class="preprocessor">#if ENABLE_FT_THUMBNAILS</span>
<a name="l01794"></a>01794 <span class="preprocessor"></span>        <span class="comment">/* if there is a thumbnail, we should request it... */</span>
<a name="l01795"></a>01795         <span class="keywordflow">if</span> ((thumbnail = xmlnode_get_child_with_namespace(file, <span class="stringliteral">&quot;thumbnail&quot;</span>,
<a name="l01796"></a>01796                 NS_THUMBS))) {
<a name="l01797"></a>01797                 <span class="keyword">const</span> <span class="keywordtype">char</span> *cid = xmlnode_get_attrib(thumbnail, <span class="stringliteral">&quot;cid&quot;</span>);
<a name="l01798"></a>01798                 <span class="keywordflow">if</span> (cid) {
<a name="l01799"></a>01799                         jabber_data_request(js, cid, purple_xfer_get_remote_user(xfer),
<a name="l01800"></a>01800                             NULL, TRUE, jabber_si_thumbnail_cb, xfer);
<a name="l01801"></a>01801                         <span class="keywordflow">return</span>;
<a name="l01802"></a>01802                 }
<a name="l01803"></a>01803         }
<a name="l01804"></a>01804 <span class="preprocessor">#endif</span>
<a name="l01805"></a>01805 <span class="preprocessor"></span>
<a name="l01806"></a>01806         purple_xfer_request(xfer);
<a name="l01807"></a>01807 }
<a name="l01808"></a>01808 
<a name="l01809"></a>01809 <span class="keywordtype">void</span>
<a name="l01810"></a>01810 jabber_si_init(<span class="keywordtype">void</span>)
<a name="l01811"></a>01811 {
<a name="l01812"></a>01812         jabber_iq_register_handler(<span class="stringliteral">&quot;si&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/si&quot;</span>, jabber_si_parse);
<a name="l01813"></a>01813 
<a name="l01814"></a>01814         jabber_ibb_register_open_handler(jabber_si_xfer_ibb_open_cb);
<a name="l01815"></a>01815 }
<a name="l01816"></a>01816 
<a name="l01817"></a>01817 <span class="keywordtype">void</span>
<a name="l01818"></a>01818 jabber_si_uninit(<span class="keywordtype">void</span>)
<a name="l01819"></a>01819 {
<a name="l01820"></a>01820         jabber_ibb_unregister_open_handler(jabber_si_xfer_ibb_open_cb);
<a name="l01821"></a>01821 }
<a name="l01822"></a>01822 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>si.c</b>      </li>
      <li class="footer">Generated on Sun Mar 24 2013 16:05:12 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
