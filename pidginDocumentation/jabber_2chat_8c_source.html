<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>protocols/jabber/chat.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('jabber_2chat_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">protocols/jabber/chat.c</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * purple - Jabber Protocol Plugin</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Purple is the legal property of its developers, whose names are too numerous</span>
<a name="l00005"></a>00005 <span class="comment"> * to list here.  Please refer to the COPYRIGHT file distributed with this</span>
<a name="l00006"></a>00006 <span class="comment"> * source distribution.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00009"></a>00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00010"></a>00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00011"></a>00011 <span class="comment"> * (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00016"></a>00016 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00019"></a>00019 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00020"></a>00020 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02111-1301  USA</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;internal.h&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html">debug.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="prpl_8h.html">prpl.h</a>&quot;</span> <span class="comment">/* for proto_chat_entry */</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="notify_8h.html">notify.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="request_8h.html">request.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="roomlist_8h.html">roomlist.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="util_8h.html">util.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="chat_8h.html">chat.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="iq_8h.html">iq.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;message.h&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="presence_8h.html">presence.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="xdata_8h.html">xdata.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;data.h&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 GList *jabber_chat_info(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc)
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040         GList *m = NULL;
<a name="l00041"></a>00041         <span class="keyword">struct </span><a class="code" href="structproto__chat__entry.html">proto_chat_entry</a> *pce;
<a name="l00042"></a>00042 
<a name="l00043"></a>00043         pce = g_new0(<span class="keyword">struct</span> <a class="code" href="structproto__chat__entry.html">proto_chat_entry</a>, 1);
<a name="l00044"></a>00044         pce-&gt;<a class="code" href="structproto__chat__entry.html#ab768d3856f2e654a6186ab2412a57184">label</a> = _(<span class="stringliteral">&quot;_Room:&quot;</span>);
<a name="l00045"></a>00045         pce-&gt;<a class="code" href="structproto__chat__entry.html#a55bf097671c4b1f97aba81fa506f6233">identifier</a> = <span class="stringliteral">&quot;room&quot;</span>;
<a name="l00046"></a>00046         pce-&gt;<a class="code" href="structproto__chat__entry.html#a540a9f2b5ee1dc521e6a24f043266971">required</a> = TRUE;
<a name="l00047"></a>00047         m = g_list_append(m, pce);
<a name="l00048"></a>00048 
<a name="l00049"></a>00049         pce = g_new0(<span class="keyword">struct</span> <a class="code" href="structproto__chat__entry.html">proto_chat_entry</a>, 1);
<a name="l00050"></a>00050         pce-&gt;<a class="code" href="structproto__chat__entry.html#ab768d3856f2e654a6186ab2412a57184">label</a> = _(<span class="stringliteral">&quot;_Server:&quot;</span>);
<a name="l00051"></a>00051         pce-&gt;<a class="code" href="structproto__chat__entry.html#a55bf097671c4b1f97aba81fa506f6233">identifier</a> = <span class="stringliteral">&quot;server&quot;</span>;
<a name="l00052"></a>00052         pce-&gt;<a class="code" href="structproto__chat__entry.html#a540a9f2b5ee1dc521e6a24f043266971">required</a> = TRUE;
<a name="l00053"></a>00053         m = g_list_append(m, pce);
<a name="l00054"></a>00054 
<a name="l00055"></a>00055         pce = g_new0(<span class="keyword">struct</span> <a class="code" href="structproto__chat__entry.html">proto_chat_entry</a>, 1);
<a name="l00056"></a>00056         pce-&gt;<a class="code" href="structproto__chat__entry.html#ab768d3856f2e654a6186ab2412a57184">label</a> = _(<span class="stringliteral">&quot;_Handle:&quot;</span>);
<a name="l00057"></a>00057         pce-&gt;<a class="code" href="structproto__chat__entry.html#a55bf097671c4b1f97aba81fa506f6233">identifier</a> = <span class="stringliteral">&quot;handle&quot;</span>;
<a name="l00058"></a>00058         pce-&gt;<a class="code" href="structproto__chat__entry.html#a540a9f2b5ee1dc521e6a24f043266971">required</a> = TRUE;
<a name="l00059"></a>00059         m = g_list_append(m, pce);
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         pce = g_new0(<span class="keyword">struct</span> <a class="code" href="structproto__chat__entry.html">proto_chat_entry</a>, 1);
<a name="l00062"></a>00062         pce-&gt;<a class="code" href="structproto__chat__entry.html#ab768d3856f2e654a6186ab2412a57184">label</a> = _(<span class="stringliteral">&quot;_Password:&quot;</span>);
<a name="l00063"></a>00063         pce-&gt;<a class="code" href="structproto__chat__entry.html#a55bf097671c4b1f97aba81fa506f6233">identifier</a> = <span class="stringliteral">&quot;password&quot;</span>;
<a name="l00064"></a>00064         pce-&gt;<a class="code" href="structproto__chat__entry.html#ac2df22097dc20fa0d52eed857799be65">secret</a> = TRUE;
<a name="l00065"></a>00065         m = g_list_append(m, pce);
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="keywordflow">return</span> m;
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 GHashTable *jabber_chat_info_defaults(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keyword">const</span> <span class="keywordtype">char</span> *chat_name)
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072         GHashTable *defaults;
<a name="l00073"></a>00073         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         defaults = g_hash_table_new_full(g_str_hash, g_str_equal, NULL, g_free);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077         g_hash_table_insert(defaults, <span class="stringliteral">&quot;handle&quot;</span>, g_strdup(js-&gt;user-&gt;node));
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         <span class="keywordflow">if</span> (js-&gt;chat_servers)
<a name="l00080"></a>00080                 g_hash_table_insert(defaults, <span class="stringliteral">&quot;server&quot;</span>, g_strdup(js-&gt;chat_servers-&gt;data));
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         <span class="keywordflow">if</span> (chat_name != NULL) {
<a name="l00083"></a>00083                 <a class="code" href="struct___jabber_i_d.html">JabberID</a> *jid = jabber_id_new(chat_name);
<a name="l00084"></a>00084                 <span class="keywordflow">if</span>(jid) {
<a name="l00085"></a>00085                         g_hash_table_insert(defaults, <span class="stringliteral">&quot;room&quot;</span>, g_strdup(jid-&gt;node));
<a name="l00086"></a>00086                         <span class="keywordflow">if</span>(jid-&gt;domain)
<a name="l00087"></a>00087                                 g_hash_table_replace(defaults, <span class="stringliteral">&quot;server&quot;</span>, g_strdup(jid-&gt;domain));
<a name="l00088"></a>00088                         <span class="keywordflow">if</span>(jid-&gt;resource)
<a name="l00089"></a>00089                                 g_hash_table_replace(defaults, <span class="stringliteral">&quot;handle&quot;</span>, g_strdup(jid-&gt;resource));
<a name="l00090"></a>00090                         jabber_id_free(jid);
<a name="l00091"></a>00091                 }
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         <span class="keywordflow">return</span> defaults;
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <a class="code" href="struct___jabber_chat.html">JabberChat</a> *jabber_chat_find(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *room,
<a name="l00098"></a>00098                 <span class="keyword">const</span> <span class="keywordtype">char</span> *server)
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat = NULL;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         g_return_val_if_fail(room != NULL, NULL);
<a name="l00103"></a>00103         g_return_val_if_fail(server != NULL, NULL);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105         <span class="keywordflow">if</span>(NULL != js-&gt;chats)
<a name="l00106"></a>00106         {
<a name="l00107"></a>00107                 <span class="keywordtype">char</span> *room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, room, server);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109                 chat = g_hash_table_lookup(js-&gt;chats, room_jid);
<a name="l00110"></a>00110                 g_free(room_jid);
<a name="l00111"></a>00111         }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         <span class="keywordflow">return</span> chat;
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="struct__find__by__id__data.html">00116</a> <span class="keyword">struct </span><a class="code" href="struct__find__by__id__data.html">_find_by_id_data</a> {
<a name="l00117"></a>00117         <span class="keywordtype">int</span> id;
<a name="l00118"></a>00118         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l00119"></a>00119 };
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="keyword">static</span> <span class="keywordtype">void</span> find_by_id_foreach_cb(gpointer key, gpointer value, gpointer user_data)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat = value;
<a name="l00124"></a>00124         <span class="keyword">struct </span><a class="code" href="struct__find__by__id__data.html">_find_by_id_data</a> *fbid = user_data;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         <span class="keywordflow">if</span>(chat-&gt;id == fbid-&gt;id)
<a name="l00127"></a>00127                 fbid-&gt;chat = chat;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <a class="code" href="struct___jabber_chat.html">JabberChat</a> *jabber_chat_find_by_id(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keywordtype">int</span> <span class="keywordtype">id</span>)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l00133"></a>00133         <span class="keyword">struct </span><a class="code" href="struct__find__by__id__data.html">_find_by_id_data</a> *fbid = g_new0(<span class="keyword">struct</span> <a class="code" href="struct__find__by__id__data.html">_find_by_id_data</a>, 1);
<a name="l00134"></a>00134         fbid-&gt;id = id;
<a name="l00135"></a>00135         g_hash_table_foreach(js-&gt;chats, find_by_id_foreach_cb, fbid);
<a name="l00136"></a>00136         chat = fbid-&gt;chat;
<a name="l00137"></a>00137         g_free(fbid);
<a name="l00138"></a>00138         <span class="keywordflow">return</span> chat;
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <a class="code" href="struct___jabber_chat.html">JabberChat</a> *jabber_chat_find_by_conv(<a class="code" href="struct___purple_conversation.html">PurpleConversation</a> *conv)
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143         <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account = purple_conversation_get_account(conv);
<a name="l00144"></a>00144         <a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc = purple_account_get_connection(account);
<a name="l00145"></a>00145         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js;
<a name="l00146"></a>00146         <span class="keywordtype">int</span> id;
<a name="l00147"></a>00147         <span class="keywordflow">if</span> (!gc)
<a name="l00148"></a>00148                 <span class="keywordflow">return</span> NULL;
<a name="l00149"></a>00149         js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00150"></a>00150         <span class="keywordtype">id</span> = purple_conv_chat_get_id(PURPLE_CONV_CHAT(conv));
<a name="l00151"></a>00151         <span class="keywordflow">return</span> jabber_chat_find_by_id(js, <span class="keywordtype">id</span>);
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="keywordtype">void</span> jabber_chat_invite(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg,
<a name="l00155"></a>00155                 <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00158"></a>00158         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l00159"></a>00159         <a class="code" href="struct__xmlnode.html">xmlnode</a> *message, *body, *x, *invite;
<a name="l00160"></a>00160         <span class="keywordtype">char</span> *room_jid;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         chat = jabber_chat_find_by_id(js, <span class="keywordtype">id</span>);
<a name="l00163"></a>00163         <span class="keywordflow">if</span>(!chat)
<a name="l00164"></a>00164                 <span class="keywordflow">return</span>;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         message = xmlnode_new(<span class="stringliteral">&quot;message&quot;</span>);
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="keywordflow">if</span>(chat-&gt;muc) {
<a name="l00171"></a>00171                 xmlnode_set_attrib(message, <span class="stringliteral">&quot;to&quot;</span>, room_jid);
<a name="l00172"></a>00172                 x = xmlnode_new_child(message, <span class="stringliteral">&quot;x&quot;</span>);
<a name="l00173"></a>00173                 xmlnode_set_namespace(x, <span class="stringliteral">&quot;http://jabber.org/protocol/muc#user&quot;</span>);
<a name="l00174"></a>00174                 invite = xmlnode_new_child(x, <span class="stringliteral">&quot;invite&quot;</span>);
<a name="l00175"></a>00175                 xmlnode_set_attrib(invite, <span class="stringliteral">&quot;to&quot;</span>, name);
<a name="l00176"></a>00176                 <span class="keywordflow">if</span> (msg) {
<a name="l00177"></a>00177                         body = xmlnode_new_child(invite, <span class="stringliteral">&quot;reason&quot;</span>);
<a name="l00178"></a>00178                         xmlnode_insert_data(body, msg, -1);
<a name="l00179"></a>00179                 }
<a name="l00180"></a>00180         } <span class="keywordflow">else</span> {
<a name="l00181"></a>00181                 xmlnode_set_attrib(message, <span class="stringliteral">&quot;to&quot;</span>, name);
<a name="l00182"></a>00182                 <span class="comment">/*</span>
<a name="l00183"></a>00183 <span class="comment">                 * Putting the reason into the body was an &#39;undocumented protocol,</span>
<a name="l00184"></a>00184 <span class="comment">                 * ...not part of &quot;groupchat 1.0&quot;&#39;.</span>
<a name="l00185"></a>00185 <span class="comment">                 * http://xmpp.org/extensions/attic/jep-0045-1.16.html#invite</span>
<a name="l00186"></a>00186 <span class="comment">                 *</span>
<a name="l00187"></a>00187 <span class="comment">                 * Left here for compatibility.</span>
<a name="l00188"></a>00188 <span class="comment">                 */</span>
<a name="l00189"></a>00189                 <span class="keywordflow">if</span> (msg) {
<a name="l00190"></a>00190                         body = xmlnode_new_child(message, <span class="stringliteral">&quot;body&quot;</span>);
<a name="l00191"></a>00191                         xmlnode_insert_data(body, msg, -1);
<a name="l00192"></a>00192                 }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194                 x = xmlnode_new_child(message, <span class="stringliteral">&quot;x&quot;</span>);
<a name="l00195"></a>00195                 xmlnode_set_attrib(x, <span class="stringliteral">&quot;jid&quot;</span>, room_jid);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197                 <span class="comment">/* The better place for it! XEP-0249 style. */</span>
<a name="l00198"></a>00198                 <span class="keywordflow">if</span> (msg)
<a name="l00199"></a>00199                         xmlnode_set_attrib(x, <span class="stringliteral">&quot;reason&quot;</span>, msg);
<a name="l00200"></a>00200                 xmlnode_set_namespace(x, <span class="stringliteral">&quot;jabber:x:conference&quot;</span>);
<a name="l00201"></a>00201         }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         jabber_send(js, message);
<a name="l00204"></a>00204         xmlnode_free(message);
<a name="l00205"></a>00205         g_free(room_jid);
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="keywordtype">void</span> jabber_chat_member_free(<a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *jcm);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="keywordtype">char</span> *jabber_get_chat_name(GHashTable *data) {
<a name="l00211"></a>00211         <span class="keywordtype">char</span> *room, *server, *chat_name = NULL;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         room = g_hash_table_lookup(data, <span class="stringliteral">&quot;room&quot;</span>);
<a name="l00214"></a>00214         server = g_hash_table_lookup(data, <span class="stringliteral">&quot;server&quot;</span>);
<a name="l00215"></a>00215 
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (room &amp;&amp; server) {
<a name="l00217"></a>00217                 chat_name = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, room, server);
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219         <span class="keywordflow">return</span> chat_name;
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="keyword">static</span> <span class="keywordtype">void</span> insert_in_hash_table(gpointer key, gpointer value, gpointer user_data)
<a name="l00223"></a>00223 {
<a name="l00224"></a>00224         GHashTable *hash_table = (GHashTable *)user_data;
<a name="l00225"></a>00225         g_hash_table_insert(hash_table, g_strdup(key), g_strdup(value));
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="keyword">static</span> <a class="code" href="struct___jabber_chat.html">JabberChat</a> *jabber_chat_new(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *room,
<a name="l00229"></a>00229                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *server, <span class="keyword">const</span> <span class="keywordtype">char</span> *handle,
<a name="l00230"></a>00230                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *password, GHashTable *data)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l00233"></a>00233         <span class="keywordtype">char</span> *jid;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (jabber_chat_find(js, room, server) != NULL)
<a name="l00236"></a>00236                 <span class="keywordflow">return</span> NULL;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238         chat = g_new0(<a class="code" href="struct___jabber_chat.html">JabberChat</a>, 1);
<a name="l00239"></a>00239         chat-&gt;js = js;
<a name="l00240"></a>00240         chat-&gt;joined = 0;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         chat-&gt;room = g_strdup(room);
<a name="l00243"></a>00243         chat-&gt;server = g_strdup(server);
<a name="l00244"></a>00244         chat-&gt;handle = g_strdup(handle);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <span class="comment">/* Copy the data hash table to chat-&gt;components */</span>
<a name="l00247"></a>00247         chat-&gt;components = g_hash_table_new_full(g_str_hash, g_str_equal,
<a name="l00248"></a>00248                         g_free, g_free);
<a name="l00249"></a>00249         <span class="keywordflow">if</span> (data == NULL) {
<a name="l00250"></a>00250                 g_hash_table_insert(chat-&gt;components, g_strdup(<span class="stringliteral">&quot;handle&quot;</span>), g_strdup(handle));
<a name="l00251"></a>00251                 g_hash_table_insert(chat-&gt;components, g_strdup(<span class="stringliteral">&quot;room&quot;</span>), g_strdup(room));
<a name="l00252"></a>00252                 g_hash_table_insert(chat-&gt;components, g_strdup(<span class="stringliteral">&quot;server&quot;</span>), g_strdup(server));
<a name="l00253"></a>00253                 <span class="comment">/* g_hash_table_insert(chat-&gt;components, g_strdup(&quot;password&quot;), g_strdup(server)); */</span>
<a name="l00254"></a>00254         } <span class="keywordflow">else</span> {
<a name="l00255"></a>00255                 g_hash_table_foreach(data, insert_in_hash_table, chat-&gt;components);
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         chat-&gt;members = g_hash_table_new_full(g_str_hash, g_str_equal, NULL,
<a name="l00259"></a>00259                         (GDestroyNotify)jabber_chat_member_free);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, room, server);
<a name="l00262"></a>00262         g_hash_table_insert(js-&gt;chats, jid, chat);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <span class="keywordflow">return</span> chat;
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="chat_8h.html#a6b93f9251782c9e7f3bb1d9281e0e424">00267</a> <a class="code" href="struct___jabber_chat.html">JabberChat</a> *jabber_join_chat(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *room,
<a name="l00268"></a>00268                              <span class="keyword">const</span> <span class="keywordtype">char</span> *server, <span class="keyword">const</span> <span class="keywordtype">char</span> *handle,
<a name="l00269"></a>00269                              <span class="keyword">const</span> <span class="keywordtype">char</span> *password, GHashTable *data)
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         <a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc;
<a name="l00274"></a>00274         <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account;
<a name="l00275"></a>00275         <a class="code" href="struct___purple_status.html">PurpleStatus</a> *status;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277         <a class="code" href="struct__xmlnode.html">xmlnode</a> *presence, *x;
<a name="l00278"></a>00278         JabberBuddyState state;
<a name="l00279"></a>00279         <span class="keywordtype">char</span> *msg;
<a name="l00280"></a>00280         <span class="keywordtype">int</span> priority;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         <span class="keywordtype">char</span> *jid;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="keywordtype">char</span> *history_maxchars;
<a name="l00285"></a>00285         <span class="keywordtype">char</span> *history_maxstanzas;
<a name="l00286"></a>00286         <span class="keywordtype">char</span> *history_seconds;
<a name="l00287"></a>00287         <span class="keywordtype">char</span> *history_since;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keyword">struct </span>tm history_since_datetime;
<a name="l00290"></a>00290         <span class="keyword">const</span> <span class="keywordtype">char</span> *history_since_string = NULL;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         chat = jabber_chat_new(js, room, server, handle, password, data);
<a name="l00293"></a>00293         <span class="keywordflow">if</span> (chat == NULL)
<a name="l00294"></a>00294                 <span class="keywordflow">return</span> NULL;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         gc = js-&gt;gc;
<a name="l00297"></a>00297         account = purple_connection_get_account(gc);
<a name="l00298"></a>00298         status = purple_account_get_active_status(account);
<a name="l00299"></a>00299         purple_status_to_jabber(status, &amp;state, &amp;msg, &amp;priority);
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         presence = jabber_presence_create_js(js, state, msg, priority);
<a name="l00302"></a>00302         g_free(msg);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304         jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s/%s&quot;</span>, room, server, handle);
<a name="l00305"></a>00305         xmlnode_set_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, jid);
<a name="l00306"></a>00306         g_free(jid);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         history_maxchars   = g_hash_table_lookup(data, <span class="stringliteral">&quot;history_maxchars&quot;</span>);
<a name="l00309"></a>00309         history_maxstanzas = g_hash_table_lookup(data, <span class="stringliteral">&quot;history_maxstanzas&quot;</span>);
<a name="l00310"></a>00310         history_seconds    = g_hash_table_lookup(data, <span class="stringliteral">&quot;history_seconds&quot;</span>);
<a name="l00311"></a>00311         history_since      = g_hash_table_lookup(data, <span class="stringliteral">&quot;history_since&quot;</span>);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313         <span class="keywordflow">if</span> (history_since) {
<a name="l00314"></a>00314                 <span class="keywordflow">if</span> (purple_str_to_time(history_since, TRUE, &amp;history_since_datetime, NULL, NULL) != 0) {
<a name="l00315"></a>00315                         history_since_string = purple_utf8_strftime(<span class="stringliteral">&quot;%Y-%m-%dT%H:%M:%SZ&quot;</span>, &amp;history_since_datetime);
<a name="l00316"></a>00316                 } <span class="keywordflow">else</span> {
<a name="l00317"></a>00317                         history_since_string = NULL;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319                         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;jabber&quot;</span>, <span class="stringliteral">&quot;Invalid date format for history_since&quot;</span>
<a name="l00320"></a>00320                                                      <span class="stringliteral">&quot; while requesting history: %s&quot;</span>, history_since);
<a name="l00321"></a>00321                 }
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324         x = xmlnode_new_child(presence, <span class="stringliteral">&quot;x&quot;</span>);
<a name="l00325"></a>00325         xmlnode_set_namespace(x, <span class="stringliteral">&quot;http://jabber.org/protocol/muc&quot;</span>);
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         <span class="keywordflow">if</span> (password &amp;&amp; *password) {
<a name="l00328"></a>00328                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *p = xmlnode_new_child(x, <span class="stringliteral">&quot;password&quot;</span>);
<a name="l00329"></a>00329                 xmlnode_insert_data(p, password, -1);
<a name="l00330"></a>00330         }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="keywordflow">if</span> ((history_maxchars &amp;&amp; *history_maxchars)
<a name="l00333"></a>00333             || (history_maxstanzas &amp;&amp; *history_maxstanzas)
<a name="l00334"></a>00334             || (history_seconds &amp;&amp; *history_seconds)
<a name="l00335"></a>00335             || (history_since_string &amp;&amp; *history_since_string)) {
<a name="l00336"></a>00336 
<a name="l00337"></a>00337                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *history = xmlnode_new_child(x, <span class="stringliteral">&quot;history&quot;</span>);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339                 <span class="keywordflow">if</span> (history_maxchars &amp;&amp; *history_maxchars) {
<a name="l00340"></a>00340                         xmlnode_set_attrib(history, <span class="stringliteral">&quot;maxchars&quot;</span>, history_maxchars);
<a name="l00341"></a>00341                 }
<a name="l00342"></a>00342                 <span class="keywordflow">if</span> (history_maxstanzas &amp;&amp; *history_maxstanzas) {
<a name="l00343"></a>00343                         xmlnode_set_attrib(history, <span class="stringliteral">&quot;maxstanzas&quot;</span>, history_maxstanzas);
<a name="l00344"></a>00344                 }
<a name="l00345"></a>00345                 <span class="keywordflow">if</span> (history_seconds &amp;&amp; *history_seconds) {
<a name="l00346"></a>00346                         xmlnode_set_attrib(history, <span class="stringliteral">&quot;seconds&quot;</span>, history_seconds);
<a name="l00347"></a>00347                 }
<a name="l00348"></a>00348                 <span class="keywordflow">if</span> (history_since_string &amp;&amp; *history_since_string) {
<a name="l00349"></a>00349                         xmlnode_set_attrib(history, <span class="stringliteral">&quot;since&quot;</span>, history_since_string);
<a name="l00350"></a>00350                 }
<a name="l00351"></a>00351         }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         jabber_send(js, presence);
<a name="l00354"></a>00354         xmlnode_free(presence);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         <span class="keywordflow">return</span> chat;
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <span class="keywordtype">void</span> jabber_chat_join(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, GHashTable *data)
<a name="l00360"></a>00360 {
<a name="l00361"></a>00361         <span class="keywordtype">char</span> *room, *server, *handle, *passwd;
<a name="l00362"></a>00362         <a class="code" href="struct___jabber_i_d.html">JabberID</a> *jid;
<a name="l00363"></a>00363         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00364"></a>00364         <span class="keywordtype">char</span> *tmp;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         room = g_hash_table_lookup(data, <span class="stringliteral">&quot;room&quot;</span>);
<a name="l00367"></a>00367         server = g_hash_table_lookup(data, <span class="stringliteral">&quot;server&quot;</span>);
<a name="l00368"></a>00368         handle = g_hash_table_lookup(data, <span class="stringliteral">&quot;handle&quot;</span>);
<a name="l00369"></a>00369         passwd = g_hash_table_lookup(data, <span class="stringliteral">&quot;password&quot;</span>);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <span class="keywordflow">if</span>(!room || !server)
<a name="l00372"></a>00372                 <span class="keywordflow">return</span>;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <span class="keywordflow">if</span>(!handle)
<a name="l00375"></a>00375                 handle = js-&gt;user-&gt;node;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         <span class="keywordflow">if</span>(!jabber_nodeprep_validate(room)) {
<a name="l00378"></a>00378                 <span class="keywordtype">char</span> *buf = g_strdup_printf(_(<span class="stringliteral">&quot;%s is not a valid room name&quot;</span>), room);
<a name="l00379"></a>00379                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(gc, _(<span class="stringliteral">&quot;Invalid Room Name&quot;</span>), _(<span class="stringliteral">&quot;Invalid Room Name&quot;</span>),
<a name="l00380"></a>00380                                 buf);
<a name="l00381"></a>00381                 purple_serv_got_join_chat_failed(gc, data);
<a name="l00382"></a>00382                 g_free(buf);
<a name="l00383"></a>00383                 <span class="keywordflow">return</span>;
<a name="l00384"></a>00384         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!jabber_domain_validate(server)) {
<a name="l00385"></a>00385                 <span class="keywordtype">char</span> *buf = g_strdup_printf(_(<span class="stringliteral">&quot;%s is not a valid server name&quot;</span>), server);
<a name="l00386"></a>00386                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(gc, _(<span class="stringliteral">&quot;Invalid Server Name&quot;</span>),
<a name="l00387"></a>00387                                 _(<span class="stringliteral">&quot;Invalid Server Name&quot;</span>), buf);
<a name="l00388"></a>00388                 purple_serv_got_join_chat_failed(gc, data);
<a name="l00389"></a>00389                 g_free(buf);
<a name="l00390"></a>00390                 <span class="keywordflow">return</span>;
<a name="l00391"></a>00391         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!jabber_resourceprep_validate(handle)) {
<a name="l00392"></a>00392                 <span class="keywordtype">char</span> *buf = g_strdup_printf(_(<span class="stringliteral">&quot;%s is not a valid room handle&quot;</span>), handle);
<a name="l00393"></a>00393                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(gc, _(<span class="stringliteral">&quot;Invalid Room Handle&quot;</span>),
<a name="l00394"></a>00394                                 _(<span class="stringliteral">&quot;Invalid Room Handle&quot;</span>), buf);
<a name="l00395"></a>00395                 purple_serv_got_join_chat_failed(gc, data);
<a name="l00396"></a>00396                 g_free(buf);
<a name="l00397"></a>00397                 <span class="keywordflow">return</span>;
<a name="l00398"></a>00398         }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400         <span class="comment">/* Normalize the room and server parameters */</span>
<a name="l00401"></a>00401         tmp = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, room, server);
<a name="l00402"></a>00402         jid = jabber_id_new(tmp);
<a name="l00403"></a>00403         g_free(tmp);
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="keywordflow">if</span> (jid == NULL) {
<a name="l00406"></a>00406                 <span class="comment">/* TODO: Error message */</span>
<a name="l00407"></a>00407 
<a name="l00408"></a>00408                 g_return_if_reached();
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         <span class="comment">/*</span>
<a name="l00412"></a>00412 <span class="comment">         * Now that we&#39;ve done all that nice core-interface stuff, let&#39;s join</span>
<a name="l00413"></a>00413 <span class="comment">         * this room!</span>
<a name="l00414"></a>00414 <span class="comment">         */</span>
<a name="l00415"></a>00415         jabber_join_chat(js, jid-&gt;node, jid-&gt;domain, handle, passwd, data);
<a name="l00416"></a>00416         jabber_id_free(jid);
<a name="l00417"></a>00417 }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 <span class="keywordtype">void</span> jabber_chat_leave(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keywordtype">int</span> <span class="keywordtype">id</span>)
<a name="l00420"></a>00420 {
<a name="l00421"></a>00421         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00422"></a>00422         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat = jabber_chat_find_by_id(js, <span class="keywordtype">id</span>);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 
<a name="l00425"></a>00425         <span class="keywordflow">if</span>(!chat)
<a name="l00426"></a>00426                 <span class="keywordflow">return</span>;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         jabber_chat_part(chat, NULL);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430         chat-&gt;left = TRUE;
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="keywordtype">void</span> jabber_chat_destroy(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat)
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = chat-&gt;js;
<a name="l00436"></a>00436         <span class="keywordtype">char</span> *room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438         g_hash_table_remove(js-&gt;chats, room_jid);
<a name="l00439"></a>00439         g_free(room_jid);
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 <span class="keywordtype">void</span> jabber_chat_free(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444         <span class="keywordflow">if</span>(chat-&gt;config_dialog_handle)
<a name="l00445"></a>00445                 purple_request_close(chat-&gt;config_dialog_type, chat-&gt;config_dialog_handle);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         g_free(chat-&gt;room);
<a name="l00448"></a>00448         g_free(chat-&gt;server);
<a name="l00449"></a>00449         g_free(chat-&gt;handle);
<a name="l00450"></a>00450         g_hash_table_destroy(chat-&gt;members);
<a name="l00451"></a>00451         g_hash_table_destroy(chat-&gt;components);
<a name="l00452"></a>00452         g_free(chat);
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 gboolean jabber_chat_find_buddy(<a class="code" href="struct___purple_conversation.html">PurpleConversation</a> *conv, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00456"></a>00456 {
<a name="l00457"></a>00457         <span class="keywordflow">return</span> purple_conv_chat_find_user(PURPLE_CONV_CHAT(conv), name);
<a name="l00458"></a>00458 }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 <span class="keywordtype">char</span> *jabber_chat_buddy_real_name(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *who)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00463"></a>00463         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l00464"></a>00464         <a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *jcm;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466         chat = jabber_chat_find_by_id(js, <span class="keywordtype">id</span>);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         <span class="keywordflow">if</span>(!chat)
<a name="l00469"></a>00469                 <span class="keywordflow">return</span> NULL;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         jcm = g_hash_table_lookup(chat-&gt;members, who);
<a name="l00472"></a>00472         <span class="keywordflow">if</span> (jcm != NULL &amp;&amp; jcm-&gt;jid)
<a name="l00473"></a>00473                 <span class="keywordflow">return</span> g_strdup(jcm-&gt;jid);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="keywordflow">return</span> g_strdup_printf(<span class="stringliteral">&quot;%s@%s/%s&quot;</span>, chat-&gt;room, chat-&gt;server, who);
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_chat_room_configure_x_data_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <a class="code" href="struct__xmlnode.html">xmlnode</a> *result, gpointer data)
<a name="l00480"></a>00480 {
<a name="l00481"></a>00481         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat = data;
<a name="l00482"></a>00482         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query;
<a name="l00483"></a>00483         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00484"></a>00484         <span class="keywordtype">char</span> *to = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         iq = jabber_iq_new_query(js, JABBER_IQ_SET, <span class="stringliteral">&quot;http://jabber.org/protocol/muc#owner&quot;</span>);
<a name="l00487"></a>00487         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, to);
<a name="l00488"></a>00488         g_free(to);
<a name="l00489"></a>00489 
<a name="l00490"></a>00490         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492         xmlnode_insert_child(query, result);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         jabber_iq_send(iq);
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_chat_room_configure_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l00498"></a>00498                                           JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l00499"></a>00499                                           <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *x;
<a name="l00502"></a>00502         <span class="keywordtype">char</span> *msg;
<a name="l00503"></a>00503         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l00504"></a>00504         <a class="code" href="struct___jabber_i_d.html">JabberID</a> *jid;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (!from)
<a name="l00507"></a>00507                 <span class="keywordflow">return</span>;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509         <span class="keywordflow">if</span> (type == JABBER_IQ_RESULT) {
<a name="l00510"></a>00510                 jid = jabber_id_new(from);
<a name="l00511"></a>00511 
<a name="l00512"></a>00512                 <span class="keywordflow">if</span>(!jid)
<a name="l00513"></a>00513                         <span class="keywordflow">return</span>;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515                 chat = jabber_chat_find(js, jid-&gt;node, jid-&gt;domain);
<a name="l00516"></a>00516                 jabber_id_free(jid);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518                 <span class="keywordflow">if</span>(!chat)
<a name="l00519"></a>00519                         <span class="keywordflow">return</span>;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521                 <span class="keywordflow">if</span>(!(query = xmlnode_get_child(packet, <span class="stringliteral">&quot;query&quot;</span>)))
<a name="l00522"></a>00522                         <span class="keywordflow">return</span>;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524                 <span class="keywordflow">for</span>(x = xmlnode_get_child(query, <span class="stringliteral">&quot;x&quot;</span>); x; x = xmlnode_get_next_twin(x)) {
<a name="l00525"></a>00525                         <span class="keyword">const</span> <span class="keywordtype">char</span> *xmlns;
<a name="l00526"></a>00526                         <span class="keywordflow">if</span>(!(xmlns = xmlnode_get_namespace(x)))
<a name="l00527"></a>00527                                 <span class="keywordflow">continue</span>;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529                         <span class="keywordflow">if</span>(!strcmp(xmlns, <span class="stringliteral">&quot;jabber:x:data&quot;</span>)) {
<a name="l00530"></a>00530                                 chat-&gt;config_dialog_type = <a class="code" href="request_8h.html#a36835ad4ae9447147802edf1b522e11fa8976f67a78c8f63bc12b156885d55d0b">PURPLE_REQUEST_FIELDS</a>;
<a name="l00531"></a>00531                                 chat-&gt;config_dialog_handle = jabber_x_data_request(js, x, jabber_chat_room_configure_x_data_cb, chat);
<a name="l00532"></a>00532                                 <span class="keywordflow">return</span>;
<a name="l00533"></a>00533                         }
<a name="l00534"></a>00534                 }
<a name="l00535"></a>00535         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == JABBER_IQ_ERROR) {
<a name="l00536"></a>00536                 <span class="keywordtype">char</span> *msg = jabber_parse_error(js, packet, NULL);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(js-&gt;gc, _(<span class="stringliteral">&quot;Configuration error&quot;</span>), _(<span class="stringliteral">&quot;Configuration error&quot;</span>), msg);
<a name="l00539"></a>00539 
<a name="l00540"></a>00540                 <span class="keywordflow">if</span>(msg)
<a name="l00541"></a>00541                         g_free(msg);
<a name="l00542"></a>00542                 <span class="keywordflow">return</span>;
<a name="l00543"></a>00543         }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545         msg = g_strdup_printf(<span class="stringliteral">&quot;Unable to configure room %s&quot;</span>, from);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <a class="code" href="notify_8h.html#a19d6cb8c2338f2c4e7c73fee4714f473">purple_notify_info</a>(js-&gt;gc, _(<span class="stringliteral">&quot;Unable to configure&quot;</span>), _(<span class="stringliteral">&quot;Unable to configure&quot;</span>), msg);
<a name="l00548"></a>00548         g_free(msg);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="keywordtype">void</span> jabber_chat_request_room_configure(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat) {
<a name="l00553"></a>00553         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00554"></a>00554         <span class="keywordtype">char</span> *room_jid;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556         <span class="keywordflow">if</span>(!chat)
<a name="l00557"></a>00557                 <span class="keywordflow">return</span>;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         chat-&gt;config_dialog_handle = NULL;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561         <span class="keywordflow">if</span>(!chat-&gt;muc) {
<a name="l00562"></a>00562                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(chat-&gt;js-&gt;gc, _(<span class="stringliteral">&quot;Room Configuration Error&quot;</span>), _(<span class="stringliteral">&quot;Room Configuration Error&quot;</span>),
<a name="l00563"></a>00563                                 _(<span class="stringliteral">&quot;This room is not capable of being configured&quot;</span>));
<a name="l00564"></a>00564                 <span class="keywordflow">return</span>;
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_GET,
<a name="l00568"></a>00568                         <span class="stringliteral">&quot;http://jabber.org/protocol/muc#owner&quot;</span>);
<a name="l00569"></a>00569         room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, room_jid);
<a name="l00572"></a>00572 
<a name="l00573"></a>00573         jabber_iq_set_callback(iq, jabber_chat_room_configure_cb, NULL);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         jabber_iq_send(iq);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         g_free(room_jid);
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="keywordtype">void</span> jabber_chat_create_instant_room(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat) {
<a name="l00581"></a>00581         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00582"></a>00582         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *x;
<a name="l00583"></a>00583         <span class="keywordtype">char</span> *room_jid;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585         <span class="keywordflow">if</span>(!chat)
<a name="l00586"></a>00586                 <span class="keywordflow">return</span>;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         chat-&gt;config_dialog_handle = NULL;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_SET,
<a name="l00591"></a>00591                         <span class="stringliteral">&quot;http://jabber.org/protocol/muc#owner&quot;</span>);
<a name="l00592"></a>00592         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00593"></a>00593         x = xmlnode_new_child(query, <span class="stringliteral">&quot;x&quot;</span>);
<a name="l00594"></a>00594         room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00595"></a>00595 
<a name="l00596"></a>00596         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, room_jid);
<a name="l00597"></a>00597         xmlnode_set_namespace(x, <span class="stringliteral">&quot;jabber:x:data&quot;</span>);
<a name="l00598"></a>00598         xmlnode_set_attrib(x, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;submit&quot;</span>);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600         jabber_iq_send(iq);
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         g_free(room_jid);
<a name="l00603"></a>00603 }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00606"></a>00606 jabber_chat_register_x_data_result_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l00607"></a>00607                                       JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l00608"></a>00608                                       <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l00609"></a>00609 {
<a name="l00610"></a>00610         <span class="keywordflow">if</span> (type == JABBER_IQ_ERROR) {
<a name="l00611"></a>00611                 <span class="keywordtype">char</span> *msg = jabber_parse_error(js, packet, NULL);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(js-&gt;gc, _(<span class="stringliteral">&quot;Registration error&quot;</span>), _(<span class="stringliteral">&quot;Registration error&quot;</span>), msg);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615                 <span class="keywordflow">if</span>(msg)
<a name="l00616"></a>00616                         g_free(msg);
<a name="l00617"></a>00617                 <span class="keywordflow">return</span>;
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619 }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_chat_register_x_data_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <a class="code" href="struct__xmlnode.html">xmlnode</a> *result, gpointer data)
<a name="l00622"></a>00622 {
<a name="l00623"></a>00623         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat = data;
<a name="l00624"></a>00624         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query;
<a name="l00625"></a>00625         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00626"></a>00626         <span class="keywordtype">char</span> *to = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628         iq = jabber_iq_new_query(js, JABBER_IQ_SET, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l00629"></a>00629         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, to);
<a name="l00630"></a>00630         g_free(to);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         xmlnode_insert_child(query, result);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         jabber_iq_set_callback(iq, jabber_chat_register_x_data_result_cb, NULL);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638         jabber_iq_send(iq);
<a name="l00639"></a>00639 }
<a name="l00640"></a>00640 
<a name="l00641"></a>00641 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_chat_register_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l00642"></a>00642                                     JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l00643"></a>00643                                     <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *x;
<a name="l00646"></a>00646         <span class="keywordtype">char</span> *msg;
<a name="l00647"></a>00647         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l00648"></a>00648         <a class="code" href="struct___jabber_i_d.html">JabberID</a> *jid;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <span class="keywordflow">if</span> (!from)
<a name="l00651"></a>00651                 <span class="keywordflow">return</span>;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         <span class="keywordflow">if</span> (type == JABBER_IQ_RESULT) {
<a name="l00654"></a>00654                 jid = jabber_id_new(from);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656                 <span class="keywordflow">if</span>(!jid)
<a name="l00657"></a>00657                         <span class="keywordflow">return</span>;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659                 chat = jabber_chat_find(js, jid-&gt;node, jid-&gt;domain);
<a name="l00660"></a>00660                 jabber_id_free(jid);
<a name="l00661"></a>00661 
<a name="l00662"></a>00662                 <span class="keywordflow">if</span>(!chat)
<a name="l00663"></a>00663                         <span class="keywordflow">return</span>;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665                 <span class="keywordflow">if</span>(!(query = xmlnode_get_child(packet, <span class="stringliteral">&quot;query&quot;</span>)))
<a name="l00666"></a>00666                         <span class="keywordflow">return</span>;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668                 <span class="keywordflow">for</span>(x = xmlnode_get_child(query, <span class="stringliteral">&quot;x&quot;</span>); x; x = xmlnode_get_next_twin(x)) {
<a name="l00669"></a>00669                         <span class="keyword">const</span> <span class="keywordtype">char</span> *xmlns;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671                         <span class="keywordflow">if</span>(!(xmlns = xmlnode_get_namespace(x)))
<a name="l00672"></a>00672                                 <span class="keywordflow">continue</span>;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674                         <span class="keywordflow">if</span>(!strcmp(xmlns, <span class="stringliteral">&quot;jabber:x:data&quot;</span>)) {
<a name="l00675"></a>00675                                 jabber_x_data_request(js, x, jabber_chat_register_x_data_cb, chat);
<a name="l00676"></a>00676                                 <span class="keywordflow">return</span>;
<a name="l00677"></a>00677                         }
<a name="l00678"></a>00678                 }
<a name="l00679"></a>00679         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == JABBER_IQ_ERROR) {
<a name="l00680"></a>00680                 <span class="keywordtype">char</span> *msg = jabber_parse_error(js, packet, NULL);
<a name="l00681"></a>00681 
<a name="l00682"></a>00682                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(js-&gt;gc, _(<span class="stringliteral">&quot;Registration error&quot;</span>), _(<span class="stringliteral">&quot;Registration error&quot;</span>), msg);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684                 <span class="keywordflow">if</span>(msg)
<a name="l00685"></a>00685                         g_free(msg);
<a name="l00686"></a>00686                 <span class="keywordflow">return</span>;
<a name="l00687"></a>00687         }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689         msg = g_strdup_printf(<span class="stringliteral">&quot;Unable to configure room %s&quot;</span>, from);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691         <a class="code" href="notify_8h.html#a19d6cb8c2338f2c4e7c73fee4714f473">purple_notify_info</a>(js-&gt;gc, _(<span class="stringliteral">&quot;Unable to configure&quot;</span>), _(<span class="stringliteral">&quot;Unable to configure&quot;</span>), msg);
<a name="l00692"></a>00692         g_free(msg);
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696 <span class="keywordtype">void</span> jabber_chat_register(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat)
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00699"></a>00699         <span class="keywordtype">char</span> *room_jid;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         <span class="keywordflow">if</span>(!chat)
<a name="l00702"></a>00702                 <span class="keywordflow">return</span>;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704         room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00705"></a>00705 
<a name="l00706"></a>00706         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_GET, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l00707"></a>00707         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, room_jid);
<a name="l00708"></a>00708         g_free(room_jid);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710         jabber_iq_set_callback(iq, jabber_chat_register_cb, NULL);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712         jabber_iq_send(iq);
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 <span class="comment">/* merge this with the function below when we get everyone on the same page wrt /commands */</span>
<a name="l00716"></a>00716 <span class="keywordtype">void</span> jabber_chat_change_topic(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *topic)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718         <a class="code" href="struct___jabber_message.html">JabberMessage</a> *jm;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720         jm = g_new0(<a class="code" href="struct___jabber_message.html">JabberMessage</a>, 1);
<a name="l00721"></a>00721         jm-&gt;js = chat-&gt;js;
<a name="l00722"></a>00722         jm-&gt;type = JABBER_MESSAGE_GROUPCHAT;
<a name="l00723"></a>00723         jm-&gt;to = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725         <span class="keywordflow">if</span> (topic &amp;&amp; *topic)
<a name="l00726"></a>00726                 jm-&gt;subject = g_strdup(topic);
<a name="l00727"></a>00727         <span class="keywordflow">else</span>
<a name="l00728"></a>00728                 jm-&gt;subject = g_strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         jabber_message_send(jm);
<a name="l00731"></a>00731         jabber_message_free(jm);
<a name="l00732"></a>00732 }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 <span class="keywordtype">void</span> jabber_chat_set_topic(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc, <span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *topic)
<a name="l00735"></a>00735 {
<a name="l00736"></a>00736         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = purple_connection_get_protocol_data(gc);
<a name="l00737"></a>00737         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat = jabber_chat_find_by_id(js, <span class="keywordtype">id</span>);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         <span class="keywordflow">if</span>(!chat)
<a name="l00740"></a>00740                 <span class="keywordflow">return</span>;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742         jabber_chat_change_topic(chat, topic);
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 gboolean jabber_chat_change_nick(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *nick)
<a name="l00747"></a>00747 {
<a name="l00748"></a>00748         <a class="code" href="struct__xmlnode.html">xmlnode</a> *presence;
<a name="l00749"></a>00749         <span class="keywordtype">char</span> *full_jid;
<a name="l00750"></a>00750         <a class="code" href="struct___purple_account.html">PurpleAccount</a> *account;
<a name="l00751"></a>00751         <a class="code" href="struct___purple_status.html">PurpleStatus</a> *status;
<a name="l00752"></a>00752         JabberBuddyState state;
<a name="l00753"></a>00753         <span class="keywordtype">char</span> *msg;
<a name="l00754"></a>00754         <span class="keywordtype">int</span> priority;
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="keywordflow">if</span>(!chat-&gt;muc) {
<a name="l00757"></a>00757                 purple_conv_chat_write(PURPLE_CONV_CHAT(chat-&gt;conv), <span class="stringliteral">&quot;&quot;</span>,
<a name="l00758"></a>00758                                 _(<span class="stringliteral">&quot;Nick changing not supported in non-MUC chatrooms&quot;</span>),
<a name="l00759"></a>00759                                 <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5a3c4f1ba272e4552dfc9715b49514fba6">PURPLE_MESSAGE_SYSTEM</a>, time(NULL));
<a name="l00760"></a>00760                 <span class="keywordflow">return</span> FALSE;
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763         account = purple_connection_get_account(chat-&gt;js-&gt;gc);
<a name="l00764"></a>00764         status = purple_account_get_active_status(account);
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         purple_status_to_jabber(status, &amp;state, &amp;msg, &amp;priority);
<a name="l00767"></a>00767 
<a name="l00768"></a>00768         presence = jabber_presence_create_js(chat-&gt;js, state, msg, priority);
<a name="l00769"></a>00769         full_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s/%s&quot;</span>, chat-&gt;room, chat-&gt;server, nick);
<a name="l00770"></a>00770         xmlnode_set_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, full_jid);
<a name="l00771"></a>00771         g_free(full_jid);
<a name="l00772"></a>00772         g_free(msg);
<a name="l00773"></a>00773 
<a name="l00774"></a>00774         jabber_send(chat-&gt;js, presence);
<a name="l00775"></a>00775         xmlnode_free(presence);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         <span class="keywordflow">return</span> TRUE;
<a name="l00778"></a>00778 }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 <span class="keywordtype">void</span> jabber_chat_part(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg)
<a name="l00781"></a>00781 {
<a name="l00782"></a>00782         <span class="keywordtype">char</span> *room_jid;
<a name="l00783"></a>00783         <a class="code" href="struct__xmlnode.html">xmlnode</a> *presence;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s/%s&quot;</span>, chat-&gt;room, chat-&gt;server,
<a name="l00786"></a>00786                         chat-&gt;handle);
<a name="l00787"></a>00787         presence = xmlnode_new(<span class="stringliteral">&quot;presence&quot;</span>);
<a name="l00788"></a>00788         xmlnode_set_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, room_jid);
<a name="l00789"></a>00789         xmlnode_set_attrib(presence, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;unavailable&quot;</span>);
<a name="l00790"></a>00790         <span class="keywordflow">if</span>(msg) {
<a name="l00791"></a>00791                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *status = xmlnode_new_child(presence, <span class="stringliteral">&quot;status&quot;</span>);
<a name="l00792"></a>00792                 xmlnode_insert_data(status, msg, -1);
<a name="l00793"></a>00793         }
<a name="l00794"></a>00794         jabber_send(chat-&gt;js, presence);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796         xmlnode_free(presence);
<a name="l00797"></a>00797         g_free(room_jid);
<a name="l00798"></a>00798 }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800 <span class="keyword">static</span> <span class="keywordtype">void</span> roomlist_disco_result_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l00801"></a>00801                                      JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l00802"></a>00802                                      <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l00803"></a>00803 {
<a name="l00804"></a>00804         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query;
<a name="l00805"></a>00805         <a class="code" href="struct__xmlnode.html">xmlnode</a> *item;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="keywordflow">if</span>(!js-&gt;roomlist)
<a name="l00808"></a>00808                 <span class="keywordflow">return</span>;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         <span class="keywordflow">if</span> (type == JABBER_IQ_ERROR) {
<a name="l00811"></a>00811                 <span class="keywordtype">char</span> *err = jabber_parse_error(js, packet, NULL);
<a name="l00812"></a>00812                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(js-&gt;gc, _(<span class="stringliteral">&quot;Error&quot;</span>),
<a name="l00813"></a>00813                                 _(<span class="stringliteral">&quot;Error retrieving room list&quot;</span>), err);
<a name="l00814"></a>00814                 purple_roomlist_set_in_progress(js-&gt;roomlist, FALSE);
<a name="l00815"></a>00815                 purple_roomlist_unref(js-&gt;roomlist);
<a name="l00816"></a>00816                 js-&gt;roomlist = NULL;
<a name="l00817"></a>00817                 g_free(err);
<a name="l00818"></a>00818                 <span class="keywordflow">return</span>;
<a name="l00819"></a>00819         }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821         <span class="keywordflow">if</span>(!(query = xmlnode_get_child(packet, <span class="stringliteral">&quot;query&quot;</span>))) {
<a name="l00822"></a>00822                 <span class="keywordtype">char</span> *err = jabber_parse_error(js, packet, NULL);
<a name="l00823"></a>00823                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(js-&gt;gc, _(<span class="stringliteral">&quot;Error&quot;</span>),
<a name="l00824"></a>00824                                 _(<span class="stringliteral">&quot;Error retrieving room list&quot;</span>), err);
<a name="l00825"></a>00825                 purple_roomlist_set_in_progress(js-&gt;roomlist, FALSE);
<a name="l00826"></a>00826                 purple_roomlist_unref(js-&gt;roomlist);
<a name="l00827"></a>00827                 js-&gt;roomlist = NULL;
<a name="l00828"></a>00828                 g_free(err);
<a name="l00829"></a>00829                 <span class="keywordflow">return</span>;
<a name="l00830"></a>00830         }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832         <span class="keywordflow">for</span>(item = xmlnode_get_child(query, <span class="stringliteral">&quot;item&quot;</span>); item;
<a name="l00833"></a>00833                         item = xmlnode_get_next_twin(item)) {
<a name="l00834"></a>00834                 <span class="keyword">const</span> <span class="keywordtype">char</span> *name;
<a name="l00835"></a>00835                 <a class="code" href="struct___purple_roomlist_room.html">PurpleRoomlistRoom</a> *room;
<a name="l00836"></a>00836                 <a class="code" href="struct___jabber_i_d.html">JabberID</a> *jid;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838                 <span class="keywordflow">if</span>(!(jid = jabber_id_new(xmlnode_get_attrib(item, <span class="stringliteral">&quot;jid&quot;</span>))))
<a name="l00839"></a>00839                         <span class="keywordflow">continue</span>;
<a name="l00840"></a>00840                 name = xmlnode_get_attrib(item, <span class="stringliteral">&quot;name&quot;</span>);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842 
<a name="l00843"></a>00843                 room = purple_roomlist_room_new(<a class="code" href="roomlist_8h.html#a57ede825a49ddf1d5854f4ee66d0b39ea518f25d9d87c92013755e6fd81a89d1e">PURPLE_ROOMLIST_ROOMTYPE_ROOM</a>, jid-&gt;node, NULL);
<a name="l00844"></a>00844                 purple_roomlist_room_add_field(js-&gt;roomlist, room, jid-&gt;node);
<a name="l00845"></a>00845                 purple_roomlist_room_add_field(js-&gt;roomlist, room, jid-&gt;domain);
<a name="l00846"></a>00846                 purple_roomlist_room_add_field(js-&gt;roomlist, room, name ? name : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00847"></a>00847                 purple_roomlist_room_add(js-&gt;roomlist, room);
<a name="l00848"></a>00848 
<a name="l00849"></a>00849                 jabber_id_free(jid);
<a name="l00850"></a>00850         }
<a name="l00851"></a>00851         purple_roomlist_set_in_progress(js-&gt;roomlist, FALSE);
<a name="l00852"></a>00852         purple_roomlist_unref(js-&gt;roomlist);
<a name="l00853"></a>00853         js-&gt;roomlist = NULL;
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00856"></a>00856 <span class="keyword">static</span> <span class="keywordtype">void</span> roomlist_cancel_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *server) {
<a name="l00857"></a>00857         <span class="keywordflow">if</span>(js-&gt;roomlist) {
<a name="l00858"></a>00858                 purple_roomlist_set_in_progress(js-&gt;roomlist, FALSE);
<a name="l00859"></a>00859                 purple_roomlist_unref(js-&gt;roomlist);
<a name="l00860"></a>00860                 js-&gt;roomlist = NULL;
<a name="l00861"></a>00861         }
<a name="l00862"></a>00862 }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864 <span class="keyword">static</span> <span class="keywordtype">void</span> roomlist_ok_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *server)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868         <span class="keywordflow">if</span>(!js-&gt;roomlist)
<a name="l00869"></a>00869                 <span class="keywordflow">return</span>;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871         <span class="keywordflow">if</span>(!server || !*server) {
<a name="l00872"></a>00872                 <a class="code" href="notify_8h.html#ad54861c382f50702e2c6c2317aff878d">purple_notify_error</a>(js-&gt;gc, _(<span class="stringliteral">&quot;Invalid Server&quot;</span>), _(<span class="stringliteral">&quot;Invalid Server&quot;</span>), NULL);
<a name="l00873"></a>00873                 purple_roomlist_set_in_progress(js-&gt;roomlist, FALSE);
<a name="l00874"></a>00874                 <span class="keywordflow">return</span>;
<a name="l00875"></a>00875         }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         purple_roomlist_set_in_progress(js-&gt;roomlist, TRUE);
<a name="l00878"></a>00878 
<a name="l00879"></a>00879         iq = jabber_iq_new_query(js, JABBER_IQ_GET, NS_DISCO_ITEMS);
<a name="l00880"></a>00880 
<a name="l00881"></a>00881         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, server);
<a name="l00882"></a>00882 
<a name="l00883"></a>00883         jabber_iq_set_callback(iq, roomlist_disco_result_cb, NULL);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885         jabber_iq_send(iq);
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="keywordtype">char</span> *jabber_roomlist_room_serialize(<a class="code" href="struct___purple_roomlist_room.html">PurpleRoomlistRoom</a> *room)
<a name="l00889"></a>00889 {
<a name="l00890"></a>00890 
<a name="l00891"></a>00891         <span class="keywordflow">return</span> g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, (<span class="keywordtype">char</span>*)room-&gt;<a class="code" href="struct___purple_roomlist_room.html#ad7be1183117d2209aae78d19311fbab9">fields</a>-&gt;data, (<span class="keywordtype">char</span>*)room-&gt;<a class="code" href="struct___purple_roomlist_room.html#ad7be1183117d2209aae78d19311fbab9">fields</a>-&gt;next-&gt;data);
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 <a class="code" href="struct___purple_roomlist.html">PurpleRoomlist</a> *jabber_roomlist_get_list(<a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc)
<a name="l00895"></a>00895 {
<a name="l00896"></a>00896         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00897"></a>00897         GList *fields = NULL;
<a name="l00898"></a>00898         <a class="code" href="struct___purple_roomlist_field.html">PurpleRoomlistField</a> *f;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900         <span class="keywordflow">if</span>(js-&gt;roomlist)
<a name="l00901"></a>00901                 purple_roomlist_unref(js-&gt;roomlist);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903         js-&gt;roomlist = purple_roomlist_new(purple_connection_get_account(js-&gt;gc));
<a name="l00904"></a>00904 
<a name="l00905"></a>00905         f = purple_roomlist_field_new(<a class="code" href="roomlist_8h.html#ad47e072310dd048310e8df957d028d0ca87593a40e8c419dccb40c1a82ea3f78e">PURPLE_ROOMLIST_FIELD_STRING</a>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;room&quot;</span>, TRUE);
<a name="l00906"></a>00906         fields = g_list_append(fields, f);
<a name="l00907"></a>00907 
<a name="l00908"></a>00908         f = purple_roomlist_field_new(<a class="code" href="roomlist_8h.html#ad47e072310dd048310e8df957d028d0ca87593a40e8c419dccb40c1a82ea3f78e">PURPLE_ROOMLIST_FIELD_STRING</a>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;server&quot;</span>, TRUE);
<a name="l00909"></a>00909         fields = g_list_append(fields, f);
<a name="l00910"></a>00910 
<a name="l00911"></a>00911         f = purple_roomlist_field_new(<a class="code" href="roomlist_8h.html#ad47e072310dd048310e8df957d028d0ca87593a40e8c419dccb40c1a82ea3f78e">PURPLE_ROOMLIST_FIELD_STRING</a>, _(<span class="stringliteral">&quot;Description&quot;</span>), <span class="stringliteral">&quot;description&quot;</span>, FALSE);
<a name="l00912"></a>00912         fields = g_list_append(fields, f);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         purple_roomlist_set_fields(js-&gt;roomlist, fields);
<a name="l00915"></a>00915 
<a name="l00916"></a>00916 
<a name="l00917"></a>00917         purple_request_input(gc, _(<span class="stringliteral">&quot;Enter a Conference Server&quot;</span>), _(<span class="stringliteral">&quot;Enter a Conference Server&quot;</span>),
<a name="l00918"></a>00918                         _(<span class="stringliteral">&quot;Select a conference server to query&quot;</span>),
<a name="l00919"></a>00919                         js-&gt;chat_servers ? js-&gt;chat_servers-&gt;data : NULL,
<a name="l00920"></a>00920                         FALSE, FALSE, NULL,
<a name="l00921"></a>00921                         _(<span class="stringliteral">&quot;Find Rooms&quot;</span>), PURPLE_CALLBACK(roomlist_ok_cb),
<a name="l00922"></a>00922                         _(<span class="stringliteral">&quot;Cancel&quot;</span>), PURPLE_CALLBACK(roomlist_cancel_cb),
<a name="l00923"></a>00923                         purple_connection_get_account(gc), NULL, NULL,
<a name="l00924"></a>00924                         js);
<a name="l00925"></a>00925 
<a name="l00926"></a>00926         <span class="keywordflow">return</span> js-&gt;roomlist;
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 <span class="keywordtype">void</span> jabber_roomlist_cancel(<a class="code" href="struct___purple_roomlist.html">PurpleRoomlist</a> *list)
<a name="l00930"></a>00930 {
<a name="l00931"></a>00931         <a class="code" href="struct___purple_connection.html">PurpleConnection</a> *gc;
<a name="l00932"></a>00932         <a class="code" href="struct___jabber_stream.html">JabberStream</a> *js;
<a name="l00933"></a>00933 
<a name="l00934"></a>00934         gc = purple_account_get_connection(list-&gt;<a class="code" href="struct___purple_roomlist.html#aaf305dc495eae48ece146a3f496763ff">account</a>);
<a name="l00935"></a>00935         js = gc-&gt;<a class="code" href="struct___purple_connection.html#a65c34f25cec84b2f513f7fdbd27d62bd">proto_data</a>;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937         purple_roomlist_set_in_progress(list, FALSE);
<a name="l00938"></a>00938 
<a name="l00939"></a>00939         <span class="keywordflow">if</span> (js-&gt;roomlist == list) {
<a name="l00940"></a>00940                 js-&gt;roomlist = NULL;
<a name="l00941"></a>00941                 purple_roomlist_unref(list);
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943 }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945 <span class="keywordtype">void</span> jabber_chat_member_free(<a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *jcm)
<a name="l00946"></a>00946 {
<a name="l00947"></a>00947         g_free(jcm-&gt;handle);
<a name="l00948"></a>00948         g_free(jcm-&gt;jid);
<a name="l00949"></a>00949         g_free(jcm);
<a name="l00950"></a>00950 }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952 <span class="keywordtype">void</span> jabber_chat_track_handle(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *handle,
<a name="l00953"></a>00953                 <span class="keyword">const</span> <span class="keywordtype">char</span> *jid, <span class="keyword">const</span> <span class="keywordtype">char</span> *affiliation, <span class="keyword">const</span> <span class="keywordtype">char</span> *role)
<a name="l00954"></a>00954 {
<a name="l00955"></a>00955         <a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *jcm = g_new0(<a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a>, 1);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         jcm-&gt;handle = g_strdup(handle);
<a name="l00958"></a>00958         jcm-&gt;jid = g_strdup(jid);
<a name="l00959"></a>00959 
<a name="l00960"></a>00960         g_hash_table_replace(chat-&gt;members, jcm-&gt;handle, jcm);
<a name="l00961"></a>00961 
<a name="l00962"></a>00962         <span class="comment">/* XXX: keep track of role and affiliation */</span>
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 <span class="keywordtype">void</span> jabber_chat_remove_handle(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *handle)
<a name="l00966"></a>00966 {
<a name="l00967"></a>00967         g_hash_table_remove(chat-&gt;members, handle);
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 gboolean jabber_chat_ban_user(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *who, <span class="keyword">const</span> <span class="keywordtype">char</span> *why)
<a name="l00971"></a>00971 {
<a name="l00972"></a>00972         <a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *jcm;
<a name="l00973"></a>00973         <span class="keyword">const</span> <span class="keywordtype">char</span> *jid;
<a name="l00974"></a>00974         <span class="keywordtype">char</span> *to;
<a name="l00975"></a>00975         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l00976"></a>00976         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *item, *reason;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978         jcm = g_hash_table_lookup(chat-&gt;members, who);
<a name="l00979"></a>00979         <span class="keywordflow">if</span> (jcm &amp;&amp; jcm-&gt;jid)
<a name="l00980"></a>00980                 jid = jcm-&gt;jid;
<a name="l00981"></a>00981         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(who, <span class="charliteral">&#39;@&#39;</span>) != NULL)
<a name="l00982"></a>00982                 jid = who;
<a name="l00983"></a>00983         <span class="keywordflow">else</span>
<a name="l00984"></a>00984                 <span class="keywordflow">return</span> FALSE;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_SET,
<a name="l00987"></a>00987                         <span class="stringliteral">&quot;http://jabber.org/protocol/muc#admin&quot;</span>);
<a name="l00988"></a>00988 
<a name="l00989"></a>00989         to = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l00990"></a>00990         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, to);
<a name="l00991"></a>00991         g_free(to);
<a name="l00992"></a>00992 
<a name="l00993"></a>00993         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00994"></a>00994         item = xmlnode_new_child(query, <span class="stringliteral">&quot;item&quot;</span>);
<a name="l00995"></a>00995         xmlnode_set_attrib(item, <span class="stringliteral">&quot;jid&quot;</span>, jid);
<a name="l00996"></a>00996         xmlnode_set_attrib(item, <span class="stringliteral">&quot;affiliation&quot;</span>, <span class="stringliteral">&quot;outcast&quot;</span>);
<a name="l00997"></a>00997         <span class="keywordflow">if</span>(why) {
<a name="l00998"></a>00998                 reason = xmlnode_new_child(item, <span class="stringliteral">&quot;reason&quot;</span>);
<a name="l00999"></a>00999                 xmlnode_insert_data(reason, why, -1);
<a name="l01000"></a>01000         }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         jabber_iq_send(iq);
<a name="l01003"></a>01003 
<a name="l01004"></a>01004         <span class="keywordflow">return</span> TRUE;
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007 gboolean jabber_chat_affiliate_user(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *who, <span class="keyword">const</span> <span class="keywordtype">char</span> *affiliation)
<a name="l01008"></a>01008 {
<a name="l01009"></a>01009         <a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *jcm;
<a name="l01010"></a>01010         <span class="keyword">const</span> <span class="keywordtype">char</span> *jid;
<a name="l01011"></a>01011         <span class="keywordtype">char</span> *to;
<a name="l01012"></a>01012         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l01013"></a>01013         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *item;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015         jcm = g_hash_table_lookup(chat-&gt;members, who);
<a name="l01016"></a>01016         <span class="keywordflow">if</span> (jcm &amp;&amp; jcm-&gt;jid)
<a name="l01017"></a>01017                 jid = jcm-&gt;jid;
<a name="l01018"></a>01018         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(who, <span class="charliteral">&#39;@&#39;</span>) != NULL)
<a name="l01019"></a>01019                 jid = who;
<a name="l01020"></a>01020         <span class="keywordflow">else</span>
<a name="l01021"></a>01021                 <span class="keywordflow">return</span> FALSE;
<a name="l01022"></a>01022 
<a name="l01023"></a>01023         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_SET,
<a name="l01024"></a>01024                         <span class="stringliteral">&quot;http://jabber.org/protocol/muc#admin&quot;</span>);
<a name="l01025"></a>01025 
<a name="l01026"></a>01026         to = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l01027"></a>01027         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, to);
<a name="l01028"></a>01028         g_free(to);
<a name="l01029"></a>01029 
<a name="l01030"></a>01030         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l01031"></a>01031         item = xmlnode_new_child(query, <span class="stringliteral">&quot;item&quot;</span>);
<a name="l01032"></a>01032         xmlnode_set_attrib(item, <span class="stringliteral">&quot;jid&quot;</span>, jid);
<a name="l01033"></a>01033         xmlnode_set_attrib(item, <span class="stringliteral">&quot;affiliation&quot;</span>, affiliation);
<a name="l01034"></a>01034 
<a name="l01035"></a>01035         jabber_iq_send(iq);
<a name="l01036"></a>01036 
<a name="l01037"></a>01037         <span class="keywordflow">return</span> TRUE;
<a name="l01038"></a>01038 }
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01041"></a>01041 jabber_chat_affiliation_list_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l01042"></a>01042                                 JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l01043"></a>01043                                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l01044"></a>01044 {
<a name="l01045"></a>01045         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l01046"></a>01046         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *item;
<a name="l01047"></a>01047         <span class="keywordtype">int</span> chat_id = GPOINTER_TO_INT(data);
<a name="l01048"></a>01048         GString *buf;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050         <span class="keywordflow">if</span>(!(chat = jabber_chat_find_by_id(js, chat_id)))
<a name="l01051"></a>01051                 <span class="keywordflow">return</span>;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053         <span class="keywordflow">if</span> (type == JABBER_IQ_ERROR)
<a name="l01054"></a>01054                 <span class="keywordflow">return</span>;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         <span class="keywordflow">if</span>(!(query = xmlnode_get_child(packet, <span class="stringliteral">&quot;query&quot;</span>)))
<a name="l01057"></a>01057                 <span class="keywordflow">return</span>;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059         buf = g_string_new(_(<span class="stringliteral">&quot;Affiliations:&quot;</span>));
<a name="l01060"></a>01060 
<a name="l01061"></a>01061         item = xmlnode_get_child(query, <span class="stringliteral">&quot;item&quot;</span>);
<a name="l01062"></a>01062         <span class="keywordflow">if</span> (item) {
<a name="l01063"></a>01063                 <span class="keywordflow">for</span>( ; item; item = xmlnode_get_next_twin(item)) {
<a name="l01064"></a>01064                         <span class="keyword">const</span> <span class="keywordtype">char</span> *jid = xmlnode_get_attrib(item, <span class="stringliteral">&quot;jid&quot;</span>);
<a name="l01065"></a>01065                         <span class="keyword">const</span> <span class="keywordtype">char</span> *affiliation = xmlnode_get_attrib(item, <span class="stringliteral">&quot;affiliation&quot;</span>);
<a name="l01066"></a>01066                         <span class="keywordflow">if</span> (jid &amp;&amp; affiliation)
<a name="l01067"></a>01067                                 g_string_append_printf(buf, <span class="stringliteral">&quot;\n%s %s&quot;</span>, jid, affiliation);
<a name="l01068"></a>01068                 }
<a name="l01069"></a>01069     } <span class="keywordflow">else</span> {
<a name="l01070"></a>01070                 buf = g_string_append_c(buf, <span class="charliteral">&#39;\n&#39;</span>);
<a name="l01071"></a>01071                 buf = g_string_append_len(buf, _(<span class="stringliteral">&quot;No users found&quot;</span>), -1);
<a name="l01072"></a>01072         }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         purple_conv_chat_write(PURPLE_CONV_CHAT(chat-&gt;conv), <span class="stringliteral">&quot;&quot;</span>, buf-&gt;str,
<a name="l01075"></a>01075         <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5a3c4f1ba272e4552dfc9715b49514fba6">PURPLE_MESSAGE_SYSTEM</a> | <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5a1178205f532b7803f82995e1ea0a0882">PURPLE_MESSAGE_NO_LOG</a>, time(NULL));
<a name="l01076"></a>01076 
<a name="l01077"></a>01077         g_string_free(buf, TRUE);
<a name="l01078"></a>01078 }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080 gboolean jabber_chat_affiliation_list(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *affiliation)
<a name="l01081"></a>01081 {
<a name="l01082"></a>01082         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l01083"></a>01083         <span class="keywordtype">char</span> *room_jid;
<a name="l01084"></a>01084         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *item;
<a name="l01085"></a>01085 
<a name="l01086"></a>01086         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_GET,
<a name="l01087"></a>01087                         <span class="stringliteral">&quot;http://jabber.org/protocol/muc#admin&quot;</span>);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089         room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l01090"></a>01090         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, room_jid);
<a name="l01091"></a>01091 
<a name="l01092"></a>01092         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l01093"></a>01093         item = xmlnode_new_child(query, <span class="stringliteral">&quot;item&quot;</span>);
<a name="l01094"></a>01094         xmlnode_set_attrib(item, <span class="stringliteral">&quot;affiliation&quot;</span>, affiliation);
<a name="l01095"></a>01095 
<a name="l01096"></a>01096         jabber_iq_set_callback(iq, jabber_chat_affiliation_list_cb, GINT_TO_POINTER(chat-&gt;id));
<a name="l01097"></a>01097         jabber_iq_send(iq);
<a name="l01098"></a>01098 
<a name="l01099"></a>01099         <span class="keywordflow">return</span> TRUE;
<a name="l01100"></a>01100 }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102 gboolean jabber_chat_role_user(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *who,
<a name="l01103"></a>01103                                <span class="keyword">const</span> <span class="keywordtype">char</span> *role, <span class="keyword">const</span> <span class="keywordtype">char</span> *why)
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105         <span class="keywordtype">char</span> *to;
<a name="l01106"></a>01106         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l01107"></a>01107         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *item;
<a name="l01108"></a>01108         <a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *jcm;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110         jcm = g_hash_table_lookup(chat-&gt;members, who);
<a name="l01111"></a>01111 
<a name="l01112"></a>01112         <span class="keywordflow">if</span> (!jcm || !jcm-&gt;handle)
<a name="l01113"></a>01113                 <span class="keywordflow">return</span> FALSE;
<a name="l01114"></a>01114 
<a name="l01115"></a>01115         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_SET,
<a name="l01116"></a>01116                                  <span class="stringliteral">&quot;http://jabber.org/protocol/muc#admin&quot;</span>);
<a name="l01117"></a>01117 
<a name="l01118"></a>01118         to = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l01119"></a>01119         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, to);
<a name="l01120"></a>01120         g_free(to);
<a name="l01121"></a>01121 
<a name="l01122"></a>01122         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l01123"></a>01123         item = xmlnode_new_child(query, <span class="stringliteral">&quot;item&quot;</span>);
<a name="l01124"></a>01124         xmlnode_set_attrib(item, <span class="stringliteral">&quot;nick&quot;</span>, jcm-&gt;handle);
<a name="l01125"></a>01125         xmlnode_set_attrib(item, <span class="stringliteral">&quot;role&quot;</span>, role);
<a name="l01126"></a>01126         <span class="keywordflow">if</span> (why) {
<a name="l01127"></a>01127                 <a class="code" href="struct__xmlnode.html">xmlnode</a> *reason = xmlnode_new_child(item, <span class="stringliteral">&quot;reason&quot;</span>);
<a name="l01128"></a>01128                 xmlnode_insert_data(reason, why, -1);
<a name="l01129"></a>01129         }
<a name="l01130"></a>01130 
<a name="l01131"></a>01131         jabber_iq_send(iq);
<a name="l01132"></a>01132 
<a name="l01133"></a>01133         <span class="keywordflow">return</span> TRUE;
<a name="l01134"></a>01134 }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_chat_role_list_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l01137"></a>01137                                      JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l01138"></a>01138                                      <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l01139"></a>01139 {
<a name="l01140"></a>01140         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l01141"></a>01141         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *item;
<a name="l01142"></a>01142         <span class="keywordtype">int</span> chat_id = GPOINTER_TO_INT(data);
<a name="l01143"></a>01143         GString *buf;
<a name="l01144"></a>01144 
<a name="l01145"></a>01145         <span class="keywordflow">if</span>(!(chat = jabber_chat_find_by_id(js, chat_id)))
<a name="l01146"></a>01146                 <span class="keywordflow">return</span>;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148         <span class="keywordflow">if</span> (type == JABBER_IQ_ERROR)
<a name="l01149"></a>01149                 <span class="keywordflow">return</span>;
<a name="l01150"></a>01150 
<a name="l01151"></a>01151         <span class="keywordflow">if</span>(!(query = xmlnode_get_child(packet, <span class="stringliteral">&quot;query&quot;</span>)))
<a name="l01152"></a>01152                 <span class="keywordflow">return</span>;
<a name="l01153"></a>01153 
<a name="l01154"></a>01154         buf = g_string_new(_(<span class="stringliteral">&quot;Roles:&quot;</span>));
<a name="l01155"></a>01155 
<a name="l01156"></a>01156         item = xmlnode_get_child(query, <span class="stringliteral">&quot;item&quot;</span>);
<a name="l01157"></a>01157         <span class="keywordflow">if</span> (item) {
<a name="l01158"></a>01158                 <span class="keywordflow">for</span>( ; item; item = xmlnode_get_next_twin(item)) {
<a name="l01159"></a>01159                         <span class="keyword">const</span> <span class="keywordtype">char</span> *jid  = xmlnode_get_attrib(item, <span class="stringliteral">&quot;jid&quot;</span>);
<a name="l01160"></a>01160                         <span class="keyword">const</span> <span class="keywordtype">char</span> *role = xmlnode_get_attrib(item, <span class="stringliteral">&quot;role&quot;</span>);
<a name="l01161"></a>01161                         <span class="keywordflow">if</span> (jid &amp;&amp; role)
<a name="l01162"></a>01162                                 g_string_append_printf(buf, <span class="stringliteral">&quot;\n%s %s&quot;</span>, jid, role);
<a name="l01163"></a>01163             }
<a name="l01164"></a>01164         } <span class="keywordflow">else</span> {
<a name="l01165"></a>01165                 buf = g_string_append_c(buf, <span class="charliteral">&#39;\n&#39;</span>);
<a name="l01166"></a>01166                 buf = g_string_append_len(buf, _(<span class="stringliteral">&quot;No users found&quot;</span>), -1);
<a name="l01167"></a>01167         }
<a name="l01168"></a>01168 
<a name="l01169"></a>01169         purple_conv_chat_write(PURPLE_CONV_CHAT(chat-&gt;conv), <span class="stringliteral">&quot;&quot;</span>, buf-&gt;str,
<a name="l01170"></a>01170         <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5a3c4f1ba272e4552dfc9715b49514fba6">PURPLE_MESSAGE_SYSTEM</a> | <a class="code" href="conversation_8h.html#a66e44dfdc0de2953d73f03fb806bf6f5a1178205f532b7803f82995e1ea0a0882">PURPLE_MESSAGE_NO_LOG</a>, time(NULL));
<a name="l01171"></a>01171 
<a name="l01172"></a>01172         g_string_free(buf, TRUE);
<a name="l01173"></a>01173 }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175 gboolean jabber_chat_role_list(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat, <span class="keyword">const</span> <span class="keywordtype">char</span> *role)
<a name="l01176"></a>01176 {
<a name="l01177"></a>01177         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l01178"></a>01178         <span class="keywordtype">char</span> *room_jid;
<a name="l01179"></a>01179         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *item;
<a name="l01180"></a>01180 
<a name="l01181"></a>01181         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_GET,
<a name="l01182"></a>01182                         <span class="stringliteral">&quot;http://jabber.org/protocol/muc#admin&quot;</span>);
<a name="l01183"></a>01183 
<a name="l01184"></a>01184         room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l01185"></a>01185         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, room_jid);
<a name="l01186"></a>01186 
<a name="l01187"></a>01187         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l01188"></a>01188         item = xmlnode_new_child(query, <span class="stringliteral">&quot;item&quot;</span>);
<a name="l01189"></a>01189         xmlnode_set_attrib(item, <span class="stringliteral">&quot;role&quot;</span>, role);
<a name="l01190"></a>01190 
<a name="l01191"></a>01191         jabber_iq_set_callback(iq, jabber_chat_role_list_cb, GINT_TO_POINTER(chat-&gt;id));
<a name="l01192"></a>01192         jabber_iq_send(iq);
<a name="l01193"></a>01193 
<a name="l01194"></a>01194         <span class="keywordflow">return</span> TRUE;
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 <span class="keyword">static</span> <span class="keywordtype">void</span> jabber_chat_disco_traffic_cb(<a class="code" href="struct___jabber_stream.html">JabberStream</a> *js, <span class="keyword">const</span> <span class="keywordtype">char</span> *from,
<a name="l01198"></a>01198                                          JabberIqType type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,
<a name="l01199"></a>01199                                          <a class="code" href="struct__xmlnode.html">xmlnode</a> *packet, gpointer data)
<a name="l01200"></a>01200 {
<a name="l01201"></a>01201         <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat;
<a name="l01202"></a>01202 <span class="preprocessor">#if 0</span>
<a name="l01203"></a>01203 <span class="preprocessor"></span>        <a class="code" href="struct__xmlnode.html">xmlnode</a> *query, *x;
<a name="l01204"></a>01204 <span class="preprocessor">#endif</span>
<a name="l01205"></a>01205 <span class="preprocessor"></span>        <span class="keywordtype">int</span> chat_id = GPOINTER_TO_INT(data);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207         <span class="keywordflow">if</span>(!(chat = jabber_chat_find_by_id(js, chat_id)))
<a name="l01208"></a>01208                 <span class="keywordflow">return</span>;
<a name="l01209"></a>01209 
<a name="l01210"></a>01210         <span class="comment">/* defaults, in case the conference server doesn&#39;t</span>
<a name="l01211"></a>01211 <span class="comment">         * support this request */</span>
<a name="l01212"></a>01212         chat-&gt;xhtml = TRUE;
<a name="l01213"></a>01213 
<a name="l01214"></a>01214         <span class="comment">/* disabling this until more MUC servers support</span>
<a name="l01215"></a>01215 <span class="comment">         * announcing this */</span>
<a name="l01216"></a>01216 <span class="preprocessor">#if 0</span>
<a name="l01217"></a>01217 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (type == JABBER_IQ_ERROR) {
<a name="l01218"></a>01218                 <span class="keywordflow">return</span>;
<a name="l01219"></a>01219         }
<a name="l01220"></a>01220 
<a name="l01221"></a>01221         <span class="keywordflow">if</span>(!(query = xmlnode_get_child(packet, <span class="stringliteral">&quot;query&quot;</span>)))
<a name="l01222"></a>01222                 <span class="keywordflow">return</span>;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224         chat-&gt;xhtml = FALSE;
<a name="l01225"></a>01225 
<a name="l01226"></a>01226         <span class="keywordflow">for</span>(x = xmlnode_get_child(query, <span class="stringliteral">&quot;feature&quot;</span>); x; x = xmlnode_get_next_twin(x)) {
<a name="l01227"></a>01227                 <span class="keyword">const</span> <span class="keywordtype">char</span> *var = xmlnode_get_attrib(x, <span class="stringliteral">&quot;var&quot;</span>);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229                 <span class="keywordflow">if</span>(var &amp;&amp; !strcmp(var, NS_XHTML_IM)) {
<a name="l01230"></a>01230                         chat-&gt;xhtml = TRUE;
<a name="l01231"></a>01231                 }
<a name="l01232"></a>01232         }
<a name="l01233"></a>01233 <span class="preprocessor">#endif</span>
<a name="l01234"></a>01234 <span class="preprocessor"></span>}
<a name="l01235"></a>01235 
<a name="l01236"></a>01236 <span class="keywordtype">void</span> jabber_chat_disco_traffic(<a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat)
<a name="l01237"></a>01237 {
<a name="l01238"></a>01238         <a class="code" href="struct___jabber_iq.html">JabberIq</a> *iq;
<a name="l01239"></a>01239         <a class="code" href="struct__xmlnode.html">xmlnode</a> *query;
<a name="l01240"></a>01240         <span class="keywordtype">char</span> *room_jid;
<a name="l01241"></a>01241 
<a name="l01242"></a>01242         room_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l01243"></a>01243 
<a name="l01244"></a>01244         iq = jabber_iq_new_query(chat-&gt;js, JABBER_IQ_GET, NS_DISCO_INFO);
<a name="l01245"></a>01245 
<a name="l01246"></a>01246         xmlnode_set_attrib(iq-&gt;node, <span class="stringliteral">&quot;to&quot;</span>, room_jid);
<a name="l01247"></a>01247 
<a name="l01248"></a>01248         query = xmlnode_get_child(iq-&gt;node, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l01249"></a>01249 
<a name="l01250"></a>01250         xmlnode_set_attrib(query, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/muc#traffic&quot;</span>);
<a name="l01251"></a>01251 
<a name="l01252"></a>01252         jabber_iq_set_callback(iq, jabber_chat_disco_traffic_cb, GINT_TO_POINTER(chat-&gt;id));
<a name="l01253"></a>01253 
<a name="l01254"></a>01254         jabber_iq_send(iq);
<a name="l01255"></a>01255 
<a name="l01256"></a>01256         g_free(room_jid);
<a name="l01257"></a>01257 }
<a name="l01258"></a>01258 
<a name="l01259"></a><a class="code" href="struct_jabber_chat_caps_data.html">01259</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01260"></a>01260         <span class="keyword">const</span> gchar *cap;
<a name="l01261"></a>01261         gboolean *all_support;
<a name="l01262"></a>01262         <a class="code" href="struct___jabber_buddy.html">JabberBuddy</a> *jb;
<a name="l01263"></a>01263 } <a class="code" href="struct_jabber_chat_caps_data.html">JabberChatCapsData</a>;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01266"></a>01266 jabber_chat_all_participants_have_capability_foreach(gpointer key,
<a name="l01267"></a>01267                                                      gpointer value,
<a name="l01268"></a>01268                                                      gpointer user_data)
<a name="l01269"></a>01269 {
<a name="l01270"></a>01270         <span class="keyword">const</span> gchar *cap = ((<a class="code" href="struct_jabber_chat_caps_data.html">JabberChatCapsData</a> *) user_data)-&gt;cap;
<a name="l01271"></a>01271         gboolean *all_support = ((<a class="code" href="struct_jabber_chat_caps_data.html">JabberChatCapsData</a> *) user_data)-&gt;all_support;
<a name="l01272"></a>01272         <a class="code" href="struct___jabber_buddy.html">JabberBuddy</a> *jb = ((<a class="code" href="struct_jabber_chat_caps_data.html">JabberChatCapsData</a> *) user_data)-&gt;jb;
<a name="l01273"></a>01273         <a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *member = (<a class="code" href="struct___jabber_chat_member.html">JabberChatMember</a> *) value;
<a name="l01274"></a>01274         <span class="keyword">const</span> gchar *resource = member-&gt;handle;
<a name="l01275"></a>01275         <a class="code" href="struct___jabber_buddy_resource.html">JabberBuddyResource</a> *jbr = jabber_buddy_find_resource(jb, resource);
<a name="l01276"></a>01276 
<a name="l01277"></a>01277         <span class="keywordflow">if</span> (jbr) {
<a name="l01278"></a>01278                 *all_support &amp;= jabber_resource_has_capability(jbr, cap);
<a name="l01279"></a>01279         } <span class="keywordflow">else</span> {
<a name="l01280"></a>01280                 *all_support = FALSE;
<a name="l01281"></a>01281         }
<a name="l01282"></a>01282 }
<a name="l01283"></a>01283 
<a name="l01284"></a>01284 gboolean
<a name="l01285"></a>01285 jabber_chat_all_participants_have_capability(<span class="keyword">const</span> <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat,
<a name="l01286"></a>01286         <span class="keyword">const</span> gchar *cap)
<a name="l01287"></a>01287 {
<a name="l01288"></a>01288         gchar *chat_jid = NULL;
<a name="l01289"></a>01289         <a class="code" href="struct___jabber_buddy.html">JabberBuddy</a> *jb = NULL;
<a name="l01290"></a>01290         gboolean all_support = TRUE;
<a name="l01291"></a>01291         <a class="code" href="struct_jabber_chat_caps_data.html">JabberChatCapsData</a> data;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293         chat_jid = g_strdup_printf(<span class="stringliteral">&quot;%s@%s&quot;</span>, chat-&gt;room, chat-&gt;server);
<a name="l01294"></a>01294         jb = jabber_buddy_find(chat-&gt;js, chat_jid, FALSE);
<a name="l01295"></a>01295 
<a name="l01296"></a>01296         <span class="keywordflow">if</span> (jb) {
<a name="l01297"></a>01297                 data.cap = cap;
<a name="l01298"></a>01298                 data.all_support = &amp;all_support;
<a name="l01299"></a>01299                 data.jb = jb;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301                 g_hash_table_foreach(chat-&gt;members,
<a name="l01302"></a>01302                         jabber_chat_all_participants_have_capability_foreach, &amp;data);
<a name="l01303"></a>01303         } <span class="keywordflow">else</span> {
<a name="l01304"></a>01304                 all_support = FALSE;
<a name="l01305"></a>01305         }
<a name="l01306"></a>01306         g_free(chat_jid);
<a name="l01307"></a>01307         <span class="keywordflow">return</span> all_support;
<a name="l01308"></a>01308 }
<a name="l01309"></a>01309 
<a name="l01310"></a>01310 guint
<a name="l01311"></a>01311 jabber_chat_get_num_participants(<span class="keyword">const</span> <a class="code" href="struct___jabber_chat.html">JabberChat</a> *chat)
<a name="l01312"></a>01312 {
<a name="l01313"></a>01313         <span class="keywordflow">return</span> g_hash_table_size(chat-&gt;members);
<a name="l01314"></a>01314 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>chat.c</b>      </li>
      <li class="footer">Generated on Sun Mar 24 2013 16:05:12 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
