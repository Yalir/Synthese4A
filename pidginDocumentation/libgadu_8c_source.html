<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>protocols/gg/lib/libgadu.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('libgadu_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">protocols/gg/lib/libgadu.c</div>  </div>
</div>
<div class="contents">
<a href="libgadu_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* $Id: libgadu.c 1102 2011-05-05 21:17:57Z wojtekka $ */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">/*</span>
<a name="l00004"></a>00004 <span class="comment"> *  (C) Copyright 2001-2010 Wojtek Kaniewski &lt;wojtekka@irc.pl&gt;</span>
<a name="l00005"></a>00005 <span class="comment"> *                          Robert J. Woźny &lt;speedy@ziew.org&gt;</span>
<a name="l00006"></a>00006 <span class="comment"> *                          Arkadiusz Miśkiewicz &lt;arekm@pld-linux.org&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *                          Tomasz Chiliński &lt;chilek@chilan.com&gt;</span>
<a name="l00008"></a>00008 <span class="comment"> *                          Adam Wysocki &lt;gophi@ekg.chmurka.net&gt;</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> *  This program is free software; you can redistribute it and/or modify</span>
<a name="l00011"></a>00011 <span class="comment"> *  it under the terms of the GNU Lesser General Public License Version</span>
<a name="l00012"></a>00012 <span class="comment"> *  2.1 as published by the Free Software Foundation.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> *  This program is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00017"></a>00017 <span class="comment"> *  GNU Lesser General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> *  You should have received a copy of the GNU Lesser General Public</span>
<a name="l00020"></a>00020 <span class="comment"> *  License along with this program; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307,</span>
<a name="l00022"></a>00022 <span class="comment"> *  USA.</span>
<a name="l00023"></a>00023 <span class="comment"> */</span>
<a name="l00024"></a>00024 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;io.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#  include &lt;fcntl.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#  include &lt;errno.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#  define SHUT_RDWR SD_BOTH</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;sys/socket.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#  include &lt;netinet/in.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#  include &lt;arpa/inet.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#  ifdef sun</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">#    include &lt;sys/filio.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#  endif</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="compat_8h.html" title="Makra zapewniające kompatybilność API na różnych systemach.">compat.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="libgadu_8h.html" title="Główny plik nagłówkowy biblioteki.">libgadu.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;libgadu-config.h&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;protocol.h&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;resolver.h&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;libgadu-internal.h&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;encoding.h&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;libgadu-debug.h&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;session.h&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;message.h&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;deflate.h&quot;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#ifndef _WIN32</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;errno.h&gt;</span> <span class="comment">/* on Win32 this is included above */</span>
<a name="l00060"></a>00060 <span class="preprocessor">#  include &lt;netdb.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#endif</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdarg.h&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_GNUTLS</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;gnutls/gnutls.h&gt;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#endif</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#ifdef GG_CONFIG_HAVE_OPENSSL</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;openssl/err.h&gt;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#  include &lt;openssl/rand.h&gt;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#endif</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077 <span class="preprocessor">#define GG_LIBGADU_VERSION &quot;1.11.0&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>
<a name="l00084"></a><a class="code" href="libgadu_8h.html#a960d84f00c52c563d77638fcd558de4c">00084</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a960d84f00c52c563d77638fcd558de4c">gg_dcc_port</a> = 0;
<a name="l00085"></a>00085 
<a name="l00091"></a><a class="code" href="libgadu_8h.html#a07d86b10975c0311e908165df247494c">00091</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="libgadu_8c.html#a07d86b10975c0311e908165df247494c">gg_dcc_ip</a> = 0;
<a name="l00092"></a>00092 
<a name="l00098"></a><a class="code" href="libgadu_8h.html#a3278b666b85b4572e32025ca40d2b10b">00098</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="libgadu_8c.html#a3278b666b85b4572e32025ca40d2b10b">gg_local_ip</a> = 0;
<a name="l00099"></a>00099 
<a name="l00105"></a><a class="code" href="libgadu_8h.html#aac1649ba1fcd3f24f01e16c99d84e799">00105</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#aac1649ba1fcd3f24f01e16c99d84e799">gg_proxy_enabled</a> = 0;
<a name="l00106"></a>00106 
<a name="l00112"></a><a class="code" href="libgadu_8h.html#ab1bcfc3ddfef79b410ebd69320ec5398">00112</a> <span class="keywordtype">char</span> *<a class="code" href="libgadu_8c.html#ab1bcfc3ddfef79b410ebd69320ec5398">gg_proxy_host</a> = NULL;
<a name="l00113"></a>00113 
<a name="l00119"></a><a class="code" href="libgadu_8h.html#a7e6921ea3b93f9ce494ea280c8d8b541">00119</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a7e6921ea3b93f9ce494ea280c8d8b541">gg_proxy_port</a> = 0;
<a name="l00120"></a>00120 
<a name="l00126"></a><a class="code" href="libgadu_8h.html#aa5dcac12af4fbf3264de18beeddd48b5">00126</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#aa5dcac12af4fbf3264de18beeddd48b5">gg_proxy_http_only</a> = 0;
<a name="l00127"></a>00127 
<a name="l00133"></a><a class="code" href="libgadu_8h.html#a0ad8a852bfbad89e2ddc9da2cf9b0587">00133</a> <span class="keywordtype">char</span> *<a class="code" href="libgadu_8c.html#a0ad8a852bfbad89e2ddc9da2cf9b0587">gg_proxy_username</a> = NULL;
<a name="l00134"></a>00134 
<a name="l00140"></a><a class="code" href="libgadu_8h.html#a594e0828d76b991763610b55a3c398b2">00140</a> <span class="keywordtype">char</span> *<a class="code" href="libgadu_8c.html#a594e0828d76b991763610b55a3c398b2">gg_proxy_password</a> = NULL;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="preprocessor">#ifndef DOXYGEN</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>
<a name="l00144"></a>00144 <span class="preprocessor">#ifndef lint</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> rcsid[]
<a name="l00146"></a>00146 <span class="preprocessor">#ifdef __GNUC__</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>__attribute__ ((unused))
<a name="l00148"></a>00148 <span class="preprocessor">#endif</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>= <span class="stringliteral">&quot;$Id: libgadu.c 1102 2011-05-05 21:17:57Z wojtekka $&quot;</span>;
<a name="l00150"></a>00150 <span class="preprocessor">#endif</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>
<a name="l00152"></a>00152 <span class="preprocessor">#endif </span><span class="comment">/* DOXYGEN */</span>
<a name="l00153"></a>00153 
<a name="l00161"></a><a class="code" href="libgadu_8h.html#a7d4669c46873ab27f3a4577db8ed9419">00161</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="libgadu_8c.html#aeac7dc1381758308c47468ddfef77e71">gg_libgadu_version</a>()
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163         <span class="keywordflow">return</span> GG_LIBGADU_VERSION;
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_UINT64_T</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>
<a name="l00179"></a>00179 uint64_t gg_fix64(uint64_t x)
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181 <span class="preprocessor">#ifndef GG_CONFIG_BIGENDIAN</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>        <span class="keywordflow">return</span> x;
<a name="l00183"></a>00183 <span class="preprocessor">#else</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>        <span class="keywordflow">return</span> (uint64_t)
<a name="l00185"></a>00185                 (((x &amp; (uint64_t) 0x00000000000000ffULL) &lt;&lt; 56) |
<a name="l00186"></a>00186                 ((x &amp; (uint64_t) 0x000000000000ff00ULL) &lt;&lt; 40) |
<a name="l00187"></a>00187                 ((x &amp; (uint64_t) 0x0000000000ff0000ULL) &lt;&lt; 24) |
<a name="l00188"></a>00188                 ((x &amp; (uint64_t) 0x00000000ff000000ULL) &lt;&lt; 8) |
<a name="l00189"></a>00189                 ((x &amp; (uint64_t) 0x000000ff00000000ULL) &gt;&gt; 8) |
<a name="l00190"></a>00190                 ((x &amp; (uint64_t) 0x0000ff0000000000ULL) &gt;&gt; 24) |
<a name="l00191"></a>00191                 ((x &amp; (uint64_t) 0x00ff000000000000ULL) &gt;&gt; 40) |
<a name="l00192"></a>00192                 ((x &amp; (uint64_t) 0xff00000000000000ULL) &gt;&gt; 56));
<a name="l00193"></a>00193 <span class="preprocessor">#endif</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>}
<a name="l00195"></a>00195 <span class="preprocessor">#endif </span><span class="comment">/* GG_CONFIG_HAVE_UINT64_T */</span>
<a name="l00196"></a>00196 
<a name="l00209"></a>00209 uint32_t gg_fix32(uint32_t x)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211 <span class="preprocessor">#ifndef GG_CONFIG_BIGENDIAN</span>
<a name="l00212"></a>00212 <span class="preprocessor"></span>        <span class="keywordflow">return</span> x;
<a name="l00213"></a>00213 <span class="preprocessor">#else</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span>        <span class="keywordflow">return</span> (uint32_t)
<a name="l00215"></a>00215                 (((x &amp; (uint32_t) 0x000000ffU) &lt;&lt; 24) |
<a name="l00216"></a>00216                 ((x &amp; (uint32_t) 0x0000ff00U) &lt;&lt; 8) |
<a name="l00217"></a>00217                 ((x &amp; (uint32_t) 0x00ff0000U) &gt;&gt; 8) |
<a name="l00218"></a>00218                 ((x &amp; (uint32_t) 0xff000000U) &gt;&gt; 24));
<a name="l00219"></a>00219 <span class="preprocessor">#endif</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>}
<a name="l00221"></a>00221 
<a name="l00234"></a>00234 uint16_t gg_fix16(uint16_t x)
<a name="l00235"></a>00235 {
<a name="l00236"></a>00236 <span class="preprocessor">#ifndef GG_CONFIG_BIGENDIAN</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span>        <span class="keywordflow">return</span> x;
<a name="l00238"></a>00238 <span class="preprocessor">#else</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>        <span class="keywordflow">return</span> (uint16_t)
<a name="l00240"></a>00240                 (((x &amp; (uint16_t) 0x00ffU) &lt;&lt; 8) |
<a name="l00241"></a>00241                 ((x &amp; (uint16_t) 0xff00U) &gt;&gt; 8));
<a name="l00242"></a>00242 <span class="preprocessor">#endif</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span>}
<a name="l00244"></a>00244 
<a name="l00253"></a>00253 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gg_login_hash(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *password, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> seed)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x, y, z;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257         y = seed;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="keywordflow">for</span> (x = 0; *password; password++) {
<a name="l00260"></a>00260                 x = (x &amp; 0xffffff00) | *password;
<a name="l00261"></a>00261                 y ^= x;
<a name="l00262"></a>00262                 y += x;
<a name="l00263"></a>00263                 x &lt;&lt;= 8;
<a name="l00264"></a>00264                 y ^= x;
<a name="l00265"></a>00265                 x &lt;&lt;= 8;
<a name="l00266"></a>00266                 y -= x;
<a name="l00267"></a>00267                 x &lt;&lt;= 8;
<a name="l00268"></a>00268                 y ^= x;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270                 z = y &amp; 0x1F;
<a name="l00271"></a>00271                 y = (y &lt;&lt; z) | (y &gt;&gt; (32 - z));
<a name="l00272"></a>00272         }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274         <span class="keywordflow">return</span> y;
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00290"></a>00290 <span class="keywordtype">int</span> gg_read(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> length)
<a name="l00291"></a>00291 {
<a name="l00292"></a>00292         <span class="keywordtype">int</span> res;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_GNUTLS</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> != NULL) {
<a name="l00296"></a>00296                 <span class="keywordflow">for</span> (;;) {
<a name="l00297"></a>00297                         res = gnutls_record_recv(GG_SESSION_GNUTLS(sess), buf, length);
<a name="l00298"></a>00298 
<a name="l00299"></a>00299                         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00300"></a>00300                                 <span class="keywordflow">if</span> (!gnutls_error_is_fatal(res) || res == GNUTLS_E_INTERRUPTED)
<a name="l00301"></a>00301                                         <span class="keywordflow">continue</span>;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303                                 <span class="keywordflow">if</span> (res == GNUTLS_E_AGAIN)
<a name="l00304"></a>00304                                         errno = EAGAIN;
<a name="l00305"></a>00305                                 <span class="keywordflow">else</span>
<a name="l00306"></a>00306                                         errno = EINVAL;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308                                 <span class="keywordflow">return</span> -1;
<a name="l00309"></a>00309                         }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311                         <span class="keywordflow">return</span> res;
<a name="l00312"></a>00312                 }
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314 <span class="preprocessor">#endif</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span>
<a name="l00316"></a>00316 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_OPENSSL</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> != NULL) {
<a name="l00318"></a>00318                 <span class="keywordflow">for</span> (;;) {
<a name="l00319"></a>00319                         <span class="keywordtype">int</span> err;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321                         res = SSL_read(sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>, buf, length);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323                         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00324"></a>00324                                 err = SSL_get_error(sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>, res);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326                                 <span class="keywordflow">if</span> (err == SSL_ERROR_SYSCALL &amp;&amp; errno == EINTR)
<a name="l00327"></a>00327                                         <span class="keywordflow">continue</span>;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                                 <span class="keywordflow">if</span> (err == SSL_ERROR_WANT_READ)
<a name="l00330"></a>00330                                         errno = EAGAIN;
<a name="l00331"></a>00331                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err != SSL_ERROR_SYSCALL)
<a name="l00332"></a>00332                                         errno = EINVAL;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334                                 <span class="keywordflow">return</span> -1;
<a name="l00335"></a>00335                         }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337                         <span class="keywordflow">return</span> res;
<a name="l00338"></a>00338                 }
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340 <span class="preprocessor">#endif</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span>
<a name="l00342"></a>00342         <span class="keywordflow">for</span> (;;) {
<a name="l00343"></a>00343                 res = read(sess-&gt;fd, buf, length);
<a name="l00344"></a>00344 
<a name="l00345"></a>00345                 <span class="keywordflow">if</span> (res == -1 &amp;&amp; errno == EINTR)
<a name="l00346"></a>00346                         <span class="keywordflow">continue</span>;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348                 <span class="keywordflow">return</span> res;
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00368"></a>00368 <span class="keyword">static</span> <span class="keywordtype">int</span> gg_write_common(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> length)
<a name="l00369"></a>00369 {
<a name="l00370"></a>00370         <span class="keywordtype">int</span> res;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_GNUTLS</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> != NULL) {
<a name="l00374"></a>00374                 <span class="keywordflow">for</span> (;;) {
<a name="l00375"></a>00375                         res = gnutls_record_send(GG_SESSION_GNUTLS(sess), buf, length);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377                         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00378"></a>00378                                 <span class="keywordflow">if</span> (!gnutls_error_is_fatal(res) || res == GNUTLS_E_INTERRUPTED)
<a name="l00379"></a>00379                                         <span class="keywordflow">continue</span>;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381                                 <span class="keywordflow">if</span> (res == GNUTLS_E_AGAIN)
<a name="l00382"></a>00382                                         errno = EAGAIN;
<a name="l00383"></a>00383                                 <span class="keywordflow">else</span>
<a name="l00384"></a>00384                                         errno = EINVAL;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386                                 <span class="keywordflow">return</span> -1;
<a name="l00387"></a>00387                         }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389                         <span class="keywordflow">return</span> res;
<a name="l00390"></a>00390                 }
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392 <span class="preprocessor">#endif</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>
<a name="l00394"></a>00394 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_OPENSSL</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> != NULL) {
<a name="l00396"></a>00396                 <span class="keywordflow">for</span> (;;) {
<a name="l00397"></a>00397                         <span class="keywordtype">int</span> err;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399                         res = SSL_write(sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>, buf, length);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401                         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00402"></a>00402                                 err = SSL_get_error(sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>, res);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404                                 <span class="keywordflow">if</span> (err == SSL_ERROR_SYSCALL &amp;&amp; errno == EINTR)
<a name="l00405"></a>00405                                         <span class="keywordflow">continue</span>;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407                                 <span class="keywordflow">if</span> (err == SSL_ERROR_WANT_WRITE)
<a name="l00408"></a>00408                                         errno = EAGAIN;
<a name="l00409"></a>00409                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err != SSL_ERROR_SYSCALL)
<a name="l00410"></a>00410                                         errno = EINVAL;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412                                 <span class="keywordflow">return</span> -1;
<a name="l00413"></a>00413                         }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415                         <span class="keywordflow">return</span> res;
<a name="l00416"></a>00416                 }
<a name="l00417"></a>00417         }
<a name="l00418"></a>00418 <span class="preprocessor">#endif</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span>
<a name="l00420"></a>00420         <span class="keywordflow">for</span> (;;) {
<a name="l00421"></a>00421                 res = write(sess-&gt;fd, buf, length);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423                 <span class="keywordflow">if</span> (res == -1 &amp;&amp; errno == EINTR)
<a name="l00424"></a>00424                         <span class="keywordflow">continue</span>;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426                 <span class="keywordflow">return</span> res;
<a name="l00427"></a>00427         }
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 
<a name="l00443"></a>00443 <span class="keywordtype">int</span> gg_write(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> length)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445         <span class="keywordtype">int</span> res = 0;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         <span class="keywordflow">if</span> (!sess-&gt;async) {
<a name="l00448"></a>00448                 <span class="keywordtype">int</span> written = 0;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450                 <span class="keywordflow">while</span> (written &lt; length) {
<a name="l00451"></a>00451                         res = gg_write_common(sess, buf + written, length - written);
<a name="l00452"></a>00452 
<a name="l00453"></a>00453                         <span class="keywordflow">if</span> (res == -1)
<a name="l00454"></a>00454                                 <span class="keywordflow">return</span> -1;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456                         written += res;
<a name="l00457"></a>00457                         res = written;
<a name="l00458"></a>00458                 }
<a name="l00459"></a>00459         } <span class="keywordflow">else</span> {
<a name="l00460"></a>00460                 res = 0;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a> == NULL) {
<a name="l00463"></a>00463                         res = gg_write_common(sess, buf, length);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465                         <span class="keywordflow">if</span> (res == -1)
<a name="l00466"></a>00466                                 <span class="keywordflow">return</span> -1;
<a name="l00467"></a>00467                 }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469                 <span class="keywordflow">if</span> (res &lt; length) {
<a name="l00470"></a>00470                         <span class="keywordtype">char</span> *tmp;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472                         <span class="keywordflow">if</span> (!(tmp = realloc(sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a>, sess-&gt;<a class="code" href="structgg__session.html#a2d287ecd0fab8dca69a25ed90c2c02a3">send_left</a> + length - res))) {
<a name="l00473"></a>00473                                 errno = ENOMEM;
<a name="l00474"></a>00474                                 <span class="keywordflow">return</span> -1;
<a name="l00475"></a>00475                         }
<a name="l00476"></a>00476 
<a name="l00477"></a>00477                         sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a> = tmp;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479                         memcpy(sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a> + sess-&gt;<a class="code" href="structgg__session.html#a2d287ecd0fab8dca69a25ed90c2c02a3">send_left</a>, buf + res, length - res);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481                         sess-&gt;<a class="code" href="structgg__session.html#a2d287ecd0fab8dca69a25ed90c2c02a3">send_left</a> += length - res;
<a name="l00482"></a>00482                 }
<a name="l00483"></a>00483         }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485         <span class="keywordflow">return</span> res;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00502"></a>00502 <span class="keywordtype">void</span> *gg_recv_packet(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504         <span class="keyword">struct </span><a class="code" href="structgg__header.html">gg_header</a> h;
<a name="l00505"></a>00505         <span class="keywordtype">char</span> *packet;
<a name="l00506"></a>00506         <span class="keywordtype">int</span> ret = 0;
<a name="l00507"></a>00507         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset, size = 0;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_recv_packet(%p);\n&quot;</span>, sess);
<a name="l00510"></a>00510 
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (!sess) {
<a name="l00512"></a>00512                 errno = EFAULT;
<a name="l00513"></a>00513                 <span class="keywordflow">return</span> NULL;
<a name="l00514"></a>00514         }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#ae527488a279db2b93a4655b0a2198947">recv_left</a> &lt; 1) {
<a name="l00517"></a>00517                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a61f431ba941e974ae60160fe6112ef6d">header_buf</a>) {
<a name="l00518"></a>00518                         memcpy(&amp;h, sess-&gt;<a class="code" href="structgg__session.html#a61f431ba941e974ae60160fe6112ef6d">header_buf</a>, sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a>);
<a name="l00519"></a>00519                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() header recv: resuming last read (%d bytes left)\n&quot;</span>, <span class="keyword">sizeof</span>(h) - sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a>);
<a name="l00520"></a>00520                         free(sess-&gt;<a class="code" href="structgg__session.html#a61f431ba941e974ae60160fe6112ef6d">header_buf</a>);
<a name="l00521"></a>00521                         sess-&gt;<a class="code" href="structgg__session.html#a61f431ba941e974ae60160fe6112ef6d">header_buf</a> = NULL;
<a name="l00522"></a>00522                 } <span class="keywordflow">else</span>
<a name="l00523"></a>00523                         sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a> = 0;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525                 <span class="keywordflow">while</span> (sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a> &lt; <span class="keyword">sizeof</span>(h)) {
<a name="l00526"></a>00526                         ret = gg_read(sess, (<span class="keywordtype">char</span>*) &amp;h + sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a>, <span class="keyword">sizeof</span>(h) - sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a>);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() header recv(%d,%p,%d) = %d\n&quot;</span>, sess-&gt;fd, (<span class="keywordtype">char</span>*)&amp;h + sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a>, <span class="keyword">sizeof</span>(h) - sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a>, ret);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530                         <span class="keywordflow">if</span> (!ret) {
<a name="l00531"></a>00531                                 errno = ECONNRESET;
<a name="l00532"></a>00532                                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() header recv() failed: connection broken\n&quot;</span>);
<a name="l00533"></a>00533                                 <span class="keywordflow">return</span> NULL;
<a name="l00534"></a>00534                         }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536                         <span class="keywordflow">if</span> (ret == -1) {
<a name="l00537"></a>00537                                 <span class="keywordflow">if</span> (errno == EAGAIN) {
<a name="l00538"></a>00538                                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() header recv() incomplete header received\n&quot;</span>);
<a name="l00539"></a>00539 
<a name="l00540"></a>00540                                         <span class="keywordflow">if</span> (!(sess-&gt;<a class="code" href="structgg__session.html#a61f431ba941e974ae60160fe6112ef6d">header_buf</a> = malloc(sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a>))) {
<a name="l00541"></a>00541                                                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() header recv() not enough memory\n&quot;</span>);
<a name="l00542"></a>00542                                                 <span class="keywordflow">return</span> NULL;
<a name="l00543"></a>00543                                         }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545                                         memcpy(sess-&gt;<a class="code" href="structgg__session.html#a61f431ba941e974ae60160fe6112ef6d">header_buf</a>, &amp;h, sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a>);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547                                         errno = EAGAIN;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549                                         <span class="keywordflow">return</span> NULL;
<a name="l00550"></a>00550                                 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552                                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() header recv() failed: errno=%d, %s\n&quot;</span>, errno, strerror(errno));
<a name="l00553"></a>00553 
<a name="l00554"></a>00554                                 <span class="keywordflow">return</span> NULL;
<a name="l00555"></a>00555                         }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557                         sess-&gt;<a class="code" href="structgg__session.html#a502aba4e254ac672a28079a197895a13">header_done</a> += ret;
<a name="l00558"></a>00558                 }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560                 h.type = gg_fix32(h.type);
<a name="l00561"></a>00561                 h.length = gg_fix32(h.length);
<a name="l00562"></a>00562         } <span class="keywordflow">else</span>
<a name="l00563"></a>00563                 memcpy(&amp;h, sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a>, <span class="keyword">sizeof</span>(h));
<a name="l00564"></a>00564 
<a name="l00565"></a>00565         <span class="comment">/* jakieś sensowne limity na rozmiar pakietu */</span>
<a name="l00566"></a>00566         <span class="keywordflow">if</span> (h.length &gt; 65535) {
<a name="l00567"></a>00567                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() invalid packet length (%d)\n&quot;</span>, h.length);
<a name="l00568"></a>00568                 errno = ERANGE;
<a name="l00569"></a>00569                 <span class="keywordflow">return</span> NULL;
<a name="l00570"></a>00570         }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#ae527488a279db2b93a4655b0a2198947">recv_left</a> &gt; 0) {
<a name="l00573"></a>00573                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() resuming last gg_recv_packet()\n&quot;</span>);
<a name="l00574"></a>00574                 size = sess-&gt;<a class="code" href="structgg__session.html#ae527488a279db2b93a4655b0a2198947">recv_left</a>;
<a name="l00575"></a>00575                 offset = sess-&gt;<a class="code" href="structgg__session.html#a27e5b2d0c922d712f78f733575546a76">recv_done</a>;
<a name="l00576"></a>00576         } <span class="keywordflow">else</span> {
<a name="l00577"></a>00577                 <span class="keywordflow">if</span> (!(sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a> = malloc(<span class="keyword">sizeof</span>(h) + h.length + 1))) {
<a name="l00578"></a>00578                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() not enough memory for packet data\n&quot;</span>);
<a name="l00579"></a>00579                         <span class="keywordflow">return</span> NULL;
<a name="l00580"></a>00580                 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582                 memcpy(sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a>, &amp;h, <span class="keyword">sizeof</span>(h));
<a name="l00583"></a>00583 
<a name="l00584"></a>00584                 offset = 0;
<a name="l00585"></a>00585                 size = h.length;
<a name="l00586"></a>00586         }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keywordflow">while</span> (size &gt; 0) {
<a name="l00589"></a>00589                 ret = gg_read(sess, sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a> + <span class="keyword">sizeof</span>(h) + offset, size);
<a name="l00590"></a>00590                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() body recv(%d,%p,%d) = %d\n&quot;</span>, sess-&gt;fd, sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a> + <span class="keyword">sizeof</span>(h) + offset, size, ret);
<a name="l00591"></a>00591                 <span class="keywordflow">if</span> (!ret) {
<a name="l00592"></a>00592                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() body recv() failed: connection broken\n&quot;</span>);
<a name="l00593"></a>00593                         errno = ECONNRESET;
<a name="l00594"></a>00594                         <span class="keywordflow">goto</span> fail;
<a name="l00595"></a>00595                 }
<a name="l00596"></a>00596                 <span class="keywordflow">if</span> (ret &gt; -1 &amp;&amp; ret &lt;= size) {
<a name="l00597"></a>00597                         offset += ret;
<a name="l00598"></a>00598                         size -= ret;
<a name="l00599"></a>00599                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ret == -1) {
<a name="l00600"></a>00600                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() body recv() failed (errno=%d, %s)\n&quot;</span>, errno, strerror(errno));
<a name="l00601"></a>00601 
<a name="l00602"></a>00602                         <span class="keywordflow">if</span> (errno == EAGAIN) {
<a name="l00603"></a>00603                                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_recv_packet() %d bytes received, %d left\n&quot;</span>, offset, size);
<a name="l00604"></a>00604                                 sess-&gt;<a class="code" href="structgg__session.html#ae527488a279db2b93a4655b0a2198947">recv_left</a> = size;
<a name="l00605"></a>00605                                 sess-&gt;<a class="code" href="structgg__session.html#a27e5b2d0c922d712f78f733575546a76">recv_done</a> = offset;
<a name="l00606"></a>00606                                 <span class="keywordflow">return</span> NULL;
<a name="l00607"></a>00607                         }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609                         <span class="keywordflow">goto</span> fail;
<a name="l00610"></a>00610                 }
<a name="l00611"></a>00611         }
<a name="l00612"></a>00612 
<a name="l00613"></a>00613         packet = sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a>;
<a name="l00614"></a>00614         sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a> = NULL;
<a name="l00615"></a>00615         sess-&gt;<a class="code" href="structgg__session.html#ae527488a279db2b93a4655b0a2198947">recv_left</a> = 0;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a0d0e67a559d992f5a7ef7ea05a89fd26">GG_DEBUG_DUMP</a>, <span class="stringliteral">&quot;// gg_recv_packet(type=0x%.2x, length=%d)\n&quot;</span>, h.type, h.length);
<a name="l00618"></a>00618         gg_debug_dump(sess, <a class="code" href="libgadu_8h.html#a0d0e67a559d992f5a7ef7ea05a89fd26">GG_DEBUG_DUMP</a>, packet, <span class="keyword">sizeof</span>(h) + h.length);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="keywordflow">return</span> packet;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 fail:
<a name="l00623"></a>00623         free(sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a>);
<a name="l00624"></a>00624         sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a> = NULL;
<a name="l00625"></a>00625         sess-&gt;<a class="code" href="structgg__session.html#ae527488a279db2b93a4655b0a2198947">recv_left</a> = 0;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         <span class="keywordflow">return</span> NULL;
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 
<a name="l00644"></a>00644 <span class="keywordtype">int</span> gg_send_packet(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> type, ...)
<a name="l00645"></a>00645 {
<a name="l00646"></a>00646         <span class="keyword">struct </span><a class="code" href="structgg__header.html">gg_header</a> *h;
<a name="l00647"></a>00647         <span class="keywordtype">char</span> *tmp;
<a name="l00648"></a>00648         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tmp_length;
<a name="l00649"></a>00649         <span class="keywordtype">void</span> *payload;
<a name="l00650"></a>00650         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> payload_length;
<a name="l00651"></a>00651         va_list ap;
<a name="l00652"></a>00652         <span class="keywordtype">int</span> res;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_send_packet(%p, 0x%.2x, ...);\n&quot;</span>, sess, type);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656         tmp_length = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structgg__header.html">gg_header</a>);
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         <span class="keywordflow">if</span> (!(tmp = malloc(tmp_length))) {
<a name="l00659"></a>00659                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_send_packet() not enough memory for packet header\n&quot;</span>);
<a name="l00660"></a>00660                 <span class="keywordflow">return</span> -1;
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         va_start(ap, type);
<a name="l00664"></a>00664 
<a name="l00665"></a>00665         payload = va_arg(ap, <span class="keywordtype">void</span> *);
<a name="l00666"></a>00666 
<a name="l00667"></a>00667         <span class="keywordflow">while</span> (payload) {
<a name="l00668"></a>00668                 <span class="keywordtype">char</span> *tmp2;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670                 payload_length = va_arg(ap, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672                 <span class="keywordflow">if</span> (!(tmp2 = realloc(tmp, tmp_length + payload_length))) {
<a name="l00673"></a>00673                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_send_packet() not enough memory for payload\n&quot;</span>);
<a name="l00674"></a>00674                         free(tmp);
<a name="l00675"></a>00675                         va_end(ap);
<a name="l00676"></a>00676                         <span class="keywordflow">return</span> -1;
<a name="l00677"></a>00677                 }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679                 tmp = tmp2;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681                 memcpy(tmp + tmp_length, payload, payload_length);
<a name="l00682"></a>00682                 tmp_length += payload_length;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684                 payload = va_arg(ap, <span class="keywordtype">void</span> *);
<a name="l00685"></a>00685         }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687         va_end(ap);
<a name="l00688"></a>00688 
<a name="l00689"></a>00689         h = (<span class="keyword">struct </span><a class="code" href="structgg__header.html">gg_header</a>*) tmp;
<a name="l00690"></a>00690         h-&gt;type = gg_fix32(type);
<a name="l00691"></a>00691         h-&gt;length = gg_fix32(tmp_length - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgg__header.html">gg_header</a>));
<a name="l00692"></a>00692 
<a name="l00693"></a>00693         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a0d0e67a559d992f5a7ef7ea05a89fd26">GG_DEBUG_DUMP</a>, <span class="stringliteral">&quot;// gg_send_packet(type=0x%.2x, length=%d)\n&quot;</span>, gg_fix32(h-&gt;type), gg_fix32(h-&gt;length));
<a name="l00694"></a>00694         gg_debug_dump(sess, <a class="code" href="libgadu_8h.html#a0d0e67a559d992f5a7ef7ea05a89fd26">GG_DEBUG_DUMP</a>, tmp, tmp_length);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696         res = gg_write(sess, tmp, tmp_length);
<a name="l00697"></a>00697 
<a name="l00698"></a>00698         free(tmp);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (res == -1) {
<a name="l00701"></a>00701                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_send_packet() write() failed. res = %d, errno = %d (%s)\n&quot;</span>, res, errno, strerror(errno));
<a name="l00702"></a>00702                 <span class="keywordflow">return</span> -1;
<a name="l00703"></a>00703         }
<a name="l00704"></a>00704 
<a name="l00705"></a>00705         <span class="keywordflow">if</span> (sess-&gt;async)
<a name="l00706"></a>00706                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_send_packet() partial write(), %d sent, %d left, %d total left\n&quot;</span>, res, tmp_length - res, sess-&gt;<a class="code" href="structgg__session.html#a2d287ecd0fab8dca69a25ed90c2c02a3">send_left</a>);
<a name="l00707"></a>00707 
<a name="l00708"></a>00708         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a>)
<a name="l00709"></a>00709                 sess-&gt;check |= <a class="code" href="libgadu_8h.html#a6eef74c7cbf152ecd7338667120701dba627a193d0827e0ba9e13883c21d31217">GG_CHECK_WRITE</a>;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         <span class="keywordflow">return</span> 0;
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00726"></a>00726 <span class="keyword">static</span> <span class="keywordtype">int</span> gg_session_callback(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess)
<a name="l00727"></a>00727 {
<a name="l00728"></a>00728         <span class="keywordflow">if</span> (!sess) {
<a name="l00729"></a>00729                 errno = EFAULT;
<a name="l00730"></a>00730                 <span class="keywordflow">return</span> -1;
<a name="l00731"></a>00731         }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         <span class="keywordflow">return</span> ((sess-&gt;<a class="code" href="structgg__session.html#a724ae353bd6d409bbf2bb882ce921395">event</a> = <a class="code" href="events_8c.html#ae28360891a3b393d606fb455564e3b3a">gg_watch_fd</a>(sess)) != NULL) ? 0 : -1;
<a name="l00734"></a>00734 }
<a name="l00735"></a>00735 
<a name="l00769"></a><a class="code" href="libgadu_8h.html#af231ccc428422f1b9e14e7c6ed65d1c4">00769</a> <span class="keyword">struct </span><a class="code" href="structgg__session.html">gg_session</a> *<a class="code" href="libgadu_8c.html#af231ccc428422f1b9e14e7c6ed65d1c4">gg_login</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structgg__login__params.html">gg_login_params</a> *p)
<a name="l00770"></a>00770 {
<a name="l00771"></a>00771         <span class="keyword">struct </span><a class="code" href="structgg__session.html">gg_session</a> *sess = NULL;
<a name="l00772"></a>00772         <span class="keywordtype">char</span> *hostname;
<a name="l00773"></a>00773         <span class="keywordtype">int</span> <a class="code" href="structgg__session.html#ab35f009229ac56f118173cbe0e0900ec">port</a>;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (!p) {
<a name="l00776"></a>00776                 gg_debug(<a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_login(%p);\n&quot;</span>, p);
<a name="l00777"></a>00777                 errno = EFAULT;
<a name="l00778"></a>00778                 <span class="keywordflow">return</span> NULL;
<a name="l00779"></a>00779         }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         gg_debug(<a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_login(%p: [uin=%u, async=%d, ...]);\n&quot;</span>, p, p-&gt;<a class="code" href="structgg__login__params.html#a0de481f3a7c1fdd3d4f563df8fa0468a">uin</a>, p-&gt;<a class="code" href="structgg__login__params.html#a048202385d63f811c6ffee36c3907a75">async</a>);
<a name="l00782"></a>00782 
<a name="l00783"></a>00783         <span class="keywordflow">if</span> (!(sess = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a>)))) {
<a name="l00784"></a>00784                 gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() not enough memory for session data\n&quot;</span>);
<a name="l00785"></a>00785                 <span class="keywordflow">goto</span> fail;
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788         memset(sess, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a>));
<a name="l00789"></a>00789 
<a name="l00790"></a>00790         <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structgg__login__params.html#aa6e463579e297ed18783400996b8ca99">password</a> || !p-&gt;<a class="code" href="structgg__login__params.html#a0de481f3a7c1fdd3d4f563df8fa0468a">uin</a>) {
<a name="l00791"></a>00791                 gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() invalid arguments. uin and password needed\n&quot;</span>);
<a name="l00792"></a>00792                 errno = EFAULT;
<a name="l00793"></a>00793                 <span class="keywordflow">goto</span> fail;
<a name="l00794"></a>00794         }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796         <span class="keywordflow">if</span> (!(sess-&gt;<a class="code" href="structgg__session.html#ad88a607636bef9e6da16887b5eea7a2e">password</a> = strdup(p-&gt;<a class="code" href="structgg__login__params.html#aa6e463579e297ed18783400996b8ca99">password</a>))) {
<a name="l00797"></a>00797                 gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() not enough memory for password\n&quot;</span>);
<a name="l00798"></a>00798                 <span class="keywordflow">goto</span> fail;
<a name="l00799"></a>00799         }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structgg__login__params.html#a47f2b5c174e75a639ef5c1cb0727109f">hash_type</a> &lt; 0 || p-&gt;<a class="code" href="structgg__login__params.html#a47f2b5c174e75a639ef5c1cb0727109f">hash_type</a> &gt; <a class="code" href="libgadu_8h.html#a353e3d0e4cb21619eb77cc790f86c651">GG_LOGIN_HASH_SHA1</a>) {
<a name="l00802"></a>00802                 gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() invalid arguments. unknown hash type (%d)\n&quot;</span>, p-&gt;<a class="code" href="structgg__login__params.html#a47f2b5c174e75a639ef5c1cb0727109f">hash_type</a>);
<a name="l00803"></a>00803                 errno = EFAULT;
<a name="l00804"></a>00804                 <span class="keywordflow">goto</span> fail;
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         sess-&gt;<a class="code" href="structgg__session.html#a5bc5e1eae3b57dd705f52f0b0bcc71f4">uin</a> = p-&gt;<a class="code" href="structgg__login__params.html#a0de481f3a7c1fdd3d4f563df8fa0468a">uin</a>;
<a name="l00808"></a>00808         sess-&gt;state = <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7ac06ea040b53ae994893308e0e46e108d">GG_STATE_RESOLVING</a>;
<a name="l00809"></a>00809         sess-&gt;check = <a class="code" href="libgadu_8h.html#a6eef74c7cbf152ecd7338667120701dba824c3b01b802b45ed8633950a94359c7">GG_CHECK_READ</a>;
<a name="l00810"></a>00810         sess-&gt;timeout = GG_DEFAULT_TIMEOUT;
<a name="l00811"></a>00811         sess-&gt;async = p-&gt;<a class="code" href="structgg__login__params.html#a048202385d63f811c6ffee36c3907a75">async</a>;
<a name="l00812"></a>00812         sess-&gt;type = <a class="code" href="libgadu_8h.html#a8e0ba81bce6c15f3538fde299ba640e0a1830835c553a0105f02de8e6faaa1606">GG_SESSION_GG</a>;
<a name="l00813"></a>00813         sess-&gt;<a class="code" href="structgg__session.html#a44148d0d1002f3f0207917a9ef46767c">initial_status</a> = p-&gt;<a class="code" href="structgg__login__params.html#adbee4613c68830971c15f84dc31af246">status</a>;
<a name="l00814"></a>00814         sess-&gt;callback = gg_session_callback;
<a name="l00815"></a>00815         sess-&gt;destroy = <a class="code" href="libgadu_8c.html#a5984b117ce4d0897c8e1aee69f1b6763">gg_free_session</a>;
<a name="l00816"></a>00816         sess-&gt;<a class="code" href="structgg__session.html#ab35f009229ac56f118173cbe0e0900ec">port</a> = (p-&gt;<a class="code" href="structgg__login__params.html#a793375cbce5e9aaabb82c43481c83d71">server_port</a>) ? p-&gt;<a class="code" href="structgg__login__params.html#a793375cbce5e9aaabb82c43481c83d71">server_port</a> : ((<a class="code" href="libgadu_8c.html#aac1649ba1fcd3f24f01e16c99d84e799">gg_proxy_enabled</a>) ? GG_HTTPS_PORT : GG_DEFAULT_PORT);
<a name="l00817"></a>00817         sess-&gt;<a class="code" href="structgg__session.html#a6adde00b298b693892a7a5d06bd58c52">server_addr</a> = p-&gt;<a class="code" href="structgg__login__params.html#a7e9251e25d4990c5c70ba48a1b576ec9">server_addr</a>;
<a name="l00818"></a>00818         sess-&gt;<a class="code" href="structgg__session.html#ad4d1de2ce1db5512f816776880306d99">external_port</a> = p-&gt;<a class="code" href="structgg__login__params.html#a8bd13a16ec8039a94ecc1b40931e7cd1">external_port</a>;
<a name="l00819"></a>00819         sess-&gt;<a class="code" href="structgg__session.html#a8e005e4af8f78249c57607e66c48477a">external_addr</a> = p-&gt;<a class="code" href="structgg__login__params.html#ab335edec1589c43cee2bc496a9013715">external_addr</a>;
<a name="l00820"></a>00820         sess-&gt;<a class="code" href="structgg__session.html#abe030d5b648a6baeaae5cedc868878ef">client_addr</a> = p-&gt;<a class="code" href="structgg__login__params.html#a8737c6cb27d8e6d0b5f5d231baf3c99e">client_addr</a>;
<a name="l00821"></a>00821         sess-&gt;<a class="code" href="structgg__session.html#a7f24ed69795d48277d62bddfe608c677">client_port</a> = p-&gt;<a class="code" href="structgg__login__params.html#a8b2fdcdd1e02cd55a4eeff63043dbaad">client_port</a>;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structgg__login__params.html#ae07f059102d9429c640b111147ea5f46">protocol_features</a> == 0) {
<a name="l00824"></a>00824                 sess-&gt;<a class="code" href="structgg__session.html#a35ec57b443e5f460bf723751873150b6">protocol_features</a> = GG_FEATURE_MSG80 | GG_FEATURE_STATUS80 | GG_FEATURE_DND_FFC | GG_FEATURE_IMAGE_DESCR | GG_FEATURE_UNKNOWN_100 | GG_FEATURE_USER_DATA | GG_FEATURE_MSG_ACK | GG_FEATURE_TYPING_NOTIFICATION;
<a name="l00825"></a>00825         } <span class="keywordflow">else</span> {
<a name="l00826"></a>00826                 sess-&gt;<a class="code" href="structgg__session.html#a35ec57b443e5f460bf723751873150b6">protocol_features</a> = (p-&gt;<a class="code" href="structgg__login__params.html#ae07f059102d9429c640b111147ea5f46">protocol_features</a> &amp; ~(GG_FEATURE_STATUS77 | GG_FEATURE_MSG77));
<a name="l00827"></a>00827 
<a name="l00828"></a>00828                 <span class="keywordflow">if</span> (!(p-&gt;<a class="code" href="structgg__login__params.html#ae07f059102d9429c640b111147ea5f46">protocol_features</a> &amp; GG_FEATURE_STATUS77))
<a name="l00829"></a>00829                         sess-&gt;<a class="code" href="structgg__session.html#a35ec57b443e5f460bf723751873150b6">protocol_features</a> |= GG_FEATURE_STATUS80;
<a name="l00830"></a>00830 
<a name="l00831"></a>00831                 if (!(p-&gt;<a class="code" href="structgg__login__params.html#ae07f059102d9429c640b111147ea5f46">protocol_features</a> &amp; GG_FEATURE_MSG77))
<a name="l00832"></a>00832                         sess-&gt;<a class="code" href="structgg__session.html#a35ec57b443e5f460bf723751873150b6">protocol_features</a> |= GG_FEATURE_MSG80;
<a name="l00833"></a>00833         }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835         <span class="keywordflow">if</span> (!(sess-&gt;<a class="code" href="structgg__session.html#a5fcbb379fd707c43309dd260395ec2cc">status_flags</a> = p-&gt;<a class="code" href="structgg__login__params.html#afa76b76ed54c44974801872c2e546473">status_flags</a>))
<a name="l00836"></a>00836                 sess-&gt;<a class="code" href="structgg__session.html#a5fcbb379fd707c43309dd260395ec2cc">status_flags</a> = GG_STATUS_FLAG_UNKNOWN | GG_STATUS_FLAG_SPAM;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838         sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> = (p-&gt;<a class="code" href="structgg__login__params.html#a16a7672ea91aa259634dd761a734e12f">protocol_version</a>) ? p-&gt;<a class="code" href="structgg__login__params.html#a16a7672ea91aa259634dd761a734e12f">protocol_version</a> : GG_DEFAULT_PROTOCOL_VERSION;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structgg__login__params.html#a8b9153f415b45d858a34b2442f24523e">era_omnix</a>)
<a name="l00841"></a>00841                 sess-&gt;<a class="code" href="structgg__session.html#a1c719ba2e76f0da4a1e1becbed5c891c">protocol_flags</a> |= GG_ERA_OMNIX_MASK;
<a name="l00842"></a>00842         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structgg__login__params.html#a7549c357fdf8cd81db1ee3f7e0477ada">has_audio</a>)
<a name="l00843"></a>00843                 sess-&gt;<a class="code" href="structgg__session.html#a1c719ba2e76f0da4a1e1becbed5c891c">protocol_flags</a> |= GG_HAS_AUDIO_MASK;
<a name="l00844"></a>00844         sess-&gt;<a class="code" href="structgg__session.html#a66b1d7621f6a8c3a6dae0952a44ce605">client_version</a> = (p-&gt;<a class="code" href="structgg__login__params.html#ac57d7ff7b82652a0637cb84e389f441f">client_version</a>) ? strdup(p-&gt;<a class="code" href="structgg__login__params.html#ac57d7ff7b82652a0637cb84e389f441f">client_version</a>) : NULL;
<a name="l00845"></a>00845         sess-&gt;<a class="code" href="structgg__session.html#afc70fa822d02cb063284fa15d3338d0d">last_sysmsg</a> = p-&gt;<a class="code" href="structgg__login__params.html#a2a33b226481c6563124baa398b6ae4dc">last_sysmsg</a>;
<a name="l00846"></a>00846         sess-&gt;<a class="code" href="structgg__session.html#ab4defbef949ce5167f28394cf7fbaa86">image_size</a> = p-&gt;<a class="code" href="structgg__login__params.html#a6dd2a830039b4b4002fd585013ba0cdf">image_size</a>;
<a name="l00847"></a>00847         sess-&gt;<a class="code" href="structgg__session.html#a82743f3498749123d8fafcc04721b109">pid</a> = -1;
<a name="l00848"></a>00848         sess-&gt;<a class="code" href="structgg__session.html#ac510ffbf7c1e5735490850cd80263215">encoding</a> = p-&gt;<a class="code" href="structgg__login__params.html#abd6a58a051be636a2ed4187fcd6fba75">encoding</a>;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850         <span class="keywordflow">if</span> (<a class="code" href="libgadu_8h.html#aace0683350d5568a28fa42d5e52d86eb">gg_session_set_resolver</a>(sess, p-&gt;<a class="code" href="structgg__login__params.html#a0a0a0bb92753c1d6c3356cec266c3685">resolver</a>) == -1) {
<a name="l00851"></a>00851                 gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() invalid arguments. unsupported resolver type (%d)\n&quot;</span>, p-&gt;<a class="code" href="structgg__login__params.html#a0a0a0bb92753c1d6c3356cec266c3685">resolver</a>);
<a name="l00852"></a>00852                 errno = EFAULT;
<a name="l00853"></a>00853                 <span class="keywordflow">goto</span> fail;
<a name="l00854"></a>00854         }
<a name="l00855"></a>00855 
<a name="l00856"></a>00856         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structgg__login__params.html#a0803c73326b4097c9197833532a82e75">status_descr</a>) {
<a name="l00857"></a>00857                 <span class="keywordtype">int</span> max_length;
<a name="l00858"></a>00858 
<a name="l00859"></a>00859                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &gt;= 0x2d)
<a name="l00860"></a>00860                         max_length = <a class="code" href="libgadu_8h.html#a79d95cdaefbbda3ccfad58c7862373b4">GG_STATUS_DESCR_MAXSIZE</a>;
<a name="l00861"></a>00861                 <span class="keywordflow">else</span>
<a name="l00862"></a>00862                         max_length = GG_STATUS_DESCR_MAXSIZE_PRE_8_0;
<a name="l00863"></a>00863 
<a name="l00864"></a>00864                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &gt;= 0x2d)
<a name="l00865"></a>00865                         sess-&gt;<a class="code" href="structgg__session.html#a2cecec4eccf9ccdaaa91cc9d32547d10">initial_descr</a> = gg_encoding_convert(p-&gt;<a class="code" href="structgg__login__params.html#a0803c73326b4097c9197833532a82e75">status_descr</a>, p-&gt;<a class="code" href="structgg__login__params.html#abd6a58a051be636a2ed4187fcd6fba75">encoding</a>, <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498add132d17c370e55d0f421b7867ce0d40">GG_ENCODING_UTF8</a>, -1, -1);
<a name="l00866"></a>00866                 <span class="keywordflow">else</span>
<a name="l00867"></a>00867                         sess-&gt;<a class="code" href="structgg__session.html#a2cecec4eccf9ccdaaa91cc9d32547d10">initial_descr</a> = strdup(p-&gt;<a class="code" href="structgg__login__params.html#a0803c73326b4097c9197833532a82e75">status_descr</a>);
<a name="l00868"></a>00868 
<a name="l00869"></a>00869                 <span class="keywordflow">if</span> (!sess-&gt;<a class="code" href="structgg__session.html#a2cecec4eccf9ccdaaa91cc9d32547d10">initial_descr</a>) {
<a name="l00870"></a>00870                         gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() not enough memory for status\n&quot;</span>);
<a name="l00871"></a>00871                         <span class="keywordflow">goto</span> fail;
<a name="l00872"></a>00872                 }
<a name="l00873"></a>00873                 
<a name="l00874"></a>00874                 <span class="comment">// XXX pamiętać, żeby nie ciąć w środku znaku utf-8</span>
<a name="l00875"></a>00875                 
<a name="l00876"></a>00876                 <span class="keywordflow">if</span> (strlen(sess-&gt;<a class="code" href="structgg__session.html#a2cecec4eccf9ccdaaa91cc9d32547d10">initial_descr</a>) &gt; max_length)
<a name="l00877"></a>00877                         sess-&gt;<a class="code" href="structgg__session.html#a2cecec4eccf9ccdaaa91cc9d32547d10">initial_descr</a>[max_length] = 0;
<a name="l00878"></a>00878         }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structgg__login__params.html#aeef87e081d518183321936bb605c0dd0">tls</a> != <a class="code" href="libgadu_8h.html#af5331c4041f0322580d80922d59d0594afa4abee9df67b022a6eb09797d860595">GG_SSL_DISABLED</a>) {
<a name="l00881"></a>00881 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_GNUTLS</span>
<a name="l00882"></a>00882 <span class="preprocessor"></span>                gg_session_gnutls_t *tmp;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884                 tmp = malloc(<span class="keyword">sizeof</span>(gg_session_gnutls_t));
<a name="l00885"></a>00885 
<a name="l00886"></a>00886                 <span class="keywordflow">if</span> (tmp == NULL) {
<a name="l00887"></a>00887                         gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() out of memory for GnuTLS session\n&quot;</span>);
<a name="l00888"></a>00888                         <span class="keywordflow">goto</span> fail;
<a name="l00889"></a>00889                 }
<a name="l00890"></a>00890 
<a name="l00891"></a>00891                 sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> = tmp;
<a name="l00892"></a>00892 
<a name="l00893"></a>00893                 gnutls_global_init();
<a name="l00894"></a>00894                 gnutls_certificate_allocate_credentials(&amp;tmp-&gt;xcred);
<a name="l00895"></a>00895                 gnutls_init(&amp;tmp-&gt;session, GNUTLS_CLIENT);
<a name="l00896"></a>00896                 gnutls_set_default_priority(tmp-&gt;session);
<a name="l00897"></a>00897                 gnutls_credentials_set(tmp-&gt;session, GNUTLS_CRD_CERTIFICATE, tmp-&gt;xcred);
<a name="l00898"></a>00898 <span class="preprocessor">#elif defined(GG_CONFIG_HAVE_OPENSSL)</span>
<a name="l00899"></a>00899 <span class="preprocessor"></span>                <span class="keywordtype">char</span> buf[1024];
<a name="l00900"></a>00900 
<a name="l00901"></a>00901                 OpenSSL_add_ssl_algorithms();
<a name="l00902"></a>00902 
<a name="l00903"></a>00903                 <span class="keywordflow">if</span> (!RAND_status()) {
<a name="l00904"></a>00904                         <span class="keywordtype">char</span> rdata[1024];
<a name="l00905"></a>00905                         <span class="keyword">struct </span>{
<a name="l00906"></a>00906                                 time_t time;
<a name="l00907"></a>00907                                 <span class="keywordtype">void</span> *ptr;
<a name="l00908"></a>00908                         } rstruct;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910                         time(&amp;rstruct.time);
<a name="l00911"></a>00911                         rstruct.ptr = (<span class="keywordtype">void</span> *) &amp;rstruct;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913                         RAND_seed((<span class="keywordtype">void</span> *) rdata, <span class="keyword">sizeof</span>(rdata));
<a name="l00914"></a>00914                         RAND_seed((<span class="keywordtype">void</span> *) &amp;rstruct, <span class="keyword">sizeof</span>(rstruct));
<a name="l00915"></a>00915                 }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917                 sess-&gt;<a class="code" href="structgg__session.html#a35f1293106e880aca95ded2b77f201e1">ssl_ctx</a> = SSL_CTX_new(SSLv3_client_method());
<a name="l00918"></a>00918 
<a name="l00919"></a>00919                 <span class="keywordflow">if</span> (!sess-&gt;<a class="code" href="structgg__session.html#a35f1293106e880aca95ded2b77f201e1">ssl_ctx</a>) {
<a name="l00920"></a>00920                         ERR_error_string_n(ERR_get_error(), buf, <span class="keyword">sizeof</span>(buf));
<a name="l00921"></a>00921                         gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() SSL_CTX_new() failed: %s\n&quot;</span>, buf);
<a name="l00922"></a>00922                         <span class="keywordflow">goto</span> fail;
<a name="l00923"></a>00923                 }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925                 SSL_CTX_set_verify(sess-&gt;<a class="code" href="structgg__session.html#a35f1293106e880aca95ded2b77f201e1">ssl_ctx</a>, SSL_VERIFY_NONE, NULL);
<a name="l00926"></a>00926 
<a name="l00927"></a>00927                 sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> = SSL_new(sess-&gt;<a class="code" href="structgg__session.html#a35f1293106e880aca95ded2b77f201e1">ssl_ctx</a>);
<a name="l00928"></a>00928 
<a name="l00929"></a>00929                 <span class="keywordflow">if</span> (!sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>) {
<a name="l00930"></a>00930                         ERR_error_string_n(ERR_get_error(), buf, <span class="keyword">sizeof</span>(buf));
<a name="l00931"></a>00931                         gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() SSL_new() failed: %s\n&quot;</span>, buf);
<a name="l00932"></a>00932                         <span class="keywordflow">goto</span> fail;
<a name="l00933"></a>00933                 }
<a name="l00934"></a>00934 <span class="preprocessor">#else</span>
<a name="l00935"></a>00935 <span class="preprocessor"></span>                gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() client requested TLS but no support compiled in\n&quot;</span>);
<a name="l00936"></a>00936 
<a name="l00937"></a>00937                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structgg__login__params.html#aeef87e081d518183321936bb605c0dd0">tls</a> == <a class="code" href="libgadu_8h.html#af5331c4041f0322580d80922d59d0594afd30c226066c2f6c92660fd732dace8f">GG_SSL_REQUIRED</a>) {
<a name="l00938"></a>00938                         errno = ENOSYS;
<a name="l00939"></a>00939                         <span class="keywordflow">goto</span> fail;
<a name="l00940"></a>00940                 }
<a name="l00941"></a>00941 <span class="preprocessor">#endif</span>
<a name="l00942"></a>00942 <span class="preprocessor"></span>        }
<a name="l00943"></a>00943 
<a name="l00944"></a>00944         <span class="keywordflow">if</span> (<a class="code" href="libgadu_8c.html#aac1649ba1fcd3f24f01e16c99d84e799">gg_proxy_enabled</a>) {
<a name="l00945"></a>00945                 hostname = <a class="code" href="libgadu_8c.html#ab1bcfc3ddfef79b410ebd69320ec5398">gg_proxy_host</a>;
<a name="l00946"></a>00946                 sess-&gt;<a class="code" href="structgg__session.html#a9257a3255cea8f2aa8110bfa7c944335">proxy_port</a> = port = <a class="code" href="libgadu_8c.html#a7e6921ea3b93f9ce494ea280c8d8b541">gg_proxy_port</a>;
<a name="l00947"></a>00947         } <span class="keywordflow">else</span> {
<a name="l00948"></a>00948                 hostname = GG_APPMSG_HOST;
<a name="l00949"></a>00949                 port = GG_APPMSG_PORT;
<a name="l00950"></a>00950         }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structgg__login__params.html#a47f2b5c174e75a639ef5c1cb0727109f">hash_type</a>)
<a name="l00953"></a>00953                 sess-&gt;<a class="code" href="structgg__session.html#a782d09449f35e15f7da9cc2c1155fac5">hash_type</a> = p-&gt;<a class="code" href="structgg__login__params.html#a47f2b5c174e75a639ef5c1cb0727109f">hash_type</a>;
<a name="l00954"></a>00954         <span class="keywordflow">else</span>
<a name="l00955"></a>00955                 sess-&gt;<a class="code" href="structgg__session.html#a782d09449f35e15f7da9cc2c1155fac5">hash_type</a> = <a class="code" href="libgadu_8h.html#a353e3d0e4cb21619eb77cc790f86c651">GG_LOGIN_HASH_SHA1</a>;
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structgg__login__params.html#a048202385d63f811c6ffee36c3907a75">async</a>) {
<a name="l00958"></a>00958                 <span class="keyword">struct </span>in_addr addr;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960                 <span class="keywordflow">if</span> (!sess-&gt;<a class="code" href="structgg__session.html#a6adde00b298b693892a7a5d06bd58c52">server_addr</a>) {
<a name="l00961"></a>00961                         <span class="keywordflow">if</span> ((addr.s_addr = inet_addr(hostname)) == INADDR_NONE) {
<a name="l00962"></a>00962                                 <span class="keyword">struct </span>in_addr *addr_list = NULL;
<a name="l00963"></a>00963                                 <span class="keywordtype">int</span> addr_count;
<a name="l00964"></a>00964 
<a name="l00965"></a>00965                                 <span class="keywordflow">if</span> (gg_gethostbyname_real(hostname, &amp;addr_list, &amp;addr_count, 0) == -1 || addr_count == 0) {
<a name="l00966"></a>00966                                         gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() host \&quot;%s\&quot; not found\n&quot;</span>, hostname);
<a name="l00967"></a>00967                                         free(addr_list);
<a name="l00968"></a>00968                                         <span class="keywordflow">goto</span> fail;
<a name="l00969"></a>00969                                 }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971                                 addr = addr_list[0];
<a name="l00972"></a>00972 
<a name="l00973"></a>00973                                 free(addr_list);
<a name="l00974"></a>00974                         }
<a name="l00975"></a>00975                 } <span class="keywordflow">else</span> {
<a name="l00976"></a>00976                         addr.s_addr = sess-&gt;<a class="code" href="structgg__session.html#a6adde00b298b693892a7a5d06bd58c52">server_addr</a>;
<a name="l00977"></a>00977                         port = sess-&gt;<a class="code" href="structgg__session.html#ab35f009229ac56f118173cbe0e0900ec">port</a>;
<a name="l00978"></a>00978                 }
<a name="l00979"></a>00979 
<a name="l00980"></a>00980                 sess-&gt;<a class="code" href="structgg__session.html#a11b539190cd3eeb17336f73f92324bbd">hub_addr</a> = addr.s_addr;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982                 <span class="keywordflow">if</span> (<a class="code" href="libgadu_8c.html#aac1649ba1fcd3f24f01e16c99d84e799">gg_proxy_enabled</a>)
<a name="l00983"></a>00983                         sess-&gt;<a class="code" href="structgg__session.html#a68030e7b24a4ab8898f6301d841d4e5a">proxy_addr</a> = addr.s_addr;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985                 <span class="keywordflow">if</span> ((sess-&gt;fd = gg_connect(&amp;addr, port, 0)) == -1) {
<a name="l00986"></a>00986                         gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() connection failed (errno=%d, %s)\n&quot;</span>, errno, strerror(errno));
<a name="l00987"></a>00987 
<a name="l00988"></a>00988                         <span class="comment">/* nie wyszło? próbujemy portu 443. */</span>
<a name="l00989"></a>00989                         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6adde00b298b693892a7a5d06bd58c52">server_addr</a>) {
<a name="l00990"></a>00990                                 sess-&gt;<a class="code" href="structgg__session.html#ab35f009229ac56f118173cbe0e0900ec">port</a> = GG_HTTPS_PORT;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992                                 <span class="keywordflow">if</span> ((sess-&gt;fd = gg_connect(&amp;addr, GG_HTTPS_PORT, 0)) == -1) {
<a name="l00993"></a>00993                                         <span class="comment">/* ostatnia deska ratunku zawiodła?</span>
<a name="l00994"></a>00994 <span class="comment">                                         * w takim razie zwijamy manatki. */</span>
<a name="l00995"></a>00995                                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() connection failed (errno=%d, %s)\n&quot;</span>, errno, strerror(errno));
<a name="l00996"></a>00996                                         <span class="keywordflow">goto</span> fail;
<a name="l00997"></a>00997                                 }
<a name="l00998"></a>00998                         } <span class="keywordflow">else</span> {
<a name="l00999"></a>00999                                 <span class="keywordflow">goto</span> fail;
<a name="l01000"></a>01000                         }
<a name="l01001"></a>01001                 }
<a name="l01002"></a>01002 
<a name="l01003"></a>01003                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6adde00b298b693892a7a5d06bd58c52">server_addr</a>)
<a name="l01004"></a>01004                         sess-&gt;state = <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7adf5095b9196e86e9cdcb7cba3076196e">GG_STATE_CONNECTING_GG</a>;
<a name="l01005"></a>01005                 <span class="keywordflow">else</span>
<a name="l01006"></a>01006                         sess-&gt;state = <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7adbd412430dbecf5b015ff9540c8b20c9">GG_STATE_CONNECTING_HUB</a>;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008                 <span class="keywordflow">while</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01009"></a>01009                         <span class="keyword">struct </span><a class="code" href="structgg__event.html">gg_event</a> *e;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011                         <span class="keywordflow">if</span> (!(e = <a class="code" href="events_8c.html#ae28360891a3b393d606fb455564e3b3a">gg_watch_fd</a>(sess))) {
<a name="l01012"></a>01012                                 gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() critical error in gg_watch_fd()\n&quot;</span>);
<a name="l01013"></a>01013                                 <span class="keywordflow">goto</span> fail;
<a name="l01014"></a>01014                         }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016                         <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structgg__event.html#aa48d2c8dea332bbeca34b60c6f7ecc6e">type</a> == <a class="code" href="libgadu_8h.html#a3dd02c0d2ff1d304d134f677faf66cfca3f923107546c95bce0bf662d721706c7" title="Nie udało się połączyć">GG_EVENT_CONN_FAILED</a>) {
<a name="l01017"></a>01017                                 errno = EACCES;
<a name="l01018"></a>01018                                 gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() could not login\n&quot;</span>);
<a name="l01019"></a>01019                                 <a class="code" href="events_8c.html#a1845d4710eede4aaef1c52c4111fbda1">gg_event_free</a>(e);
<a name="l01020"></a>01020                                 <span class="keywordflow">goto</span> fail;
<a name="l01021"></a>01021                         }
<a name="l01022"></a>01022 
<a name="l01023"></a>01023                         <a class="code" href="events_8c.html#a1845d4710eede4aaef1c52c4111fbda1">gg_event_free</a>(e);
<a name="l01024"></a>01024                 }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026                 <span class="keywordflow">return</span> sess;
<a name="l01027"></a>01027         }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <span class="keywordflow">if</span> (!sess-&gt;<a class="code" href="structgg__session.html#a6adde00b298b693892a7a5d06bd58c52">server_addr</a> || <a class="code" href="libgadu_8c.html#aac1649ba1fcd3f24f01e16c99d84e799">gg_proxy_enabled</a>) {
<a name="l01030"></a>01030                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a8fcdc59df8de49ee0aa44303b2838494">resolver_start</a>(&amp;sess-&gt;fd, &amp;sess-&gt;<a class="code" href="structgg__session.html#ac18f26d498f7d46754971d842e12b74e">resolver</a>, hostname) == -1) {
<a name="l01031"></a>01031                         gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() resolving failed (errno=%d, %s)\n&quot;</span>, errno, strerror(errno));
<a name="l01032"></a>01032                         <span class="keywordflow">goto</span> fail;
<a name="l01033"></a>01033                 }
<a name="l01034"></a>01034         } <span class="keywordflow">else</span> {
<a name="l01035"></a>01035                 <span class="keywordflow">if</span> ((sess-&gt;fd = gg_connect(&amp;sess-&gt;<a class="code" href="structgg__session.html#a6adde00b298b693892a7a5d06bd58c52">server_addr</a>, sess-&gt;<a class="code" href="structgg__session.html#ab35f009229ac56f118173cbe0e0900ec">port</a>, sess-&gt;async)) == -1) {
<a name="l01036"></a>01036                         gg_debug(<a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_login() direct connection failed (errno=%d, %s)\n&quot;</span>, errno, strerror(errno));
<a name="l01037"></a>01037                         <span class="keywordflow">goto</span> fail;
<a name="l01038"></a>01038                 }
<a name="l01039"></a>01039                 sess-&gt;state = <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7adf5095b9196e86e9cdcb7cba3076196e">GG_STATE_CONNECTING_GG</a>;
<a name="l01040"></a>01040                 sess-&gt;check = <a class="code" href="libgadu_8h.html#a6eef74c7cbf152ecd7338667120701dba627a193d0827e0ba9e13883c21d31217">GG_CHECK_WRITE</a>;
<a name="l01041"></a>01041                 sess-&gt;<a class="code" href="structgg__session.html#a87bed420157fae056b74e09a50452622">soft_timeout</a> = 1;
<a name="l01042"></a>01042         }
<a name="l01043"></a>01043 
<a name="l01044"></a>01044         <span class="keywordflow">return</span> sess;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046 fail:
<a name="l01047"></a>01047         <span class="keywordflow">if</span> (sess) {
<a name="l01048"></a>01048                 free(sess-&gt;<a class="code" href="structgg__session.html#ad88a607636bef9e6da16887b5eea7a2e">password</a>);
<a name="l01049"></a>01049                 free(sess-&gt;<a class="code" href="structgg__session.html#a2cecec4eccf9ccdaaa91cc9d32547d10">initial_descr</a>);
<a name="l01050"></a>01050                 free(sess);
<a name="l01051"></a>01051         }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053         <span class="keywordflow">return</span> NULL;
<a name="l01054"></a>01054 }
<a name="l01055"></a>01055 
<a name="l01069"></a><a class="code" href="libgadu_8h.html#acf05d07e2495672e0384317293c5a342">01069</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#acf05d07e2495672e0384317293c5a342">gg_ping</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess)
<a name="l01070"></a>01070 {
<a name="l01071"></a>01071         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_ping(%p);\n&quot;</span>, sess);
<a name="l01072"></a>01072 
<a name="l01073"></a>01073         <span class="keywordflow">if</span> (!sess) {
<a name="l01074"></a>01074                 errno = EFAULT;
<a name="l01075"></a>01075                 <span class="keywordflow">return</span> -1;
<a name="l01076"></a>01076         }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01079"></a>01079                 errno = ENOTCONN;
<a name="l01080"></a>01080                 <span class="keywordflow">return</span> -1;
<a name="l01081"></a>01081         }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083         <span class="keywordflow">return</span> gg_send_packet(sess, GG_PING, NULL);
<a name="l01084"></a>01084 }
<a name="l01085"></a>01085 
<a name="l01105"></a><a class="code" href="libgadu_8h.html#a415c0e5527711d9ddb2be6c7f5eff9fc">01105</a> <span class="keywordtype">void</span> <a class="code" href="libgadu_8c.html#a415c0e5527711d9ddb2be6c7f5eff9fc">gg_logoff</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess)
<a name="l01106"></a>01106 {
<a name="l01107"></a>01107         <span class="keywordflow">if</span> (!sess)
<a name="l01108"></a>01108                 <span class="keywordflow">return</span>;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_logoff(%p);\n&quot;</span>, sess);
<a name="l01111"></a>01111 
<a name="l01112"></a>01112 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_GNUTLS</span>
<a name="l01113"></a>01113 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> != NULL)
<a name="l01114"></a>01114                 gnutls_bye(GG_SESSION_GNUTLS(sess), GNUTLS_SHUT_RDWR);
<a name="l01115"></a>01115 <span class="preprocessor">#endif</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span>
<a name="l01117"></a>01117 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_OPENSSL</span>
<a name="l01118"></a>01118 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> != NULL)
<a name="l01119"></a>01119                 SSL_shutdown(sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>);
<a name="l01120"></a>01120 <span class="preprocessor">#endif</span>
<a name="l01121"></a>01121 <span class="preprocessor"></span>
<a name="l01122"></a>01122         sess-&gt;<a class="code" href="structgg__session.html#a3f5d51c09ea880a937fa7699f842fc1f">resolver_cleanup</a>(&amp;sess-&gt;<a class="code" href="structgg__session.html#ac18f26d498f7d46754971d842e12b74e">resolver</a>, 1);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124         <span class="keywordflow">if</span> (sess-&gt;fd != -1) {
<a name="l01125"></a>01125                 shutdown(sess-&gt;fd, SHUT_RDWR);
<a name="l01126"></a>01126                 close(sess-&gt;fd);
<a name="l01127"></a>01127                 sess-&gt;fd = -1;
<a name="l01128"></a>01128         }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_GNUTLS</span>
<a name="l01131"></a>01131 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a> != NULL) {
<a name="l01132"></a>01132                 gg_session_gnutls_t *tmp;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134                 tmp = (gg_session_gnutls_t*) sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>;
<a name="l01135"></a>01135                 gnutls_deinit(tmp-&gt;session);
<a name="l01136"></a>01136                 gnutls_certificate_free_credentials(tmp-&gt;xcred);
<a name="l01137"></a>01137                 gnutls_global_deinit();
<a name="l01138"></a>01138                 free(sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>);
<a name="l01139"></a>01139         }
<a name="l01140"></a>01140 <span class="preprocessor">#endif</span>
<a name="l01141"></a>01141 <span class="preprocessor"></span>
<a name="l01142"></a>01142         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a>) {
<a name="l01143"></a>01143                 free(sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a>);
<a name="l01144"></a>01144                 sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a> = NULL;
<a name="l01145"></a>01145                 sess-&gt;<a class="code" href="structgg__session.html#a2d287ecd0fab8dca69a25ed90c2c02a3">send_left</a> = 0;
<a name="l01146"></a>01146         }
<a name="l01147"></a>01147 }
<a name="l01148"></a>01148 
<a name="l01158"></a><a class="code" href="libgadu_8h.html#a5984b117ce4d0897c8e1aee69f1b6763">01158</a> <span class="keywordtype">void</span> <a class="code" href="libgadu_8c.html#a5984b117ce4d0897c8e1aee69f1b6763">gg_free_session</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess)
<a name="l01159"></a>01159 {
<a name="l01160"></a>01160         <span class="keyword">struct </span><a class="code" href="structgg__dcc7.html">gg_dcc7</a> *dcc;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162         <span class="keywordflow">if</span> (!sess)
<a name="l01163"></a>01163                 <span class="keywordflow">return</span>;
<a name="l01164"></a>01164 
<a name="l01165"></a>01165         <span class="comment">/* XXX dopisać zwalnianie i zamykanie wszystkiego, co mogło zostać */</span>
<a name="l01166"></a>01166 
<a name="l01167"></a>01167         free(sess-&gt;<a class="code" href="structgg__session.html#ad88a607636bef9e6da16887b5eea7a2e">password</a>);
<a name="l01168"></a>01168         free(sess-&gt;<a class="code" href="structgg__session.html#a2cecec4eccf9ccdaaa91cc9d32547d10">initial_descr</a>);
<a name="l01169"></a>01169         free(sess-&gt;<a class="code" href="structgg__session.html#a66b1d7621f6a8c3a6dae0952a44ce605">client_version</a>);
<a name="l01170"></a>01170         free(sess-&gt;<a class="code" href="structgg__session.html#a11593d25043e3cba732329329060e5fa">recv_buf</a>);
<a name="l01171"></a>01171         free(sess-&gt;<a class="code" href="structgg__session.html#a61f431ba941e974ae60160fe6112ef6d">header_buf</a>);
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_OPENSSL</span>
<a name="l01174"></a>01174 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>)
<a name="l01175"></a>01175                 SSL_free(sess-&gt;<a class="code" href="structgg__session.html#a5ce77fa424868386ba4038996a321901">ssl</a>);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a35f1293106e880aca95ded2b77f201e1">ssl_ctx</a>)
<a name="l01178"></a>01178                 SSL_CTX_free(sess-&gt;<a class="code" href="structgg__session.html#a35f1293106e880aca95ded2b77f201e1">ssl_ctx</a>);
<a name="l01179"></a>01179 <span class="preprocessor">#endif</span>
<a name="l01180"></a>01180 <span class="preprocessor"></span>
<a name="l01181"></a>01181         sess-&gt;<a class="code" href="structgg__session.html#a3f5d51c09ea880a937fa7699f842fc1f">resolver_cleanup</a>(&amp;sess-&gt;<a class="code" href="structgg__session.html#ac18f26d498f7d46754971d842e12b74e">resolver</a>, 1);
<a name="l01182"></a>01182 
<a name="l01183"></a>01183         <span class="keywordflow">if</span> (sess-&gt;fd != -1)
<a name="l01184"></a>01184                 close(sess-&gt;fd);
<a name="l01185"></a>01185 
<a name="l01186"></a>01186         <span class="keywordflow">while</span> (sess-&gt;<a class="code" href="structgg__session.html#a1b75db0653256658842702073c2b5a1d">images</a>)
<a name="l01187"></a>01187                 gg_image_queue_remove(sess, sess-&gt;<a class="code" href="structgg__session.html#a1b75db0653256658842702073c2b5a1d">images</a>, 1);
<a name="l01188"></a>01188 
<a name="l01189"></a>01189         free(sess-&gt;<a class="code" href="structgg__session.html#ab118a4de5dc2358bd4b6ef1adc6478ba">send_buf</a>);
<a name="l01190"></a>01190 
<a name="l01191"></a>01191         <span class="keywordflow">for</span> (dcc = sess-&gt;<a class="code" href="structgg__session.html#a5eb9dc40f684a753897dccd9b0e851ab">dcc7_list</a>; dcc; dcc = dcc-&gt;<a class="code" href="structgg__dcc7.html#ac9f16d597c38fc6bf6e3ec61a4efee6f">next</a>)
<a name="l01192"></a>01192                 dcc-&gt;<a class="code" href="structgg__dcc7.html#a94249ea92829956b831a49601f58a153">sess</a> = NULL;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194         free(sess);
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 <span class="preprocessor">#ifndef DOXYGEN</span>
<a name="l01198"></a>01198 <span class="preprocessor"></span>
<a name="l01211"></a>01211 <span class="keyword">static</span> <span class="keywordtype">int</span> gg_change_status_common(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> status, <span class="keyword">const</span> <span class="keywordtype">char</span> *descr, <span class="keywordtype">int</span> time)
<a name="l01212"></a>01212 {
<a name="l01213"></a>01213         <span class="keywordtype">char</span> *new_descr = NULL;
<a name="l01214"></a>01214         uint32_t new_time;
<a name="l01215"></a>01215         <span class="keywordtype">int</span> descr_len = 0;
<a name="l01216"></a>01216         <span class="keywordtype">int</span> descr_len_max;
<a name="l01217"></a>01217         <span class="keywordtype">int</span> packet_type;
<a name="l01218"></a>01218         <span class="keywordtype">int</span> append_null = 0;
<a name="l01219"></a>01219         <span class="keywordtype">int</span> res;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221         <span class="keywordflow">if</span> (!sess) {
<a name="l01222"></a>01222                 errno = EFAULT;
<a name="l01223"></a>01223                 <span class="keywordflow">return</span> -1;
<a name="l01224"></a>01224         }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01227"></a>01227                 errno = ENOTCONN;
<a name="l01228"></a>01228                 <span class="keywordflow">return</span> -1;
<a name="l01229"></a>01229         }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231         <span class="comment">/* XXX, obcinać stany których stary protokół niezna (czyt. dnd-&gt;aw; ffc-&gt;av) */</span>
<a name="l01232"></a>01232 
<a name="l01233"></a>01233         <span class="comment">/* dodaj flagę obsługi połączeń głosowych zgodną z GG 7.x */</span>
<a name="l01234"></a>01234         <span class="keywordflow">if</span> ((sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &gt;= 0x2a) &amp;&amp; (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &lt; 0x2d <span class="comment">/* ? */</span> ) &amp;&amp; (sess-&gt;<a class="code" href="structgg__session.html#a1c719ba2e76f0da4a1e1becbed5c891c">protocol_flags</a> &amp; GG_HAS_AUDIO_MASK) &amp;&amp; !GG_S_I(status))
<a name="l01235"></a>01235                 status |= <a class="code" href="libgadu_8h.html#afd99f3af6281b03af00a09bbbd5d9a90">GG_STATUS_VOICE_MASK</a>;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237         sess-&gt;<a class="code" href="structgg__session.html#a87f2e913433fb4eda113f498b921acb2">status</a> = status;
<a name="l01238"></a>01238 
<a name="l01239"></a>01239         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &gt;= 0x2d) {
<a name="l01240"></a>01240                 <span class="keywordflow">if</span> (descr != NULL &amp;&amp; sess-&gt;<a class="code" href="structgg__session.html#ac510ffbf7c1e5735490850cd80263215">encoding</a> != <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498add132d17c370e55d0f421b7867ce0d40">GG_ENCODING_UTF8</a>) {
<a name="l01241"></a>01241                         new_descr = gg_encoding_convert(descr, <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498a923b0b07c392fc993f9627b5df43397c">GG_ENCODING_CP1250</a>, <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498add132d17c370e55d0f421b7867ce0d40">GG_ENCODING_UTF8</a>, -1, -1);
<a name="l01242"></a>01242 
<a name="l01243"></a>01243                         <span class="keywordflow">if</span> (!new_descr)
<a name="l01244"></a>01244                                 <span class="keywordflow">return</span> -1;
<a name="l01245"></a>01245                 }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &gt;= 0x2e)
<a name="l01248"></a>01248                         packet_type = GG_NEW_STATUS80;
<a name="l01249"></a>01249                 <span class="keywordflow">else</span> <span class="comment">/* sess-&gt;protocol_version == 0x2d */</span>
<a name="l01250"></a>01250                         packet_type = GG_NEW_STATUS80BETA;
<a name="l01251"></a>01251                 descr_len_max = <a class="code" href="libgadu_8h.html#a79d95cdaefbbda3ccfad58c7862373b4">GG_STATUS_DESCR_MAXSIZE</a>;
<a name="l01252"></a>01252                 append_null = 1;
<a name="l01253"></a>01253 
<a name="l01254"></a>01254         } <span class="keywordflow">else</span> {
<a name="l01255"></a>01255                 packet_type = GG_NEW_STATUS;
<a name="l01256"></a>01256                 descr_len_max = GG_STATUS_DESCR_MAXSIZE_PRE_8_0;
<a name="l01257"></a>01257 
<a name="l01258"></a>01258                 <span class="keywordflow">if</span> (time != 0)
<a name="l01259"></a>01259                         append_null = 1;
<a name="l01260"></a>01260         }
<a name="l01261"></a>01261 
<a name="l01262"></a>01262         <span class="keywordflow">if</span> (descr) {
<a name="l01263"></a>01263                 descr_len = strlen((new_descr) ? new_descr : descr);
<a name="l01264"></a>01264 
<a name="l01265"></a>01265                 <span class="keywordflow">if</span> (descr_len &gt; descr_len_max)
<a name="l01266"></a>01266                         descr_len = descr_len_max;
<a name="l01267"></a>01267 
<a name="l01268"></a>01268                 <span class="comment">// XXX pamiętać o tym, żeby nie ucinać w środku znaku utf-8</span>
<a name="l01269"></a>01269         }
<a name="l01270"></a>01270 
<a name="l01271"></a>01271         <span class="keywordflow">if</span> (time)
<a name="l01272"></a>01272                 new_time = gg_fix32(time);
<a name="l01273"></a>01273 
<a name="l01274"></a>01274         <span class="keywordflow">if</span> (packet_type == GG_NEW_STATUS80) {
<a name="l01275"></a>01275                 <span class="keyword">struct </span><a class="code" href="structgg__new__status80.html">gg_new_status80</a> p;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277                 p.<a class="code" href="structgg__new__status80.html#a7e598946bc669f94be46a699fbf67db2">status</a>                = gg_fix32(status);
<a name="l01278"></a>01278                 p.flags                 = gg_fix32(sess-&gt;<a class="code" href="structgg__session.html#a5fcbb379fd707c43309dd260395ec2cc">status_flags</a>);
<a name="l01279"></a>01279                 p.description_size      = gg_fix32(descr_len);
<a name="l01280"></a>01280                 res = gg_send_packet(sess,
<a name="l01281"></a>01281                                 packet_type,
<a name="l01282"></a>01282                                 &amp;p,
<a name="l01283"></a>01283                                 <span class="keyword">sizeof</span>(p),
<a name="l01284"></a>01284                                 (new_descr) ? new_descr : descr,
<a name="l01285"></a>01285                                 descr_len,
<a name="l01286"></a>01286                                 NULL);
<a name="l01287"></a>01287 
<a name="l01288"></a>01288         } <span class="keywordflow">else</span> {
<a name="l01289"></a>01289                 <span class="keyword">struct </span><a class="code" href="structgg__new__status.html">gg_new_status</a> p;
<a name="l01290"></a>01290 
<a name="l01291"></a>01291                 p.<a class="code" href="structgg__new__status.html#af4e30ec658173f7b0c5edd8b619bfa42">status</a> = gg_fix32(status);
<a name="l01292"></a>01292                 res = gg_send_packet(sess,
<a name="l01293"></a>01293                                 packet_type,
<a name="l01294"></a>01294                                 &amp;p,
<a name="l01295"></a>01295                                 <span class="keyword">sizeof</span>(p),
<a name="l01296"></a>01296                                 (new_descr) ? new_descr : descr,
<a name="l01297"></a>01297                                 descr_len,
<a name="l01298"></a>01298                                 (append_null) ? <span class="stringliteral">&quot;\0&quot;</span> : NULL,
<a name="l01299"></a>01299                                 (append_null) ? 1 : 0,
<a name="l01300"></a>01300                                 (time) ? &amp;new_time : NULL,
<a name="l01301"></a>01301                                 (time) ? <span class="keyword">sizeof</span>(new_time) : 0,
<a name="l01302"></a>01302                                 NULL);
<a name="l01303"></a>01303         }
<a name="l01304"></a>01304 
<a name="l01305"></a>01305         free(new_descr);
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <span class="keywordflow">if</span> (GG_S_NA(status)) {
<a name="l01308"></a>01308                 sess-&gt;state = <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a535f6a4125c63e090f73b38b981e8e33">GG_STATE_DISCONNECTING</a>;
<a name="l01309"></a>01309                 sess-&gt;timeout = GG_TIMEOUT_DISCONNECT;
<a name="l01310"></a>01310         }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312         <span class="keywordflow">return</span> res;
<a name="l01313"></a>01313 }
<a name="l01314"></a>01314 
<a name="l01315"></a>01315 <span class="preprocessor">#endif </span><span class="comment">/* DOXYGEN */</span>
<a name="l01316"></a>01316 
<a name="l01327"></a><a class="code" href="libgadu_8h.html#ac39145f5cc6c166730011aafc150c8af">01327</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#ac39145f5cc6c166730011aafc150c8af">gg_change_status</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> status)
<a name="l01328"></a>01328 {
<a name="l01329"></a>01329         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_change_status(%p, %d);\n&quot;</span>, sess, status);
<a name="l01330"></a>01330 
<a name="l01331"></a>01331         <span class="keywordflow">return</span> gg_change_status_common(sess, status, NULL, 0);
<a name="l01332"></a>01332 }
<a name="l01333"></a>01333 
<a name="l01345"></a><a class="code" href="libgadu_8h.html#a88e51a8ffa11ab83ce5be8ae6d244fa5">01345</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a88e51a8ffa11ab83ce5be8ae6d244fa5">gg_change_status_descr</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> status, <span class="keyword">const</span> <span class="keywordtype">char</span> *descr)
<a name="l01346"></a>01346 {
<a name="l01347"></a>01347         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_change_status_descr(%p, %d, \&quot;%s\&quot;);\n&quot;</span>, sess, status, descr);
<a name="l01348"></a>01348 
<a name="l01349"></a>01349         <span class="keywordflow">return</span> gg_change_status_common(sess, status, descr, 0);
<a name="l01350"></a>01350 }
<a name="l01351"></a>01351 
<a name="l01364"></a><a class="code" href="libgadu_8h.html#a0487618b7521b1900bf4771971084bb0">01364</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a0487618b7521b1900bf4771971084bb0">gg_change_status_descr_time</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> status, <span class="keyword">const</span> <span class="keywordtype">char</span> *descr, <span class="keywordtype">int</span> time)
<a name="l01365"></a>01365 {
<a name="l01366"></a>01366         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_change_status_descr_time(%p, %d, \&quot;%s\&quot;, %d);\n&quot;</span>, sess, status, descr, time);
<a name="l01367"></a>01367 
<a name="l01368"></a>01368         <span class="keywordflow">return</span> gg_change_status_common(sess, status, descr, time);
<a name="l01369"></a>01369 }
<a name="l01370"></a>01370 
<a name="l01384"></a><a class="code" href="libgadu_8h.html#a58f2aededfe215bfb7ccbd6b019c94d4">01384</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a58f2aededfe215bfb7ccbd6b019c94d4">gg_change_status_flags</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> flags)
<a name="l01385"></a>01385 {
<a name="l01386"></a>01386         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_change_status_flags(%p, 0x%08x);\n&quot;</span>, sess, flags);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388         <span class="keywordflow">if</span> (sess == NULL) {
<a name="l01389"></a>01389                 errno = EFAULT;
<a name="l01390"></a>01390                 <span class="keywordflow">return</span> -1;
<a name="l01391"></a>01391         }
<a name="l01392"></a>01392 
<a name="l01393"></a>01393         sess-&gt;<a class="code" href="structgg__session.html#a5fcbb379fd707c43309dd260395ec2cc">status_flags</a> = flags;
<a name="l01394"></a>01394 
<a name="l01395"></a>01395         <span class="keywordflow">return</span> 0;
<a name="l01396"></a>01396 }
<a name="l01397"></a>01397 
<a name="l01413"></a><a class="code" href="libgadu_8h.html#abcc076e57528b91518f573f59fadde08">01413</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#abcc076e57528b91518f573f59fadde08">gg_send_message</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> msgclass, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> recipient, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *message)
<a name="l01414"></a>01414 {
<a name="l01415"></a>01415         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_send_message(%p, %d, %u, %p)\n&quot;</span>, sess, msgclass, recipient, message);
<a name="l01416"></a>01416 
<a name="l01417"></a>01417         <span class="keywordflow">return</span> <a class="code" href="libgadu_8c.html#a0e5df383eeac438710656704fa4bdd30">gg_send_message_confer_richtext</a>(sess, msgclass, 1, &amp;recipient, message, NULL, 0);
<a name="l01418"></a>01418 }
<a name="l01419"></a>01419 
<a name="l01437"></a><a class="code" href="libgadu_8h.html#a2a30ed0ecd9691b7af77406619087a67">01437</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a2a30ed0ecd9691b7af77406619087a67">gg_send_message_richtext</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> msgclass, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> recipient, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *message, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *format, <span class="keywordtype">int</span> formatlen)
<a name="l01438"></a>01438 {
<a name="l01439"></a>01439         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_send_message_richtext(%p, %d, %u, %p, %p, %d);\n&quot;</span>, sess, msgclass, recipient, message, format, formatlen);
<a name="l01440"></a>01440 
<a name="l01441"></a>01441         <span class="keywordflow">return</span> <a class="code" href="libgadu_8c.html#a0e5df383eeac438710656704fa4bdd30">gg_send_message_confer_richtext</a>(sess, msgclass, 1, &amp;recipient, message, format, formatlen);
<a name="l01442"></a>01442 }
<a name="l01443"></a>01443 
<a name="l01460"></a><a class="code" href="libgadu_8h.html#a48f3197c621872c670f49fe0d1ac25eb">01460</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a48f3197c621872c670f49fe0d1ac25eb">gg_send_message_confer</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> msgclass, <span class="keywordtype">int</span> recipients_count, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> *recipients, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *message)
<a name="l01461"></a>01461 {
<a name="l01462"></a>01462         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_send_message_confer(%p, %d, %d, %p, %p);\n&quot;</span>, sess, msgclass, recipients_count, recipients, message);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464         <span class="keywordflow">return</span> <a class="code" href="libgadu_8c.html#a0e5df383eeac438710656704fa4bdd30">gg_send_message_confer_richtext</a>(sess, msgclass, recipients_count, recipients, message, NULL, 0);
<a name="l01465"></a>01465 }
<a name="l01466"></a>01466 
<a name="l01485"></a><a class="code" href="libgadu_8h.html#a0e5df383eeac438710656704fa4bdd30">01485</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a0e5df383eeac438710656704fa4bdd30">gg_send_message_confer_richtext</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> msgclass, <span class="keywordtype">int</span> recipients_count, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> *recipients, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *message, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *format, <span class="keywordtype">int</span> formatlen)
<a name="l01486"></a>01486 {
<a name="l01487"></a>01487         <span class="keyword">struct </span><a class="code" href="structgg__send__msg.html">gg_send_msg</a> s;
<a name="l01488"></a>01488         <span class="keyword">struct </span><a class="code" href="structgg__send__msg80.html">gg_send_msg80</a> s80;
<a name="l01489"></a>01489         <span class="keyword">struct </span><a class="code" href="structgg__msg__recipients.html">gg_msg_recipients</a> r;
<a name="l01490"></a>01490         <span class="keywordtype">char</span> *cp_msg = NULL;
<a name="l01491"></a>01491         <span class="keywordtype">char</span> *utf_msg = NULL;
<a name="l01492"></a>01492         <span class="keywordtype">char</span> *html_msg = NULL;
<a name="l01493"></a>01493         <span class="keywordtype">int</span> seq_no;
<a name="l01494"></a>01494         <span class="keywordtype">int</span> i, j, k;
<a name="l01495"></a>01495         <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> *recps;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_send_message_confer_richtext(%p, %d, %d, %p, %p, %p, %d);\n&quot;</span>, sess, msgclass, recipients_count, recipients, message, format, formatlen);
<a name="l01498"></a>01498 
<a name="l01499"></a>01499         <span class="keywordflow">if</span> (!sess) {
<a name="l01500"></a>01500                 errno = EFAULT;
<a name="l01501"></a>01501                 <span class="keywordflow">return</span> -1;
<a name="l01502"></a>01502         }
<a name="l01503"></a>01503 
<a name="l01504"></a>01504         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01505"></a>01505                 errno = ENOTCONN;
<a name="l01506"></a>01506                 <span class="keywordflow">return</span> -1;
<a name="l01507"></a>01507         }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509         <span class="keywordflow">if</span> (message == NULL || recipients_count &lt;= 0 || recipients_count &gt; 0xffff || (recipients_count != 1 &amp;&amp; recipients == NULL)) {
<a name="l01510"></a>01510                 errno = EINVAL;
<a name="l01511"></a>01511                 <span class="keywordflow">return</span> -1;
<a name="l01512"></a>01512         }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#ac510ffbf7c1e5735490850cd80263215">encoding</a> == <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498add132d17c370e55d0f421b7867ce0d40">GG_ENCODING_UTF8</a>) {
<a name="l01515"></a>01515                 <span class="keywordflow">if</span> (!(cp_msg = gg_encoding_convert((<span class="keyword">const</span> <span class="keywordtype">char</span> *) message, <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498add132d17c370e55d0f421b7867ce0d40">GG_ENCODING_UTF8</a>, <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498a923b0b07c392fc993f9627b5df43397c">GG_ENCODING_CP1250</a>, -1, -1)))
<a name="l01516"></a>01516                         <span class="keywordflow">return</span> -1;
<a name="l01517"></a>01517 
<a name="l01518"></a>01518                 utf_msg = (<span class="keywordtype">char</span>*) message;
<a name="l01519"></a>01519         } <span class="keywordflow">else</span> {
<a name="l01520"></a>01520                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &gt;= 0x2d) {
<a name="l01521"></a>01521                         <span class="keywordflow">if</span> (!(utf_msg = gg_encoding_convert((<span class="keyword">const</span> <span class="keywordtype">char</span> *) message, <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498a923b0b07c392fc993f9627b5df43397c">GG_ENCODING_CP1250</a>, <a class="code" href="libgadu_8h.html#adbaace4dc70e6607a9d6bd4c23cd2498add132d17c370e55d0f421b7867ce0d40">GG_ENCODING_UTF8</a>, -1, -1)))
<a name="l01522"></a>01522                                 <span class="keywordflow">return</span> -1;
<a name="l01523"></a>01523                 }
<a name="l01524"></a>01524 
<a name="l01525"></a>01525                 cp_msg = (<span class="keywordtype">char</span>*) message;
<a name="l01526"></a>01526         }
<a name="l01527"></a>01527 
<a name="l01528"></a>01528         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &lt; 0x2d) {
<a name="l01529"></a>01529                 <span class="keywordflow">if</span> (!sess-&gt;<a class="code" href="structgg__session.html#ac1009c0a2e23655eb304ab4dc929f669">seq</a>)
<a name="l01530"></a>01530                         sess-&gt;<a class="code" href="structgg__session.html#ac1009c0a2e23655eb304ab4dc929f669">seq</a> = 0x01740000 | (rand() &amp; 0xffff);
<a name="l01531"></a>01531                 seq_no = sess-&gt;<a class="code" href="structgg__session.html#ac1009c0a2e23655eb304ab4dc929f669">seq</a>;
<a name="l01532"></a>01532                 sess-&gt;<a class="code" href="structgg__session.html#ac1009c0a2e23655eb304ab4dc929f669">seq</a> += (rand() % 0x300) + 0x300;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534                 s.msgclass = gg_fix32(msgclass);
<a name="l01535"></a>01535                 s.seq = gg_fix32(seq_no);
<a name="l01536"></a>01536         } <span class="keywordflow">else</span> {
<a name="l01537"></a>01537                 <span class="keywordtype">int</span> len;
<a name="l01538"></a>01538                 
<a name="l01539"></a>01539                 <span class="comment">// Drobne odchylenie od protokołu. Jeśli wysyłamy kilka</span>
<a name="l01540"></a>01540                 <span class="comment">// wiadomości w ciągu jednej sekundy, zwiększamy poprzednią</span>
<a name="l01541"></a>01541                 <span class="comment">// wartość, żeby każda wiadomość miała unikalny numer.</span>
<a name="l01542"></a>01542 
<a name="l01543"></a>01543                 seq_no = time(NULL);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545                 <span class="keywordflow">if</span> (seq_no &lt;= sess-&gt;seq)
<a name="l01546"></a>01546                         seq_no = sess-&gt;<a class="code" href="structgg__session.html#ac1009c0a2e23655eb304ab4dc929f669">seq</a> + 1;
<a name="l01547"></a>01547 
<a name="l01548"></a>01548                 sess-&gt;<a class="code" href="structgg__session.html#ac1009c0a2e23655eb304ab4dc929f669">seq</a> = seq_no;
<a name="l01549"></a>01549 
<a name="l01550"></a>01550                 <span class="keywordflow">if</span> (format == NULL || formatlen &lt; 3) {
<a name="l01551"></a>01551                         format = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) <span class="stringliteral">&quot;\x02\x06\x00\x00\x00\x08\x00\x00\x00&quot;</span>;
<a name="l01552"></a>01552                         formatlen = 9;
<a name="l01553"></a>01553                 }
<a name="l01554"></a>01554 
<a name="l01555"></a>01555                 len = gg_message_text_to_html(NULL, utf_msg, (<span class="keywordtype">char</span>*) format + 3, formatlen - 3);
<a name="l01556"></a>01556 
<a name="l01557"></a>01557                 html_msg = malloc(len + 1);
<a name="l01558"></a>01558 
<a name="l01559"></a>01559                 <span class="keywordflow">if</span> (html_msg == NULL) {
<a name="l01560"></a>01560                         seq_no = -1;
<a name="l01561"></a>01561                         <span class="keywordflow">goto</span> cleanup;
<a name="l01562"></a>01562                 }
<a name="l01563"></a>01563 
<a name="l01564"></a>01564                 gg_message_text_to_html(html_msg, utf_msg, (<span class="keywordtype">char</span>*) format + 3, formatlen - 3);
<a name="l01565"></a>01565 
<a name="l01566"></a>01566                 s80.seq = gg_fix32(seq_no);
<a name="l01567"></a>01567                 s80.msgclass = gg_fix32(msgclass);
<a name="l01568"></a>01568                 s80.offset_plain = gg_fix32(<span class="keyword">sizeof</span>(s80) + strlen(html_msg) + 1);
<a name="l01569"></a>01569                 s80.offset_attr = gg_fix32(<span class="keyword">sizeof</span>(s80) + strlen(html_msg) + 1 + strlen(cp_msg) + 1);
<a name="l01570"></a>01570         }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572         <span class="keywordflow">if</span> (recipients_count &gt; 1) {
<a name="l01573"></a>01573                 r.flag = 0x01;
<a name="l01574"></a>01574                 r.count = gg_fix32(recipients_count - 1);
<a name="l01575"></a>01575 
<a name="l01576"></a>01576                 recps = malloc(<span class="keyword">sizeof</span>(<a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a>) * recipients_count);
<a name="l01577"></a>01577 
<a name="l01578"></a>01578                 <span class="keywordflow">if</span> (!recps) {
<a name="l01579"></a>01579                         seq_no = -1;
<a name="l01580"></a>01580                         <span class="keywordflow">goto</span> cleanup;
<a name="l01581"></a>01581                 }
<a name="l01582"></a>01582 
<a name="l01583"></a>01583                 <span class="keywordflow">for</span> (i = 0; i &lt; recipients_count; i++) {
<a name="l01584"></a>01584                         <span class="keywordflow">for</span> (j = 0, k = 0; j &lt; recipients_count; j++) {
<a name="l01585"></a>01585                                 <span class="keywordflow">if</span> (recipients[j] != recipients[i]) {
<a name="l01586"></a>01586                                         recps[k] = gg_fix32(recipients[j]);
<a name="l01587"></a>01587                                         k++;
<a name="l01588"></a>01588                                 }
<a name="l01589"></a>01589                         }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591                         <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &lt; 0x2d) {
<a name="l01592"></a>01592                                 s.recipient = gg_fix32(recipients[i]);
<a name="l01593"></a>01593 
<a name="l01594"></a>01594                                 <span class="keywordflow">if</span> (gg_send_packet(sess, GG_SEND_MSG, &amp;s, <span class="keyword">sizeof</span>(s), cp_msg, strlen(cp_msg) + 1, &amp;r, <span class="keyword">sizeof</span>(r), recps, (recipients_count - 1) * <span class="keyword">sizeof</span>(<a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a>), format, formatlen, NULL) == -1)
<a name="l01595"></a>01595                                         seq_no = -1;
<a name="l01596"></a>01596                         } <span class="keywordflow">else</span> {
<a name="l01597"></a>01597                                 s80.recipient = gg_fix32(recipients[i]);
<a name="l01598"></a>01598 
<a name="l01599"></a>01599                                 <span class="keywordflow">if</span> (gg_send_packet(sess, GG_SEND_MSG80, &amp;s80, <span class="keyword">sizeof</span>(s80), html_msg, strlen(html_msg) + 1, cp_msg, strlen(cp_msg) + 1, &amp;r, <span class="keyword">sizeof</span>(r), recps, (recipients_count - 1) * <span class="keyword">sizeof</span>(<a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a>), format, formatlen, NULL) == -1)
<a name="l01600"></a>01600                                         seq_no = -1;
<a name="l01601"></a>01601                         }
<a name="l01602"></a>01602                 }
<a name="l01603"></a>01603 
<a name="l01604"></a>01604                 free(recps);
<a name="l01605"></a>01605         } <span class="keywordflow">else</span> {
<a name="l01606"></a>01606                 <span class="keywordflow">if</span> (sess-&gt;<a class="code" href="structgg__session.html#a6d8165ceaaaaa7198cd95d91ff7ff8bd">protocol_version</a> &lt; 0x2d) {
<a name="l01607"></a>01607                         s.recipient = gg_fix32(recipients[0]);
<a name="l01608"></a>01608 
<a name="l01609"></a>01609                         <span class="keywordflow">if</span> (gg_send_packet(sess, GG_SEND_MSG, &amp;s, <span class="keyword">sizeof</span>(s), cp_msg, strlen(cp_msg) + 1, format, formatlen, NULL) == -1)
<a name="l01610"></a>01610                                 seq_no = -1;
<a name="l01611"></a>01611                 } <span class="keywordflow">else</span> {
<a name="l01612"></a>01612                         s80.recipient = gg_fix32(recipients[0]);
<a name="l01613"></a>01613 
<a name="l01614"></a>01614                         <span class="keywordflow">if</span> (gg_send_packet(sess, GG_SEND_MSG80, &amp;s80, <span class="keyword">sizeof</span>(s80), html_msg, strlen(html_msg) + 1, cp_msg, strlen(cp_msg) + 1, format, formatlen, NULL) == -1)
<a name="l01615"></a>01615                                 seq_no = -1;
<a name="l01616"></a>01616                 }
<a name="l01617"></a>01617         }
<a name="l01618"></a>01618 
<a name="l01619"></a>01619 cleanup:
<a name="l01620"></a>01620         <span class="keywordflow">if</span> (cp_msg != (<span class="keywordtype">char</span>*) message)
<a name="l01621"></a>01621                 free(cp_msg);
<a name="l01622"></a>01622 
<a name="l01623"></a>01623         <span class="keywordflow">if</span> (utf_msg != (<span class="keywordtype">char</span>*) message)
<a name="l01624"></a>01624                 free(utf_msg);
<a name="l01625"></a>01625 
<a name="l01626"></a>01626         free(html_msg);
<a name="l01627"></a>01627 
<a name="l01628"></a>01628         <span class="keywordflow">return</span> seq_no;
<a name="l01629"></a>01629 }
<a name="l01630"></a>01630 
<a name="l01648"></a><a class="code" href="libgadu_8h.html#a2c03e907a237f1de9a0e22b252e333c5">01648</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a2c03e907a237f1de9a0e22b252e333c5">gg_send_message_ctcp</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">int</span> msgclass, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> recipient, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *message, <span class="keywordtype">int</span> message_len)
<a name="l01649"></a>01649 {
<a name="l01650"></a>01650         <span class="keyword">struct </span><a class="code" href="structgg__send__msg.html">gg_send_msg</a> s;
<a name="l01651"></a>01651 
<a name="l01652"></a>01652         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_send_message_ctcp(%p, %d, %u, ...);\n&quot;</span>, sess, msgclass, recipient);
<a name="l01653"></a>01653 
<a name="l01654"></a>01654         <span class="keywordflow">if</span> (!sess) {
<a name="l01655"></a>01655                 errno = EFAULT;
<a name="l01656"></a>01656                 <span class="keywordflow">return</span> -1;
<a name="l01657"></a>01657         }
<a name="l01658"></a>01658 
<a name="l01659"></a>01659         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01660"></a>01660                 errno = ENOTCONN;
<a name="l01661"></a>01661                 <span class="keywordflow">return</span> -1;
<a name="l01662"></a>01662         }
<a name="l01663"></a>01663 
<a name="l01664"></a>01664         s.recipient = gg_fix32(recipient);
<a name="l01665"></a>01665         s.seq = gg_fix32(0);
<a name="l01666"></a>01666         s.msgclass = gg_fix32(msgclass);
<a name="l01667"></a>01667 
<a name="l01668"></a>01668         <span class="keywordflow">return</span> gg_send_packet(sess, GG_SEND_MSG, &amp;s, <span class="keyword">sizeof</span>(s), message, message_len, NULL);
<a name="l01669"></a>01669 }
<a name="l01670"></a>01670 
<a name="l01688"></a><a class="code" href="libgadu_8h.html#ad8f4addf7ac77bb992e42eb6e2de5b60">01688</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#ad8f4addf7ac77bb992e42eb6e2de5b60">gg_image_request</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> recipient, <span class="keywordtype">int</span> size, uint32_t crc32)
<a name="l01689"></a>01689 {
<a name="l01690"></a>01690         <span class="keyword">struct </span><a class="code" href="structgg__send__msg.html">gg_send_msg</a> s;
<a name="l01691"></a>01691         <span class="keyword">struct </span><a class="code" href="structgg__msg__image__request.html">gg_msg_image_request</a> r;
<a name="l01692"></a>01692         <span class="keywordtype">char</span> dummy = 0;
<a name="l01693"></a>01693         <span class="keywordtype">int</span> res;
<a name="l01694"></a>01694 
<a name="l01695"></a>01695         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_image_request(%p, %d, %u, 0x%.4x);\n&quot;</span>, sess, recipient, size, crc32);
<a name="l01696"></a>01696 
<a name="l01697"></a>01697         <span class="keywordflow">if</span> (!sess) {
<a name="l01698"></a>01698                 errno = EFAULT;
<a name="l01699"></a>01699                 <span class="keywordflow">return</span> -1;
<a name="l01700"></a>01700         }
<a name="l01701"></a>01701 
<a name="l01702"></a>01702         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01703"></a>01703                 errno = ENOTCONN;
<a name="l01704"></a>01704                 <span class="keywordflow">return</span> -1;
<a name="l01705"></a>01705         }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707         <span class="keywordflow">if</span> (size &lt; 0) {
<a name="l01708"></a>01708                 errno = EINVAL;
<a name="l01709"></a>01709                 <span class="keywordflow">return</span> -1;
<a name="l01710"></a>01710         }
<a name="l01711"></a>01711 
<a name="l01712"></a>01712         s.recipient = gg_fix32(recipient);
<a name="l01713"></a>01713         s.seq = gg_fix32(0);
<a name="l01714"></a>01714         s.msgclass = gg_fix32(GG_CLASS_MSG);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716         r.flag = 0x04;
<a name="l01717"></a>01717         r.size = gg_fix32(size);
<a name="l01718"></a>01718         r.crc32 = gg_fix32(crc32);
<a name="l01719"></a>01719 
<a name="l01720"></a>01720         res = gg_send_packet(sess, GG_SEND_MSG, &amp;s, <span class="keyword">sizeof</span>(s), &amp;dummy, 1, &amp;r, <span class="keyword">sizeof</span>(r), NULL);
<a name="l01721"></a>01721 
<a name="l01722"></a>01722         <span class="keywordflow">if</span> (!res) {
<a name="l01723"></a>01723                 <span class="keyword">struct </span><a class="code" href="structgg__image__queue.html">gg_image_queue</a> *q = malloc(<span class="keyword">sizeof</span>(*q));
<a name="l01724"></a>01724                 <span class="keywordtype">char</span> *buf;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726                 <span class="keywordflow">if</span> (!q) {
<a name="l01727"></a>01727                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_image_request() not enough memory for image queue\n&quot;</span>);
<a name="l01728"></a>01728                         <span class="keywordflow">return</span> -1;
<a name="l01729"></a>01729                 }
<a name="l01730"></a>01730 
<a name="l01731"></a>01731                 buf = malloc(size);
<a name="l01732"></a>01732                 <span class="keywordflow">if</span> (size &amp;&amp; !buf)
<a name="l01733"></a>01733                 {
<a name="l01734"></a>01734                         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_image_request() not enough memory for image\n&quot;</span>);
<a name="l01735"></a>01735                         free(q);
<a name="l01736"></a>01736                         <span class="keywordflow">return</span> -1;
<a name="l01737"></a>01737                 }
<a name="l01738"></a>01738 
<a name="l01739"></a>01739                 memset(q, 0, <span class="keyword">sizeof</span>(*q));
<a name="l01740"></a>01740 
<a name="l01741"></a>01741                 q-&gt;<a class="code" href="structgg__image__queue.html#a1d0a7f67880535903c8acb89dc7044a5">sender</a> = recipient;
<a name="l01742"></a>01742                 q-&gt;<a class="code" href="structgg__image__queue.html#a55d5a25acf21cb80934da55e99d52f95">size</a> = <a class="code" href="structgg__image__queue.html#a55d5a25acf21cb80934da55e99d52f95">size</a>;
<a name="l01743"></a>01743                 q-&gt;<a class="code" href="structgg__image__queue.html#a830e0bc4204b1400fc7f09c39d7f4fa0">crc32</a> = <a class="code" href="structgg__image__queue.html#a830e0bc4204b1400fc7f09c39d7f4fa0">crc32</a>;
<a name="l01744"></a>01744                 q-&gt;<a class="code" href="structgg__image__queue.html#acfeeb9036a11bcaae726f055fa7dd7f5">image</a> = buf;
<a name="l01745"></a>01745 
<a name="l01746"></a>01746                 <span class="keywordflow">if</span> (!sess-&gt;<a class="code" href="structgg__session.html#a1b75db0653256658842702073c2b5a1d">images</a>)
<a name="l01747"></a>01747                         sess-&gt;<a class="code" href="structgg__session.html#a1b75db0653256658842702073c2b5a1d">images</a> = q;
<a name="l01748"></a>01748                 <span class="keywordflow">else</span> {
<a name="l01749"></a>01749                         <span class="keyword">struct </span><a class="code" href="structgg__image__queue.html">gg_image_queue</a> *qq;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751                         <span class="keywordflow">for</span> (qq = sess-&gt;<a class="code" href="structgg__session.html#a1b75db0653256658842702073c2b5a1d">images</a>; qq-&gt;<a class="code" href="structgg__image__queue.html#a489c820cd4f62ba42a8ebb6b632ca23b">next</a>; qq = qq-&gt;<a class="code" href="structgg__image__queue.html#a489c820cd4f62ba42a8ebb6b632ca23b">next</a>)
<a name="l01752"></a>01752                                 ;
<a name="l01753"></a>01753 
<a name="l01754"></a>01754                         qq-&gt;<a class="code" href="structgg__image__queue.html#a489c820cd4f62ba42a8ebb6b632ca23b">next</a> = q;
<a name="l01755"></a>01755                 }
<a name="l01756"></a>01756         }
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         <span class="keywordflow">return</span> res;
<a name="l01759"></a>01759 }
<a name="l01760"></a>01760 
<a name="l01774"></a><a class="code" href="libgadu_8h.html#a8d1a50a10b076d0006c8b1b301394bd2">01774</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a8d1a50a10b076d0006c8b1b301394bd2">gg_image_reply</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> recipient, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structgg__image__queue.html#a802af91de9443478d2a0788c75ca3446">filename</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structgg__image__queue.html#acfeeb9036a11bcaae726f055fa7dd7f5">image</a>, <span class="keywordtype">int</span> size)
<a name="l01775"></a>01775 {
<a name="l01776"></a>01776         <span class="keyword">struct </span><a class="code" href="structgg__msg__image__reply.html">gg_msg_image_reply</a> *r;
<a name="l01777"></a>01777         <span class="keyword">struct </span><a class="code" href="structgg__send__msg.html">gg_send_msg</a> s;
<a name="l01778"></a>01778         <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
<a name="l01779"></a>01779         <span class="keywordtype">char</span> buf[1910];
<a name="l01780"></a>01780         <span class="keywordtype">int</span> res = -1;
<a name="l01781"></a>01781 
<a name="l01782"></a>01782         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_image_reply(%p, %d, \&quot;%s\&quot;, %p, %d);\n&quot;</span>, sess, recipient, filename, image, size);
<a name="l01783"></a>01783 
<a name="l01784"></a>01784         <span class="keywordflow">if</span> (!sess || !filename || !image) {
<a name="l01785"></a>01785                 errno = EFAULT;
<a name="l01786"></a>01786                 <span class="keywordflow">return</span> -1;
<a name="l01787"></a>01787         }
<a name="l01788"></a>01788 
<a name="l01789"></a>01789         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01790"></a>01790                 errno = ENOTCONN;
<a name="l01791"></a>01791                 <span class="keywordflow">return</span> -1;
<a name="l01792"></a>01792         }
<a name="l01793"></a>01793 
<a name="l01794"></a>01794         <span class="keywordflow">if</span> (size &lt; 0) {
<a name="l01795"></a>01795                 errno = EINVAL;
<a name="l01796"></a>01796                 <span class="keywordflow">return</span> -1;
<a name="l01797"></a>01797         }
<a name="l01798"></a>01798 
<a name="l01799"></a>01799         <span class="comment">/* wytnij ścieżki, zostaw tylko nazwę pliku */</span>
<a name="l01800"></a>01800         <span class="keywordflow">while</span> ((tmp = strrchr(filename, <span class="charliteral">&#39;/&#39;</span>)) || (tmp = strrchr(filename, <span class="charliteral">&#39;\\&#39;</span>)))
<a name="l01801"></a>01801                 filename = tmp + 1;
<a name="l01802"></a>01802 
<a name="l01803"></a>01803         <span class="keywordflow">if</span> (strlen(filename) &lt; 1 || strlen(filename) &gt; 1024) {
<a name="l01804"></a>01804                 errno = EINVAL;
<a name="l01805"></a>01805                 <span class="keywordflow">return</span> -1;
<a name="l01806"></a>01806         }
<a name="l01807"></a>01807 
<a name="l01808"></a>01808         s.recipient = gg_fix32(recipient);
<a name="l01809"></a>01809         s.seq = gg_fix32(0);
<a name="l01810"></a>01810         s.msgclass = gg_fix32(GG_CLASS_MSG);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812         buf[0] = 0;
<a name="l01813"></a>01813         r = (<span class="keywordtype">void</span>*) &amp;buf[1];
<a name="l01814"></a>01814 
<a name="l01815"></a>01815         r-&gt;flag = 0x05;
<a name="l01816"></a>01816         r-&gt;size = gg_fix32(size);
<a name="l01817"></a>01817         r-&gt;crc32 = gg_fix32(<a class="code" href="common_8c.html#a1674418e6048446e8279a62eb23d483f">gg_crc32</a>(0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) image, size));
<a name="l01818"></a>01818 
<a name="l01819"></a>01819         <span class="keywordflow">while</span> (size &gt; 0) {
<a name="l01820"></a>01820                 <span class="keywordtype">int</span> buflen, chunklen;
<a name="l01821"></a>01821 
<a name="l01822"></a>01822                 <span class="comment">/* \0 + struct gg_msg_image_reply */</span>
<a name="l01823"></a>01823                 buflen = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structgg__msg__image__reply.html">gg_msg_image_reply</a>) + 1;
<a name="l01824"></a>01824 
<a name="l01825"></a>01825                 <span class="comment">/* w pierwszym kawałku jest nazwa pliku */</span>
<a name="l01826"></a>01826                 <span class="keywordflow">if</span> (r-&gt;flag == 0x05) {
<a name="l01827"></a>01827                         strcpy(buf + buflen, filename);
<a name="l01828"></a>01828                         buflen += strlen(filename) + 1;
<a name="l01829"></a>01829                 }
<a name="l01830"></a>01830 
<a name="l01831"></a>01831                 chunklen = (size &gt;= <span class="keyword">sizeof</span>(buf) - buflen) ? (<span class="keyword">sizeof</span>(buf) - buflen) : size;
<a name="l01832"></a>01832 
<a name="l01833"></a>01833                 memcpy(buf + buflen, image, chunklen);
<a name="l01834"></a>01834                 size -= chunklen;
<a name="l01835"></a>01835                 image += chunklen;
<a name="l01836"></a>01836 
<a name="l01837"></a>01837                 res = gg_send_packet(sess, GG_SEND_MSG, &amp;s, <span class="keyword">sizeof</span>(s), buf, buflen + chunklen, NULL);
<a name="l01838"></a>01838 
<a name="l01839"></a>01839                 <span class="keywordflow">if</span> (res == -1)
<a name="l01840"></a>01840                         <span class="keywordflow">break</span>;
<a name="l01841"></a>01841 
<a name="l01842"></a>01842                 r-&gt;flag = 0x06;
<a name="l01843"></a>01843         }
<a name="l01844"></a>01844 
<a name="l01845"></a>01845         <span class="keywordflow">return</span> res;
<a name="l01846"></a>01846 }
<a name="l01847"></a>01847 
<a name="l01868"></a><a class="code" href="libgadu_8h.html#ae32ab8481e2198fca185d4179bdd8509">01868</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#ae32ab8481e2198fca185d4179bdd8509">gg_notify_ex</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> *userlist, <span class="keywordtype">char</span> *types, <span class="keywordtype">int</span> count)
<a name="l01869"></a>01869 {
<a name="l01870"></a>01870         <span class="keyword">struct </span><a class="code" href="structgg__notify.html">gg_notify</a> *n;
<a name="l01871"></a>01871         <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> *u;
<a name="l01872"></a>01872         <span class="keywordtype">char</span> *t;
<a name="l01873"></a>01873         <span class="keywordtype">int</span> i, res = 0;
<a name="l01874"></a>01874 
<a name="l01875"></a>01875         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_notify_ex(%p, %p, %p, %d);\n&quot;</span>, sess, userlist, types, count);
<a name="l01876"></a>01876 
<a name="l01877"></a>01877         <span class="keywordflow">if</span> (!sess) {
<a name="l01878"></a>01878                 errno = EFAULT;
<a name="l01879"></a>01879                 <span class="keywordflow">return</span> -1;
<a name="l01880"></a>01880         }
<a name="l01881"></a>01881 
<a name="l01882"></a>01882         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01883"></a>01883                 errno = ENOTCONN;
<a name="l01884"></a>01884                 <span class="keywordflow">return</span> -1;
<a name="l01885"></a>01885         }
<a name="l01886"></a>01886 
<a name="l01887"></a>01887         <span class="keywordflow">if</span> (!userlist || !count)
<a name="l01888"></a>01888                 <span class="keywordflow">return</span> gg_send_packet(sess, GG_LIST_EMPTY, NULL);
<a name="l01889"></a>01889 
<a name="l01890"></a>01890         <span class="keywordflow">while</span> (count &gt; 0) {
<a name="l01891"></a>01891                 <span class="keywordtype">int</span> part_count, packet_type;
<a name="l01892"></a>01892 
<a name="l01893"></a>01893                 <span class="keywordflow">if</span> (count &gt; 400) {
<a name="l01894"></a>01894                         part_count = 400;
<a name="l01895"></a>01895                         packet_type = GG_NOTIFY_FIRST;
<a name="l01896"></a>01896                 } <span class="keywordflow">else</span> {
<a name="l01897"></a>01897                         part_count = count;
<a name="l01898"></a>01898                         packet_type = GG_NOTIFY_LAST;
<a name="l01899"></a>01899                 }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901                 <span class="keywordflow">if</span> (!(n = (<span class="keyword">struct</span> <a class="code" href="structgg__notify.html">gg_notify</a>*) malloc(<span class="keyword">sizeof</span>(*n) * part_count)))
<a name="l01902"></a>01902                         <span class="keywordflow">return</span> -1;
<a name="l01903"></a>01903 
<a name="l01904"></a>01904                 <span class="keywordflow">for</span> (u = userlist, t = types, i = 0; i &lt; part_count; u++, t++, i++) {
<a name="l01905"></a>01905                         n[i].uin = gg_fix32(*u);
<a name="l01906"></a>01906                         n[i].dunno1 = *t;
<a name="l01907"></a>01907                 }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909                 <span class="keywordflow">if</span> (gg_send_packet(sess, packet_type, n, <span class="keyword">sizeof</span>(*n) * part_count, NULL) == -1) {
<a name="l01910"></a>01910                         free(n);
<a name="l01911"></a>01911                         res = -1;
<a name="l01912"></a>01912                         <span class="keywordflow">break</span>;
<a name="l01913"></a>01913                 }
<a name="l01914"></a>01914 
<a name="l01915"></a>01915                 count -= part_count;
<a name="l01916"></a>01916                 userlist += part_count;
<a name="l01917"></a>01917                 types += part_count;
<a name="l01918"></a>01918 
<a name="l01919"></a>01919                 free(n);
<a name="l01920"></a>01920         }
<a name="l01921"></a>01921 
<a name="l01922"></a>01922         <span class="keywordflow">return</span> res;
<a name="l01923"></a>01923 }
<a name="l01924"></a>01924 
<a name="l01939"></a><a class="code" href="libgadu_8h.html#ac1b2b6ea2f7e69afaf3ebb7e8e1c96ac">01939</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#ac1b2b6ea2f7e69afaf3ebb7e8e1c96ac">gg_notify</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> *userlist, <span class="keywordtype">int</span> count)
<a name="l01940"></a>01940 {
<a name="l01941"></a>01941         <span class="keyword">struct </span><a class="code" href="structgg__notify.html">gg_notify</a> *n;
<a name="l01942"></a>01942         <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> *u;
<a name="l01943"></a>01943         <span class="keywordtype">int</span> i, res = 0;
<a name="l01944"></a>01944 
<a name="l01945"></a>01945         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_notify(%p, %p, %d);\n&quot;</span>, sess, userlist, count);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947         <span class="keywordflow">if</span> (!sess) {
<a name="l01948"></a>01948                 errno = EFAULT;
<a name="l01949"></a>01949                 <span class="keywordflow">return</span> -1;
<a name="l01950"></a>01950         }
<a name="l01951"></a>01951 
<a name="l01952"></a>01952         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l01953"></a>01953                 errno = ENOTCONN;
<a name="l01954"></a>01954                 <span class="keywordflow">return</span> -1;
<a name="l01955"></a>01955         }
<a name="l01956"></a>01956 
<a name="l01957"></a>01957         <span class="keywordflow">if</span> (!userlist || !count)
<a name="l01958"></a>01958                 <span class="keywordflow">return</span> gg_send_packet(sess, GG_LIST_EMPTY, NULL);
<a name="l01959"></a>01959 
<a name="l01960"></a>01960         <span class="keywordflow">while</span> (count &gt; 0) {
<a name="l01961"></a>01961                 <span class="keywordtype">int</span> part_count, packet_type;
<a name="l01962"></a>01962 
<a name="l01963"></a>01963                 <span class="keywordflow">if</span> (count &gt; 400) {
<a name="l01964"></a>01964                         part_count = 400;
<a name="l01965"></a>01965                         packet_type = GG_NOTIFY_FIRST;
<a name="l01966"></a>01966                 } <span class="keywordflow">else</span> {
<a name="l01967"></a>01967                         part_count = count;
<a name="l01968"></a>01968                         packet_type = GG_NOTIFY_LAST;
<a name="l01969"></a>01969                 }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971                 <span class="keywordflow">if</span> (!(n = (<span class="keyword">struct</span> <a class="code" href="structgg__notify.html">gg_notify</a>*) malloc(<span class="keyword">sizeof</span>(*n) * part_count)))
<a name="l01972"></a>01972                         <span class="keywordflow">return</span> -1;
<a name="l01973"></a>01973 
<a name="l01974"></a>01974                 <span class="keywordflow">for</span> (u = userlist, i = 0; i &lt; part_count; u++, i++) {
<a name="l01975"></a>01975                         n[i].uin = gg_fix32(*u);
<a name="l01976"></a>01976                         n[i].dunno1 = GG_USER_NORMAL;
<a name="l01977"></a>01977                 }
<a name="l01978"></a>01978 
<a name="l01979"></a>01979                 <span class="keywordflow">if</span> (gg_send_packet(sess, packet_type, n, <span class="keyword">sizeof</span>(*n) * part_count, NULL) == -1) {
<a name="l01980"></a>01980                         res = -1;
<a name="l01981"></a>01981                         free(n);
<a name="l01982"></a>01982                         <span class="keywordflow">break</span>;
<a name="l01983"></a>01983                 }
<a name="l01984"></a>01984 
<a name="l01985"></a>01985                 free(n);
<a name="l01986"></a>01986 
<a name="l01987"></a>01987                 userlist += part_count;
<a name="l01988"></a>01988                 count -= part_count;
<a name="l01989"></a>01989         }
<a name="l01990"></a>01990 
<a name="l01991"></a>01991         <span class="keywordflow">return</span> res;
<a name="l01992"></a>01992 }
<a name="l01993"></a>01993 
<a name="l02009"></a><a class="code" href="libgadu_8h.html#a98b46ee010fd5af4455db16e559b8167">02009</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a98b46ee010fd5af4455db16e559b8167">gg_add_notify_ex</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> uin, <span class="keywordtype">char</span> type)
<a name="l02010"></a>02010 {
<a name="l02011"></a>02011         <span class="keyword">struct </span><a class="code" href="structgg__add__remove.html">gg_add_remove</a> a;
<a name="l02012"></a>02012 
<a name="l02013"></a>02013         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_add_notify_ex(%p, %u, %d);\n&quot;</span>, sess, uin, type);
<a name="l02014"></a>02014 
<a name="l02015"></a>02015         <span class="keywordflow">if</span> (!sess) {
<a name="l02016"></a>02016                 errno = EFAULT;
<a name="l02017"></a>02017                 <span class="keywordflow">return</span> -1;
<a name="l02018"></a>02018         }
<a name="l02019"></a>02019 
<a name="l02020"></a>02020         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l02021"></a>02021                 errno = ENOTCONN;
<a name="l02022"></a>02022                 <span class="keywordflow">return</span> -1;
<a name="l02023"></a>02023         }
<a name="l02024"></a>02024 
<a name="l02025"></a>02025         a.uin = gg_fix32(uin);
<a name="l02026"></a>02026         a.dunno1 = type;
<a name="l02027"></a>02027 
<a name="l02028"></a>02028         <span class="keywordflow">return</span> gg_send_packet(sess, GG_ADD_NOTIFY, &amp;a, <span class="keyword">sizeof</span>(a), NULL);
<a name="l02029"></a>02029 }
<a name="l02030"></a>02030 
<a name="l02044"></a><a class="code" href="libgadu_8h.html#a0ce81a9cd1af5b6f4c177053c070934f">02044</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a0ce81a9cd1af5b6f4c177053c070934f">gg_add_notify</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> uin)
<a name="l02045"></a>02045 {
<a name="l02046"></a>02046         <span class="keywordflow">return</span> <a class="code" href="libgadu_8c.html#a98b46ee010fd5af4455db16e559b8167">gg_add_notify_ex</a>(sess, uin, GG_USER_NORMAL);
<a name="l02047"></a>02047 }
<a name="l02048"></a>02048 
<a name="l02062"></a><a class="code" href="libgadu_8h.html#a987a81820cda7bae995983ae1cc45c68">02062</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a987a81820cda7bae995983ae1cc45c68">gg_remove_notify_ex</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> uin, <span class="keywordtype">char</span> type)
<a name="l02063"></a>02063 {
<a name="l02064"></a>02064         <span class="keyword">struct </span><a class="code" href="structgg__add__remove.html">gg_add_remove</a> a;
<a name="l02065"></a>02065 
<a name="l02066"></a>02066         gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a3370765722a4297e9cfdf876dad7f492">GG_DEBUG_FUNCTION</a>, <span class="stringliteral">&quot;** gg_remove_notify_ex(%p, %u, %d);\n&quot;</span>, sess, uin, type);
<a name="l02067"></a>02067 
<a name="l02068"></a>02068         <span class="keywordflow">if</span> (!sess) {
<a name="l02069"></a>02069                 errno = EFAULT;
<a name="l02070"></a>02070                 <span class="keywordflow">return</span> -1;
<a name="l02071"></a>02071         }
<a name="l02072"></a>02072 
<a name="l02073"></a>02073         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l02074"></a>02074                 errno = ENOTCONN;
<a name="l02075"></a>02075                 <span class="keywordflow">return</span> -1;
<a name="l02076"></a>02076         }
<a name="l02077"></a>02077 
<a name="l02078"></a>02078         a.uin = gg_fix32(uin);
<a name="l02079"></a>02079         a.dunno1 = type;
<a name="l02080"></a>02080 
<a name="l02081"></a>02081         <span class="keywordflow">return</span> gg_send_packet(sess, GG_REMOVE_NOTIFY, &amp;a, <span class="keyword">sizeof</span>(a), NULL);
<a name="l02082"></a>02082 }
<a name="l02083"></a>02083 
<a name="l02097"></a><a class="code" href="libgadu_8h.html#ab79e24e6654c40f331372bd05fbd62c6">02097</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#ab79e24e6654c40f331372bd05fbd62c6">gg_remove_notify</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> uin)
<a name="l02098"></a>02098 {
<a name="l02099"></a>02099         <span class="keywordflow">return</span> <a class="code" href="libgadu_8c.html#a987a81820cda7bae995983ae1cc45c68">gg_remove_notify_ex</a>(sess, uin, GG_USER_NORMAL);
<a name="l02100"></a>02100 }
<a name="l02101"></a>02101 
<a name="l02123"></a><a class="code" href="libgadu_8h.html#a21924150fd6eb96e8da4f9c124ec4b5d">02123</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a21924150fd6eb96e8da4f9c124ec4b5d">gg_userlist_request</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">char</span> type, <span class="keyword">const</span> <span class="keywordtype">char</span> *request)
<a name="l02124"></a>02124 {
<a name="l02125"></a>02125         <span class="keywordtype">int</span> len;
<a name="l02126"></a>02126 
<a name="l02127"></a>02127         <span class="keywordflow">if</span> (!sess) {
<a name="l02128"></a>02128                 errno = EFAULT;
<a name="l02129"></a>02129                 <span class="keywordflow">return</span> -1;
<a name="l02130"></a>02130         }
<a name="l02131"></a>02131 
<a name="l02132"></a>02132         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l02133"></a>02133                 errno = ENOTCONN;
<a name="l02134"></a>02134                 <span class="keywordflow">return</span> -1;
<a name="l02135"></a>02135         }
<a name="l02136"></a>02136 
<a name="l02137"></a>02137         <span class="keywordflow">if</span> (!request) {
<a name="l02138"></a>02138                 sess-&gt;<a class="code" href="structgg__session.html#a8205a18557ce55d43d07728a12c32a7e">userlist_blocks</a> = 1;
<a name="l02139"></a>02139                 <span class="keywordflow">return</span> gg_send_packet(sess, GG_USERLIST_REQUEST, &amp;type, <span class="keyword">sizeof</span>(type), NULL);
<a name="l02140"></a>02140         }
<a name="l02141"></a>02141 
<a name="l02142"></a>02142         len = strlen(request);
<a name="l02143"></a>02143 
<a name="l02144"></a>02144         sess-&gt;<a class="code" href="structgg__session.html#a8205a18557ce55d43d07728a12c32a7e">userlist_blocks</a> = 0;
<a name="l02145"></a>02145 
<a name="l02146"></a>02146         <span class="keywordflow">while</span> (len &gt; 2047) {
<a name="l02147"></a>02147                 sess-&gt;<a class="code" href="structgg__session.html#a8205a18557ce55d43d07728a12c32a7e">userlist_blocks</a>++;
<a name="l02148"></a>02148 
<a name="l02149"></a>02149                 <span class="keywordflow">if</span> (gg_send_packet(sess, GG_USERLIST_REQUEST, &amp;type, <span class="keyword">sizeof</span>(type), request, 2047, NULL) == -1)
<a name="l02150"></a>02150                         <span class="keywordflow">return</span> -1;
<a name="l02151"></a>02151 
<a name="l02152"></a>02152                 <span class="keywordflow">if</span> (type == GG_USERLIST_PUT)
<a name="l02153"></a>02153                         type = GG_USERLIST_PUT_MORE;
<a name="l02154"></a>02154 
<a name="l02155"></a>02155                 request += 2047;
<a name="l02156"></a>02156                 len -= 2047;
<a name="l02157"></a>02157         }
<a name="l02158"></a>02158 
<a name="l02159"></a>02159         sess-&gt;<a class="code" href="structgg__session.html#a8205a18557ce55d43d07728a12c32a7e">userlist_blocks</a>++;
<a name="l02160"></a>02160 
<a name="l02161"></a>02161         <span class="keywordflow">return</span> gg_send_packet(sess, GG_USERLIST_REQUEST, &amp;type, <span class="keyword">sizeof</span>(type), request, len, NULL);
<a name="l02162"></a>02162 }
<a name="l02163"></a>02163 
<a name="l02189"></a><a class="code" href="libgadu_8h.html#aac963e10f462185248412205132d73db">02189</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#aac963e10f462185248412205132d73db">gg_userlist100_request</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <span class="keywordtype">char</span> type, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> version, <span class="keywordtype">char</span> format_type, <span class="keyword">const</span> <span class="keywordtype">char</span> *request)
<a name="l02190"></a>02190 {
<a name="l02191"></a>02191         <span class="keyword">struct </span><a class="code" href="structgg__userlist100__request.html">gg_userlist100_request</a> pkt;
<a name="l02192"></a>02192         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *zrequest;
<a name="l02193"></a>02193         <span class="keywordtype">size_t</span> zrequest_len;
<a name="l02194"></a>02194         <span class="keywordtype">int</span> ret;
<a name="l02195"></a>02195 
<a name="l02196"></a>02196         <span class="keywordflow">if</span> (!sess) {
<a name="l02197"></a>02197                 errno = EFAULT;
<a name="l02198"></a>02198                 <span class="keywordflow">return</span> -1;
<a name="l02199"></a>02199         }
<a name="l02200"></a>02200 
<a name="l02201"></a>02201         <span class="keywordflow">if</span> (sess-&gt;state != <a class="code" href="libgadu_8h.html#afbb1b72a09ced0851effa5e75b31a6a7a751f461af644b2b4aef39181a2b8b428">GG_STATE_CONNECTED</a>) {
<a name="l02202"></a>02202                 errno = ENOTCONN;
<a name="l02203"></a>02203                 <span class="keywordflow">return</span> -1;
<a name="l02204"></a>02204         }
<a name="l02205"></a>02205 
<a name="l02206"></a>02206         pkt.type = type;
<a name="l02207"></a>02207         pkt.version = gg_fix32(version);
<a name="l02208"></a>02208         pkt.format_type = format_type;
<a name="l02209"></a>02209         pkt.unknown1 = 0x01;
<a name="l02210"></a>02210 
<a name="l02211"></a>02211         <span class="keywordflow">if</span> (request == NULL)
<a name="l02212"></a>02212                 <span class="keywordflow">return</span> gg_send_packet(sess, GG_USERLIST100_REQUEST, &amp;pkt, <span class="keyword">sizeof</span>(pkt), NULL);
<a name="l02213"></a>02213 
<a name="l02214"></a>02214         zrequest = gg_deflate(request, &amp;zrequest_len);
<a name="l02215"></a>02215 
<a name="l02216"></a>02216         <span class="keywordflow">if</span> (zrequest == NULL) {
<a name="l02217"></a>02217                 gg_debug_session(sess, <a class="code" href="libgadu_8h.html#a40e449afb3f941037e1227afe28ddace">GG_DEBUG_MISC</a>, <span class="stringliteral">&quot;// gg_userlist100_request() gg_deflate() failed&quot;</span>);
<a name="l02218"></a>02218                 <span class="keywordflow">return</span> -1;
<a name="l02219"></a>02219         }
<a name="l02220"></a>02220 
<a name="l02221"></a>02221         ret = gg_send_packet(sess, GG_USERLIST100_REQUEST, &amp;pkt, <span class="keyword">sizeof</span>(pkt), zrequest, zrequest_len, NULL);
<a name="l02222"></a>02222 
<a name="l02223"></a>02223         free(zrequest);
<a name="l02224"></a>02224 
<a name="l02225"></a>02225         <span class="keywordflow">return</span> ret;
<a name="l02226"></a>02226 }
<a name="l02227"></a>02227 
<a name="l02239"></a><a class="code" href="libgadu_8h.html#a27a5bb1766cbb99dae4e862eec635899">02239</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a27a5bb1766cbb99dae4e862eec635899">gg_typing_notification</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *sess, <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> recipient, <span class="keywordtype">int</span> length){
<a name="l02240"></a>02240         <span class="keyword">struct </span><a class="code" href="structgg__typing__notification.html">gg_typing_notification</a> pkt;
<a name="l02241"></a>02241         <a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a> uin;
<a name="l02242"></a>02242 
<a name="l02243"></a>02243         pkt.length = gg_fix16(length);
<a name="l02244"></a>02244         uin = gg_fix32(recipient);
<a name="l02245"></a>02245         memcpy(&amp;pkt.uin, &amp;uin, <span class="keyword">sizeof</span>(<a class="code" href="libgadu_8h.html#a33f630ba74294027f9bcda26ed49cdc8">uin_t</a>));
<a name="l02246"></a>02246 
<a name="l02247"></a>02247         <span class="keywordflow">return</span> gg_send_packet(sess, GG_TYPING_NOTIFICATION, &amp;pkt, <span class="keyword">sizeof</span>(pkt), NULL);
<a name="l02248"></a>02248 }
<a name="l02249"></a>02249 
<a name="l02260"></a><a class="code" href="libgadu_8h.html#a48a54ca3fa4e3a46bc2f0e40950b6595">02260</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a48a54ca3fa4e3a46bc2f0e40950b6595">gg_multilogon_disconnect</a>(<span class="keyword">struct</span> <a class="code" href="structgg__session.html">gg_session</a> *gs, <a class="code" href="structgg__multilogon__id__t.html">gg_multilogon_id_t</a> conn_id)
<a name="l02261"></a>02261 {
<a name="l02262"></a>02262         <span class="keyword">struct </span><a class="code" href="structgg__multilogon__disconnect.html">gg_multilogon_disconnect</a> pkt;
<a name="l02263"></a>02263 
<a name="l02264"></a>02264         pkt.conn_id = conn_id;
<a name="l02265"></a>02265 
<a name="l02266"></a>02266         <span class="keywordflow">return</span> gg_send_packet(gs, GG_MULTILOGON_DISCONNECT, &amp;pkt, <span class="keyword">sizeof</span>(pkt), NULL);
<a name="l02267"></a>02267 }
<a name="l02268"></a>02268 
<a name="l02269"></a>02269 <span class="comment">/* @} */</span>
<a name="l02270"></a>02270 
<a name="l02280"></a><a class="code" href="libgadu_8h.html#a70cd8e2f735c8e21fcf806e6e049226a">02280</a> <span class="keywordtype">int</span> <a class="code" href="libgadu_8c.html#a70cd8e2f735c8e21fcf806e6e049226a">gg_libgadu_check_feature</a>(<a class="code" href="libgadu_8h.html#ac4777982c5734d69b512cbfc950a9186">gg_libgadu_feature_t</a> feature)
<a name="l02281"></a>02281 {
<a name="l02282"></a>02282         <span class="keywordflow">switch</span> (feature)
<a name="l02283"></a>02283         {
<a name="l02284"></a>02284         <span class="keywordflow">case</span> <a class="code" href="libgadu_8h.html#ac4777982c5734d69b512cbfc950a9186a213849cb991914e39acaca4abdb24678">GG_LIBGADU_FEATURE_SSL</a>:
<a name="l02285"></a>02285 <span class="preprocessor">#if defined(GG_CONFIG_HAVE_OPENSSL) || defined(GG_CONFIG_HAVE_GNUTLS)</span>
<a name="l02286"></a>02286 <span class="preprocessor"></span>                <span class="keywordflow">return</span> 1;
<a name="l02287"></a>02287 <span class="preprocessor">#else</span>
<a name="l02288"></a>02288 <span class="preprocessor"></span>                <span class="keywordflow">return</span> 0;
<a name="l02289"></a>02289 <span class="preprocessor">#endif</span>
<a name="l02290"></a>02290 <span class="preprocessor"></span>
<a name="l02291"></a>02291         <span class="keywordflow">case</span> <a class="code" href="libgadu_8h.html#ac4777982c5734d69b512cbfc950a9186ac4fcd3efe2b8ef91ae82565b7b24d65a">GG_LIBGADU_FEATURE_PTHREAD</a>:
<a name="l02292"></a>02292 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_PTHREAD</span>
<a name="l02293"></a>02293 <span class="preprocessor"></span>                <span class="keywordflow">return</span> 1;
<a name="l02294"></a>02294 <span class="preprocessor">#else</span>
<a name="l02295"></a>02295 <span class="preprocessor"></span>                <span class="keywordflow">return</span> 0;
<a name="l02296"></a>02296 <span class="preprocessor">#endif</span>
<a name="l02297"></a>02297 <span class="preprocessor"></span>
<a name="l02298"></a>02298         <span class="keywordflow">case</span> <a class="code" href="libgadu_8h.html#ac4777982c5734d69b512cbfc950a9186a97ba961086b883d0cb80c5d787f0a04a">GG_LIBGADU_FEATURE_USERLIST100</a>:
<a name="l02299"></a>02299 <span class="preprocessor">#ifdef GG_CONFIG_HAVE_ZLIB</span>
<a name="l02300"></a>02300 <span class="preprocessor"></span>                <span class="keywordflow">return</span> 1;
<a name="l02301"></a>02301 <span class="preprocessor">#else</span>
<a name="l02302"></a>02302 <span class="preprocessor"></span>                <span class="keywordflow">return</span> 0;
<a name="l02303"></a>02303 <span class="preprocessor">#endif</span>
<a name="l02304"></a>02304 <span class="preprocessor"></span>
<a name="l02305"></a>02305         <span class="comment">/* Celowo nie ma default, żeby kompilator wyłapał brakujące funkcje */</span>
<a name="l02306"></a>02306 
<a name="l02307"></a>02307         }
<a name="l02308"></a>02308 
<a name="l02309"></a>02309         <span class="keywordflow">return</span> 0;
<a name="l02310"></a>02310 }
<a name="l02311"></a>02311 
<a name="l02312"></a>02312 <span class="comment">/*</span>
<a name="l02313"></a>02313 <span class="comment"> * Local variables:</span>
<a name="l02314"></a>02314 <span class="comment"> * c-indentation-style: k&amp;r</span>
<a name="l02315"></a>02315 <span class="comment"> * c-basic-offset: 8</span>
<a name="l02316"></a>02316 <span class="comment"> * indent-tabs-mode: notnil</span>
<a name="l02317"></a>02317 <span class="comment"> * End:</span>
<a name="l02318"></a>02318 <span class="comment"> *</span>
<a name="l02319"></a>02319 <span class="comment"> * vim: shiftwidth=8:</span>
<a name="l02320"></a>02320 <span class="comment"> */</span>
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="libgadu_8c.html">libgadu.c</a>      </li>
      <li class="footer">Generated on Sun Mar 24 2013 16:05:12 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
