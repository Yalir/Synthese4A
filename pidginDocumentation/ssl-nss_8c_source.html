<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>plugins/ssl/ssl-nss.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('ssl-nss_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">plugins/ssl/ssl-nss.c</div>  </div>
</div>
<div class="contents">
<a href="ssl-nss_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;internal.h&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="debug_8h.html">debug.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="certificate_8h.html">certificate.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="plugin_8h.html">plugin.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="sslconn_8h.html">sslconn.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="util_8h.html">util.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="version_8h.html">version.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#define SSL_NSS_PLUGIN_ID &quot;ssl-nss&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="preprocessor">#undef HAVE_LONG_LONG </span><span class="comment">/* Make Mozilla less angry. If angry, Mozilla SMASH! */</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;nspr.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;nss.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;nssb64.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;pk11func.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;prio.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;secerr.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;secmod.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;ssl.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;sslerr.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;sslproto.h&gt;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">/* This is defined in NSPR&#39;s &lt;private/pprio.h&gt;, but to avoid including a</span>
<a name="l00046"></a>00046 <span class="comment"> * private header we duplicate the prototype here */</span>
<a name="l00047"></a>00047 NSPR_API(PRFileDesc*)  PR_ImportTCPSocket(PRInt32 osfd);
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 typedef struct
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051         PRFileDesc *fd;
<a name="l00052"></a>00052         PRFileDesc *in;
<a name="l00053"></a>00053         guint handshake_handler;
<a name="l00054"></a>00054         guint handshake_timer;
<a name="l00055"></a>00055 } PurpleSslNssData;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#define PURPLE_SSL_NSS_DATA(gsc) ((PurpleSslNssData *)gsc-&gt;private_data)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a>00059 <span class="keyword">static</span> <span class="keyword">const</span> PRIOMethods *_nss_methods = NULL;
<a name="l00060"></a>00060 <span class="keyword">static</span> PRDescIdentity _identity;
<a name="l00061"></a>00061 <span class="keyword">static</span> <a class="code" href="struct___purple_certificate_scheme.html">PurpleCertificateScheme</a> x509_nss;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="comment">/* Thank you, Evolution */</span>
<a name="l00064"></a>00064 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00065"></a>00065 set_errno(<span class="keywordtype">int</span> code)
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067         <span class="comment">/* FIXME: this should handle more. */</span>
<a name="l00068"></a>00068         <span class="keywordflow">switch</span> (code) {
<a name="l00069"></a>00069         <span class="keywordflow">case</span> PR_INVALID_ARGUMENT_ERROR:
<a name="l00070"></a>00070                 errno = EINVAL;
<a name="l00071"></a>00071                 <span class="keywordflow">break</span>;
<a name="l00072"></a>00072         <span class="keywordflow">case</span> PR_PENDING_INTERRUPT_ERROR:
<a name="l00073"></a>00073                 errno = EINTR;
<a name="l00074"></a>00074                 <span class="keywordflow">break</span>;
<a name="l00075"></a>00075         <span class="keywordflow">case</span> PR_IO_PENDING_ERROR:
<a name="l00076"></a>00076                 errno = EAGAIN;
<a name="l00077"></a>00077                 <span class="keywordflow">break</span>;
<a name="l00078"></a>00078         <span class="keywordflow">case</span> PR_WOULD_BLOCK_ERROR:
<a name="l00079"></a>00079                 errno = EAGAIN;
<a name="l00080"></a>00080                 <span class="comment">/*errno = EWOULDBLOCK; */</span>
<a name="l00081"></a>00081                 <span class="keywordflow">break</span>;
<a name="l00082"></a>00082         <span class="keywordflow">case</span> PR_IN_PROGRESS_ERROR:
<a name="l00083"></a>00083                 errno = EINPROGRESS;
<a name="l00084"></a>00084                 <span class="keywordflow">break</span>;
<a name="l00085"></a>00085         <span class="keywordflow">case</span> PR_ALREADY_INITIATED_ERROR:
<a name="l00086"></a>00086                 errno = EALREADY;
<a name="l00087"></a>00087                 <span class="keywordflow">break</span>;
<a name="l00088"></a>00088         <span class="keywordflow">case</span> PR_NETWORK_UNREACHABLE_ERROR:
<a name="l00089"></a>00089                 errno = EHOSTUNREACH;
<a name="l00090"></a>00090                 <span class="keywordflow">break</span>;
<a name="l00091"></a>00091         <span class="keywordflow">case</span> PR_CONNECT_REFUSED_ERROR:
<a name="l00092"></a>00092                 errno = ECONNREFUSED;
<a name="l00093"></a>00093                 <span class="keywordflow">break</span>;
<a name="l00094"></a>00094         <span class="keywordflow">case</span> PR_CONNECT_TIMEOUT_ERROR:
<a name="l00095"></a>00095         <span class="keywordflow">case</span> PR_IO_TIMEOUT_ERROR:
<a name="l00096"></a>00096                 errno = ETIMEDOUT;
<a name="l00097"></a>00097                 <span class="keywordflow">break</span>;
<a name="l00098"></a>00098         <span class="keywordflow">case</span> PR_NOT_CONNECTED_ERROR:
<a name="l00099"></a>00099                 errno = ENOTCONN;
<a name="l00100"></a>00100                 <span class="keywordflow">break</span>;
<a name="l00101"></a>00101         <span class="keywordflow">case</span> PR_CONNECT_RESET_ERROR:
<a name="l00102"></a>00102                 errno = ECONNRESET;
<a name="l00103"></a>00103                 <span class="keywordflow">break</span>;
<a name="l00104"></a>00104         <span class="keywordflow">case</span> PR_IO_ERROR:
<a name="l00105"></a>00105         <span class="keywordflow">default</span>:
<a name="l00106"></a>00106                 errno = EIO;
<a name="l00107"></a>00107                 <span class="keywordflow">break</span>;
<a name="l00108"></a>00108         }
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="keyword">static</span> gchar *get_error_text(<span class="keywordtype">void</span>)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113         PRInt32 len = PR_GetErrorTextLength();
<a name="l00114"></a>00114         gchar *ret = NULL;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l00117"></a>00117                 ret = g_malloc(len + 1);
<a name="l00118"></a>00118                 len = PR_GetErrorText(ret);
<a name="l00119"></a>00119                 ret[len] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00120"></a>00120         }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122         <span class="keywordflow">return</span> ret;
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00126"></a>00126 ssl_nss_init_nss(<span class="keywordtype">void</span>)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128         PR_Init(PR_SYSTEM_THREAD, PR_PRIORITY_NORMAL, 1);
<a name="l00129"></a>00129         NSS_NoDB_Init(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00130"></a>00130         NSS_SetDomesticPolicy();
<a name="l00131"></a>00131 
<a name="l00132"></a>00132         SSL_CipherPrefSetDefault(TLS_DHE_RSA_WITH_AES_256_CBC_SHA, 1);
<a name="l00133"></a>00133         SSL_CipherPrefSetDefault(TLS_DHE_DSS_WITH_AES_256_CBC_SHA, 1);
<a name="l00134"></a>00134         SSL_CipherPrefSetDefault(TLS_RSA_WITH_AES_256_CBC_SHA, 1);
<a name="l00135"></a>00135         SSL_CipherPrefSetDefault(TLS_DHE_DSS_WITH_RC4_128_SHA, 1);
<a name="l00136"></a>00136         SSL_CipherPrefSetDefault(TLS_DHE_RSA_WITH_AES_128_CBC_SHA, 1);
<a name="l00137"></a>00137         SSL_CipherPrefSetDefault(TLS_DHE_DSS_WITH_AES_128_CBC_SHA, 1);
<a name="l00138"></a>00138         SSL_CipherPrefSetDefault(SSL_RSA_WITH_RC4_128_SHA, 1);
<a name="l00139"></a>00139         SSL_CipherPrefSetDefault(TLS_RSA_WITH_AES_128_CBC_SHA, 1);
<a name="l00140"></a>00140         SSL_CipherPrefSetDefault(SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, 1);
<a name="l00141"></a>00141         SSL_CipherPrefSetDefault(SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, 1);
<a name="l00142"></a>00142         SSL_CipherPrefSetDefault(SSL_DHE_RSA_WITH_DES_CBC_SHA, 1);
<a name="l00143"></a>00143         SSL_CipherPrefSetDefault(SSL_DHE_DSS_WITH_DES_CBC_SHA, 1);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145         _identity = PR_GetUniqueIdentity(<span class="stringliteral">&quot;Purple&quot;</span>);
<a name="l00146"></a>00146         _nss_methods = PR_GetDefaultIOMethods();
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="keyword">static</span> SECStatus
<a name="l00150"></a>00150 ssl_auth_cert(<span class="keywordtype">void</span> *arg, PRFileDesc *socket, PRBool checksig,
<a name="l00151"></a>00151                           PRBool is_server)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153         <span class="keywordflow">return</span> SECSuccess;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 <span class="preprocessor">#if 0</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span>        CERTCertificate *cert;
<a name="l00157"></a>00157         <span class="keywordtype">void</span> *pinArg;
<a name="l00158"></a>00158         SECStatus status;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160         cert = SSL_PeerCertificate(socket);
<a name="l00161"></a>00161         pinArg = SSL_RevealPinArg(socket);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         status = CERT_VerifyCertNow((CERTCertDBHandle *)arg, cert, checksig,
<a name="l00164"></a>00164                                                                 certUsageSSLClient, pinArg);
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         <span class="keywordflow">if</span> (status != SECSuccess) {
<a name="l00167"></a>00167                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;CERT_VerifyCertNow failed\n&quot;</span>);
<a name="l00168"></a>00168                 CERT_DestroyCertificate(cert);
<a name="l00169"></a>00169                 <span class="keywordflow">return</span> status;
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         CERT_DestroyCertificate(cert);
<a name="l00173"></a>00173         <span class="keywordflow">return</span> SECSuccess;
<a name="l00174"></a>00174 <span class="preprocessor">#endif</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>}
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="preprocessor">#if 0</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span><span class="keyword">static</span> SECStatus
<a name="l00179"></a>00179 ssl_bad_cert(<span class="keywordtype">void</span> *arg, PRFileDesc *socket)
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181         SECStatus status = SECFailure;
<a name="l00182"></a>00182         PRErrorCode err;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         <span class="keywordflow">if</span> (arg == NULL)
<a name="l00185"></a>00185                 <span class="keywordflow">return</span> status;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187         *(PRErrorCode *)arg = err = PORT_GetError();
<a name="l00188"></a>00188 
<a name="l00189"></a>00189         <span class="keywordflow">switch</span> (err)
<a name="l00190"></a>00190         {
<a name="l00191"></a>00191                 <span class="keywordflow">case</span> SEC_ERROR_INVALID_AVA:
<a name="l00192"></a>00192                 <span class="keywordflow">case</span> SEC_ERROR_INVALID_TIME:
<a name="l00193"></a>00193                 <span class="keywordflow">case</span> SEC_ERROR_BAD_SIGNATURE:
<a name="l00194"></a>00194                 <span class="keywordflow">case</span> SEC_ERROR_EXPIRED_CERTIFICATE:
<a name="l00195"></a>00195                 <span class="keywordflow">case</span> SEC_ERROR_UNKNOWN_ISSUER:
<a name="l00196"></a>00196                 <span class="keywordflow">case</span> SEC_ERROR_UNTRUSTED_CERT:
<a name="l00197"></a>00197                 <span class="keywordflow">case</span> SEC_ERROR_CERT_VALID:
<a name="l00198"></a>00198                 <span class="keywordflow">case</span> SEC_ERROR_EXPIRED_ISSUER_CERTIFICATE:
<a name="l00199"></a>00199                 <span class="keywordflow">case</span> SEC_ERROR_CRL_EXPIRED:
<a name="l00200"></a>00200                 <span class="keywordflow">case</span> SEC_ERROR_CRL_BAD_SIGNATURE:
<a name="l00201"></a>00201                 <span class="keywordflow">case</span> SEC_ERROR_EXTENSION_VALUE_INVALID:
<a name="l00202"></a>00202                 <span class="keywordflow">case</span> SEC_ERROR_CA_CERT_INVALID:
<a name="l00203"></a>00203                 <span class="keywordflow">case</span> SEC_ERROR_CERT_USAGES_INVALID:
<a name="l00204"></a>00204                 <span class="keywordflow">case</span> SEC_ERROR_UNKNOWN_CRITICAL_EXTENSION:
<a name="l00205"></a>00205                         status = SECSuccess;
<a name="l00206"></a>00206                         <span class="keywordflow">break</span>;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208                 <span class="keywordflow">default</span>:
<a name="l00209"></a>00209                         status = SECFailure;
<a name="l00210"></a>00210                         <span class="keywordflow">break</span>;
<a name="l00211"></a>00211         }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;Bad certificate: %d\n&quot;</span>, err);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="keywordflow">return</span> status;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 <span class="preprocessor">#endif</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>
<a name="l00219"></a>00219 <span class="keyword">static</span> gboolean
<a name="l00220"></a>00220 ssl_nss_init(<span class="keywordtype">void</span>)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222    <span class="keywordflow">return</span> TRUE;
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00226"></a>00226 ssl_nss_uninit(<span class="keywordtype">void</span>)
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228         NSS_Shutdown();
<a name="l00229"></a>00229         PR_Cleanup();
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         _nss_methods = NULL;
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00235"></a>00235 ssl_nss_verified_cb(PurpleCertificateVerificationStatus st,
<a name="l00236"></a>00236                        gpointer userdata)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238         <a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *gsc = (<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *) userdata;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (st == PURPLE_CERTIFICATE_VALID) {
<a name="l00241"></a>00241                 <span class="comment">/* Certificate valid? Good! Do the connection! */</span>
<a name="l00242"></a>00242                 gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a439700f2b4e3568fec14a787176de873">connect_cb</a>(gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a4d6e5627e1a64b9e17edb6270d4460c9">connect_cb_data</a>, gsc, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a04a9339a9f5df8019b8afc3af679ec9e">PURPLE_INPUT_READ</a>);
<a name="l00243"></a>00243         } <span class="keywordflow">else</span> {
<a name="l00244"></a>00244                 <span class="comment">/* Otherwise, signal an error */</span>
<a name="l00245"></a>00245                 <span class="keywordflow">if</span>(gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a1d0230e7919e2cd8c4f0c21d1191a0b5">error_cb</a> != NULL)
<a name="l00246"></a>00246                         gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a1d0230e7919e2cd8c4f0c21d1191a0b5">error_cb</a>(gsc, PURPLE_SSL_CERTIFICATE_INVALID,
<a name="l00247"></a>00247                                       gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a4d6e5627e1a64b9e17edb6270d4460c9">connect_cb_data</a>);
<a name="l00248"></a>00248                 purple_ssl_close(gsc);
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00257"></a>00257 <span class="keyword">static</span> <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *
<a name="l00258"></a>00258 x509_import_from_nss(CERTCertificate* cert)
<a name="l00259"></a>00259 {
<a name="l00260"></a>00260         <span class="comment">/* New certificate to return */</span>
<a name="l00261"></a>00261         <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> * crt;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263         <span class="comment">/* Allocate the certificate and load it with data */</span>
<a name="l00264"></a>00264         crt = g_new0(<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a>, 1);
<a name="l00265"></a>00265         crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> = &amp;x509_nss;
<a name="l00266"></a>00266         crt-&gt;<a class="code" href="struct___purple_certificate.html#ac2d150b349f3d00b3c333b5e16c30449">data</a> = CERT_DupCertificate(cert);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <span class="keywordflow">return</span> crt;
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="keyword">static</span> GList *
<a name="l00272"></a>00272 ssl_nss_get_peer_certificates(PRFileDesc *socket, <a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> * gsc)
<a name="l00273"></a>00273 {
<a name="l00274"></a>00274         CERTCertificate *curcert;
<a name="l00275"></a>00275         CERTCertificate *issuerCert;
<a name="l00276"></a>00276         <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> * newcrt;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="comment">/* List of Certificate instances to return */</span>
<a name="l00279"></a>00279         GList * peer_certs = NULL;
<a name="l00280"></a>00280         <span class="keywordtype">int</span> count;
<a name="l00281"></a>00281         int64 now = PR_Now();
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         curcert = SSL_PeerCertificate(socket);
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (curcert == NULL) {
<a name="l00285"></a>00285                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;could not DupCertificate\n&quot;</span>);
<a name="l00286"></a>00286                 <span class="keywordflow">return</span> NULL;
<a name="l00287"></a>00287         }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keywordflow">for</span> (count = 0 ; count &lt; CERT_MAX_CERT_CHAIN ; count++) {
<a name="l00290"></a>00290                 <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;subject=%s issuer=%s\n&quot;</span>, curcert-&gt;subjectName,
<a name="l00291"></a>00291                                                   curcert-&gt;issuerName  ? curcert-&gt;issuerName : <span class="stringliteral">&quot;(null)&quot;</span>);
<a name="l00292"></a>00292                 newcrt = x509_import_from_nss(curcert);
<a name="l00293"></a>00293                 peer_certs = g_list_append(peer_certs, newcrt);
<a name="l00294"></a>00294 
<a name="l00295"></a>00295                 <span class="keywordflow">if</span> (curcert-&gt;isRoot) {
<a name="l00296"></a>00296                         <span class="keywordflow">break</span>;
<a name="l00297"></a>00297                 }
<a name="l00298"></a>00298                 issuerCert = CERT_FindCertIssuer(curcert, now, certUsageSSLServer);
<a name="l00299"></a>00299                 <span class="keywordflow">if</span> (!issuerCert) {
<a name="l00300"></a>00300                         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;partial certificate chain\n&quot;</span>);
<a name="l00301"></a>00301                         <span class="keywordflow">break</span>;
<a name="l00302"></a>00302                 }
<a name="l00303"></a>00303                 CERT_DestroyCertificate(curcert);
<a name="l00304"></a>00304                 curcert = issuerCert;
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306         CERT_DestroyCertificate(curcert);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         <span class="keywordflow">return</span> peer_certs;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00312"></a>00312 ssl_nss_handshake_cb(gpointer data, <span class="keywordtype">int</span> fd, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3">PurpleInputCondition</a> cond)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314         <a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *gsc = (<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *)data;
<a name="l00315"></a>00315         PurpleSslNssData *nss_data = gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a93a75a9c2aab285e1997e775b9be60a6">private_data</a>;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <span class="comment">/* I don&#39;t think this the best way to do this...</span>
<a name="l00318"></a>00318 <span class="comment">         * It seems to work because it&#39;ll eventually use the cached value</span>
<a name="l00319"></a>00319 <span class="comment">         */</span>
<a name="l00320"></a>00320         <span class="keywordflow">if</span>(SSL_ForceHandshake(nss_data-&gt;in) != SECSuccess) {
<a name="l00321"></a>00321                 gchar *error_txt;
<a name="l00322"></a>00322                 set_errno(PR_GetError());
<a name="l00323"></a>00323                 <span class="keywordflow">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)
<a name="l00324"></a>00324                         <span class="keywordflow">return</span>;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326                 error_txt = get_error_text();
<a name="l00327"></a>00327                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;Handshake failed %s (%d)\n&quot;</span>, error_txt ? error_txt : <span class="stringliteral">&quot;&quot;</span>, PR_GetError());
<a name="l00328"></a>00328                 g_free(error_txt);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330                 <span class="keywordflow">if</span> (gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a1d0230e7919e2cd8c4f0c21d1191a0b5">error_cb</a> != NULL)
<a name="l00331"></a>00331                         gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a1d0230e7919e2cd8c4f0c21d1191a0b5">error_cb</a>(gsc, PURPLE_SSL_HANDSHAKE_FAILED, gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a4d6e5627e1a64b9e17edb6270d4460c9">connect_cb_data</a>);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333                 purple_ssl_close(gsc);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335                 <span class="keywordflow">return</span>;
<a name="l00336"></a>00336         }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338         <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(nss_data-&gt;handshake_handler);
<a name="l00339"></a>00339         nss_data-&gt;handshake_handler = 0;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">/* If a Verifier was given, hand control over to it */</span>
<a name="l00342"></a>00342         <span class="keywordflow">if</span> (gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#acaa17acd2bdd2bdccf6b4cffd2481c90">verifier</a>) {
<a name="l00343"></a>00343                 GList *peers;
<a name="l00344"></a>00344                 <span class="comment">/* First, get the peer cert chain */</span>
<a name="l00345"></a>00345                 peers = ssl_nss_get_peer_certificates(nss_data-&gt;in, gsc);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347                 <span class="comment">/* Now kick off the verification process */</span>
<a name="l00348"></a>00348                 purple_certificate_verify(gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#acaa17acd2bdd2bdccf6b4cffd2481c90">verifier</a>,
<a name="l00349"></a>00349                                 gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a30b603b1954be6113242ec013680f3a4">host</a>,
<a name="l00350"></a>00350                                 peers,
<a name="l00351"></a>00351                                 ssl_nss_verified_cb,
<a name="l00352"></a>00352                                 gsc);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                 purple_certificate_destroy_list(peers);
<a name="l00355"></a>00355         } <span class="keywordflow">else</span> {
<a name="l00356"></a>00356                 <span class="comment">/* Otherwise, just call the &quot;connection complete&quot;</span>
<a name="l00357"></a>00357 <span class="comment">                   callback */</span>
<a name="l00358"></a>00358                 gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a439700f2b4e3568fec14a787176de873">connect_cb</a>(gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a4d6e5627e1a64b9e17edb6270d4460c9">connect_cb_data</a>, gsc, cond);
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="keyword">static</span> gboolean
<a name="l00363"></a>00363 start_handshake_cb(gpointer data)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365         <a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *gsc = data;
<a name="l00366"></a>00366         PurpleSslNssData *nss_data = PURPLE_SSL_NSS_DATA(gsc);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368         nss_data-&gt;handshake_timer = 0;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370         ssl_nss_handshake_cb(gsc, gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a96fc1a70065540dbf86d704d46382100">fd</a>, <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a04a9339a9f5df8019b8afc3af679ec9e">PURPLE_INPUT_READ</a>);
<a name="l00371"></a>00371         <span class="keywordflow">return</span> FALSE;
<a name="l00372"></a>00372 }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00375"></a>00375 ssl_nss_connect(<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *gsc)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377         PurpleSslNssData *nss_data = g_new0(PurpleSslNssData, 1);
<a name="l00378"></a>00378         PRSocketOptionData socket_opt;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a93a75a9c2aab285e1997e775b9be60a6">private_data</a> = nss_data;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         nss_data-&gt;fd = PR_ImportTCPSocket(gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a96fc1a70065540dbf86d704d46382100">fd</a>);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (nss_data-&gt;fd == NULL)
<a name="l00385"></a>00385         {
<a name="l00386"></a>00386                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;nss_data-&gt;fd == NULL!\n&quot;</span>);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388                 <span class="keywordflow">if</span> (gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a1d0230e7919e2cd8c4f0c21d1191a0b5">error_cb</a> != NULL)
<a name="l00389"></a>00389                         gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a1d0230e7919e2cd8c4f0c21d1191a0b5">error_cb</a>(gsc, PURPLE_SSL_CONNECT_FAILED, gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a4d6e5627e1a64b9e17edb6270d4460c9">connect_cb_data</a>);
<a name="l00390"></a>00390 
<a name="l00391"></a>00391                 purple_ssl_close((<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *)gsc);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393                 <span class="keywordflow">return</span>;
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         socket_opt.option = PR_SockOpt_Nonblocking;
<a name="l00397"></a>00397         socket_opt.value.non_blocking = PR_TRUE;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         <span class="keywordflow">if</span> (PR_SetSocketOption(nss_data-&gt;fd, &amp;socket_opt) != PR_SUCCESS) {
<a name="l00400"></a>00400                 gchar *error_txt = get_error_text();
<a name="l00401"></a>00401                 <a class="code" href="debug_8h.html#a73ce6863806209621433421e69487799">purple_debug_warning</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;unable to set socket into non-blocking mode: %s (%d)\n&quot;</span>, error_txt ? error_txt : <span class="stringliteral">&quot;&quot;</span>, PR_GetError());
<a name="l00402"></a>00402                 g_free(error_txt);
<a name="l00403"></a>00403         }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         nss_data-&gt;in = SSL_ImportFD(NULL, nss_data-&gt;fd);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407         <span class="keywordflow">if</span> (nss_data-&gt;in == NULL)
<a name="l00408"></a>00408         {
<a name="l00409"></a>00409                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss&quot;</span>, <span class="stringliteral">&quot;nss_data-&gt;in == NUL!\n&quot;</span>);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411                 <span class="keywordflow">if</span> (gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a1d0230e7919e2cd8c4f0c21d1191a0b5">error_cb</a> != NULL)
<a name="l00412"></a>00412                         gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a1d0230e7919e2cd8c4f0c21d1191a0b5">error_cb</a>(gsc, PURPLE_SSL_CONNECT_FAILED, gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a4d6e5627e1a64b9e17edb6270d4460c9">connect_cb_data</a>);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414                 purple_ssl_close((<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *)gsc);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416                 <span class="keywordflow">return</span>;
<a name="l00417"></a>00417         }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         SSL_OptionSet(nss_data-&gt;in, SSL_SECURITY,            PR_TRUE);
<a name="l00420"></a>00420         SSL_OptionSet(nss_data-&gt;in, SSL_HANDSHAKE_AS_CLIENT, PR_TRUE);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422         SSL_AuthCertificateHook(nss_data-&gt;in,
<a name="l00423"></a>00423                                                         (SSLAuthCertificate)ssl_auth_cert,
<a name="l00424"></a>00424                                                         (<span class="keywordtype">void</span> *)CERT_GetDefaultCertDB());
<a name="l00425"></a>00425 <span class="preprocessor">#if 0</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>        <span class="comment">/* No point in hooking BadCert, since ssl_auth_cert always succeeds */</span>
<a name="l00427"></a>00427         SSL_BadCertHook(nss_data-&gt;in, (SSLBadCertHandler)ssl_bad_cert, NULL);
<a name="l00428"></a>00428 <span class="preprocessor">#endif</span>
<a name="l00429"></a>00429 <span class="preprocessor"></span>
<a name="l00430"></a>00430         <span class="keywordflow">if</span>(gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a30b603b1954be6113242ec013680f3a4">host</a>)
<a name="l00431"></a>00431                 SSL_SetURL(nss_data-&gt;in, gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a30b603b1954be6113242ec013680f3a4">host</a>);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="preprocessor">#if 0</span>
<a name="l00434"></a>00434 <span class="preprocessor"></span>        <span class="comment">/* This seems like it&#39;d the be the correct way to implement the</span>
<a name="l00435"></a>00435 <span class="comment">        nonblocking stuff, but it doesn&#39;t seem to work */</span>
<a name="l00436"></a>00436         SSL_HandshakeCallback(nss_data-&gt;in,
<a name="l00437"></a>00437                 (SSLHandshakeCallback) ssl_nss_handshake_cb, gsc);
<a name="l00438"></a>00438 <span class="preprocessor">#endif</span>
<a name="l00439"></a>00439 <span class="preprocessor"></span>        SSL_ResetHandshake(nss_data-&gt;in, PR_FALSE);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         nss_data-&gt;handshake_handler = <a class="code" href="eventloop_8c.html#ad4f7f5fdc0ee617d0e3fe358f04f838b">purple_input_add</a>(gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a96fc1a70065540dbf86d704d46382100">fd</a>,
<a name="l00442"></a>00442                 <a class="code" href="eventloop_8h.html#ae16a4b18f1da57dff1eb139e934fffb3a04a9339a9f5df8019b8afc3af679ec9e">PURPLE_INPUT_READ</a>, ssl_nss_handshake_cb, gsc);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444         nss_data-&gt;handshake_timer = <a class="code" href="eventloop_8c.html#aadefb8b6d8b677ba989e47cbf8a05806">purple_timeout_add</a>(0, start_handshake_cb, gsc);
<a name="l00445"></a>00445 }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00448"></a>00448 ssl_nss_close(<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *gsc)
<a name="l00449"></a>00449 {
<a name="l00450"></a>00450         PurpleSslNssData *nss_data = PURPLE_SSL_NSS_DATA(gsc);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452         <span class="keywordflow">if</span>(!nss_data)
<a name="l00453"></a>00453                 <span class="keywordflow">return</span>;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455         <span class="keywordflow">if</span> (nss_data-&gt;in) {
<a name="l00456"></a>00456                 PR_Close(nss_data-&gt;in);
<a name="l00457"></a>00457                 gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a96fc1a70065540dbf86d704d46382100">fd</a> = -1;
<a name="l00458"></a>00458         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nss_data-&gt;fd) {
<a name="l00459"></a>00459                 PR_Close(nss_data-&gt;fd);
<a name="l00460"></a>00460                 gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a96fc1a70065540dbf86d704d46382100">fd</a> = -1;
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463         <span class="keywordflow">if</span> (nss_data-&gt;handshake_handler)
<a name="l00464"></a>00464                 <a class="code" href="eventloop_8c.html#ae309cb053b0e7984f10d9886367ed84e">purple_input_remove</a>(nss_data-&gt;handshake_handler);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466         <span class="keywordflow">if</span> (nss_data-&gt;handshake_timer)
<a name="l00467"></a>00467                 <a class="code" href="eventloop_8c.html#aa63215615dfb1d5e8e61612520e5ec27">purple_timeout_remove</a>(nss_data-&gt;handshake_timer);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         g_free(nss_data);
<a name="l00470"></a>00470         gsc-&gt;<a class="code" href="struct___purple_ssl_connection.html#a93a75a9c2aab285e1997e775b9be60a6">private_data</a> = NULL;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00474"></a>00474 ssl_nss_read(<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *gsc, <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> len)
<a name="l00475"></a>00475 {
<a name="l00476"></a>00476         ssize_t ret;
<a name="l00477"></a>00477         PurpleSslNssData *nss_data = PURPLE_SSL_NSS_DATA(gsc);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479         ret = PR_Read(nss_data-&gt;in, data, len);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         <span class="keywordflow">if</span> (ret == -1)
<a name="l00482"></a>00482                 set_errno(PR_GetError());
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         <span class="keywordflow">return</span> ret;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00488"></a>00488 ssl_nss_write(<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *gsc, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> len)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490         ssize_t ret;
<a name="l00491"></a>00491         PurpleSslNssData *nss_data = PURPLE_SSL_NSS_DATA(gsc);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493         <span class="keywordflow">if</span>(!nss_data)
<a name="l00494"></a>00494                 <span class="keywordflow">return</span> 0;
<a name="l00495"></a>00495 
<a name="l00496"></a>00496         ret = PR_Write(nss_data-&gt;in, data, len);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <span class="keywordflow">if</span> (ret == -1)
<a name="l00499"></a>00499                 set_errno(PR_GetError());
<a name="l00500"></a>00500 
<a name="l00501"></a>00501         <span class="keywordflow">return</span> ret;
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 <span class="keyword">static</span> GList *
<a name="l00505"></a>00505 ssl_nss_peer_certs(<a class="code" href="struct___purple_ssl_connection.html">PurpleSslConnection</a> *gsc)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507 <span class="preprocessor">#if 0</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span>        PurpleSslNssData *nss_data = PURPLE_SSL_NSS_DATA(gsc);
<a name="l00509"></a>00509         CERTCertificate *cert;
<a name="l00510"></a>00510 <span class="comment">/*</span>
<a name="l00511"></a>00511 <span class="comment">        GList *chain = NULL;</span>
<a name="l00512"></a>00512 <span class="comment">        void *pinArg;</span>
<a name="l00513"></a>00513 <span class="comment">        SECStatus status;</span>
<a name="l00514"></a>00514 <span class="comment">*/</span>
<a name="l00515"></a>00515 
<a name="l00516"></a>00516         <span class="comment">/* TODO: this is a blind guess */</span>
<a name="l00517"></a>00517         cert = SSL_PeerCertificate(nss_data-&gt;fd);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         <span class="keywordflow">if</span> (cert)
<a name="l00520"></a>00520                 CERT_DestroyCertificate(cert);
<a name="l00521"></a>00521 <span class="preprocessor">#endif</span>
<a name="l00522"></a>00522 <span class="preprocessor"></span>
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="keywordflow">return</span> NULL;
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 <span class="comment">/************************************************************************/</span>
<a name="l00529"></a>00529 <span class="comment">/* X.509 functionality                                                  */</span>
<a name="l00530"></a>00530 <span class="comment">/************************************************************************/</span>
<a name="l00531"></a>00531 <span class="keyword">static</span> <a class="code" href="struct___purple_certificate_scheme.html">PurpleCertificateScheme</a> x509_nss;
<a name="l00532"></a>00532 
<a name="l00534"></a><a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">00534</a> <span class="preprocessor">#define X509_NSS_DATA(pcrt) ( (CERTCertificate * ) (pcrt-&gt;data) )</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span>
<a name="l00541"></a>00541 <span class="keyword">static</span> <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *
<a name="l00542"></a>00542 x509_import_from_file(<span class="keyword">const</span> gchar *filename)
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544         gchar *rawcert;
<a name="l00545"></a>00545         gsize len = 0;
<a name="l00546"></a>00546         CERTCertificate *crt_dat;
<a name="l00547"></a>00547         <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549         g_return_val_if_fail(filename != NULL, NULL);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>,
<a name="l00552"></a>00552                           <span class="stringliteral">&quot;Loading certificate from %s\n&quot;</span>,
<a name="l00553"></a>00553                           filename);
<a name="l00554"></a>00554 
<a name="l00555"></a>00555         <span class="comment">/* Load the raw data up */</span>
<a name="l00556"></a>00556         <span class="keywordflow">if</span> (!g_file_get_contents(filename,
<a name="l00557"></a>00557                                  &amp;rawcert, &amp;len,
<a name="l00558"></a>00558                                  NULL)) {
<a name="l00559"></a>00559                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>, <span class="stringliteral">&quot;Unable to read certificate file.\n&quot;</span>);
<a name="l00560"></a>00560                 <span class="keywordflow">return</span> NULL;
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563         <span class="keywordflow">if</span> (len == 0) {
<a name="l00564"></a>00564                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>,
<a name="l00565"></a>00565                                 <span class="stringliteral">&quot;Certificate file has no contents!\n&quot;</span>);
<a name="l00566"></a>00566                 <span class="keywordflow">if</span> (rawcert)
<a name="l00567"></a>00567                         g_free(rawcert);
<a name="l00568"></a>00568                 <span class="keywordflow">return</span> NULL;
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         <span class="comment">/* Decode the certificate */</span>
<a name="l00572"></a>00572         crt_dat = CERT_DecodeCertFromPackage(rawcert, len);
<a name="l00573"></a>00573         g_free(rawcert);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         g_return_val_if_fail(crt_dat != NULL, NULL);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         crt = g_new0(<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a>, 1);
<a name="l00578"></a>00578         crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> = &amp;x509_nss;
<a name="l00579"></a>00579         crt-&gt;<a class="code" href="struct___purple_certificate.html#ac2d150b349f3d00b3c333b5e16c30449">data</a> = crt_dat;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <span class="keywordflow">return</span> crt;
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 
<a name="l00589"></a>00589 <span class="keyword">static</span> GSList *
<a name="l00590"></a>00590 x509_importcerts_from_file(<span class="keyword">const</span> gchar *filename)
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592         gchar *rawcert, *begin, *end;
<a name="l00593"></a>00593         gsize len = 0;
<a name="l00594"></a>00594         GSList *crts = NULL;
<a name="l00595"></a>00595         CERTCertificate *crt_dat;
<a name="l00596"></a>00596         <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         g_return_val_if_fail(filename != NULL, NULL);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>,
<a name="l00601"></a>00601                           <span class="stringliteral">&quot;Loading certificate from %s\n&quot;</span>,
<a name="l00602"></a>00602                           filename);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         <span class="comment">/* Load the raw data up */</span>
<a name="l00605"></a>00605         <span class="keywordflow">if</span> (!g_file_get_contents(filename,
<a name="l00606"></a>00606                                  &amp;rawcert, &amp;len,
<a name="l00607"></a>00607                                  NULL)) {
<a name="l00608"></a>00608                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>, <span class="stringliteral">&quot;Unable to read certificate file.\n&quot;</span>);
<a name="l00609"></a>00609                 <span class="keywordflow">return</span> NULL;
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         <span class="keywordflow">if</span> (len == 0) {
<a name="l00613"></a>00613                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>,
<a name="l00614"></a>00614                                 <span class="stringliteral">&quot;Certificate file has no contents!\n&quot;</span>);
<a name="l00615"></a>00615                 <span class="keywordflow">if</span> (rawcert)
<a name="l00616"></a>00616                         g_free(rawcert);
<a name="l00617"></a>00617                 <span class="keywordflow">return</span> NULL;
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         begin = rawcert;
<a name="l00621"></a>00621         <span class="keywordflow">while</span>((end = strstr(begin, <span class="stringliteral">&quot;-----END CERTIFICATE-----&quot;</span>)) != NULL) {
<a name="l00622"></a>00622                 end += <span class="keyword">sizeof</span>(<span class="stringliteral">&quot;-----END CERTIFICATE-----&quot;</span>)-1;
<a name="l00623"></a>00623                 <span class="comment">/* Decode the certificate */</span>
<a name="l00624"></a>00624                 crt_dat = CERT_DecodeCertFromPackage(begin, (end-begin));
<a name="l00625"></a>00625 
<a name="l00626"></a>00626                 g_return_val_if_fail(crt_dat != NULL, NULL);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628                 crt = g_new0(<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a>, 1);
<a name="l00629"></a>00629                 crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> = &amp;x509_nss;
<a name="l00630"></a>00630                 crt-&gt;<a class="code" href="struct___purple_certificate.html#ac2d150b349f3d00b3c333b5e16c30449">data</a> = crt_dat;
<a name="l00631"></a>00631                 crts = g_slist_prepend(crts, crt);
<a name="l00632"></a>00632                 begin = end;
<a name="l00633"></a>00633         }
<a name="l00634"></a>00634         g_free(rawcert);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         <span class="keywordflow">return</span> crts;
<a name="l00637"></a>00637 }
<a name="l00645"></a>00645 <span class="comment">/* This function should not be so complicated, but NSS doesn&#39;t seem to have a</span>
<a name="l00646"></a>00646 <span class="comment">   &quot;convert yon certificate to PEM format&quot; function. */</span>
<a name="l00647"></a>00647 <span class="keyword">static</span> gboolean
<a name="l00648"></a>00648 x509_export_certificate(<span class="keyword">const</span> gchar *filename, <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650         CERTCertificate *crt_dat;
<a name="l00651"></a>00651         SECItem *dercrt;
<a name="l00652"></a>00652         gchar *b64crt;
<a name="l00653"></a>00653         gchar *pemcrt;
<a name="l00654"></a>00654         gboolean ret = FALSE;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656         g_return_val_if_fail(filename, FALSE);
<a name="l00657"></a>00657         g_return_val_if_fail(crt, FALSE);
<a name="l00658"></a>00658         g_return_val_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss, FALSE);
<a name="l00659"></a>00659 
<a name="l00660"></a>00660         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00661"></a>00661         g_return_val_if_fail(crt_dat, FALSE);
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         <a class="code" href="debug_8h.html#a112ab6ae0c750309516442f315002bee">purple_debug_info</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>,
<a name="l00664"></a>00664                           <span class="stringliteral">&quot;Exporting certificate to %s\n&quot;</span>, filename);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         <span class="comment">/* First, use NSS voodoo to create a DER-formatted certificate */</span>
<a name="l00667"></a>00667         dercrt = SEC_ASN1EncodeItem(NULL, NULL, crt_dat,
<a name="l00668"></a>00668                                     SEC_ASN1_GET(SEC_SignedCertificateTemplate));
<a name="l00669"></a>00669         g_return_val_if_fail(dercrt != NULL, FALSE);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <span class="comment">/* Now encode it to b64 */</span>
<a name="l00672"></a>00672         b64crt = NSSBase64_EncodeItem(NULL, NULL, 0, dercrt);
<a name="l00673"></a>00673         SECITEM_FreeItem(dercrt, PR_TRUE);
<a name="l00674"></a>00674         g_return_val_if_fail(b64crt, FALSE);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         <span class="comment">/* Wrap it in nice PEM header things */</span>
<a name="l00677"></a>00677         pemcrt = g_strdup_printf(<span class="stringliteral">&quot;-----BEGIN CERTIFICATE-----\n%s\n-----END CERTIFICATE-----\n&quot;</span>, b64crt);
<a name="l00678"></a>00678         PORT_Free(b64crt); <span class="comment">/* Notice that b64crt was allocated by an NSS</span>
<a name="l00679"></a>00679 <span class="comment">                              function; hence, we&#39;ll let NSPR free it. */</span>
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         <span class="comment">/* Finally, dump the silly thing to a file. */</span>
<a name="l00682"></a>00682         ret =  purple_util_write_data_to_file_absolute(filename, pemcrt, -1);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684         g_free(pemcrt);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <span class="keywordflow">return</span> ret;
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="keyword">static</span> <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *
<a name="l00690"></a>00690 x509_copy_certificate(<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692         CERTCertificate *crt_dat;
<a name="l00693"></a>00693         <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *newcrt;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695         g_return_val_if_fail(crt, NULL);
<a name="l00696"></a>00696         g_return_val_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss, NULL);
<a name="l00697"></a>00697 
<a name="l00698"></a>00698         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00699"></a>00699         g_return_val_if_fail(crt_dat, NULL);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         <span class="comment">/* Create the certificate copy */</span>
<a name="l00702"></a>00702         newcrt = g_new0(<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a>, 1);
<a name="l00703"></a>00703         newcrt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> = &amp;x509_nss;
<a name="l00704"></a>00704         <span class="comment">/* NSS does refcounting automatically */</span>
<a name="l00705"></a>00705         newcrt-&gt;<a class="code" href="struct___purple_certificate.html#ac2d150b349f3d00b3c333b5e16c30449">data</a> = CERT_DupCertificate(crt_dat);
<a name="l00706"></a>00706 
<a name="l00707"></a>00707         <span class="keywordflow">return</span> newcrt;
<a name="l00708"></a>00708 }
<a name="l00709"></a>00709 
<a name="l00718"></a>00718 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00719"></a>00719 x509_destroy_certificate(<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> * crt)
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721         CERTCertificate *crt_dat;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723         g_return_if_fail(crt);
<a name="l00724"></a>00724         g_return_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss);
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00727"></a>00727         g_return_if_fail(crt_dat);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729         <span class="comment">/* Finally we have the certificate. So let&#39;s kill it */</span>
<a name="l00730"></a>00730         <span class="comment">/* NSS does refcounting automatically */</span>
<a name="l00731"></a>00731         CERT_DestroyCertificate(crt_dat);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         <span class="comment">/* Delete the PurpleCertificate as well */</span>
<a name="l00734"></a>00734         g_free(crt);
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00745"></a>00745 <span class="keyword">static</span> gboolean
<a name="l00746"></a>00746 x509_signed_by(<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> * crt,
<a name="l00747"></a>00747                <a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> * issuer)
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749         CERTCertificate *subjectCert;
<a name="l00750"></a>00750         CERTCertificate *issuerCert;
<a name="l00751"></a>00751         SECStatus st;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         issuerCert = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(issuer);
<a name="l00754"></a>00754         g_return_val_if_fail(issuerCert, FALSE);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         subjectCert = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00757"></a>00757         g_return_val_if_fail(subjectCert, FALSE);
<a name="l00758"></a>00758 
<a name="l00759"></a>00759         <span class="keywordflow">if</span> (subjectCert-&gt;issuerName == NULL
<a name="l00760"></a>00760                         || PORT_Strcmp(subjectCert-&gt;issuerName, issuerCert-&gt;subjectName) != 0)
<a name="l00761"></a>00761                 <span class="keywordflow">return</span> FALSE;
<a name="l00762"></a>00762         st = CERT_VerifySignedData(&amp;subjectCert-&gt;signatureWrap, issuerCert, PR_Now(), NULL);
<a name="l00763"></a>00763         <span class="keywordflow">return</span> st == SECSuccess;
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 <span class="keyword">static</span> GByteArray *
<a name="l00767"></a>00767 x509_sha1sum(<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt)
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769         CERTCertificate *crt_dat;
<a name="l00770"></a>00770         <span class="keywordtype">size_t</span> hashlen = 20; <span class="comment">/* Size of an sha1sum */</span>
<a name="l00771"></a>00771         GByteArray *sha1sum;
<a name="l00772"></a>00772         SECItem *derCert; <span class="comment">/* DER representation of the cert */</span>
<a name="l00773"></a>00773         SECStatus st;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         g_return_val_if_fail(crt, NULL);
<a name="l00776"></a>00776         g_return_val_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss, NULL);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00779"></a>00779         g_return_val_if_fail(crt_dat, NULL);
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <span class="comment">/* Get the certificate DER representation */</span>
<a name="l00782"></a>00782         derCert = &amp;(crt_dat-&gt;derCert);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784         <span class="comment">/* Make a hash! */</span>
<a name="l00785"></a>00785         sha1sum = g_byte_array_sized_new(hashlen);
<a name="l00786"></a>00786         <span class="comment">/* glib leaves the size as 0 by default */</span>
<a name="l00787"></a>00787         sha1sum-&gt;len = hashlen;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789         st = PK11_HashBuf(SEC_OID_SHA1, sha1sum-&gt;data,
<a name="l00790"></a>00790                           derCert-&gt;data, derCert-&gt;len);
<a name="l00791"></a>00791 
<a name="l00792"></a>00792         <span class="comment">/* Check for errors */</span>
<a name="l00793"></a>00793         <span class="keywordflow">if</span> (st != SECSuccess) {
<a name="l00794"></a>00794                 g_byte_array_free(sha1sum, TRUE);
<a name="l00795"></a>00795                 <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>,
<a name="l00796"></a>00796                                    <span class="stringliteral">&quot;Error: hashing failed!\n&quot;</span>);
<a name="l00797"></a>00797                 <span class="keywordflow">return</span> NULL;
<a name="l00798"></a>00798         }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         <span class="keywordflow">return</span> sha1sum;
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 <span class="keyword">static</span> gchar *
<a name="l00804"></a>00804 x509_dn (<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt)
<a name="l00805"></a>00805 {
<a name="l00806"></a>00806         CERTCertificate *crt_dat;
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         g_return_val_if_fail(crt, NULL);
<a name="l00809"></a>00809         g_return_val_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss, NULL);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00812"></a>00812         g_return_val_if_fail(crt_dat, NULL);
<a name="l00813"></a>00813 
<a name="l00814"></a>00814         <span class="keywordflow">return</span> g_strdup(crt_dat-&gt;subjectName);
<a name="l00815"></a>00815 }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817 <span class="keyword">static</span> gchar *
<a name="l00818"></a>00818 x509_issuer_dn (<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt)
<a name="l00819"></a>00819 {
<a name="l00820"></a>00820         CERTCertificate *crt_dat;
<a name="l00821"></a>00821 
<a name="l00822"></a>00822         g_return_val_if_fail(crt, NULL);
<a name="l00823"></a>00823         g_return_val_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss, NULL);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00826"></a>00826         g_return_val_if_fail(crt_dat, NULL);
<a name="l00827"></a>00827 
<a name="l00828"></a>00828         <span class="keywordflow">return</span> g_strdup(crt_dat-&gt;issuerName);
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00831"></a>00831 <span class="keyword">static</span> gchar *
<a name="l00832"></a>00832 x509_common_name (<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt)
<a name="l00833"></a>00833 {
<a name="l00834"></a>00834         CERTCertificate *crt_dat;
<a name="l00835"></a>00835         <span class="keywordtype">char</span> *nss_cn;
<a name="l00836"></a>00836         gchar *ret_cn;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838         g_return_val_if_fail(crt, NULL);
<a name="l00839"></a>00839         g_return_val_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss, NULL);
<a name="l00840"></a>00840 
<a name="l00841"></a>00841         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00842"></a>00842         g_return_val_if_fail(crt_dat, NULL);
<a name="l00843"></a>00843 
<a name="l00844"></a>00844         <span class="comment">/* Q:</span>
<a name="l00845"></a>00845 <span class="comment">           Why get a newly allocated string out of NSS, strdup it, and then</span>
<a name="l00846"></a>00846 <span class="comment">           return the new copy?</span>
<a name="l00847"></a>00847 <span class="comment"></span>
<a name="l00848"></a>00848 <span class="comment">           A:</span>
<a name="l00849"></a>00849 <span class="comment">           The NSS LXR docs state that I should use the NSPR free functions on</span>
<a name="l00850"></a>00850 <span class="comment">           the strings that the NSS cert functions return. Since the libpurple</span>
<a name="l00851"></a>00851 <span class="comment">           API expects a g_free()-able string, we make our own copy and return</span>
<a name="l00852"></a>00852 <span class="comment">           that.</span>
<a name="l00853"></a>00853 <span class="comment"></span>
<a name="l00854"></a>00854 <span class="comment">           NSPR is something of a prima donna. */</span>
<a name="l00855"></a>00855 
<a name="l00856"></a>00856         nss_cn = CERT_GetCommonName( &amp;(crt_dat-&gt;subject) );
<a name="l00857"></a>00857         ret_cn = g_strdup(nss_cn);
<a name="l00858"></a>00858         PORT_Free(nss_cn);
<a name="l00859"></a>00859 
<a name="l00860"></a>00860         <span class="keywordflow">return</span> ret_cn;
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 <span class="keyword">static</span> gboolean
<a name="l00864"></a>00864 x509_check_name (<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt, <span class="keyword">const</span> gchar *name)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866         CERTCertificate *crt_dat;
<a name="l00867"></a>00867         SECStatus st;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         g_return_val_if_fail(crt, FALSE);
<a name="l00870"></a>00870         g_return_val_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss, FALSE);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00873"></a>00873         g_return_val_if_fail(crt_dat, FALSE);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875         st = CERT_VerifyCertName(crt_dat, name);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         <span class="keywordflow">if</span> (st == SECSuccess) {
<a name="l00878"></a>00878                 <span class="keywordflow">return</span> TRUE;
<a name="l00879"></a>00879         }
<a name="l00880"></a>00880         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (st == SECFailure) {
<a name="l00881"></a>00881                 <span class="keywordflow">return</span> FALSE;
<a name="l00882"></a>00882         }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884         <span class="comment">/* If we get here...bad things! */</span>
<a name="l00885"></a>00885         <a class="code" href="debug_8h.html#a92d772544aec6c280006448aa9a1ef50">purple_debug_error</a>(<span class="stringliteral">&quot;nss/x509&quot;</span>,
<a name="l00886"></a>00886                            <span class="stringliteral">&quot;x509_check_name fell through where it shouldn&#39;t &quot;</span>
<a name="l00887"></a>00887                            <span class="stringliteral">&quot;have.\n&quot;</span>);
<a name="l00888"></a>00888         <span class="keywordflow">return</span> FALSE;
<a name="l00889"></a>00889 }
<a name="l00890"></a>00890 
<a name="l00891"></a>00891 <span class="keyword">static</span> gboolean
<a name="l00892"></a>00892 x509_times (<a class="code" href="struct___purple_certificate.html">PurpleCertificate</a> *crt, time_t *activation, time_t *expiration)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894         CERTCertificate *crt_dat;
<a name="l00895"></a>00895         PRTime nss_activ, nss_expir;
<a name="l00896"></a>00896 
<a name="l00897"></a>00897         g_return_val_if_fail(crt, FALSE);
<a name="l00898"></a>00898         g_return_val_if_fail(crt-&gt;<a class="code" href="struct___purple_certificate.html#ad40d8dd0a806d5bd9b4b409e13aab333">scheme</a> == &amp;x509_nss, FALSE);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900         crt_dat = <a class="code" href="ssl-nss_8c.html#a1834e8c773dbe0f2dfb3672216b2ea5f">X509_NSS_DATA</a>(crt);
<a name="l00901"></a>00901         g_return_val_if_fail(crt_dat, FALSE);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903         <span class="comment">/* Extract the times into ugly PRTime thingies */</span>
<a name="l00904"></a>00904         <span class="comment">/* TODO: Maybe this shouldn&#39;t throw an error? */</span>
<a name="l00905"></a>00905         g_return_val_if_fail(
<a name="l00906"></a>00906                 SECSuccess == CERT_GetCertTimes(crt_dat,
<a name="l00907"></a>00907                                                 &amp;nss_activ, &amp;nss_expir),
<a name="l00908"></a>00908                 FALSE);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910         <span class="comment">/* NSS&#39;s native PRTime type *almost* corresponds to time_t; however,</span>
<a name="l00911"></a>00911 <span class="comment">           it measures *microseconds* since the epoch, not seconds. Hence</span>
<a name="l00912"></a>00912 <span class="comment">           the funny conversion. */</span>
<a name="l00913"></a>00913         <span class="keywordflow">if</span> (activation) {
<a name="l00914"></a>00914                 *activation = nss_activ / 1000000;
<a name="l00915"></a>00915         }
<a name="l00916"></a>00916         <span class="keywordflow">if</span> (expiration) {
<a name="l00917"></a>00917                 *expiration = nss_expir / 1000000;
<a name="l00918"></a>00918         }
<a name="l00919"></a>00919 
<a name="l00920"></a>00920         <span class="keywordflow">return</span> TRUE;
<a name="l00921"></a>00921 }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923 <span class="keyword">static</span> <a class="code" href="struct___purple_certificate_scheme.html">PurpleCertificateScheme</a> x509_nss = {
<a name="l00924"></a>00924         <span class="stringliteral">&quot;x509&quot;</span>,                          <span class="comment">/* Scheme name */</span>
<a name="l00925"></a>00925         N_(<span class="stringliteral">&quot;X.509 Certificates&quot;</span>),        <span class="comment">/* User-visible scheme name */</span>
<a name="l00926"></a>00926         x509_import_from_file,           <span class="comment">/* Certificate import function */</span>
<a name="l00927"></a>00927         x509_export_certificate,         <span class="comment">/* Certificate export function */</span>
<a name="l00928"></a>00928         x509_copy_certificate,           <span class="comment">/* Copy */</span>
<a name="l00929"></a>00929         x509_destroy_certificate,        <span class="comment">/* Destroy cert */</span>
<a name="l00930"></a>00930         x509_signed_by,                  <span class="comment">/* Signed-by */</span>
<a name="l00931"></a>00931         x509_sha1sum,                    <span class="comment">/* SHA1 fingerprint */</span>
<a name="l00932"></a>00932         x509_dn,                         <span class="comment">/* Unique ID */</span>
<a name="l00933"></a>00933         x509_issuer_dn,                  <span class="comment">/* Issuer Unique ID */</span>
<a name="l00934"></a>00934         x509_common_name,                <span class="comment">/* Subject name */</span>
<a name="l00935"></a>00935         x509_check_name,                 <span class="comment">/* Check subject name */</span>
<a name="l00936"></a>00936         x509_times,                      <span class="comment">/* Activation/Expiration time */</span>
<a name="l00937"></a>00937         x509_importcerts_from_file,      <span class="comment">/* Multiple certificate import function */</span>
<a name="l00938"></a>00938 
<a name="l00939"></a>00939         NULL,
<a name="l00940"></a>00940         NULL,
<a name="l00941"></a>00941         NULL
<a name="l00942"></a>00942 };
<a name="l00943"></a>00943 
<a name="l00944"></a>00944 <span class="keyword">static</span> <a class="code" href="struct_purple_ssl_ops.html">PurpleSslOps</a> ssl_ops =
<a name="l00945"></a>00945 {
<a name="l00946"></a>00946         ssl_nss_init,
<a name="l00947"></a>00947         ssl_nss_uninit,
<a name="l00948"></a>00948         ssl_nss_connect,
<a name="l00949"></a>00949         ssl_nss_close,
<a name="l00950"></a>00950         ssl_nss_read,
<a name="l00951"></a>00951         ssl_nss_write,
<a name="l00952"></a>00952         ssl_nss_peer_certs,
<a name="l00953"></a>00953 
<a name="l00954"></a>00954         <span class="comment">/* padding */</span>
<a name="l00955"></a>00955         NULL,
<a name="l00956"></a>00956         NULL,
<a name="l00957"></a>00957         NULL
<a name="l00958"></a>00958 };
<a name="l00959"></a>00959 
<a name="l00960"></a>00960 
<a name="l00961"></a>00961 <span class="keyword">static</span> gboolean
<a name="l00962"></a>00962 plugin_load(<a class="code" href="struct___purple_plugin.html">PurplePlugin</a> *plugin)
<a name="l00963"></a>00963 {
<a name="l00964"></a>00964         <span class="keywordflow">if</span> (!purple_ssl_get_ops()) {
<a name="l00965"></a>00965                 purple_ssl_set_ops(&amp;ssl_ops);
<a name="l00966"></a>00966         }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968         <span class="comment">/* Init NSS now, so others can use it even if sslconn never does */</span>
<a name="l00969"></a>00969         ssl_nss_init_nss();
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         <span class="comment">/* Register the X.509 functions we provide */</span>
<a name="l00972"></a>00972         purple_certificate_register_scheme(&amp;x509_nss);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974         <span class="keywordflow">return</span> TRUE;
<a name="l00975"></a>00975 }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 <span class="keyword">static</span> gboolean
<a name="l00978"></a>00978 plugin_unload(<a class="code" href="struct___purple_plugin.html">PurplePlugin</a> *plugin)
<a name="l00979"></a>00979 {
<a name="l00980"></a>00980         <span class="keywordflow">if</span> (purple_ssl_get_ops() == &amp;ssl_ops) {
<a name="l00981"></a>00981                 purple_ssl_set_ops(NULL);
<a name="l00982"></a>00982         }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984         <span class="comment">/* Unregister our X.509 functions */</span>
<a name="l00985"></a>00985         purple_certificate_unregister_scheme(&amp;x509_nss);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987         <span class="keywordflow">return</span> TRUE;
<a name="l00988"></a>00988 }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990 <span class="keyword">static</span> <a class="code" href="struct___purple_plugin_info.html">PurplePluginInfo</a> info =
<a name="l00991"></a>00991 {
<a name="l00992"></a>00992         PURPLE_PLUGIN_MAGIC,
<a name="l00993"></a>00993         <a class="code" href="version_8h.html#a046c2ee58f2b6ed94f29c524c2241f4d">PURPLE_MAJOR_VERSION</a>,
<a name="l00994"></a>00994         <a class="code" href="version_8h.html#aa67c27a6835b76d1b01df29cb3dc9f07">PURPLE_MINOR_VERSION</a>,
<a name="l00995"></a>00995         <a class="code" href="plugin_8h.html#a0e1cfd7954f1157f5ed3ccb42e6f6d58a204952e5e56c3ae37f432de93ff75e59">PURPLE_PLUGIN_STANDARD</a>,                             
<a name="l00996"></a>00996         NULL,                                             
<a name="l00997"></a>00997         PURPLE_PLUGIN_FLAG_INVISIBLE,                       
<a name="l00998"></a>00998         NULL,                                             
<a name="l00999"></a>00999         PURPLE_PRIORITY_DEFAULT,                            
<a name="l01001"></a>01001         SSL_NSS_PLUGIN_ID,                             
<a name="l01002"></a>01002         N_(<span class="stringliteral">&quot;NSS&quot;</span>),                                        
<a name="l01003"></a>01003         DISPLAY_VERSION,                                  
<a name="l01005"></a>01005         N_(<span class="stringliteral">&quot;Provides SSL support through Mozilla NSS.&quot;</span>),
<a name="l01007"></a>01007         N_(<span class="stringliteral">&quot;Provides SSL support through Mozilla NSS.&quot;</span>),
<a name="l01008"></a>01008         <span class="stringliteral">&quot;Christian Hammond &lt;chipx86@gnupdate.org&gt;&quot;</span>,
<a name="l01009"></a>01009         PURPLE_WEBSITE,                                     
<a name="l01011"></a>01011         plugin_load,                                      
<a name="l01012"></a>01012         plugin_unload,                                    
<a name="l01013"></a>01013         NULL,                                             
<a name="l01015"></a>01015         NULL,                                             
<a name="l01016"></a>01016         NULL,                                             
<a name="l01017"></a>01017         NULL,                                             
<a name="l01018"></a>01018         NULL,                                             
<a name="l01020"></a>01020         <span class="comment">/* padding */</span>
<a name="l01021"></a>01021         NULL,
<a name="l01022"></a>01022         NULL,
<a name="l01023"></a>01023         NULL,
<a name="l01024"></a>01024         NULL
<a name="l01025"></a>01025 };
<a name="l01026"></a>01026 
<a name="l01027"></a>01027 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01028"></a>01028 init_plugin(<a class="code" href="struct___purple_plugin.html">PurplePlugin</a> *plugin)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 PURPLE_INIT_PLUGIN(ssl_nss, init_plugin, info)
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="ssl-nss_8c.html">ssl-nss.c</a>      </li>
      <li class="footer">Generated on Sun Mar 24 2013 16:05:10 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
